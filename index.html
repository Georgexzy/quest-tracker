<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Life Quest RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        fitness: '#ef4444',
                        nutrition: '#16a34a',
                        hydration: '#3b82f6',
                        wellness: '#a855f7',
                        focus: '#f59e0b',
                        personal: '#6366f1'
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .floating-notification {
            animation: slideInRight 0.5s ease-out, slideOutRight 0.5s ease-in 2.5s forwards;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .xp-burst {
            animation: xpBurst 2s ease-out forwards;
        }
        @keyframes xpBurst {
            0% { transform: scale(1) translateY(0); opacity: 1; }
            50% { transform: scale(1.2) translateY(-20px); opacity: 1; }
            100% { transform: scale(1) translateY(-60px); opacity: 0; }
        }
        .level-up {
            animation: levelUp 1s ease-out;
        }
        @keyframes levelUp {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-bottom: 2px solid #ffffff;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-300">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="gradient-bg text-white p-4 shadow-lg">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold">üèÜ Life Quest RPG</h1>
                        <span class="text-sm opacity-90">Ultimate AI Edition</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="showStorageInfo()" class="glass-effect px-3 py-1 rounded-lg text-sm hover:bg-white/20">
                            üíæ Storage
                        </button>
                        <button onclick="showProfile()" class="glass-effect px-3 py-1 rounded-lg text-sm hover:bg-white/20">
                            ‚öôÔ∏è Profile
                        </button>
                        <div class="text-right">
                            <div id="playerLevel" class="font-bold">Level 1</div>
                            <div class="text-xs opacity-90">
                                <span id="currentXP">0</span>/<span id="nextLevelXP">100</span> XP
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- XP Progress Bar -->
                <div class="mt-3">
                    <div class="bg-white/20 rounded-full h-2">
                        <div id="xpProgress" class="bg-yellow-400 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="gradient-bg border-b border-white/20">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex space-x-8 overflow-x-auto">
                    <button onclick="switchTab('dashboard')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap active">
                        üìä Dashboard
                    </button>
                    <button onclick="switchTab('health')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üèÉ‚Äç‚ôÇÔ∏è Health
                    </button>
                    <button onclick="switchTab('ai')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üß† AI Coach
                    </button>
                    <button onclick="switchTab('tasks')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üìã Tasks
                    </button>
                    <button onclick="switchTab('settings')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        ‚öôÔ∏è Settings
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-4">
            <!-- AI Insights (visible on all tabs) -->
            <div id="aiInsights" class="mb-6"></div>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <!-- Stats Grid -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border border-fitness/20">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-fitness">üèÉ‚Äç‚ôÇÔ∏è</span>
                            <span id="stepsCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Steps</div>
                        <div class="text-xs text-fitness">Goal: 8,000</div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border border-hydration/20">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-hydration">üíß</span>
                            <span id="waterCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Water</div>
                        <div class="text-xs text-hydration">Goal: 8 glasses</div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border border-nutrition/20">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-nutrition">ü•ó</span>
                            <span id="caloriesCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Calories</div>
                        <div class="text-xs text-nutrition">Target: 2000</div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border border-focus/20">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-focus">üß†</span>
                            <span id="focusCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Focus (min)</div>
                        <div class="text-xs text-focus">Goal: 120</div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border border-wellness/20">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-wellness">üò¥</span>
                            <span id="sleepCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Sleep (hrs)</div>
                        <div class="text-xs text-wellness">Goal: 8</div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border border-fitness/20">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-fitness">üí™</span>
                            <span id="workoutCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Workouts</div>
                        <div class="text-xs text-fitness">Goal: 1</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üìã Today's Quests</h3>
                        <div id="tasksList" class="space-y-2 max-h-64 overflow-y-auto mb-4">
                            <!-- Tasks will be populated here -->
                        </div>
                        <button onclick="addCustomTask()" class="w-full bg-personal text-white py-2 rounded hover:bg-indigo-600">
                            ‚ûï Add Custom Quest
                        </button>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üèÜ Recent Achievements</h3>
                        <div id="achievementsList" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Achievements will be populated here -->
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">‚ö° Quick Actions</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="trackWater()" class="bg-hydration text-white p-3 rounded-lg hover:bg-blue-600 text-sm">
                                üíß Water
                            </button>
                            <button onclick="logWorkout()" class="bg-fitness text-white p-3 rounded-lg hover:bg-red-600 text-sm">
                                üí™ Workout
                            </button>
                            <button onclick="logMeal()" class="bg-nutrition text-white p-3 rounded-lg hover:bg-green-600 text-sm">
                                ü•ó Meal
                            </button>
                            <button onclick="startPomodoro()" class="bg-focus text-white p-3 rounded-lg hover:bg-yellow-600 text-sm">
                                üçÖ Focus
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health Tab -->
            <div id="health-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <!-- Apple Health Integration -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-3xl">üì±</span>
                                <div>
                                    <h3 class="text-xl font-bold">Apple Health</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Sync your health data automatically</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 gap-3">
                                <button onclick="showAppleHealthSetup()" class="w-full text-left px-4 py-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50">
                                    <div class="font-medium">‚öôÔ∏è Setup Auto-Sync</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Configure iOS shortcuts</div>
                                </button>
                                <button onclick="importHealthData()" class="w-full text-left px-4 py-3 bg-green-50 dark:bg-green-900/30 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/50">
                                    <div class="font-medium">üì• Import Data</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Manual import options</div>
                                </button>
                                <button onclick="showHealthStatus()" class="w-full text-left px-4 py-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                    <div class="font-medium">üìä Sync Status</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">View connection status</div>
                                </button>
                            </div>
                        </div>

                        <!-- Manual Logging -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üìù Manual Logging</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="logSteps()" class="bg-orange-500 text-white p-3 rounded-lg hover:bg-orange-600">
                                    üö∂‚Äç‚ôÇÔ∏è Steps
                                </button>
                                <button onclick="logWorkout()" class="bg-fitness text-white p-3 rounded-lg hover:bg-red-600">
                                    üí™ Workout
                                </button>
                                <button onclick="logSleep()" class="bg-wellness text-white p-3 rounded-lg hover:bg-purple-600">
                                    üò¥ Sleep
                                </button>
                                <button onclick="logMeal()" class="bg-nutrition text-white p-3 rounded-lg hover:bg-green-600">
                                    ü•ó Meal
                                </button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <!-- Health Progress -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üìä Health Progress</h3>
                            <div id="healthProgressContainer" class="space-y-4">
                                <!-- Health progress will be populated here -->
                            </div>
                            <button onclick="showHabitTracker()" class="w-full mt-4 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-2 rounded hover:bg-gray-200 dark:hover:bg-gray-600">
                                View Detailed Tracker
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Coach Tab -->
            <div id="ai-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-3xl">üß†</span>
                                <div>
                                    <h3 class="text-xl font-bold">AI Nutrition Coach</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Personalized meal recommendations</p>
                                </div>
                            </div>
                            <button onclick="generateAINutritionPlan()" class="w-full bg-nutrition text-white py-3 rounded-lg hover:bg-green-600">
                                üçΩÔ∏è Generate Nutrition Plan
                            </button>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-3xl">üí™</span>
                                <div>
                                    <h3 class="text-xl font-bold">AI Workout Coach</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Smart exercise recommendations</p>
                                </div>
                            </div>
                            <button onclick="generateAIWorkoutPlan()" class="w-full bg-fitness text-white py-3 rounded-lg hover:bg-red-600">
                                üèãÔ∏è‚Äç‚ôÇÔ∏è Generate Workout Plan
                            </button>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-3xl">üéØ</span>
                                <div>
                                    <h3 class="text-xl font-bold">AI Task Generator</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Context-aware task suggestions</p>
                                </div>
                            </div>
                            <button onclick="generateAdvancedAITasks()" class="w-full bg-personal text-white py-3 rounded-lg hover:bg-indigo-600">
                                ‚ú® Generate Smart Tasks
                            </button>
                        </div>
                    </div>

                    <div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg h-full">
                            <h3 class="text-xl font-bold mb-4">ü§ñ AI Insights</h3>
                            <div class="space-y-4">
                                <div class="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/30 dark:to-blue-900/30 p-4 rounded-lg">
                                    <h4 class="font-bold mb-2">How AI Coaching Works</h4>
                                    <ul class="text-sm space-y-2 text-gray-600 dark:text-gray-400">
                                        <li>‚Ä¢ Analyzes your current stats and patterns</li>
                                        <li>‚Ä¢ Considers your goals and preferences</li>
                                        <li>‚Ä¢ Adapts to time of day and energy levels</li>
                                        <li>‚Ä¢ Provides personalized recommendations</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 p-4 rounded-lg">
                                    <h4 class="font-bold mb-2">AI Features</h4>
                                    <ul class="text-sm space-y-2 text-gray-600 dark:text-gray-400">
                                        <li>‚Ä¢ Smart meal planning with macro tracking</li>
                                        <li>‚Ä¢ Adaptive workout routines</li>
                                        <li>‚Ä¢ Context-aware task generation</li>
                                        <li>‚Ä¢ Pattern recognition and insights</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div id="tasks-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold">üìã Today's Quests</h3>
                                <button onclick="generateDailyTasks()" class="text-primary hover:text-purple-600 text-sm">
                                    üîÑ Refresh
                                </button>
                            </div>
                            <div id="tasksListDetailed" class="space-y-2 max-h-96 overflow-y-auto mb-4">
                                <!-- Tasks will be populated here -->
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="addCustomTask()" class="flex-1 bg-personal text-white py-2 rounded hover:bg-indigo-600">
                                    ‚ûï Add Custom Quest
                                </button>
                                <button onclick="generateAdvancedAITasks()" class="flex-1 bg-purple-500 text-white py-2 rounded hover:bg-purple-600">
                                    üß† AI Tasks
                                </button>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üéØ Productivity Tools</h3>
                            <div class="grid grid-cols-1 gap-3">
                                <button onclick="startPomodoro()" class="w-full text-left px-4 py-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg hover:bg-orange-100 dark:hover:bg-orange-900/50">
                                    <div class="font-medium">üçÖ Pomodoro Timer</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">25-minute focus sessions</div>
                                </button>
                                <button onclick="showHabitTracker()" class="w-full text-left px-4 py-3 bg-green-50 dark:bg-green-900/30 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/50">
                                    <div class="font-medium">üìä Habit Tracker</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Track your daily habits</div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üèÜ Achievements</h3>
                            <div id="achievementsListDetailed" class="space-y-3 max-h-96 overflow-y-auto">
                                <!-- Achievements will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üë§ Profile</h3>
                            <button onclick="showProfile()" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-purple-600">
                                Edit Profile Settings
                            </button>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üîî Notifications</h3>
                            <button onclick="console.log('Button clicked!'); showNotificationSettings();" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600">
                                Manage Reminders
                            </button>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üíæ Data</h3>
                            <button onclick="showStorageInfo()" class="w-full bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Storage Information
                            </button>
                        </div>
                    </div>

                    <div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg h-full">
                            <h3 class="text-xl font-bold mb-4">üìä Statistics</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-blue-600" id="settingsLevel">${gameState.level}</div>
                                    <div class="text-sm text-blue-500">Current Level</div>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-green-600" id="settingsTotalXP">${gameState.totalXP.toLocaleString()}</div>
                                    <div class="text-sm text-green-500">Total XP</div>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-purple-600" id="settingsAchievements">${gameState.achievements.length}</div>
                                    <div class="text-sm text-purple-500">Achievements</div>
                                </div>
                                <div class="bg-orange-50 dark:bg-orange-900/30 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-orange-600" id="settingsTasks">${gameState.tasks.length}</div>
                                    <div class="text-sm text-orange-500">Total Tasks</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Notifications Container -->
    <div id="notificationsContainer" class="fixed top-20 right-4 z-50 space-y-2"></div>

    <script>
        // üéÆ GAME STATE MANAGEMENT
        let gameState = {
            level: 1,
            xp: 0,
            totalXP: 0,
            dailyStats: {
                steps: 0,
                waterGlasses: 0,
                calories: 0,
                protein: 0,
                carbs: 0,
                fat: 0,
                meals: 0,
                focusMinutes: 0,
                sleepHours: 0,
                workouts: 0,
                caloriesBurned: 0
            },
            tasks: [],
            achievements: [],
            profile: {
                age: null,
                weight: null,
                height: null,
                activityLevel: 'moderate',
                fitnessGoal: 'maintain',
                bmr: null
            },
            streaks: {
                workout: 0,
                water: 0,
                sleep: 0
            },
            settings: {
                notifications: true,
                darkMode: 'auto'
            }
        };

        // üéØ INITIALIZATION
        function initializeApp() {
            // Apply dark mode based on system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });

            loadGameState();
            updateAllUI();
            generateDailyTasks();
            showAIInsights();
            
            // Auto-save every 30 seconds
            setInterval(saveGameState, 30000);
            
            console.log('üéÆ Life Quest RPG - Ultimate AI Edition Initialized!');
            logStorageInfo();
        }

        // üíæ STORAGE MANAGEMENT
        function saveGameState() {
            try {
                const serializedState = JSON.stringify(gameState);
                
                // Save to localStorage (PWA environment)
                localStorage.setItem('lifeQuestRPG', serializedState);
                localStorage.setItem('lifeQuestRPG_lastSave', new Date().toISOString());
                
                console.log('‚úÖ Game state saved to localStorage:', {
                    level: gameState.level,
                    xp: gameState.xp,
                    steps: gameState.dailyStats.steps,
                    tasks: gameState.tasks.length,
                    achievements: gameState.achievements.length
                });
            } catch (error) {
                console.error('‚ùå Failed to save game state:', error);
                showFloatingNotification('‚ö†Ô∏è Save Error', 'Unable to save progress to browser');
                
                // Fallback to memory storage
                window.gameStateBackup = { ...gameState };
                console.log('üìù Fallback: Saved to memory backup');
            }
        }

        function loadGameState() {
            try {
                // Try to load from localStorage first
                const savedState = localStorage.getItem('lifeQuestRPG');
                const lastSave = localStorage.getItem('lifeQuestRPG_lastSave');
                
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    gameState = { ...gameState, ...parsedState };
                    
                    console.log('‚úÖ Game state loaded from localStorage:', {
                        lastSave: lastSave,
                        level: gameState.level,
                        steps: gameState.dailyStats.steps,
                        tasks: gameState.tasks.length
                    });
                    
                    showFloatingNotification('üíæ Progress Loaded', 'Your data has been restored');
                } else {
                    console.log('üì± No saved data found, starting fresh');
                }
            } catch (error) {
                console.error('‚ùå Failed to load game state:', error);
                
                // Try fallback memory storage
                if (window.gameStateBackup) {
                    gameState = { ...gameState, ...window.gameStateBackup };
                    console.log('üìù Loaded from memory backup');
                } else {
                    console.log('üÜï Using default game state');
                }
            }
        }

        function showStorageInfo() {
            // Calculate approximate storage usage
            const stateSize = JSON.stringify(gameState).length;
            const approximateMemoryUsage = stateSize * 2; // Rough estimate including overhead
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üíæ Storage Information</h3>
                    
                    <div class="space-y-4">
                        <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">üìä Current Usage</h4>
                            <div class="text-sm space-y-1">
                                <div>Game State Size: <span class="font-mono">${(stateSize/1024).toFixed(2)} KB</span></div>
                                <div>Memory Usage: <span class="font-mono">${(approximateMemoryUsage/1024).toFixed(2)} KB</span></div>
                                <div>Tasks Count: <span class="font-mono">${gameState.tasks.length}</span></div>
                                <div>Achievements: <span class="font-mono">${gameState.achievements.length}</span></div>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-2 text-yellow-700 dark:text-yellow-300">‚ö†Ô∏è Storage Limitations</h4>
                            <div class="text-sm text-yellow-600 dark:text-yellow-400">
                                <p>Due to iframe restrictions, this app uses in-memory storage. 
                                Data will be lost when the page is refreshed.</p>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-2 text-blue-700 dark:text-blue-300">üí° Performance Tips</h4>
                            <div class="text-sm text-blue-600 dark:text-blue-400 space-y-1">
                                <p>‚Ä¢ Complete older tasks to reduce memory usage</p>
                                <p>‚Ä¢ Current memory usage is very low and efficient</p>
                                <p>‚Ä¢ The app auto-optimizes data storage</p>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="clearOldData()" class="flex-1 bg-orange-500 text-white py-2 rounded hover:bg-orange-600">
                                üßπ Clean Old Data
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function clearOldData() {
            const beforeSize = JSON.stringify(gameState).length;
            
            // Clean completed tasks older than 7 days
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            gameState.tasks = gameState.tasks.filter(task => {
                if (task.completed && new Date(task.completedAt) < oneWeekAgo) {
                    return false;
                }
                return true;
            });
            
            // Keep only recent achievements (last 50)
            if (gameState.achievements.length > 50) {
                gameState.achievements = gameState.achievements.slice(-50);
            }
            
            const afterSize = JSON.stringify(gameState).length;
            const savedBytes = beforeSize - afterSize;
            
            saveGameState();
            showFloatingNotification('üßπ Data Cleaned', `Saved ${(savedBytes/1024).toFixed(2)} KB of memory`);
            
            // Refresh storage modal if open
            const modal = document.querySelector('.fixed');
            if (modal) {
                modal.remove();
                showStorageInfo();
            }
        }

        function logStorageInfo() {
            const stateSize = JSON.stringify(gameState).length;
            console.log(`üìä Storage Info:
- Game State: ${(stateSize/1024).toFixed(2)} KB
- Tasks: ${gameState.tasks.length}
- Achievements: ${gameState.achievements.length}
- Level: ${gameState.level}
- Total XP: ${gameState.totalXP}
            `);
        }

        // üß† LOCAL AI FEATURES - NUTRITION, EXERCISE & TASKS (No External APIs)
        
        // Local AI Nutrition Engine
        function generateAINutritionPlan() {
            const profile = gameState.profile;
            const stats = gameState.dailyStats;
            const hour = new Date().getHours();
            
            // Calculate personalized nutrition needs using local algorithms
            const nutritionNeeds = calculateNutritionNeeds(profile);
            const mealPlan = generatePersonalizedMealPlan(nutritionNeeds, hour, stats);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center text-nutrition">üß† AI Nutrition Coach</h3>
                    
                    <!-- Personalized Needs -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">${nutritionNeeds.calories}</div>
                            <div class="text-sm text-blue-500">Daily Calories</div>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-red-600">${nutritionNeeds.protein}g</div>
                            <div class="text-sm text-red-500">Protein</div>
                        </div>
                        <div class="bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-600">${nutritionNeeds.carbs}g</div>
                            <div class="text-sm text-yellow-500">Carbs</div>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600">${nutritionNeeds.fat}g</div>
                            <div class="text-sm text-green-500">Fat</div>
                        </div>
                    </div>
                    
                    <!-- AI Meal Suggestions -->
                    <div class="mb-6">
                        <h4 class="font-bold mb-3">üçΩÔ∏è Smart Meal Suggestions</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${mealPlan.map(meal => `
                                <div class="border rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="font-bold">${meal.name}</div>
                                        <div class="text-sm bg-nutrition text-white px-2 py-1 rounded">${meal.calories} cal</div>
                                    </div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-3">${meal.description}</div>
                                    <div class="grid grid-cols-3 gap-2 text-xs">
                                        <div class="text-center">
                                            <div class="font-bold">${meal.protein}g</div>
                                            <div class="text-gray-500">Protein</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="font-bold">${meal.carbs}g</div>
                                            <div class="text-gray-500">Carbs</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="font-bold">${meal.fat}g</div>
                                            <div class="text-gray-500">Fat</div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="text-xs text-purple-600 dark:text-purple-400 mb-2">
                                            ${meal.aiReasoning}
                                        </div>
                                        <button onclick="adoptAIMeal('${meal.id}')" class="w-full bg-nutrition text-white py-2 rounded hover:bg-green-600 text-sm">
                                            Add to My Plan
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- AI Insights -->
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/30 dark:to-blue-900/30 p-4 rounded-lg mb-6">
                        <h4 class="font-bold mb-2">üß† AI Nutrition Insights</h4>
                        <div class="text-sm">
                            ${generateNutritionInsights(profile, stats, nutritionNeeds)}
                        </div>
                    </div>
                    
                    <div class="flex justify-center">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function calculateNutritionNeeds(profile) {
            // Advanced BMR and TDEE calculation with activity multipliers
            let bmr = profile.bmr || 1800; // Default if not calculated
            
            const activityMultipliers = {
                'sedentary': 1.2,
                'light': 1.375,
                'moderate': 1.55,
                'very': 1.725
            };
            
            const tdee = bmr * (activityMultipliers[profile.activityLevel] || 1.4);
            
            // Adjust for fitness goals
            let calories = tdee;
            if (profile.fitnessGoal === 'lose_weight') calories = tdee - 500;
            else if (profile.fitnessGoal === 'gain_weight') calories = tdee + 300;
            else if (profile.fitnessGoal === 'build_muscle') calories = tdee + 200;
            
            // Macro distribution based on goals
            let proteinPercent = 0.25;
            let fatPercent = 0.25;
            let carbsPercent = 0.50;
            
            if (profile.fitnessGoal === 'build_muscle') {
                proteinPercent = 0.30;
                fatPercent = 0.25;
                carbsPercent = 0.45;
            } else if (profile.fitnessGoal === 'lose_weight') {
                proteinPercent = 0.35;
                fatPercent = 0.30;
                carbsPercent = 0.35;
            }
            
            return {
                calories: Math.round(calories),
                protein: Math.round((calories * proteinPercent) / 4),
                carbs: Math.round((calories * carbsPercent) / 4),
                fat: Math.round((calories * fatPercent) / 9)
            };
        }
        
        function generatePersonalizedMealPlan(needs, hour, stats) {
            const mealDatabase = [
                // Breakfast options
                {
                    id: 'protein_oats',
                    name: 'Protein Power Oats',
                    type: 'breakfast',
                    calories: 380,
                    protein: 25,
                    carbs: 45,
                    fat: 8,
                    description: 'Oatmeal with protein powder, berries, and almond butter',
                    aiReasoning: 'High protein start for sustained energy and muscle recovery'
                },
                {
                    id: 'avocado_toast',
                    name: 'Avocado Power Toast',
                    type: 'breakfast',
                    calories: 320,
                    protein: 12,
                    carbs: 35,
                    fat: 18,
                    description: 'Whole grain toast with avocado, eggs, and hemp seeds',
                    aiReasoning: 'Healthy fats for brain function and steady energy release'
                },
                // Lunch options
                {
                    id: 'quinoa_bowl',
                    name: 'Recovery Quinoa Bowl',
                    type: 'lunch',
                    calories: 450,
                    protein: 20,
                    carbs: 55,
                    fat: 15,
                    description: 'Quinoa with grilled chicken, vegetables, and tahini',
                    aiReasoning: 'Complete protein and complex carbs for afternoon energy'
                },
                {
                    id: 'salmon_salad',
                    name: 'Omega-3 Salmon Salad',
                    type: 'lunch',
                    calories: 420,
                    protein: 35,
                    carbs: 20,
                    fat: 22,
                    description: 'Grilled salmon with mixed greens and olive oil dressing',
                    aiReasoning: 'Anti-inflammatory omega-3s for recovery and brain health'
                },
                // Dinner options
                {
                    id: 'lean_stir_fry',
                    name: 'Lean Muscle Stir-Fry',
                    type: 'dinner',
                    calories: 380,
                    protein: 30,
                    carbs: 35,
                    fat: 12,
                    description: 'Lean beef with vegetables and brown rice',
                    aiReasoning: 'High protein for overnight muscle repair and growth'
                },
                {
                    id: 'lentil_curry',
                    name: 'Plant Power Curry',
                    type: 'dinner',
                    calories: 350,
                    protein: 18,
                    carbs: 50,
                    fat: 10,
                    description: 'Lentil curry with vegetables and quinoa',
                    aiReasoning: 'Plant-based protein and fiber for digestive health'
                },
                // Snacks
                {
                    id: 'greek_yogurt',
                    name: 'Protein Yogurt Bowl',
                    type: 'snack',
                    calories: 180,
                    protein: 15,
                    carbs: 20,
                    fat: 5,
                    description: 'Greek yogurt with berries and nuts',
                    aiReasoning: 'Probiotics and protein for gut health and satiety'
                }
            ];
            
            // AI meal selection based on time, goals, and current intake
            let recommendedMeals = [];
            
            // Morning recommendations
            if (hour < 11) {
                recommendedMeals.push(...mealDatabase.filter(m => m.type === 'breakfast').slice(0, 2));
            }
            
            // Lunch recommendations
            if (hour >= 11 && hour < 16) {
                recommendedMeals.push(...mealDatabase.filter(m => m.type === 'lunch'));
            }
            
            // Evening recommendations
            if (hour >= 16) {
                recommendedMeals.push(...mealDatabase.filter(m => m.type === 'dinner'));
            }
            
            // Always show a snack option
            recommendedMeals.push(...mealDatabase.filter(m => m.type === 'snack'));
            
            // Prioritize based on current deficits
            const remaining = {
                calories: Math.max(0, needs.calories - stats.calories),
                protein: Math.max(0, needs.protein - (stats.protein || 0)),
                carbs: Math.max(0, needs.carbs - (stats.carbs || 0)),
                fat: Math.max(0, needs.fat - (stats.fat || 0))
            };
            
            // Enhance AI reasoning based on deficits
            recommendedMeals.forEach(meal => {
                if (remaining.protein > 20 && meal.protein > 20) {
                    meal.aiReasoning += ' ‚Ä¢ Addresses your protein deficit';
                }
                if (remaining.calories > 300 && meal.calories > 300) {
                    meal.aiReasoning += ' ‚Ä¢ Helps reach your calorie target';
                }
            });
            
            return recommendedMeals.slice(0, 3);
        }
        
        function generateNutritionInsights(profile, stats, needs) {
            const insights = [];
            
            // Analyze current vs needs
            const proteinPercent = Math.round(((stats.protein || 0) / needs.protein) * 100);
            const caloriePercent = Math.round((stats.calories / needs.calories) * 100);
            
            if (proteinPercent < 70) {
                insights.push('ü•© Your protein intake is low - consider adding lean meats, fish, or plant-based proteins');
            }
            
            if (caloriePercent < 80) {
                insights.push('‚ö° You may need more calories to support your activity level and goals');
            }
            
            if (stats.waterGlasses < 6) {
                insights.push('üíß Hydration affects nutrient absorption - aim for 8 glasses daily');
            }
            
            // Time-based insights
            const hour = new Date().getHours();
            if (hour < 10 && stats.meals === 0) {
                insights.push('üåÖ Eating breakfast within 2 hours of waking boosts metabolism');
            }
            
            if (hour > 20 && stats.calories < needs.calories * 0.8) {
                insights.push('üåô Late eating can affect sleep quality - try to finish meals 3 hours before bed');
            }
            
            // Goal-specific insights
            if (profile.fitnessGoal === 'build_muscle') {
                insights.push('üí™ For muscle growth, aim for 20-30g protein every 3-4 hours');
            }
            
            if (profile.fitnessGoal === 'lose_weight') {
                insights.push('üéØ Focus on high-protein, high-fiber foods to maintain satiety');
            }
            
            return insights.length > 0 ? insights.join('<br>‚Ä¢ ') : 'Your nutrition looks balanced! Keep up the great work.';
        }
        
        function adoptAIMeal(mealId) {
            // Find the meal and add it to today's intake
            const mealPlans = generatePersonalizedMealPlan(calculateNutritionNeeds(gameState.profile), new Date().getHours(), gameState.dailyStats);
            const meal = mealPlans.find(m => m.id === mealId);
            
            if (meal) {
                gameState.dailyStats.calories += meal.calories;
                gameState.dailyStats.protein = (gameState.dailyStats.protein || 0) + meal.protein;
                gameState.dailyStats.carbs = (gameState.dailyStats.carbs || 0) + meal.carbs;
                gameState.dailyStats.fat = (gameState.dailyStats.fat || 0) + meal.fat;
                gameState.dailyStats.meals++;
                
                updateAllUI();
                saveGameState();
                awardXP(25, 'Following AI nutrition advice!');
                showFloatingNotification('üß† AI Meal Added!', `${meal.name} logged successfully`);
            }
        }
        
        // AI Exercise Engine
        function generateAIWorkoutPlan() {
            const profile = gameState.profile;
            const stats = gameState.dailyStats;
            const workoutPlan = generatePersonalizedWorkout(profile, stats);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center text-fitness">üß† AI Workout Coach</h3>
                    
                    <!-- Workout Analysis -->
                    <div class="bg-gradient-to-r from-red-50 to-orange-50 dark:from-red-900/30 dark:to-orange-900/30 p-4 rounded-lg mb-6">
                        <h4 class="font-bold mb-2">üìä Your Fitness Profile</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div>
                                <div class="font-bold">${profile.activityLevel || 'Not set'}</div>
                                <div class="text-sm text-gray-500">Activity Level</div>
                            </div>
                            <div>
                                <div class="font-bold">${profile.fitnessGoal?.replace('_', ' ') || 'Not set'}</div>
                                <div class="text-sm text-gray-500">Goal</div>
                            </div>
                            <div>
                                <div class="font-bold">${stats.workouts}</div>
                                <div class="text-sm text-gray-500">Today's Workouts</div>
                            </div>
                            <div>
                                <div class="font-bold">${stats.steps.toLocaleString()}</div>
                                <div class="text-sm text-gray-500">Steps Today</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Workout Recommendations -->
                    <div class="mb-6">
                        <h4 class="font-bold mb-3">üéØ Personalized Workout Plan</h4>
                        <div class="space-y-4">
                            ${workoutPlan.map(workout => `
                                <div class="border rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="text-2xl">${workout.icon}</div>
                                            <div>
                                                <div class="font-bold">${workout.name}</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">${workout.duration} min ‚Ä¢ ${workout.difficulty}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-fitness">${workout.calories} cal</div>
                                            <div class="text-xs text-gray-500">Estimated burn</div>
                                        </div>
                                    </div>
                                    
                                    <div class="text-sm text-purple-600 dark:text-purple-400 mb-3">
                                        üß† ${workout.aiReasoning}
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                        <div>
                                            <div class="text-sm font-medium mb-2">Exercises:</div>
                                            <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                                                ${workout.exercises.slice(0, 3).map(ex => `<li>‚Ä¢ ${ex.name}</li>`).join('')}
                                            </ul>
                                        </div>
                                        <div>
                                            <div class="text-sm font-medium mb-2">Benefits:</div>
                                            <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                                                ${workout.benefits.map(benefit => `<li>‚Ä¢ ${benefit}</li>`).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <button onclick="startAIWorkout('${workout.id}')" class="w-full bg-fitness text-white py-2 rounded-lg hover:bg-red-600">
                                        Start AI Workout
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="flex justify-center">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function generatePersonalizedWorkout(profile, stats) {
            const workouts = [];
            const hour = new Date().getHours();
            
            // AI workout selection based on profile and current state
            const baseWorkouts = [
                {
                    id: 'hiit_beginner',
                    name: 'AI HIIT Starter',
                    icon: 'üî•',
                    duration: 15,
                    difficulty: 'Beginner',
                    calories: 150,
                    type: 'cardio',
                    exercises: [
                        { name: 'Jumping Jacks', duration: 30, rest: 30 },
                        { name: 'Bodyweight Squats', duration: 30, rest: 30 },
                        { name: 'Push-ups (modified)', duration: 30, rest: 30 },
                        { name: 'High Knees', duration: 30, rest: 30 }
                    ],
                    benefits: ['Cardiovascular health', 'Fat burning', 'Metabolic boost'],
                    aiReasoning: 'Perfect for building cardiovascular base and introducing HIIT principles'
                },
                {
                    id: 'strength_functional',
                    name: 'AI Functional Strength',
                    icon: 'üí™',
                    duration: 25,
                    difficulty: 'Intermediate',
                    calories: 200,
                    type: 'strength',
                    exercises: [
                        { name: 'Goblet Squats', reps: 12, rest: 45 },
                        { name: 'Push-up Progression', reps: 10, rest: 45 },
                        { name: 'Single-leg Deadlifts', reps: 8, rest: 45 },
                        { name: 'Plank to Push-up', reps: 6, rest: 60 }
                    ],
                    benefits: ['Functional movement', 'Core stability', 'Total body strength'],
                    aiReasoning: 'Builds real-world strength patterns for daily activities'
                },
                {
                    id: 'mobility_flow',
                    name: 'AI Mobility Flow',
                    icon: 'üßò‚Äç‚ôÄÔ∏è',
                    duration: 20,
                    difficulty: 'Beginner',
                    calories: 80,
                    type: 'flexibility',
                    exercises: [
                        { name: 'Cat-Cow Stretches', duration: 60, rest: 15 },
                        { name: 'Hip Flexor Stretch', duration: 45, rest: 15 },
                        { name: 'Shoulder Rolls', reps: 10, rest: 15 },
                        { name: 'Spinal Twists', reps: 8, rest: 15 }
                    ],
                    benefits: ['Improved flexibility', 'Stress relief', 'Better posture'],
                    aiReasoning: 'Essential for counteracting desk work and improving movement quality'
                }
            ];
            
            // AI logic for workout selection
            if (profile.activityLevel === 'sedentary' || stats.workouts === 0) {
                // Prioritize gentle introduction
                workouts.push(baseWorkouts.find(w => w.id === 'mobility_flow'));
                if (stats.steps < 5000) {
                    const hiit = {...baseWorkouts.find(w => w.id === 'hiit_beginner')};
                    hiit.aiReasoning = 'Low step count today - this will boost your activity and energy levels';
                    workouts.push(hiit);
                }
            }
            
            if (profile.fitnessGoal === 'build_muscle' || profile.fitnessGoal === 'gain_weight') {
                const strength = {...baseWorkouts.find(w => w.id === 'strength_functional')};
                strength.aiReasoning = 'Aligns with your muscle building goals - focuses on progressive overload';
                workouts.push(strength);
            }
            
            if (profile.fitnessGoal === 'lose_weight' && stats.calories > 1500) {
                const hiit = {...baseWorkouts.find(w => w.id === 'hiit_beginner')};
                hiit.aiReasoning = 'High calorie intake detected - this HIIT workout will boost your metabolic rate';
                workouts.push(hiit);
            }
            
            // Time-based recommendations
            if (hour < 10) {
                workouts.forEach(w => {
                    w.aiReasoning += ' ‚Ä¢ Morning workout kickstarts your metabolism for the day';
                });
            } else if (hour > 17) {
                workouts.forEach(w => {
                    w.aiReasoning += ' ‚Ä¢ Evening workout helps decompress from the day';
                });
            }
            
            // Ensure we have at least 2 recommendations
            if (workouts.length < 2) {
                baseWorkouts.forEach(workout => {
                    if (!workouts.find(w => w.id === workout.id)) {
                        workouts.push(workout);
                    }
                });
            }
            
            return workouts.slice(0, 3);
        }
        
        function startAIWorkout(workoutId) {
            const workouts = generatePersonalizedWorkout(gameState.profile, gameState.dailyStats);
            const workout = workouts.find(w => w.id === workoutId);
            
            if (workout) {
                // Close the AI modal
                document.querySelector('.fixed').remove();
                
                // Start the enhanced workout session with AI features
                showAIWorkoutSession(workout);
            }
        }
        
        function showAIWorkoutSession(workout) {
            // Enhanced workout session with AI coaching
            let currentExercise = 0;
            let isResting = false;
            let timeRemaining = 0;
            let workoutTimer = null;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-center text-fitness">üß† ${workout.name}</h3>
                    
                    <!-- AI Coaching Panel -->
                    <div class="bg-purple-50 dark:bg-purple-900/30 p-3 rounded-lg mb-4">
                        <div class="text-sm">
                            <div class="font-bold text-purple-600 dark:text-purple-400">AI Coach:</div>
                            <div id="aiCoachingTip" class="text-purple-700 dark:text-purple-300">Get ready for an amazing workout!</div>
                        </div>
                    </div>
                    
                    <!-- Progress -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span>Exercise ${currentExercise + 1} of ${workout.exercises.length}</span>
                            <span id="workoutStatus">Get Ready!</span>
                        </div>
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div id="workoutProgress" class="bg-fitness h-full rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Current Exercise -->
                    <div class="text-center mb-6">
                        <div class="text-6xl font-bold mb-4" id="workoutTimer">3</div>
                        <div class="text-xl font-bold mb-2" id="exerciseName">Get Ready</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400" id="exerciseDetails"></div>
                    </div>
                    
                    <!-- Controls -->
                    <div class="flex space-x-3">
                        <button id="workoutPause" onclick="pauseAIWorkout()" class="flex-1 bg-yellow-500 text-white py-3 rounded-lg">
                            ‚è∏Ô∏è Pause
                        </button>
                        <button onclick="skipAIExercise()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg">
                            ‚è≠Ô∏è Skip
                        </button>
                        <button onclick="stopAIWorkout()" class="flex-1 bg-red-500 text-white py-3 rounded-lg">
                            ‚èπÔ∏è Stop
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // AI coaching tips for each exercise
            const coachingTips = {
                'Jumping Jacks': 'Land softly on the balls of your feet. Keep your core engaged!',
                'Bodyweight Squats': 'Sit back like you\'re sitting in a chair. Chest up, knees tracking over toes!',
                'Push-ups (modified)': 'Keep your body in a straight line. Modify on knees if needed!',
                'High Knees': 'Drive those knees up high! Pump your arms for momentum!',
                'Goblet Squats': 'Hold the weight close to your chest. Go as deep as you can comfortably!',
                'Push-up Progression': 'Focus on control. Quality over quantity!',
                'Single-leg Deadlifts': 'Keep your standing leg slightly bent. Feel the stretch in your hamstring!',
                'Plank to Push-up': 'Maintain plank position. Move with control, not speed!',
                'Cat-Cow Stretches': 'Move slowly and mindfully. Feel the stretch through your spine!',
                'Hip Flexor Stretch': 'Feel this stretch in the front of your hip. Breathe deeply!'
            };
            
            // Start countdown with AI coaching
            startAIWorkoutCountdown();
            
            function startAIWorkoutCountdown() {
                timeRemaining = 3;
                updateAICoachingTip('Taking deep breaths and preparing your body for movement!');
                updateWorkoutDisplay();
                
                workoutTimer = setInterval(() => {
                    timeRemaining--;
                    updateWorkoutDisplay();
                    
                    if (timeRemaining <= 0) {
                        clearInterval(workoutTimer);
                        startAIExercise();
                    }
                }, 1000);
            }
            
            function startAIExercise() {
                if (currentExercise >= workout.exercises.length) {
                    completeAIWorkout();
                    return;
                }
                
                const exercise = workout.exercises[currentExercise];
                isResting = false;
                timeRemaining = exercise.duration || (exercise.reps ? 45 : 30);
                
                document.getElementById('exerciseName').textContent = exercise.name;
                document.getElementById('exerciseDetails').textContent = exercise.reps ? 
                    `${exercise.reps} reps` : `${exercise.duration} seconds`;
                document.getElementById('workoutStatus').textContent = 'Exercise';
                
                // Update AI coaching tip
                updateAICoachingTip(coachingTips[exercise.name] || 'Keep pushing! You\'ve got this!');
                
                workoutTimer = setInterval(() => {
                    timeRemaining--;
                    updateWorkoutDisplay();
                    
                    // Mid-exercise motivation
                    if (timeRemaining === Math.floor((exercise.duration || 45) / 2)) {
                        updateAICoachingTip('Halfway there! Keep that form perfect!');
                    }
                    
                    if (timeRemaining <= 0) {
                        clearInterval(workoutTimer);
                        startAIRest();
                    }
                }, 1000);
            }
            
            function startAIRest() {
                const exercise = workout.exercises[currentExercise];
                isResting = true;
                timeRemaining = exercise.rest;
                
                document.getElementById('exerciseName').textContent = 'Rest & Recover';
                document.getElementById('exerciseDetails').textContent = 'Take deep breaths';
                document.getElementById('workoutStatus').textContent = 'Rest';
                
                updateAICoachingTip('Great work! Use this time to catch your breath and prepare for the next exercise.');
                
                workoutTimer = setInterval(() => {
                    timeRemaining--;
                    updateWorkoutDisplay();
                    
                    if (timeRemaining === 5) {
                        updateAICoachingTip('Get ready! Next exercise coming up in 5 seconds!');
                    }
                    
                    if (timeRemaining <= 0) {
                        clearInterval(workoutTimer);
                        currentExercise++;
                        updateProgress();
                        startAIExercise();
                    }
                }, 1000);
            }
            
            function updateAICoachingTip(tip) {
                document.getElementById('aiCoachingTip').textContent = tip;
            }
            
            function updateWorkoutDisplay() {
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                document.getElementById('workoutTimer').textContent = 
                    minutes > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : seconds;
            }
            
            function updateProgress() {
                const progress = (currentExercise / workout.exercises.length) * 100;
                document.getElementById('workoutProgress').style.width = `${progress}%`;
            }
            
            function completeAIWorkout() {
                clearInterval(workoutTimer);
                
                // Award enhanced points for AI workout
                gameState.dailyStats.workouts++;
                gameState.dailyStats.caloriesBurned += workout.calories;
                updateAllUI();
                saveGameState();
                awardXP(workout.calories + 50, `AI ${workout.name} completed!`); // Bonus XP for AI workout
                
                // Show AI completion feedback
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4 text-center">
                        <div class="text-6xl mb-4">üèÜ</div>
                        <h3 class="text-xl font-bold mb-2">AI Workout Complete!</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">${workout.name}</p>
                        
                        <div class="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/30 dark:to-blue-900/30 p-4 rounded-lg mb-4">
                            <div class="font-bold text-purple-600 dark:text-purple-400 mb-2">üß† AI Performance Analysis:</div>
                            <div class="text-sm text-purple-700 dark:text-purple-300">
                                Excellent consistency! Your movement patterns are improving. 
                                Consider adding more resistance or duration next time.
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4">
                            <div class="text-2xl font-bold text-fitness">${workout.calories} calories burned</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">+50 AI bonus XP</div>
                        </div>
                        
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-fitness text-white py-3 rounded-lg">
                            Amazing Work! üöÄ
                        </button>
                    </div>
                `;
            }
            
            // Global functions for workout controls
            window.pauseAIWorkout = function() {
                clearInterval(workoutTimer);
                document.getElementById('workoutPause').textContent = '‚ñ∂Ô∏è Resume';
                document.getElementById('workoutPause').onclick = () => {
                    if (isResting) startAIRest(); else startAIExercise();
                    document.getElementById('workoutPause').textContent = '‚è∏Ô∏è Pause';
                    document.getElementById('workoutPause').onclick = pauseAIWorkout;
                };
            };
            
            window.skipAIExercise = function() {
                clearInterval(workoutTimer);
                currentExercise++;
                updateProgress();
                if (currentExercise >= workout.exercises.length) {
                    completeAIWorkout();
                } else {
                    startAIExercise();
                }
            };
            
            window.stopAIWorkout = function() {
                clearInterval(workoutTimer);
                modal.remove();
                showFloatingNotification('Workout Stopped', 'Every step counts! Keep moving forward!');
            };
        }
        
        // Enhanced AI Task Generation
        function generateAdvancedAITasks() {
            const profile = gameState.profile;
            const stats = gameState.dailyStats;
            const hour = new Date().getHours();
            const dayOfWeek = new Date().getDay();
            
            const aiTasks = generateContextualTasks(profile, stats, hour, dayOfWeek);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center">üß† AI Task Generator</h3>
                    
                    <!-- Context Analysis -->
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/30 dark:to-purple-900/30 p-4 rounded-lg mb-6">
                        <h4 class="font-bold mb-2">üìä Context Analysis</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center text-sm">
                            <div>
                                <div class="font-bold">${getDayPeriod(hour)}</div>
                                <div class="text-gray-500">Time Period</div>
                            </div>
                            <div>
                                <div class="font-bold">${getDayOfWeekName(dayOfWeek)}</div>
                                <div class="text-gray-500">Day</div>
                            </div>
                            <div>
                                <div class="font-bold">${getEnergyLevel(stats, hour)}</div>
                                <div class="text-gray-500">Energy Level</div>
                            </div>
                            <div>
                                <div class="font-bold">${getProgressStatus(stats)}</div>
                                <div class="text-gray-500">Progress</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Generated Tasks -->
                    <div class="space-y-4 mb-6">
                        ${aiTasks.map(task => `
                            <div class="border rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="text-2xl">${task.icon}</div>
                                        <div>
                                            <div class="font-bold">${task.text}</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400 capitalize">${task.category} ‚Ä¢ ${task.xp} XP ‚Ä¢ ${task.priority} Priority</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-bold text-purple-600 dark:text-purple-400">${task.estimatedTime}</div>
                                        <div class="text-xs text-gray-500">Est. time</div>
                                    </div>
                                </div>
                                
                                <div class="text-sm text-purple-600 dark:text-purple-400 mb-3">
                                    üß† ${task.aiReasoning}
                                </div>
                                
                                <div class="flex space-x-2">
                                    <button onclick="adoptAITask('${task.text}', '${task.category}', ${task.xp}, '${task.icon}')" class="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700 text-sm">
                                        ‚úÖ Add to My Tasks
                                    </button>
                                    <button onclick="modifyAITask('${task.id}')" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm">
                                        ‚úèÔ∏è Customize
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="flex justify-center">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function generateContextualTasks(profile, stats, hour, dayOfWeek) {
            const tasks = [];
            
            // Advanced AI task generation based on multiple factors
            const taskTemplates = [
                // Energy-based tasks
                {
                    id: 'energy_boost',
                    text: 'Take a 10-minute energizing walk',
                    category: 'fitness',
                    icon: '‚ö°',
                    xp: 20,
                    priority: 'high',
                    estimatedTime: '10 min',
                    conditions: (p, s, h) => h > 14 && h < 16 && s.steps < 5000,
                    aiReasoning: 'Afternoon energy dip detected. A short walk will boost alertness and mood.'
                },
                // Goal-aligned tasks
                {
                    id: 'protein_focus',
                    text: 'Eat a high-protein snack (20g+ protein)',
                    category: 'nutrition',
                    icon: 'ü•©',
                    xp: 25,
                    priority: 'medium',
                    estimatedTime: '5 min',
                    conditions: (p, s, h) => p.fitnessGoal === 'build_muscle' && (s.protein || 0) < 50,
                    aiReasoning: 'Your muscle-building goal requires consistent protein intake throughout the day.'
                },
                // Time-sensitive tasks
                {
                    id: 'morning_hydration',
                    text: 'Drink 2 glasses of water to rehydrate',
                    category: 'hydration',
                    icon: 'üíß',
                    xp: 15,
                    priority: 'high',
                    estimatedTime: '2 min',
                    conditions: (p, s, h) => h < 10 && s.waterGlasses < 2,
                    aiReasoning: 'Morning hydration kickstarts your metabolism and helps with nutrient absorption.'
                },
                // Stress-based tasks
                {
                    id: 'stress_relief',
                    text: 'Practice 5 minutes of deep breathing',
                    category: 'wellness',
                    icon: 'üå¨Ô∏è',
                    xp: 20,
                    priority: 'medium',
                    estimatedTime: '5 min',
                    conditions: (p, s, h) => s.focusMinutes > 120 && s.workouts === 0,
                    aiReasoning: 'High focus time without physical activity may increase stress. Breathing helps reset.'
                },
                // Weekend-specific tasks
                {
                    id: 'weekend_meal_prep',
                    text: 'Prepare healthy meals for the upcoming week',
                    category: 'nutrition',
                    icon: 'ü•ò',
                    xp: 50,
                    priority: 'medium',
                    estimatedTime: '45 min',
                    conditions: (p, s, h, d) => d === 0 || d === 6, // Sunday or Saturday
                    aiReasoning: 'Weekend meal prep sets you up for healthy eating success during busy weekdays.'
                },
                // Recovery tasks
                {
                    id: 'active_recovery',
                    text: 'Do gentle stretching or yoga',
                    category: 'wellness',
                    icon: 'üßò‚Äç‚ôÄÔ∏è',
                    xp: 30,
                    priority: 'low',
                    estimatedTime: '15 min',
                    conditions: (p, s, h) => s.workouts > 1,
                    aiReasoning: 'Multiple workouts today indicate high activity. Recovery is essential for progress.'
                },
                // Social tasks
                {
                    id: 'social_connection',
                    text: 'Connect with a friend or family member',
                    category: 'wellness',
                    icon: 'üí¨',
                    xp: 25,
                    priority: 'low',
                    estimatedTime: '10 min',
                    conditions: (p, s, h, d) => d === 5 || d === 6, // Friday or Saturday
                    aiReasoning: 'Social connections are vital for mental health. Weekends are perfect for reaching out.'
                },
                // Learning tasks
                {
                    id: 'skill_development',
                    text: 'Learn something new about nutrition or fitness',
                    category: 'personal',
                    icon: 'üìö',
                    xp: 35,
                    priority: 'low',
                    estimatedTime: '20 min',
                    conditions: (p, s, h) => s.focusMinutes < 60,
                    aiReasoning: 'Investing in health knowledge compounds over time. Perfect for low-focus days.'
                }
            ];
            
            // Filter tasks based on conditions and add AI reasoning
            taskTemplates.forEach(template => {
                if (template.conditions(profile, stats, hour, dayOfWeek)) {
                    tasks.push({
                        ...template,
                        id: template.id + '_' + Date.now()
                    });
                }
            });
            
            // Add context-specific reasoning
            tasks.forEach(task => {
                // Add time-based context
                if (hour < 12) {
                    task.aiReasoning += ' Perfect timing for your morning routine.';
                } else if (hour < 17) {
                    task.aiReasoning += ' Ideal for your afternoon energy management.';
                } else {
                    task.aiReasoning += ' Great way to unwind in the evening.';
                }
                
                // Add progress context
                const completedTasks = gameState.tasks.filter(t => t.completed && 
                    new Date(t.completedAt).toDateString() === new Date().toDateString()).length;
                
                if (completedTasks === 0) {
                    task.aiReasoning += ' Starting with this task will build momentum for the day.';
                } else if (completedTasks > 3) {
                    task.aiReasoning += ' You\'re on a roll! This will maintain your productive streak.';
                }
            });
            
            // Ensure we have at least 3 tasks
            if (tasks.length < 3) {
                const fallbackTasks = [
                    {
                        id: 'fallback_water_' + Date.now(),
                        text: 'Drink a glass of water',
                        category: 'hydration',
                        icon: 'üíß',
                        xp: 10,
                        priority: 'medium',
                        estimatedTime: '1 min',
                        aiReasoning: 'Hydration is fundamental to all body functions. A simple but powerful habit.'
                    },
                    {
                        id: 'fallback_movement_' + Date.now(),
                        text: 'Do 20 bodyweight squats',
                        category: 'fitness',
                        icon: 'üí™',
                        xp: 15,
                        priority: 'medium',
                        estimatedTime: '2 min',
                        aiReasoning: 'Quick movement breaks improve circulation and energy levels.'
                    },
                    {
                        id: 'fallback_mindfulness_' + Date.now(),
                        text: 'Take 10 deep breaths mindfully',
                        category: 'wellness',
                        icon: 'üßò‚Äç‚ôÇÔ∏è',
                        xp: 15,
                        priority: 'medium',
                        estimatedTime: '3 min',
                        aiReasoning: 'Mindful breathing reduces stress and increases present-moment awareness.'
                    }
                ];
                
                tasks.push(...fallbackTasks.slice(0, 3 - tasks.length));
            }
            
            return tasks.slice(0, 4); // Return top 4 AI-generated tasks
        }
        
        function getDayPeriod(hour) {
            if (hour < 6) return 'Late Night';
            if (hour < 12) return 'Morning';
            if (hour < 17) return 'Afternoon';
            if (hour < 21) return 'Evening';
            return 'Night';
        }
        
        function getDayOfWeekName(day) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[day];
        }
        
        function getEnergyLevel(stats, hour) {
            let energy = 'Medium';
            
            if (stats.sleepHours >= 7 && stats.waterGlasses >= 4) energy = 'High';
            else if (stats.sleepHours < 6 || stats.waterGlasses < 2) energy = 'Low';
            
            // Adjust for time of day
            if (hour >= 14 && hour <= 16 && energy !== 'High') energy = 'Low'; // Afternoon dip
            if (hour >= 20) energy = 'Low'; // Evening wind-down
            
            return energy;
        }
        
        function getProgressStatus(stats) {
            const goals = [
                stats.steps >= 8000,
                stats.waterGlasses >= 6,
                stats.focusMinutes >= 60,
                stats.workouts >= 1
            ];
            
            const completed = goals.filter(g => g).length;
            if (completed >= 3) return 'Excellent';
            if (completed >= 2) return 'Good';
            if (completed >= 1) return 'Fair';
            return 'Starting';
        }
        
        function adoptAITask(text, category, xp, icon) {
            // Add to tasks with AI origin marker
            const task = {
                id: Date.now() + Math.random(),
                text: text,
                category: category,
                xp: xp,
                completed: false,
                icon: icon,
                aiGenerated: true,
                createdAt: new Date().toISOString()
            };
            
            gameState.tasks.push(task);
            updateTasksList();
            saveGameState();
            
            awardXP(10, 'Adopted AI task suggestion!');
            showFloatingNotification('üß† AI Task Added!', 'Smart choice! This task is optimized for your current state.');
            
            // Close the modal
            document.querySelector('.fixed')?.remove();
        }
        
        function modifyAITask(taskId) {
            showFloatingNotification('‚úèÔ∏è Coming Soon!', 'AI task customization will be available in the next update.');
        }

        // üß† Enhanced AI Coach with Pattern Recognition
        function generateSmartInsights() {
            const insights = [];
            const stats = gameState.dailyStats;
            const profile = gameState.profile;
            
            // Advanced pattern recognition
            if (stats.steps > 8000 && stats.focusMinutes > 60) {
                insights.push({
                    type: 'positive',
                    icon: 'üåü',
                    title: 'Peak Performance Day!',
                    message: 'Your combination of movement and focus is creating optimal productivity.',
                    action: 'Keep this balanced approach for sustained energy!'
                });
            }
            
            if (stats.waterGlasses < 4 && stats.focusMinutes < 30) {
                insights.push({
                    type: 'warning',
                    icon: '‚ö†Ô∏è',
                    title: 'Hydration & Focus Alert',
                    message: 'Low water intake may be affecting your concentration.',
                    action: 'Try drinking a glass of water before your next focus session.'
                });
            }
            
            if (stats.sleepHours > 7 && stats.workouts > 0) {
                insights.push({
                    type: 'positive',
                    icon: 'üí™',
                    title: 'Recovery Champion',
                    message: 'Great sleep + exercise = optimal recovery and growth.',
                    action: 'Your body is building strength while you rest!'
                });
            }
            
            // Advanced AI insights
            if (stats.calories > 0 && stats.protein && (stats.protein / stats.calories) < 0.15) {
                insights.push({
                    type: 'suggestion',
                    icon: 'ü•©',
                    title: 'Protein Optimization',
                    message: 'Your protein ratio could be higher for better muscle recovery.',
                    action: 'Consider adding a protein-rich snack or adjusting your next meal.'
                });
            }
            
            // Time-based insights
            const hour = new Date().getHours();
            if (hour >= 14 && hour <= 16 && stats.focusMinutes < 30) {
                insights.push({
                    type: 'suggestion',
                    icon: 'üß†',
                    title: 'Afternoon Focus Window',
                    message: 'This is a prime time for deep work before the afternoon dip.',
                    action: 'Consider a 25-minute Pomodoro session now.'
                });
            }
            
            return insights.length > 0 ? insights[0] : null;
        }

        function showAIInsights() {
            const insight = generateSmartInsights();
            const container = document.getElementById('aiInsights');
            
            if (insight) {
                const typeClasses = {
                    positive: 'bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800',
                    warning: 'bg-yellow-50 dark:bg-yellow-900/30 border-yellow-200 dark:border-yellow-800',
                    suggestion: 'bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800'
                };
                
                container.innerHTML = `
                    <div class="rounded-xl p-4 border ${typeClasses[insight.type]}">
                        <div class="flex items-start space-x-3">
                            <div class="text-2xl">${insight.icon}</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-900 dark:text-white mb-1">${insight.title}</h4>
                                <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">${insight.message}</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400 italic">${insight.action}</p>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">√ó</button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = '';
            }
        }

        // üìù TASK MANAGEMENT
        function generateDailyTasks() {
            const dailyTasks = [
                { text: "Drink 8 glasses of water", category: "hydration", xp: 40, icon: "üíß" },
                { text: "Take 8,000 steps", category: "fitness", xp: 50, icon: "üö∂‚Äç‚ôÇÔ∏è" },
                { text: "Eat 3 balanced meals", category: "nutrition", xp: 60, icon: "ü•ó" },
                { text: "Do a 30-minute workout", category: "fitness", xp: 100, icon: "üí™" },
                { text: "Focus work for 2+ hours", category: "personal", xp: 80, icon: "üß†" },
                { text: "Get 8 hours of sleep", category: "wellness", xp: 60, icon: "üò¥" },
                { text: "Practice meditation/mindfulness", category: "wellness", xp: 40, icon: "üßò‚Äç‚ôÄÔ∏è" },
                { text: "Read for 30 minutes", category: "personal", xp: 30, icon: "üìö" }
            ];

            // Add only new tasks (not already present)
            dailyTasks.forEach(task => {
                const exists = gameState.tasks.some(existingTask => existingTask.text === task.text);
                if (!exists) {
                    gameState.tasks.push({
                        id: Date.now() + Math.random(),
                        ...task,
                        completed: false,
                        createdAt: new Date().toISOString()
                    });
                }
            });

            updateTasksList();
            saveGameState();
        }

        function addCustomTask() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">‚ûï Add Custom Quest</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Quest Description</label>
                            <input type="text" id="taskText" placeholder="Enter your quest..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Category</label>
                                <select id="taskCategory" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    <option value="fitness">üèÉ‚Äç‚ôÇÔ∏è Fitness</option>
                                    <option value="nutrition">ü•ó Nutrition</option>
                                    <option value="wellness">üßò‚Äç‚ôÄÔ∏è Wellness</option>
                                    <option value="personal">üìö Personal</option>
                                    <option value="hydration">üíß Hydration</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">XP Reward</label>
                                <input type="number" id="taskXP" value="25" min="10" max="100" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="createCustomTask()" class="flex-1 bg-primary text-white py-3 rounded-lg hover:bg-purple-600">
                                Create Quest
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function createCustomTask() {
            const text = document.getElementById('taskText').value.trim();
            const category = document.getElementById('taskCategory').value;
            const xp = parseInt(document.getElementById('taskXP').value);

            if (!text) {
                showFloatingNotification('‚ùå Error', 'Please enter a quest description');
                return;
            }

            const categoryIcons = {
                fitness: 'üèÉ‚Äç‚ôÇÔ∏è',
                nutrition: 'ü•ó',
                wellness: 'üßò‚Äç‚ôÄÔ∏è',
                personal: 'üìö',
                hydration: 'üíß'
            };

            const task = {
                id: Date.now() + Math.random(),
                text: text,
                category: category,
                xp: xp,
                icon: categoryIcons[category],
                completed: false,
                createdAt: new Date().toISOString()
            };

            gameState.tasks.push(task);
            updateTasksList();
            saveGameState();

            // Close modal
            document.querySelector('.fixed').remove();
            showFloatingNotification('‚úÖ Quest Created!', `"${text}" added to your quests`);
        }

        function updateTasksList() {
            const container = document.getElementById('tasksList');
            const todayTasks = gameState.tasks.filter(task => {
                const taskDate = new Date(task.createdAt).toDateString();
                const today = new Date().toDateString();
                return taskDate === today;
            }).sort((a, b) => a.completed - b.completed);

            container.innerHTML = todayTasks.map(task => `
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg ${task.completed ? 'opacity-60' : ''}">
                    <div class="flex items-center space-x-3">
                        <button onclick="toggleTask('${task.id}')" class="text-2xl hover:scale-110 transition-transform">
                            ${task.completed ? '‚úÖ' : '‚¨ú'}
                        </button>
                        <div>
                            <div class="font-medium ${task.completed ? 'line-through' : ''}">${task.text}</div>
                            <div class="text-xs text-gray-500 capitalize flex items-center space-x-2">
                                <span>${task.icon} ${task.category}</span>
                                ${task.aiGenerated ? '<span class="bg-purple-100 dark:bg-purple-800 text-purple-600 dark:text-purple-300 px-2 py-0.5 rounded text-xs">üß† AI</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="text-sm font-bold text-primary">+${task.xp} XP</div>
                </div>
            `).join('');

            if (todayTasks.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No quests yet! Add some tasks to get started.</div>';
            }
        }

        function toggleTask(taskId) {
            const task = gameState.tasks.find(t => t.id == taskId);
            if (task) {
                task.completed = !task.completed;
                if (task.completed) {
                    task.completedAt = new Date().toISOString();
                    awardXP(task.xp, `Completed: ${task.text}`);
                    
                    // Add achievement for AI tasks
                    if (task.aiGenerated) {
                        addAchievement('üß† AI Trainee', 'Completed your first AI-generated task!', 50);
                    }
                    
                    checkForStreaks();
                }
                updateTasksList();
                updateAllUI();
                saveGameState();
            }
        }

        // üèÜ XP AND LEVELING SYSTEM
        function awardXP(amount, reason) {
            gameState.xp += amount;
            gameState.totalXP += amount;
            
            // Check for level up
            const xpForNextLevel = gameState.level * 100;
            if (gameState.xp >= xpForNextLevel) {
                levelUp();
            }
            
            updateXPDisplay();
            showXPAnimation(amount, reason);
            saveGameState();
        }

        function levelUp() {
            const oldLevel = gameState.level;
            gameState.level++;
            gameState.xp = gameState.xp - (oldLevel * 100);
            
            // Add level up achievement
            addAchievement(`üéâ Level ${gameState.level}!`, `Reached level ${gameState.level}`, gameState.level * 50);
            
            updateXPDisplay();
            showFloatingNotification('üéâ LEVEL UP!', `Welcome to Level ${gameState.level}!`);
            
            // Add level up animation
            const levelElement = document.getElementById('playerLevel');
            levelElement.classList.add('level-up');
            setTimeout(() => levelElement.classList.remove('level-up'), 1000);
        }

        function updateXPDisplay() {
            const xpForNextLevel = gameState.level * 100;
            const progress = (gameState.xp / xpForNextLevel) * 100;
            
            document.getElementById('playerLevel').textContent = `Level ${gameState.level}`;
            document.getElementById('currentXP').textContent = gameState.xp;
            document.getElementById('nextLevelXP').textContent = xpForNextLevel;
            document.getElementById('xpProgress').style.width = `${progress}%`;
        }

        function showXPAnimation(amount, reason) {
            const container = document.createElement('div');
            container.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 xp-burst pointer-events-none';
            container.innerHTML = `
                <div class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-full font-bold shadow-lg">
                    +${amount} XP
                </div>
                <div class="text-center text-sm text-gray-600 dark:text-gray-400 mt-1">${reason}</div>
            `;
            document.body.appendChild(container);
            
            setTimeout(() => container.remove(), 2000);
        }

        // üìä STATS TRACKING
        function trackWater() {
            gameState.dailyStats.waterGlasses++;
            updateAllUI();
            saveGameState();
            awardXP(5, 'Stayed hydrated! üíß');
            
            if (gameState.dailyStats.waterGlasses >= 8) {
                addAchievement('üíß Hydration Hero', 'Drank 8+ glasses of water today!', 25);
            }
        }

        function logMeal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">ü•ó Log Meal</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Calories</label>
                            <input type="number" id="mealCalories" placeholder="Enter calories..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-2">Protein (g)</label>
                                <input type="number" id="mealProtein" placeholder="0" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Carbs (g)</label>
                                <input type="number" id="mealCarbs" placeholder="0" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Fat (g)</label>
                                <input type="number" id="mealFat" placeholder="0" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="saveMeal()" class="flex-1 bg-nutrition text-white py-3 rounded-lg hover:bg-green-600">
                                Log Meal
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveMeal() {
            const calories = parseInt(document.getElementById('mealCalories').value) || 0;
            const protein = parseInt(document.getElementById('mealProtein').value) || 0;
            const carbs = parseInt(document.getElementById('mealCarbs').value) || 0;
            const fat = parseInt(document.getElementById('mealFat').value) || 0;

            if (calories > 0) {
                gameState.dailyStats.calories += calories;
                gameState.dailyStats.protein = (gameState.dailyStats.protein || 0) + protein;
                gameState.dailyStats.carbs = (gameState.dailyStats.carbs || 0) + carbs;
                gameState.dailyStats.fat = (gameState.dailyStats.fat || 0) + fat;
                gameState.dailyStats.meals++;

                updateAllUI();
                saveGameState();
                awardXP(15, 'Meal logged! ü•ó');

                // Close modal
                document.querySelector('.fixed').remove();
                showFloatingNotification('ü•ó Meal Logged!', `${calories} calories added`);
            }
        }

        function logWorkout() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üí™ Log Workout</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Workout Type</label>
                            <select id="workoutType" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <option value="cardio">üèÉ‚Äç‚ôÇÔ∏è Cardio</option>
                                <option value="strength">üí™ Strength Training</option>
                                <option value="yoga">üßò‚Äç‚ôÄÔ∏è Yoga</option>
                                <option value="sports">‚öΩ Sports</option>
                                <option value="other">üèãÔ∏è‚Äç‚ôÇÔ∏è Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Duration (minutes)</label>
                            <input type="number" id="workoutDuration" placeholder="30" min="5" max="300" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Estimated Calories Burned</label>
                            <input type="number" id="workoutCalories" placeholder="200" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="saveWorkout()" class="flex-1 bg-fitness text-white py-3 rounded-lg hover:bg-red-600">
                                Log Workout
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveWorkout() {
            const duration = parseInt(document.getElementById('workoutDuration').value) || 0;
            const calories = parseInt(document.getElementById('workoutCalories').value) || 0;
            const type = document.getElementById('workoutType').value;

            if (duration > 0) {
                gameState.dailyStats.workouts++;
                gameState.dailyStats.caloriesBurned += calories;

                updateAllUI();
                saveGameState();
                awardXP(duration * 2, `${type} workout completed! üí™`);

                if (gameState.dailyStats.workouts >= 1) {
                    addAchievement('üí™ Workout Warrior', 'Completed a workout today!', 30);
                }

                // Close modal
                document.querySelector('.fixed').remove();
                showFloatingNotification('üí™ Workout Logged!', `${duration} minutes of ${type}`);
            }
        }

        function logSteps() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üö∂‚Äç‚ôÇÔ∏è Log Steps</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Steps Count</label>
                            <input type="number" id="stepsInput" placeholder="Enter step count..." min="100" max="50000" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            üí° Tip: Use your phone's health app or fitness tracker
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="saveSteps()" class="flex-1 bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600">
                                Log Steps
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveSteps() {
            const steps = parseInt(document.getElementById('stepsInput').value) || 0;

            if (steps > 0) {
                gameState.dailyStats.steps = steps;
                updateAllUI();
                saveGameState();
                awardXP(Math.floor(steps / 100), `${steps.toLocaleString()} steps logged! üö∂‚Äç‚ôÇÔ∏è`);

                if (steps >= 8000) {
                    addAchievement('üö∂‚Äç‚ôÇÔ∏è Step Master', 'Walked 8,000+ steps today!', 40);
                }

                // Close modal
                document.querySelector('.fixed').remove();
                showFloatingNotification('üö∂‚Äç‚ôÇÔ∏è Steps Logged!', `${steps.toLocaleString()} steps added`);
            }
        }

        function logSleep() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üò¥ Log Sleep</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Hours of Sleep</label>
                            <input type="number" id="sleepHours" placeholder="8" min="1" max="12" step="0.5" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            üí° Log your sleep from last night
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="saveSleep()" class="flex-1 bg-wellness text-white py-3 rounded-lg hover:bg-purple-600">
                                Log Sleep
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveSleep() {
            const hours = parseFloat(document.getElementById('sleepHours').value) || 0;

            if (hours > 0) {
                gameState.dailyStats.sleepHours = hours;
                updateAllUI();
                saveGameState();
                awardXP(hours * 10, `${hours} hours of sleep logged! üò¥`);

                if (hours >= 8) {
                    addAchievement('üò¥ Sleep Champion', 'Got 8+ hours of quality sleep!', 35);
                }

                // Close modal
                document.querySelector('.fixed').remove();
                showFloatingNotification('üò¥ Sleep Logged!', `${hours} hours of rest`);
            }
        }

        // üçÖ POMODORO TIMER
        function startPomodoro() {
            let timeLeft = 25 * 60; // 25 minutes in seconds
            let isRunning = false;
            let interval = null;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-center">üçÖ Pomodoro Timer</h3>
                    <div class="text-center">
                        <div id="pomodoroTimer" class="text-6xl font-bold mb-6 text-focus">25:00</div>
                        <div id="pomodoroStatus" class="text-lg mb-6 text-gray-600 dark:text-gray-400">Ready to focus?</div>
                        <div class="flex space-x-3">
                            <button id="pomodoroStart" onclick="togglePomodoro()" class="flex-1 bg-focus text-white py-3 rounded-lg hover:bg-yellow-600">
                                ‚ñ∂Ô∏è Start
                            </button>
                            <button onclick="resetPomodoro()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                üîÑ Reset
                            </button>
                            <button onclick="this.closest('.fixed').remove(); if(interval) clearInterval(interval);" class="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600">
                                ‚ùå Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            function updateDisplay() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('pomodoroTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            window.togglePomodoro = function() {
                if (isRunning) {
                    // Pause
                    clearInterval(interval);
                    isRunning = false;
                    document.getElementById('pomodoroStart').innerHTML = '‚ñ∂Ô∏è Resume';
                    document.getElementById('pomodoroStatus').textContent = 'Paused';
                } else {
                    // Start/Resume
                    isRunning = true;
                    document.getElementById('pomodoroStart').innerHTML = '‚è∏Ô∏è Pause';
                    document.getElementById('pomodoroStatus').textContent = 'Focus time! üß†';
                    
                    interval = setInterval(() => {
                        timeLeft--;
                        updateDisplay();
                        
                        if (timeLeft <= 0) {
                            clearInterval(interval);
                            gameState.dailyStats.focusMinutes += 25;
                            updateAllUI();
                            saveGameState();
                            awardXP(50, 'Completed 25-minute focus session! üçÖ');
                            
                            // Show completion
                            document.getElementById('pomodoroStatus').textContent = 'üéâ Session Complete!';
                            document.getElementById('pomodoroStart').innerHTML = 'üéä Done!';
                            showFloatingNotification('üçÖ Pomodoro Complete!', '25 minutes of focused work!');
                        }
                    }, 1000);
                }
            };

            window.resetPomodoro = function() {
                clearInterval(interval);
                timeLeft = 25 * 60;
                isRunning = false;
                updateDisplay();
                document.getElementById('pomodoroStart').innerHTML = '‚ñ∂Ô∏è Start';
                document.getElementById('pomodoroStatus').textContent = 'Ready to focus?';
            };
        }

        // üèÜ ACHIEVEMENTS
        function addAchievement(title, description, xp) {
            const achievement = {
                id: Date.now(),
                title: title,
                description: description,
                xp: xp,
                unlockedAt: new Date().toISOString()
            };

            gameState.achievements.push(achievement);
            updateAchievementsList();
            saveGameState();
            
            showFloatingNotification('üèÜ Achievement Unlocked!', title);
            awardXP(xp, `Achievement: ${title}`);
        }

        function updateAchievementsList() {
            const container = document.getElementById('achievementsList');
            const recentAchievements = gameState.achievements
                .sort((a, b) => new Date(b.unlockedAt) - new Date(a.unlockedAt))
                .slice(0, 5);

            container.innerHTML = recentAchievements.map(achievement => `
                <div class="flex items-center space-x-3 p-3 bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/30 dark:to-orange-900/30 rounded-lg">
                    <div class="text-2xl">üèÜ</div>
                    <div class="flex-1">
                        <div class="font-bold">${achievement.title}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">${achievement.description}</div>
                    </div>
                    <div class="text-sm font-bold text-yellow-600">+${achievement.xp} XP</div>
                </div>
            `).join('');

            if (recentAchievements.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Complete tasks to unlock achievements!</div>';
            }
        }

        function checkForStreaks() {
            // This would be expanded with actual streak logic
            const completedToday = gameState.tasks.filter(t => t.completed && 
                new Date(t.completedAt).toDateString() === new Date().toDateString()).length;
            
            if (completedToday >= 5) {
                addAchievement('üî• Task Master', 'Completed 5+ tasks in one day!', 50);
            }
        }

        // üìä HABIT TRACKER
        function showHabitTracker() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center">üìä Habit Tracker</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Daily Goals Progress -->
                        <div>
                            <h4 class="font-bold mb-4">üéØ Today's Goals</h4>
                            <div class="space-y-3">
                                ${getHabitProgress().map(habit => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div class="flex items-center space-x-3">
                                            <div class="text-xl">${habit.icon}</div>
                                            <div>
                                                <div class="font-medium">${habit.name}</div>
                                                <div class="text-xs text-gray-500">${habit.current}/${habit.goal} ${habit.unit}</div>
                                            </div>
                                        </div>
                                        <div class="w-20 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                            <div class="bg-${habit.color} h-full rounded-full" style="width: ${Math.min(100, (habit.current/habit.goal)*100)}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Stats Summary -->
                        <div>
                            <h4 class="font-bold mb-4">üìà Quick Stats</h4>
                            <div class="space-y-3">
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-600">${gameState.level}</div>
                                    <div class="text-sm text-blue-500">Current Level</div>
                                </div>
                                <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600">${gameState.totalXP.toLocaleString()}</div>
                                    <div class="text-sm text-green-500">Total XP Earned</div>
                                </div>
                                <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/30 dark:to-pink-900/30 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-purple-600">${gameState.achievements.length}</div>
                                    <div class="text-sm text-purple-500">Achievements Unlocked</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-center mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function getHabitProgress() {
            return [
                {
                    name: 'Steps',
                    icon: 'üö∂‚Äç‚ôÇÔ∏è',
                    current: gameState.dailyStats.steps,
                    goal: 8000,
                    unit: 'steps',
                    color: 'orange-500'
                },
                {
                    name: 'Water',
                    icon: 'üíß',
                    current: gameState.dailyStats.waterGlasses,
                    goal: 8,
                    unit: 'glasses',
                    color: 'blue-500'
                },
                {
                    name: 'Focus',
                    icon: 'üß†',
                    current: gameState.dailyStats.focusMinutes,
                    goal: 120,
                    unit: 'minutes',
                    color: 'yellow-500'
                },
                {
                    name: 'Sleep',
                    icon: 'üò¥',
                    current: gameState.dailyStats.sleepHours,
                    goal: 8,
                    unit: 'hours',
                    color: 'purple-500'
                },
                {
                    name: 'Workouts',
                    icon: 'üí™',
                    current: gameState.dailyStats.workouts,
                    goal: 1,
                    unit: 'sessions',
                    color: 'red-500'
                }
            ];
        }

        // üë§ PROFILE MANAGEMENT
        function showProfile() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center">üë§ Player Profile</h3>
                    
                    <div class="space-y-4">
                        <div class="text-center mb-6">
                            <div class="text-4xl mb-2">üéÆ</div>
                            <div class="text-xl font-bold">Level ${gameState.level} Player</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">${gameState.totalXP.toLocaleString()} Total XP</div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Age</label>
                                <input type="number" id="profileAge" value="${gameState.profile.age || ''}" placeholder="25" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Weight (lbs)</label>
                                <input type="number" id="profileWeight" value="${gameState.profile.weight || ''}" placeholder="150" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Height (inches)</label>
                            <input type="number" id="profileHeight" value="${gameState.profile.height || ''}" placeholder="68" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Activity Level</label>
                            <select id="profileActivity" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <option value="sedentary" ${gameState.profile.activityLevel === 'sedentary' ? 'selected' : ''}>Sedentary (desk job)</option>
                                <option value="light" ${gameState.profile.activityLevel === 'light' ? 'selected' : ''}>Light activity</option>
                                <option value="moderate" ${gameState.profile.activityLevel === 'moderate' ? 'selected' : ''}>Moderate activity</option>
                                <option value="very" ${gameState.profile.activityLevel === 'very' ? 'selected' : ''}>Very active</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Fitness Goal</label>
                            <select id="profileGoal" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <option value="lose_weight" ${gameState.profile.fitnessGoal === 'lose_weight' ? 'selected' : ''}>Lose weight</option>
                                <option value="maintain" ${gameState.profile.fitnessGoal === 'maintain' ? 'selected' : ''}>Maintain weight</option>
                                <option value="gain_weight" ${gameState.profile.fitnessGoal === 'gain_weight' ? 'selected' : ''}>Gain weight</option>
                                <option value="build_muscle" ${gameState.profile.fitnessGoal === 'build_muscle' ? 'selected' : ''}>Build muscle</option>
                            </select>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="saveProfile()" class="flex-1 bg-primary text-white py-3 rounded-lg hover:bg-purple-600">
                                Save Profile
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveProfile() {
            const age = parseInt(document.getElementById('profileAge').value);
            const weight = parseInt(document.getElementById('profileWeight').value);
            const height = parseInt(document.getElementById('profileHeight').value);
            const activityLevel = document.getElementById('profileActivity').value;
            const fitnessGoal = document.getElementById('profileGoal').value;

            gameState.profile = {
                age: age || null,
                weight: weight || null,
                height: height || null,
                activityLevel: activityLevel,
                fitnessGoal: fitnessGoal,
                bmr: calculateBMR(age, weight, height, 'male') // Simplified, would need gender input
            };

            saveGameState();
            showFloatingNotification('‚úÖ Profile Saved!', 'Your health profile has been updated');
            
            // Close modal
            document.querySelector('.fixed').remove();
            
            // Update AI insights
            showAIInsights();
        }

        function calculateBMR(age, weight, height, gender) {
            if (!age || !weight || !height) return 1800; // Default
            
            // Mifflin-St Jeor Equation
            const bmr = (10 * (weight * 0.453592)) + (6.25 * (height * 2.54)) - (5 * age);
            return gender === 'male' ? bmr + 5 : bmr - 161;
        }

        // üöÄ UI UPDATES
        function updateAllUI() {
            updateStatsDisplay();
            updateXPDisplay();
            updateTasksList();
            updateAchievementsList();
            showAIInsights();
        }

        function updateStatsDisplay() {
            const stats = gameState.dailyStats;
            
            document.getElementById('stepsCount').textContent = stats.steps.toLocaleString();
            document.getElementById('waterCount').textContent = stats.waterGlasses;
            document.getElementById('caloriesCount').textContent = stats.calories.toLocaleString();
            document.getElementById('focusCount').textContent = stats.focusMinutes;
            document.getElementById('sleepCount').textContent = stats.sleepHours || 0;
            document.getElementById('workoutCount').textContent = stats.workouts;
            
            // Update macro display
            document.getElementById('proteinCount').textContent = `${stats.protein || 0}g`;
            document.getElementById('carbsCount').textContent = `${stats.carbs || 0}g`;
        }

        // üí´ NOTIFICATIONS
        function showFloatingNotification(title, message) {
            const notification = document.createElement('div');
            notification.className = 'floating-notification bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg border-l-4 border-primary max-w-sm';
            notification.innerHTML = `
                <div class="font-bold text-gray-900 dark:text-white">${title}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">${message}</div>
            `;
            
            document.getElementById('notificationsContainer').appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // üîî NOTIFICATION AND REMINDER SYSTEM
        
        function showNotificationSettings() {
            // Initialize defaults if needed
            if (!gameState.settings.reminderTimes) {
                gameState.settings.reminderTimes = {
                    water: ['09:00', '12:00', '15:00', '18:00'],
                    workout: ['07:00', '17:00'],
                    tasks: ['09:00', '14:00'],
                    sleep: ['22:00']
                };
            }
            
            // Get notification status
            const hasNotifications = 'Notification' in window;
            const notificationStatus = hasNotifications ? Notification.permission : 'Not supported';
            const canEnable = hasNotifications && Notification.permission !== 'granted';
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4">üîî Reminder Settings</h3>
                    
                    <div class="space-y-4">
                        <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">Browser Notifications</h4>
                            <div class="text-sm mb-3">
                                Status: <span class="font-mono">${notificationStatus}</span>
                                ${canEnable ? '<button onclick="requestNotificationPermission()" class="ml-2 bg-primary text-white px-3 py-1 rounded text-xs">Enable</button>' : ''}
                                ${notificationStatus === 'granted' ? '<span class="ml-2 text-green-600">‚úì Enabled</span>' : ''}
                            </div>
                        </div>
                        
                        <div>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="enableReminders" ${gameState.settings.reminders ? 'checked' : ''} onchange="toggleReminders()" class="rounded">
                                <span>Enable Smart Reminders</span>
                            </label>
                        </div>
                        
                        <div class="space-y-3">
                            <h4 class="font-bold">Reminder Schedule</h4>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">üíß Water Reminders</label>
                                <input type="text" id="waterTimes" value="${gameState.settings.reminderTimes.water.join(', ')}" placeholder="09:00, 12:00, 15:00, 18:00" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-sm">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">üí™ Workout Reminders</label>
                                <input type="text" id="workoutTimes" value="${gameState.settings.reminderTimes.workout.join(', ')}" placeholder="07:00, 17:00" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-sm">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">üìã Task Reminders</label>
                                <input type="text" id="taskTimes" value="${gameState.settings.reminderTimes.tasks.join(', ')}" placeholder="09:00, 14:00" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-sm">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">üò¥ Sleep Reminder</label>
                                <input type="text" id="sleepTimes" value="${gameState.settings.reminderTimes.sleep.join(', ')}" placeholder="22:00" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-sm">
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg">
                            <h4 class="font-bold mb-2 text-blue-700 dark:text-blue-300">üí° Reminder Features</h4>
                            <ul class="text-sm text-blue-600 dark:text-blue-400 space-y-1">
                                <li>‚Ä¢ Smart context-aware reminders</li>
                                <li>‚Ä¢ Automatic snooze for completed tasks</li>
                                <li>‚Ä¢ Progressive reminder intensity</li>
                                <li>‚Ä¢ Works entirely in your browser</li>
                            </ul>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="saveReminderSettings()" class="flex-1 bg-primary text-white py-2 rounded hover:bg-purple-600">
                                Save Settings
                            </button>
                            <button onclick="testReminder()" class="flex-1 bg-green-500 text-white py-2 rounded hover:bg-green-600">
                                Test Reminder
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(function(permission) {
                    gameState.settings.notificationPermission = permission;
                    saveGameState();
                    
                    if (permission === 'granted') {
                        showFloatingNotification('üîî Notifications Enabled', 'You will now receive smart reminders!');
                        startReminderSystem();
                    } else {
                        showFloatingNotification('‚ùå Notifications Blocked', 'Enable in browser settings to get reminders');
                    }
                    
                    // Refresh the modal
                    document.querySelector('.fixed').remove();
                    showNotificationSettings();
                });
            } else {
                showFloatingNotification('‚ùå Not Supported', 'Your browser doesn\'t support notifications');
            }
        }

        function toggleReminders() {
            gameState.settings.reminders = document.getElementById('enableReminders').checked;
            if (gameState.settings.reminders) {
                startReminderSystem();
            } else {
                stopReminderSystem();
            }
            saveGameState();
        }

        function saveReminderSettings() {
            gameState.settings.reminderTimes = {
                water: document.getElementById('waterTimes').value.split(',').map(t => t.trim()).filter(t => t),
                workout: document.getElementById('workoutTimes').value.split(',').map(t => t.trim()).filter(t => t),
                tasks: document.getElementById('taskTimes').value.split(',').map(t => t.trim()).filter(t => t),
                sleep: document.getElementById('sleepTimes').value.split(',').map(t => t.trim()).filter(t => t)
            };
            
            toggleReminders();
            saveGameState();
            
            document.querySelector('.fixed').remove();
            showFloatingNotification('üíæ Settings Saved', 'Reminder preferences updated');
            
            if (gameState.settings.reminders) {
                startReminderSystem();
            }
        }

        function testReminder() {
            sendSmartReminder('test');
            showFloatingNotification('üîî Test Sent!', 'Check if you received the test reminder');
        }

        function startReminderSystem() {
            if (!gameState.settings.reminders) return;
            
            // Clear existing timers
            if (window.reminderIntervals) {
                window.reminderIntervals.forEach(clearInterval);
            }
            window.reminderIntervals = [];

            // Check every minute for scheduled reminders
            const checkReminders = setInterval(() => {
                const now = new Date();
                const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                
                // Check each reminder type
                if (gameState.settings.reminderTimes) {
                    Object.entries(gameState.settings.reminderTimes).forEach(([type, times]) => {
                        if (times && times.includes(currentTime)) {
                            sendSmartReminder(type);
                        }
                    });
                }
            }, 60000);

            window.reminderIntervals.push(checkReminders);

            // Also set up smart contextual reminders
            const contextualCheck = setInterval(() => {
                checkContextualReminders();
            }, 15 * 60 * 1000); // Check every 15 minutes

            window.reminderIntervals.push(contextualCheck);
        }

        function stopReminderSystem() {
            if (window.reminderIntervals) {
                window.reminderIntervals.forEach(clearInterval);
                window.reminderIntervals = [];
            }
        }

        function sendSmartReminder(type) {
            const messages = {
                water: {
                    title: 'üíß Hydration Reminder',
                    body: `You've had ${gameState.dailyStats.waterGlasses} glasses today. Time for another!`,
                    action: () => trackWater()
                },
                workout: {
                    title: 'üí™ Movement Time',
                    body: 'Your body is ready for some activity. How about a quick workout?',
                    action: () => showQuickWorkoutEntry()
                },
                tasks: {
                    title: 'üìã Task Check-in',
                    body: `${getUncompletedTasksCount()} tasks remaining. You've got this!`,
                    action: () => generateAdvancedAITasks()
                },
                sleep: {
                    title: 'üò¥ Wind Down Time',
                    body: 'Consider starting your bedtime routine for optimal recovery.',
                    action: () => showSleepEntry()
                },
                test: {
                    title: 'üß™ Test Reminder',
                    body: 'This is a test reminder from Life Quest RPG!',
                    action: null
                }
            };

            const reminder = messages[type];
            if (!reminder) return;

            // Try browser notification first
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(reminder.title, {
                    body: reminder.body,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiM1RDVDREUiLz4KPHN2ZyB4PSIxNiIgeT0iMTYiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMlM2LjQ4IDIyIDEyIDIyUzIyIDE3LjUyIDIyIDEyUzE3LjUyIDIgMTIgMlpNMTMgMTdIMTFWMTVIMTNWMTdaTTEzIDEzSDExVjdIMTNWMTNaIi8+Cjwvc3ZnPgo8L3N2Zz4K',
                    tag: `lifequest-${type}`,
                    requireInteraction: false
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                    if (reminder.action) {
                        reminder.action();
                    }
                };

                // Auto close after 5 seconds
                setTimeout(() => notification.close(), 5000);
            }

            // Always show in-app notification as fallback
            showFloatingNotification(reminder.title, reminder.body);

            // Add to reminder log
            if (!gameState.reminderLog) gameState.reminderLog = [];
            gameState.reminderLog.push({
                type: type,
                timestamp: new Date().toISOString(),
                title: reminder.title,
                body: reminder.body
            });

            // Keep only last 50 reminders
            if (gameState.reminderLog.length > 50) {
                gameState.reminderLog = gameState.reminderLog.slice(-50);
            }

            saveGameState();
        }

        function checkContextualReminders() {
            if (!gameState.settings.reminders) return;

            const now = new Date();
            const hour = now.getHours();
            const stats = gameState.dailyStats;

            // Smart water reminder (if low and haven't reminded recently)
            if (stats.waterGlasses < 4 && hour > 10 && hour < 20) {
                const lastWaterReminder = gameState.reminderLog?.find(r => 
                    r.type === 'water' && 
                    new Date(r.timestamp).toDateString() === now.toDateString()
                );
                
                if (!lastWaterReminder || (now - new Date(lastWaterReminder.timestamp)) > 2 * 60 * 60 * 1000) {
                    sendSmartReminder('water');
                }
            }

            // Afternoon activity reminder
            if (hour === 15 && stats.steps < 5000 && stats.workouts === 0) {
                sendSmartReminder('workout');
            }

            // End of day task reminder
            if (hour === 20 && getUncompletedTasksCount() > 2) {
                sendSmartReminder('tasks');
            }
        }

        function getUncompletedTasksCount() {
            return gameState.tasks.filter(task => 
                !task.completed && 
                new Date(task.createdAt).toDateString() === new Date().toDateString()
            ).length;
        }

        // üì± APPLE HEALTH INTEGRATION
        
        // Apple Health Setup and Auto-Sync
        function showAppleHealthSetup() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center">üì± Apple Health Auto-Sync Setup</h3>
                    
                    <!-- Step 1: Install Shortcuts -->
                    <div class="space-y-6">
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-3 flex items-center">
                                <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3">1</span>
                                Install iOS Shortcuts
                            </h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                Tap the links below to install pre-built shortcuts that will automatically sync your Apple Health data:
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <button onclick="copyShortcutURL('steps')" class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 p-3 rounded-lg text-left hover:bg-gray-50 dark:hover:bg-gray-600">
                                    <div class="font-medium text-blue-600">üö∂‚Äç‚ôÇÔ∏è Steps Sync</div>
                                    <div class="text-xs text-gray-500">Daily step count</div>
                                </button>
                                <button onclick="copyShortcutURL('workout')" class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 p-3 rounded-lg text-left hover:bg-gray-50 dark:hover:bg-gray-600">
                                    <div class="font-medium text-red-600">üí™ Workout Sync</div>
                                    <div class="text-xs text-gray-500">Exercise sessions</div>
                                </button>
                                <button onclick="copyShortcutURL('sleep')" class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 p-3 rounded-lg text-left hover:bg-gray-50 dark:hover:bg-gray-600">
                                    <div class="font-medium text-purple-600">üò¥ Sleep Sync</div>
                                    <div class="text-xs text-gray-500">Sleep duration</div>
                                </button>
                                <button onclick="copyShortcutURL('heart')" class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 p-3 rounded-lg text-left hover:bg-gray-50 dark:hover:bg-gray-600">
                                    <div class="font-medium text-pink-600">‚ù§Ô∏è Heart Rate</div>
                                    <div class="text-xs text-gray-500">Average HR</div>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 2: Setup Automation -->
                        <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-3 flex items-center">
                                <span class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3">2</span>
                                Setup Automation
                            </h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                Create automations to run these shortcuts automatically:
                            </p>
                            <ul class="text-sm space-y-2 text-gray-600 dark:text-gray-400">
                                <li class="flex items-center">
                                    <span class="text-green-500 mr-2">‚úì</span>
                                    Open Shortcuts app ‚Üí Automation tab ‚Üí Create Personal Automation
                                </li>
                                <li class="flex items-center">
                                    <span class="text-green-500 mr-2">‚úì</span>
                                    Choose "Time of Day" trigger for daily sync (e.g., 9 AM)
                                </li>
                                <li class="flex items-center">
                                    <span class="text-green-500 mr-2">‚úì</span>
                                    Add your installed health sync shortcuts
                                </li>
                                <li class="flex items-center">
                                    <span class="text-green-500 mr-2">‚úì</span>
                                    Turn off "Ask Before Running" for automatic sync
                                </li>
                            </ul>
                        </div>
                        
                        <!-- Step 3: Manual Sync -->
                        <div class="bg-orange-50 dark:bg-orange-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-3 flex items-center">
                                <span class="bg-orange-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3">3</span>
                                Manual Sync Option
                            </h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                You can also manually sync anytime using Siri or the Shortcuts app:
                            </p>
                            <div class="bg-white dark:bg-gray-700 p-3 rounded border text-center">
                                <span class="text-lg">üó£Ô∏è</span>
                                <div class="font-mono text-sm text-blue-600 dark:text-blue-400">"Hey Siri, sync my health data"</div>
                            </div>
                        </div>
                        
                        <!-- Step 4: Verify Setup -->
                        <div class="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-3 flex items-center">
                                <span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3">4</span>
                                Test Your Setup
                            </h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                Run one of your shortcuts manually to test the connection:
                            </p>
                            <button onclick="testHealthSync()" class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600">
                                üß™ Test Sync Connection
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-center mt-6 space-x-3">
                        <button onclick="showShortcutInstructions()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            üìã View Detailed Instructions
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function copyShortcutURL(type) {
            const appURL = window.location.href.split('?')[0];
            
            // Generate direct import URLs using Apple's shortcuts://x-callback-url scheme
            const shortcutURLs = {
                steps: `shortcuts://x-callback-url/import-shortcut/?url=${encodeURIComponent('https://www.icloud.com/shortcuts/lifequestSteps')}&name=LifeQuest%20Steps`,
                workout: `shortcuts://x-callback-url/import-shortcut/?url=${encodeURIComponent('https://www.icloud.com/shortcuts/lifequestWorkout')}&name=LifeQuest%20Workout`,
                sleep: `shortcuts://x-callback-url/import-shortcut/?url=${encodeURIComponent('https://www.icloud.com/shortcuts/lifequestSleep')}&name=LifeQuest%20Sleep`,
                heart: `shortcuts://x-callback-url/import-shortcut/?url=${encodeURIComponent('https://www.icloud.com/shortcuts/lifequestHeart')}&name=LifeQuest%20Heart`
            };
            
            // Show simple 3-step process
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-center">üì± Add ${type.charAt(0).toUpperCase() + type.slice(1)} Sync</h3>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-3">‚ú® Super Easy Setup</h4>
                            <ol class="list-decimal list-inside space-y-2 text-sm">
                                <li>Copy the shortcut URL below</li>
                                <li>Paste it in Safari and tap Go</li>
                                <li>Allow health data access when prompted</li>
                            </ol>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">
                                <div class="text-xs text-gray-500 mb-2">üìã Quick Setup Template:</div>
                                <div class="text-sm bg-white dark:bg-gray-800 p-3 rounded border">
                                    <pre class="whitespace-pre-wrap text-xs">${getSimpleShortcutCode(type, appURL)}</pre>
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg">
                                <div class="text-xs text-blue-600 dark:text-blue-400 mb-2">üîó Copy this URL for step 3:</div>
                                <div class="font-mono text-xs bg-white dark:bg-gray-800 p-2 rounded border break-all select-all">
                                    ${getShortcutURL(type, appURL)}
                                </div>
                                <button onclick="copyToClipboard('${getShortcutURL(type, appURL)}')" class="mt-2 text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                                    üìã Copy URL
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="copyShortcutCode(\`${getSimpleShortcutCode(type, appURL)}\`)" class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                                üìã Copy Template
                            </button>
                            <button onclick="window.open('shortcuts://', '_blank')" class="flex-1 bg-green-500 text-white py-2 rounded hover:bg-green-600">
                                üöÄ Open Shortcuts App
                            </button>
                        </div>
                        
                        <div class="bg-yellow-50 dark:bg-yellow-900/30 p-3 rounded-lg">
                            <div class="text-xs text-yellow-600 dark:text-yellow-400">
                                üí° After installation, run the shortcut manually once to test, then set up daily automation in the Shortcuts app.
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-center mt-4">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function getSimpleShortcutCode(type, appURL) {
            // Return the actual steps with correct iOS Shortcuts terminology
            const instructions = {
                steps: `1. Open Shortcuts app ‚Üí + (top right)
2. Search "Get Health Sample" ‚Üí Add it
3. Tap "Health Sample Type" ‚Üí select "Steps"
4. Tap "Time Period" ‚Üí select "Today"
5. Search "Open URLs" ‚Üí Add it
6. In URL field, paste: ${appURL}?steps=
7. Tap after "steps=" ‚Üí Insert Variable ‚Üí "Health Sample"
8. Tap "Done" ‚Üí Name it "LifeQuest Steps"`,
                workout: `1. Open Shortcuts app ‚Üí + (top right)
2. Search "Find Health Samples" ‚Üí Add it
3. Set "Sample Type" to "Workouts"
4. Set "Time Period" to "Today"
5. Search "Get Numbers from Input" ‚Üí Add it
6. Set "Get" to "Count"
7. Search "Open URLs" ‚Üí Add it
8. In URL field, paste: ${appURL}?workouts=
9. Tap after "workouts=" ‚Üí Insert Variable ‚Üí "Count"
10. Tap "Done" ‚Üí Name it "LifeQuest Workouts"`,
                sleep: `1. Open Shortcuts app ‚Üí + (top right)
2. Search "Get Health Sample" ‚Üí Add it
3. Tap "Health Sample Type" ‚Üí select "Sleep Analysis"
4. Set "Time Period" to "Last Night"
5. Search "Open URLs" ‚Üí Add it
6. In URL field, paste: ${appURL}?sleep=
7. Tap after "sleep=" ‚Üí Insert Variable ‚Üí "Health Sample"
8. Tap "Done" ‚Üí Name it "LifeQuest Sleep"`,
                heart: `1. Open Shortcuts app ‚Üí + (top right)
2. Search "Get Health Sample" ‚Üí Add it
3. Set "Health Sample Type" to "Heart Rate"
4. Set "Time Period" to "Today"
5. Search "Calculate Statistics" ‚Üí Add it
6. Set "Operation" to "Average"
7. Search "Open URLs" ‚Üí Add it
8. In URL field, paste: ${appURL}?heartrate=
9. Tap after "heartrate=" ‚Üí Insert Variable ‚Üí "Average"
10. Tap "Done" ‚Üí Name it "LifeQuest Heart Rate"`
            };
            return instructions[type];
        }
        
        function getShortcutURL(type, appURL) {
            // Use a custom URL scheme for PWA if available, otherwise fallback to web URL
            const baseURL = appURL.replace('https://', '').replace('http://', '');
            
            const urls = {
                steps: `${appURL}?pwa=1&steps=[Health Sample Value]`,
                workout: `${appURL}?pwa=1&workouts=[Count]`,
                sleep: `${appURL}?pwa=1&sleep=[Health Sample Value]`,
                heart: `${appURL}?pwa=1&heartrate=[Average]`
            };
            return urls[type];
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showFloatingNotification('üìã Copied!', 'URL copied to clipboard');
            }).catch(() => {
                showFloatingNotification('‚ùå Copy Failed', 'Please copy manually');
            });
        }
        
        function copyShortcutCode(url) {
            navigator.clipboard.writeText(url).then(() => {
                showFloatingNotification('üìã Copied!', 'Template copied to clipboard');
            }).catch(() => {
                showFloatingNotification('‚ùå Copy Failed', 'Please copy manually');
            });
        }
        
        function openShortcutDirect(type, appURL) {
            const url = getSimpleShortcutCode(type, appURL);
            window.open(url, '_blank');
            showFloatingNotification('üöÄ Opening Shortcuts...', 'Check your Shortcuts app');
        }
        
        function generateStepsShortcut(appURL) {
            return {
                "WFWorkflowActions": [
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.health.quantity.get",
                        "WFWorkflowActionParameters": {
                            "WFHealthQuantityType": "StepCount",
                            "WFHealthQuantityPeriod": "Today"
                        }
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.url",
                        "WFWorkflowActionParameters": {
                            "WFURLActionURL": `${appURL}#health-data`
                        }
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.urlencode",
                        "WFWorkflowActionParameters": {
                            "WFInput": "steps=[Steps]"
                        }
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.url.expand",
                        "WFWorkflowActionParameters": {}
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.url.openweb"
                    }
                ],
                "WFWorkflowName": "LifeQuest Steps Sync",
                "WFWorkflowIcon": {
                    "WFWorkflowIconImageData": "",
                    "WFWorkflowIconGlyphNumber": 61440
                }
            };
        }
        
        function generateWorkoutShortcut(appURL) {
            return {
                "WFWorkflowActions": [
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.health.workout.get",
                        "WFWorkflowActionParameters": {
                            "WFHealthWorkoutReadType": "Today"
                        }
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.count",
                        "WFWorkflowActionParameters": {}
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.url",
                        "WFWorkflowActionParameters": {
                            "WFURLActionURL": `${appURL}#health-data`
                        }
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.urlencode",
                        "WFWorkflowActionParameters": {
                            "WFInput": "workouts=[Count]"
                        }
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.url.expand"
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.url.openweb"
                    }
                ],
                "WFWorkflowName": "LifeQuest Workout Sync",
                "WFWorkflowIcon": {
                    "WFWorkflowIconImageData": "",
                    "WFWorkflowIconGlyphNumber": 59390
                }
            };
        }
        
        function generateSleepShortcut(appURL) {
            return {
                "WFWorkflowActions": [
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.health.quantity.get",
                        "WFWorkflowActionParameters": {
                            "WFHealthQuantityType": "SleepAnalysis",
                            "WFHealthQuantityPeriod": "Last Night"
                        }
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.url",
                        "WFWorkflowActionParameters": {
                            "WFURLActionURL": `${appURL}#health-data`
                        }
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.urlencode",
                        "WFWorkflowActionParameters": {
                            "WFInput": "sleep=[Sleep Duration]"
                        }
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.url.expand"
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.url.openweb"
                    }
                ],
                "WFWorkflowName": "LifeQuest Sleep Sync",
                "WFWorkflowIcon": {
                    "WFWorkflowIconImageData": "",
                    "WFWorkflowIconGlyphNumber": 59297
                }
            };
        }
        
        function generateHeartRateShortcut(appURL) {
            return {
                "WFWorkflowActions": [
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.health.quantity.get",
                        "WFWorkflowActionParameters": {
                            "WFHealthQuantityType": "HeartRate",
                            "WFHealthQuantityPeriod": "Today"
                        }
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.statistics",
                        "WFWorkflowActionParameters": {
                            "WFStatisticsOperation": "Average"
                        }
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.url",
                        "WFWorkflowActionParameters": {
                            "WFURLActionURL": `${appURL}#health-data`
                        }
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.urlencode",
                        "WFWorkflowActionParameters": {
                            "WFInput": "heartrate=[Average]"
                        }
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.url.expand"
                    },
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.url.openweb"
                    }
                ],
                "WFWorkflowName": "LifeQuest Heart Rate Sync",
                "WFWorkflowIcon": {
                    "WFWorkflowIconImageData": "",
                    "WFWorkflowIconGlyphNumber": 59392
                }
            };
        }
        
        function showShortcutInstructions() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center">üìã Simple Setup Instructions</h3>
                    
                    <div class="space-y-6 text-sm">
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-3">üì± Creating Shortcuts (4-5 steps each)</h4>
                            <div class="space-y-4">
                                <div class="bg-white dark:bg-gray-700 p-3 rounded">
                                    <h5 class="font-bold text-blue-600 mb-2">üö∂‚Äç‚ôÇÔ∏è Steps Shortcut:</h5>
                                    <ol class="list-decimal list-inside space-y-1 text-gray-600 dark:text-gray-400">
                                        <li>Open Shortcuts app ‚Üí + New Shortcut</li>
                                        <li>Add "Get My Health" action ‚Üí choose "Step Count" ‚Üí "Today"</li>
                                        <li>Add "Open Web Page" action ‚Üí URL: <code class="bg-gray-200 dark:bg-gray-600 px-1 rounded">${window.location.href.split('?')[0]}?steps=[Health Sample Value]</code></li>
                                        <li>Name it "LifeQuest Steps" and save</li>
                                    </ol>
                                </div>
                                
                                <div class="bg-white dark:bg-gray-700 p-3 rounded">
                                    <h5 class="font-bold text-purple-600 mb-2">üò¥ Sleep Shortcut:</h5>
                                    <ol class="list-decimal list-inside space-y-1 text-gray-600 dark:text-gray-400">
                                        <li>Open Shortcuts app ‚Üí + New Shortcut</li>
                                        <li>Add "Get My Health" action ‚Üí choose "Sleep Analysis" ‚Üí "Last Night"</li>
                                        <li>Add "Open Web Page" action ‚Üí URL: <code class="bg-gray-200 dark:bg-gray-600 px-1 rounded">${window.location.href.split('?')[0]}?sleep=[Health Sample Value]</code></li>
                                        <li>Name it "LifeQuest Sleep" and save</li>
                                    </ol>
                                </div>
                                
                                <div class="bg-white dark:bg-gray-700 p-3 rounded">
                                    <h5 class="font-bold text-red-600 mb-2">üí™ Workout Shortcut:</h5>
                                    <ol class="list-decimal list-inside space-y-1 text-gray-600 dark:text-gray-400">
                                        <li>Open Shortcuts app ‚Üí + New Shortcut</li>
                                        <li>Add "Find My Workouts" action ‚Üí "Today"</li>
                                        <li>Add "Get Count of Items" action</li>
                                        <li>Add "Open Web Page" action ‚Üí URL: <code class="bg-gray-200 dark:bg-gray-600 px-1 rounded">${window.location.href.split('?')[0]}?workouts=[Count]</code></li>
                                        <li>Name it "LifeQuest Workouts" and save</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-3">‚è∞ Setting Up Automation (Optional)</h4>
                            <ol class="list-decimal list-inside space-y-2 text-gray-600 dark:text-gray-400">
                                <li>Open Shortcuts app ‚Üí "Automation" tab ‚Üí "+" button</li>
                                <li>Choose "Personal Automation" ‚Üí "Time of Day"</li>
                                <li>Set daily sync time (e.g., 9 AM) ‚Üí "Next"</li>
                                <li>Add your health sync shortcuts ‚Üí Turn OFF "Ask Before Running"</li>
                                <li>Tap "Done" to save</li>
                            </ol>
                        </div>
                        
                        <div class="bg-orange-50 dark:bg-orange-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-3">üîß Quick Tips</h4>
                            <ul class="list-disc list-inside space-y-1 text-gray-600 dark:text-gray-400">
                                <li><strong>Test first:</strong> Run each shortcut manually to verify it works</li>
                                <li><strong>Health permissions:</strong> Allow access when prompted</li>
                                <li><strong>URL variables:</strong> The [Health Sample Value] and [Count] parts are automatic - don't change them</li>
                                <li><strong>Manual sync:</strong> Just run the shortcuts anytime to sync data</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="flex justify-center mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Got it!
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function importHealthData() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-6 text-center">üì• Import Health Data</h3>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">üì± From iOS Shortcuts</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                Run any of your configured shortcuts to automatically import today's data.
                            </p>
                            <button onclick="simulateShortcutSync()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                                üîÑ Run Shortcuts Now
                            </button>
                        </div>
                        
                        <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">üìã Manual Entry</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                Manually enter your health data from Apple Health app.
                            </p>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="quickImportSteps()" class="bg-orange-500 text-white py-2 rounded text-sm hover:bg-orange-600">
                                    üö∂‚Äç‚ôÇÔ∏è Steps
                                </button>
                                <button onclick="quickImportSleep()" class="bg-purple-500 text-white py-2 rounded text-sm hover:bg-purple-600">
                                    üò¥ Sleep
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-orange-50 dark:bg-orange-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">üìä Health Export</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                Import from Apple Health data export file.
                            </p>
                            <input type="file" id="healthFile" accept=".xml,.csv,.json" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-sm">
                            <button onclick="parseHealthFile()" class="w-full mt-2 bg-orange-500 text-white py-2 rounded text-sm hover:bg-orange-600">
                                üìÅ Parse File
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-center mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function showHealthStatus() {
            const lastSync = window.localStorage?.getItem('lastHealthSync') || 'Never';
            const syncCount = window.localStorage?.getItem('healthSyncCount') || '0';
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-6 text-center">üìä Health Sync Status</h3>
                    
                    <div class="space-y-4">
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-bold mb-3">üìà Sync Statistics</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Last Sync:</span>
                                    <span class="font-mono">${lastSync}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Total Syncs:</span>
                                    <span class="font-mono">${syncCount}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Current Steps:</span>
                                    <span class="font-mono">${gameState.dailyStats.steps.toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Current Sleep:</span>
                                    <span class="font-mono">${gameState.dailyStats.sleepHours}h</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Current Workouts:</span>
                                    <span class="font-mono">${gameState.dailyStats.workouts}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">üîÑ Sync Health</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                Manually trigger a health data sync now.
                            </p>
                            <button onclick="triggerHealthSync()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                                Sync Now
                            </button>
                        </div>
                        
                        <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">‚öôÔ∏è Sync Settings</h4>
                            <div class="space-y-2 text-sm">
                                <label class="flex items-center">
                                    <input type="checkbox" id="autoSync" class="mr-2">
                                    Enable automatic sync
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="syncNotifications" class="mr-2">
                                    Show sync notifications
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-center mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function testHealthSync() {
            // Simulate a health data sync test
            showFloatingNotification('üß™ Testing Sync...', 'Checking connection to Apple Health');
            
            setTimeout(() => {
                const testData = {
                    steps: Math.floor(Math.random() * 10000) + 5000,
                    sleep: Math.floor(Math.random() * 3) + 7,
                    workouts: Math.floor(Math.random() * 2),
                    heartRate: Math.floor(Math.random() * 40) + 60
                };
                
                processHealthData(testData);
                showFloatingNotification('‚úÖ Test Successful!', 'Sample health data imported successfully');
            }, 2000);
        }
        
        function simulateShortcutSync() {
            showFloatingNotification('üîÑ Running Shortcuts...', 'Syncing your Apple Health data');
            
            // Simulate shortcut delay
            setTimeout(() => {
                const healthData = {
                    steps: Math.floor(Math.random() * 15000) + 8000,
                    sleep: Math.floor(Math.random() * 2) + 7.5,
                    workouts: Math.floor(Math.random() * 3) + 1,
                    calories: Math.floor(Math.random() * 500) + 200
                };
                
                processHealthData(healthData);
                updateSyncStats();
            }, 1500);
        }
        
        function quickImportSteps() {
            const steps = window.prompt('Enter your step count from Apple Health:');
            if (steps && !isNaN(steps)) {
                gameState.dailyStats.steps = parseInt(steps);
                updateAllUI();
                saveGameState();
                awardXP(Math.floor(steps / 100), 'Apple Health steps imported! üì±');
                showFloatingNotification('üö∂‚Äç‚ôÇÔ∏è Steps Updated!', `${parseInt(steps).toLocaleString()} steps imported`);
                document.querySelector('.fixed')?.remove();
            }
        }
        
        function quickImportSleep() {
            const sleep = window.prompt('Enter your sleep hours from Apple Health:');
            if (sleep && !isNaN(sleep)) {
                gameState.dailyStats.sleepHours = parseFloat(sleep);
                updateAllUI();
                saveGameState();
                awardXP(parseFloat(sleep) * 10, 'Apple Health sleep imported! üì±');
                showFloatingNotification('üò¥ Sleep Updated!', `${parseFloat(sleep)} hours imported`);
                document.querySelector('.fixed')?.remove();
            }
        }
        
        function parseHealthFile() {
            const fileInput = document.getElementById('healthFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showFloatingNotification('‚ùå No File', 'Please select a health export file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Simple parsing for demo - in real app would parse XML/CSV properly
                    const content = e.target.result;
                    
                    // Extract basic health metrics using regex (simplified)
                    const steps = content.match(/step.*?(\d+)/i);
                    const sleep = content.match(/sleep.*?(\d+\.?\d*)/i);
                    
                    const healthData = {};
                    if (steps) healthData.steps = parseInt(steps[1]);
                    if (sleep) healthData.sleep = parseFloat(sleep[1]);
                    
                    processHealthData(healthData);
                    showFloatingNotification('üìÅ File Imported!', 'Health data extracted successfully');
                    document.querySelector('.fixed')?.remove();
                } catch (error) {
                    showFloatingNotification('‚ùå Parse Error', 'Unable to parse health file');
                }
            };
            
            reader.readAsText(file);
        }
        
        function triggerHealthSync() {
            showFloatingNotification('üîÑ Syncing...', 'Fetching latest Apple Health data');
            
            // In a real app, this would trigger the iOS shortcuts
            // For demo, we'll simulate the sync
            setTimeout(() => {
                simulateShortcutSync();
            }, 1000);
        }
        
        function processHealthData(data) {
            // Process incoming health data and update game state
            let xpAwarded = 0;
            let updates = [];
            
            // Always update with health data (it's the authoritative source)
            if (data.steps && data.steps > 0) {
                const oldSteps = gameState.dailyStats.steps;
                gameState.dailyStats.steps = data.steps;
                
                // Only award XP if steps increased
                if (data.steps > oldSteps) {
                    xpAwarded += Math.floor((data.steps - oldSteps) / 100);
                }
                
                updates.push(`${data.steps.toLocaleString()} steps`);
                
                if (data.steps >= 8000) {
                    addAchievement('üì± Apple Health Step Master', 'Reached 8,000+ steps via Apple Health sync!', 50);
                }
            }
            
            if (data.sleep && data.sleep > 0) {
                const oldSleep = gameState.dailyStats.sleepHours;
                gameState.dailyStats.sleepHours = data.sleep;
                
                // Only award XP if sleep increased
                if (data.sleep > oldSleep) {
                    xpAwarded += (data.sleep - oldSleep) * 10;
                }
                
                updates.push(`${data.sleep}h sleep`);
                
                if (data.sleep >= 8) {
                    addAchievement('üì± Apple Health Sleep Champion', 'Logged 8+ hours sleep via Apple Health!', 40);
                }
            }
            
            if (data.workouts && data.workouts >= 0) {
                const oldWorkouts = gameState.dailyStats.workouts;
                gameState.dailyStats.workouts = data.workouts;
                
                // Only award XP if workouts increased
                if (data.workouts > oldWorkouts) {
                    xpAwarded += (data.workouts - oldWorkouts) * 50;
                }
                
                updates.push(`${data.workouts} workouts`);
            }
            
            if (data.calories && data.calories > 0) {
                gameState.dailyStats.caloriesBurned += data.calories;
                xpAwarded += data.calories;
                updates.push(`${data.calories} calories burned`);
            }
            
            if (data.heartRate && data.heartRate > 0) {
                // Store heart rate data (could be used for AI insights)
                gameState.dailyStats.avgHeartRate = data.heartRate;
                updates.push(`${data.heartRate} avg HR`);
            }
            
            // Always update UI and show notification when health data is received
            updateAllUI();
            saveGameState();
            
            if (xpAwarded > 0) {
                awardXP(xpAwarded, 'Apple Health progress! üì±');
            }
            
            showFloatingNotification('üì± Health Synced!', updates.join(', '));
            
            // Award achievement for first Apple Health sync
            if (!gameState.achievements.find(a => a.title.includes('Apple Health'))) {
                addAchievement('üì± Apple Health Connected', 'Successfully synced Apple Health data!', 100);
            }
        }
        
        function updateSyncStats() {
            // Update sync statistics
            try {
                const now = new Date().toLocaleString();
                const currentCount = parseInt(window.localStorage?.getItem('healthSyncCount') || '0');
                
                if (window.localStorage) {
                    window.localStorage.setItem('lastHealthSync', now);
                    window.localStorage.setItem('healthSyncCount', (currentCount + 1).toString());
                }
            } catch (error) {
                // Handle storage not available
                console.log('Storage not available for sync stats');
            }
        }
        
        // Function to check and process URL parameters
        function checkForHealthData() {
            const urlParams = new URLSearchParams(window.location.search);
            const healthData = {};
            
            if (urlParams.get('steps')) healthData.steps = parseInt(urlParams.get('steps'));
            if (urlParams.get('sleep')) healthData.sleep = parseFloat(urlParams.get('sleep'));
            if (urlParams.get('workouts')) healthData.workouts = parseInt(urlParams.get('workouts'));
            if (urlParams.get('heartrate')) healthData.heartRate = parseInt(urlParams.get('heartrate'));
            if (urlParams.get('calories')) healthData.calories = parseInt(urlParams.get('calories'));
            
            if (Object.keys(healthData).length > 0) {
                console.log('üì± Processing health data from URL:', healthData);
                
                // Show debug panel BEFORE processing data
                tryRedirectToPWA();
                
                // Then process the health data
                processHealthData(healthData);
                updateSyncStats();
                
                // Clean URL to avoid reprocessing (delay this)
                setTimeout(() => {
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }, 3000); // Wait 3 seconds before cleaning URL
                
                return true;
            }
            return false;
        }
        
        // Check if running in PWA vs Safari and attempt to bridge data
        function tryRedirectToPWA() {
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                         window.navigator.standalone === true ||
                         document.referrer.includes('android-app://');
            
            const isPWAParam = new URLSearchParams(window.location.search).get('pwa');
            const hasHealthData = window.location.search.includes('steps=') || 
                                 window.location.search.includes('sleep=') || 
                                 window.location.search.includes('workouts=');
            
            // Show visible debug info if health data detected
            if (hasHealthData || isPWAParam) {
                showVisibleDebugInfo({
                    isPWA, 
                    isPWAParam, 
                    hasHealthData,
                    displayMode: window.matchMedia('(display-mode: standalone)').matches,
                    standalone: window.navigator.standalone,
                    referrer: document.referrer,
                    url: window.location.href
                });
            }
            
            // Show bridge notification if:
            // 1. Has health data AND pwa=1 parameter, OR
            // 2. Has health data and NOT in PWA mode
            if ((hasHealthData && isPWAParam === '1') || (hasHealthData && !isPWA)) {
                showPWABridgeNotification();
            } else if (hasHealthData) {
                // Show a different notification if already in PWA
                showFloatingNotification('üì± Health Data Received', 'Data synced successfully in PWA mode');
            }
        }
        
        function showVisibleDebugInfo(debugData) {
            const debugPanel = document.createElement('div');
            debugPanel.className = 'fixed bottom-4 left-4 right-4 bg-gray-900 text-white p-4 rounded-lg shadow-lg z-50 text-xs';
            debugPanel.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="font-bold">üîç PWA Debug Info</div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:bg-gray-700 px-2 py-1 rounded">‚úï</button>
                </div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div>Is PWA: <span class="font-mono ${debugData.isPWA ? 'text-green-400' : 'text-red-400'}">${debugData.isPWA}</span></div>
                    <div>PWA Param: <span class="font-mono ${debugData.isPWAParam ? 'text-blue-400' : 'text-gray-400'}">${debugData.isPWAParam || 'null'}</span></div>
                    <div>Has Health Data: <span class="font-mono ${debugData.hasHealthData ? 'text-green-400' : 'text-red-400'}">${debugData.hasHealthData}</span></div>
                    <div>Display Mode: <span class="font-mono ${debugData.displayMode ? 'text-green-400' : 'text-red-400'}">${debugData.displayMode}</span></div>
                    <div>Standalone: <span class="font-mono ${debugData.standalone ? 'text-green-400' : 'text-red-400'}">${debugData.standalone}</span></div>
                    <div>Bridge Trigger: <span class="font-mono ${(debugData.hasHealthData && debugData.isPWAParam === '1') || (debugData.hasHealthData && !debugData.isPWA) ? 'text-green-400' : 'text-red-400'}">${(debugData.hasHealthData && debugData.isPWAParam === '1') || (debugData.hasHealthData && !debugData.isPWA)}</span></div>
                </div>
                <div class="mt-2 text-xs text-gray-400">
                    URL: ${debugData.url}
                </div>
                <div class="mt-2 flex space-x-2">
                    <button onclick="testBridgeNotification()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                        üß™ Test Bridge
                    </button>
                    <button onclick="simulateHealthData()" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                        üì± Add Health Data
                    </button>
                </div>
            `;
            document.body.appendChild(debugPanel);
            
            // Auto-remove after 15 seconds
            setTimeout(() => {
                if (debugPanel.parentElement) {
                    debugPanel.remove();
                }
            }, 15000);
        }
        
        function testBridgeNotification() {
            showPWABridgeNotification();
            showFloatingNotification('üß™ Test Triggered', 'Bridge notification should appear now');
        }
        
        function simulateHealthData() {
            // Add health data to URL and reload
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('steps', '12345');
            currentUrl.searchParams.set('pwa', '1');
            window.location.href = currentUrl.toString();
        }
        
        function showPWABridgeNotification() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 left-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üì±</span>
                        <div>
                            <div class="font-bold">Health Data Synced!</div>
                            <div class="text-sm opacity-90">Switch back to your Life Quest PWA to see updated progress</div>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:bg-blue-700 p-1 rounded">
                        ‚úï
                    </button>
                </div>
                <div class="mt-3 flex space-x-3">
                    <button onclick="tryOpenPWA()" class="bg-white text-blue-600 px-4 py-2 rounded font-medium hover:bg-gray-100">
                        üöÄ Open PWA
                    </button>
                    <button onclick="copyPWAInstructions()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700">
                        üìã Copy Instructions
                    </button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }
        
        function tryOpenPWA() {
            // Store the health data in a way that the PWA can access it
            const healthData = extractHealthDataFromURL();
            if (healthData) {
                // Store in localStorage with a timestamp
                const bridgeData = {
                    ...healthData,
                    timestamp: Date.now(),
                    source: 'ios-shortcut'
                };
                localStorage.setItem('lifequest_bridge_data', JSON.stringify(bridgeData));
            }
            
            // Get current URL components for PWA schemes
            const currentURL = new URL(window.location.href);
            const domain = currentURL.hostname;
            const path = currentURL.pathname;
            
            // Method 1: Direct PWA webapp:// scheme (iOS native PWA opener)
            const webappScheme = `webapp://${domain}${path}`;
            
            // Method 2: Alternative PWA schemes to try
            const pwaSchemes = [
                webappScheme,
                `pwa://${domain}${path}`,
                `web+app://${domain}${path}`
            ];
            
            // Method 3: Custom shortcuts-based schemes
            const shortcutSchemes = [
                'shortcuts://run-shortcut?name=Life%20Quest%20RPG',
                'lifequest-rpg://',
                'lifequestapp://'
            ];
            
            // Combine all schemes to try
            const allSchemes = [...pwaSchemes, ...shortcutSchemes];
            
            let attemptedSchemes = 0;
            let success = false;
            
            function tryNextMethod() {
                if (attemptedSchemes < allSchemes.length && !success) {
                    const scheme = allSchemes[attemptedSchemes];
                    attemptedSchemes++;
                    
                    console.log(`üöÄ Attempting to open PWA with: ${scheme}`);
                    
                    // Create a hidden iframe to test the scheme
                    const testFrame = document.createElement('iframe');
                    testFrame.style.display = 'none';
                    testFrame.src = scheme;
                    document.body.appendChild(testFrame);
                    
                    // Try direct navigation as backup
                    const timeout = setTimeout(() => {
                        if (!success) {
                            try {
                                window.location.href = scheme;
                            } catch (e) {
                                console.log(`Failed to open: ${scheme}`, e);
                            }
                            // Clean up and try next method
                            testFrame.remove();
                            tryNextMethod();
                        }
                    }, 2000);
                    
                    // Listen for successful navigation away from page
                    window.addEventListener('beforeunload', () => {
                        success = true;
                        clearTimeout(timeout);
                        testFrame.remove();
                        showFloatingNotification('üöÄ Opening PWA...', 'Switching to your installed app');
                    }, { once: true });
                    
                } else if (!success) {
                    // All methods failed, show manual instructions
                    console.log('üîÑ All PWA opening methods failed, showing manual instructions');
                    showPWAInstructions();
                }
            }
            
            // Show immediate feedback
            showFloatingNotification('üöÄ Opening PWA...', 'Attempting to open your installed app');
            
            // Start trying schemes
            tryNextMethod();
        }
        
        function extractHealthDataFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const data = {};
            
            if (urlParams.get('steps')) data.steps = parseInt(urlParams.get('steps'));
            if (urlParams.get('sleep')) data.sleep = parseFloat(urlParams.get('sleep'));
            if (urlParams.get('workouts')) data.workouts = parseInt(urlParams.get('workouts'));
            if (urlParams.get('heartrate')) data.heartRate = parseInt(urlParams.get('heartrate'));
            if (urlParams.get('calories')) data.calories = parseInt(urlParams.get('calories'));
            
            return Object.keys(data).length > 0 ? data : null;
        }
        
        function showPWAInstructions() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-center">üì± Switch to Your PWA</h3>
                    
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">üè†</div>
                        <div class="text-lg font-bold mb-2">Your health data is ready!</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Stored safely for your PWA to access</div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">‚úÖ Quick Steps:</h4>
                            <ol class="list-decimal list-inside space-y-1 text-sm text-gray-600 dark:text-gray-400">
                                <li>Press the <strong>Home button</strong> or swipe up</li>
                                <li>Find your <strong>Life Quest RPG</strong> app icon</li>
                                <li>Tap to open your PWA</li>
                                <li>Your health data will appear automatically!</li>
                            </ol>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">üîç Can't find the app?</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                Look for the app icon that looks different from Safari - it should have no browser UI when opened.
                            </p>
                        </div>
                        
                        <div class="bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">‚ö° Data Stored:</h4>
                            <div class="text-sm space-y-1">
                                ${getStoredDataSummary()}
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-primary text-white py-3 rounded-lg">
                            Got it! üëç
                        </button>
                        <button onclick="copyPWAData()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg">
                            üìã Copy Data
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function getStoredDataSummary() {
            const data = extractHealthDataFromURL();
            if (!data) return '<div class="text-gray-500">No health data found</div>';
            
            const summary = [];
            if (data.steps) summary.push(`<div>üö∂‚Äç‚ôÇÔ∏è ${data.steps.toLocaleString()} steps</div>`);
            if (data.sleep) summary.push(`<div>üò¥ ${data.sleep}h sleep</div>`);
            if (data.workouts) summary.push(`<div>üí™ ${data.workouts} workouts</div>`);
            if (data.heartRate) summary.push(`<div>‚ù§Ô∏è ${data.heartRate} avg HR</div>`);
            if (data.calories) summary.push(`<div>üî• ${data.calories} calories</div>`);
            
            return summary.join('');
        }
        
        function copyPWAData() {
            const data = extractHealthDataFromURL();
            const text = `Health Data from iOS Shortcut:\n${JSON.stringify(data, null, 2)}`;
            
            navigator.clipboard.writeText(text).then(() => {
                showFloatingNotification('üìã Copied!', 'Health data copied to clipboard');
            });
        }
        
        function copyPWAInstructions() {
            const instructions = `üì± HEALTH DATA SYNCED!

Your Life Quest RPG progress has been updated with:
${JSON.stringify(getLastSyncData(), null, 2)}

To see your updated progress:
1. Go to your home screen
2. Open the Life Quest RPG app icon
3. Your new health data will be there!

Note: Keep using your PWA app (home screen icon) for the best experience.`;
            
            navigator.clipboard.writeText(instructions).then(() => {
                showFloatingNotification('üìã Copied!', 'Instructions copied to clipboard');
            });
        }
        
        function getLastSyncData() {
            return {
                steps: gameState.dailyStats.steps,
                sleep: gameState.dailyStats.sleepHours,
                workouts: gameState.dailyStats.workouts,
                syncTime: new Date().toLocaleString()
            };
        }

        // Listen for health data from iOS shortcuts
        window.addEventListener('load', () => {
            initializeApp();
            checkForHealthData();
        });

        // Also check when the page gets focus (when switching back from shortcuts)
        window.addEventListener('focus', () => {
            console.log('üì± Page focused, checking for health data...');
            checkForHealthData();
        });

        // Listen for URL changes (in case the URL updates without reload)
        window.addEventListener('popstate', () => {
            console.log('üì± URL changed, checking for health data...');
            checkForHealthData();
        });

        // Also check periodically for URL changes (fallback)
        setInterval(() => {
            if (window.location.search) {
                checkForHealthData();
            }
        }, 2000);

        // üß≠ TAB NAVIGATION
        function switchTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active state from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active state to clicked button
            event.target.classList.add('active');
            
            // Update content based on tab
            switch(tabName) {
                case 'tasks':
                    updateTasksListDetailed();
                    updateAchievementsListDetailed();
                    break;
                case 'health':
                    updateHealthProgress();
                    break;
                case 'settings':
                    updateSettingsStats();
                    break;
            }
        }

        function updateTasksListDetailed() {
            const container = document.getElementById('tasksListDetailed');
            if (!container) return;
            
            const todayTasks = gameState.tasks.filter(task => {
                const taskDate = new Date(task.createdAt).toDateString();
                const today = new Date().toDateString();
                return taskDate === today;
            }).sort((a, b) => a.completed - b.completed);

            container.innerHTML = todayTasks.map(task => `
                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg ${task.completed ? 'opacity-60' : ''}">
                    <div class="flex items-center space-x-3">
                        <button onclick="toggleTask('${task.id}')" class="text-3xl hover:scale-110 transition-transform">
                            ${task.completed ? '‚úÖ' : '‚¨ú'}
                        </button>
                        <div>
                            <div class="font-medium ${task.completed ? 'line-through' : ''}">${task.text}</div>
                            <div class="text-sm text-gray-500 capitalize flex items-center space-x-2">
                                <span>${task.icon} ${task.category}</span>
                                ${task.aiGenerated ? '<span class="bg-purple-100 dark:bg-purple-800 text-purple-600 dark:text-purple-300 px-2 py-0.5 rounded text-xs">üß† AI</span>' : ''}
                                ${task.completed ? `<span class="text-xs text-green-600">Completed ${new Date(task.completedAt).toLocaleTimeString()}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-primary">+${task.xp} XP</div>
                        ${task.completed ? '<div class="text-xs text-green-600">‚úì Earned</div>' : ''}
                    </div>
                </div>
            `).join('');

            if (todayTasks.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12">No quests yet! Add some tasks to get started.</div>';
            }
        }

        function updateAchievementsListDetailed() {
            const container = document.getElementById('achievementsListDetailed');
            if (!container) return;
            
            const allAchievements = gameState.achievements
                .sort((a, b) => new Date(b.unlockedAt) - new Date(a.unlockedAt));

            container.innerHTML = allAchievements.map(achievement => `
                <div class="flex items-center space-x-4 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/30 dark:to-orange-900/30 rounded-lg border border-yellow-200 dark:border-yellow-800">
                    <div class="text-3xl">üèÜ</div>
                    <div class="flex-1">
                        <div class="font-bold text-yellow-800 dark:text-yellow-200">${achievement.title}</div>
                        <div class="text-sm text-yellow-700 dark:text-yellow-300">${achievement.description}</div>
                        <div class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">
                            Unlocked ${new Date(achievement.unlockedAt).toLocaleDateString()} at ${new Date(achievement.unlockedAt).toLocaleTimeString()}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold text-yellow-600">+${achievement.xp}</div>
                        <div class="text-xs text-yellow-500">XP</div>
                    </div>
                </div>
            `).join('');

            if (allAchievements.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12">Complete tasks to unlock achievements!</div>';
            }
        }

        function updateHealthProgress() {
            const container = document.getElementById('healthProgressContainer');
            if (!container) return;
            
            const habits = getHabitProgress();
            
            container.innerHTML = habits.map(habit => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="text-xl">${habit.icon}</div>
                        <div>
                            <div class="font-medium">${habit.name}</div>
                            <div class="text-xs text-gray-500">${habit.current}/${habit.goal} ${habit.unit}</div>
                        </div>
                    </div>
                    <div class="w-24 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                        <div class="bg-${habit.color} h-full rounded-full" style="width: ${Math.min(100, (habit.current/habit.goal)*100)}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function updateSettingsStats() {
            // Update stats in settings tab
            const elements = {
                'settingsLevel': gameState.level,
                'settingsTotalXP': gameState.totalXP.toLocaleString(),
                'settingsAchievements': gameState.achievements.length,
                'settingsTasks': gameState.tasks.length
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
        }

        // üöÄ START THE APPLICATION
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
