<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quest Tracker Pro - Complete Wellness Platform</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="AI-powered personal wellness optimization platform with health tracking">
    <meta name="theme-color" content="#5D5CDE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Quest Tracker">
    
    <!-- Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèÜ</text></svg>">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%235D5CDE' rx='20'/><text x='96' y='140' font-size='120' text-anchor='middle' fill='white'>üèÜ</text></svg>">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    
    <!-- Dark Mode Detection Script -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#E7E7FF'
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'celebration': 'celebration 0.8s ease-in-out'
                    },
                    keyframes: {
                        celebration: {
                            '0%': { transform: 'scale(1) rotate(0deg)' },
                            '50%': { transform: 'scale(1.2) rotate(5deg)' },
                            '100%': { transform: 'scale(1) rotate(0deg)' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- Service Worker Manager Class -->
    <script>
        class ServiceWorkerManager {
            constructor() {
                this.swRegistration = null;
                this.isOnline = navigator.onLine;
                this.init();
            }

            async init() {
                if ('serviceWorker' in navigator) {
                    try {
                        this.swRegistration = await navigator.serviceWorker.register('./service-worker.js');
                        console.log('ServiceWorker registered:', this.swRegistration);
                        
                        this.setupMessageListener();
                        this.setupNetworkListeners();
                        await this.requestNotificationPermission();
                        
                    } catch (error) {
                        console.error('ServiceWorker registration failed:', error);
                    }
                }
            }

            setupMessageListener() {
                navigator.serviceWorker.addEventListener('message', (event) => {
                    console.log('Message from SW:', event.data);
                    
                    switch (event.data.type) {
                        case 'HEALTH_DATA_RECEIVED':
                            this.handleHealthDataReceived(event.data.data);
                            break;
                        case 'QUEST_PROGRESS_UPDATED':
                            this.handleQuestProgressUpdated(event.data.data);
                            break;
                        case 'BACKGROUND_SYNC_COMPLETE':
                            this.handleSyncComplete(event.data.data);
                            break;
                        case 'NETWORK_STATUS_CHANGE':
                            this.handleNetworkStatusChange(event.data.data);
                            break;
                    }
                });
            }

            setupNetworkListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.showNotification('Back Online', 'Connection restored!');
                    this.updateConnectionStatus(true);
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showNotification('Offline', 'Working in offline mode');
                    this.updateConnectionStatus(false);
                });
            }

            updateConnectionStatus(isOnline) {
                const statusElement = document.getElementById('connection-status');
                if (statusElement) {
                    statusElement.className = isOnline 
                        ? 'text-green-600 dark:text-green-400' 
                        : 'text-red-600 dark:text-red-400';
                    statusElement.textContent = isOnline ? 'Online' : 'Offline';
                }
            }

            async requestNotificationPermission() {
                if ('Notification' in window) {
                    const permission = await Notification.requestPermission();
                    console.log('Notification permission:', permission);
                    
                    const notifStatus = document.getElementById('notification-status');
                    if (notifStatus) {
                        notifStatus.textContent = permission === 'granted' ? 'Enabled' : 'Disabled';
                        notifStatus.className = permission === 'granted' 
                            ? 'text-green-600 dark:text-green-400' 
                            : 'text-red-600 dark:text-red-400';
                    }
                }
            }

            sendMessage(type, data) {
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type, data });
                }
            }

            saveStepsData(stepsData) {
                this.sendMessage('SAVE_STEPS_DATA', stepsData);
            }

            saveHealthData(healthData) {
                this.sendMessage('SAVE_HEALTH_DATA', healthData);
            }

            saveQuestData(questData) {
                this.sendMessage('SAVE_QUEST_DATA', questData);
            }

            async getData(type) {
                return new Promise((resolve) => {
                    const messageChannel = new MessageChannel();
                    messageChannel.port1.onmessage = (event) => {
                        resolve(event.data.data);
                    };
                    
                    navigator.serviceWorker.controller.postMessage(
                        { type: `GET_${type.toUpperCase()}_DATA` },
                        [messageChannel.port2]
                    );
                });
            }

            requestSync(tag) {
                this.sendMessage('SYNC_REQUEST', { tag });
            }

            scheduleNotification(title, body, delay = 1000, tag = 'reminder') {
                this.sendMessage('SCHEDULE_NOTIFICATION', {
                    notification: { title, body, delay, tag }
                });
            }

            updateQuestProgress() {
                this.sendMessage('UPDATE_QUEST_PROGRESS');
            }

            handleHealthDataReceived(data) {
                console.log('Health data received:', data);
                
                document.dispatchEvent(new CustomEvent('healthDataReceived', {
                    detail: data
                }));

                this.showNotification('Health Data Synced', 'Step data has been updated!');
            }

            handleQuestProgressUpdated(data) {
                console.log('Quest progress updated:', data);
                
                document.dispatchEvent(new CustomEvent('questProgressUpdated', {
                    detail: data
                }));

                if (data.totalStepsToday > 0) {
                    this.showNotification('Steps Tracked!', `${data.totalStepsToday} steps recorded today`);
                }
            }

            handleSyncComplete(data) {
                console.log('Sync completed:', data);
                
                document.dispatchEvent(new CustomEvent('syncComplete', {
                    detail: data
                }));
            }

            handleNetworkStatusChange(data) {
                this.isOnline = data.isOnline;
                
                document.dispatchEvent(new CustomEvent('networkStatusChange', {
                    detail: data
                }));
            }

            showNotification(title, body) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(title, {
                        body: body,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üèÜ</text></svg>',
                        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üèÜ</text></svg>',
                        tag: 'quest-tracker'
                    });
                }
            }
        }

        // Health Data Integration Manager
        class HealthDataManager {
            constructor(swManager) {
                this.swManager = swManager;
                this.stepsSensors = [];
                this.isTracking = false;
                this.stepCount = 0;
                this.init();
            }

            async init() {
                await this.initializeHealthKitIntegration();
                await this.initializeGenericApis();
                this.setupDataSyncTimer();
            }

            async initializeHealthKitIntegration() {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                
                if (isIOS) {
                    console.log('iOS detected, attempting HealthKit integration');
                    
                    try {
                        if ('DeviceMotionEvent' in window) {
                            await this.requestMotionPermission();
                        }
                        
                        if ('Accelerometer' in window) {
                            await this.initializeAccelerometer();
                        }
                        
                        this.setupIOSDataSharing();
                        
                    } catch (error) {
                        console.log('HealthKit integration not available:', error);
                    }
                }
            }

            async requestMotionPermission() {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    const permission = await DeviceMotionEvent.requestPermission();
                    if (permission === 'granted') {
                        console.log('Motion permission granted');
                        this.initializeMotionTracking();
                        this.updateTrackingStatus(true);
                    }
                }
            }

            initializeMotionTracking() {
                let lastAcceleration = { x: 0, y: 0, z: 0 };
                let stepThreshold = 1.2;
                let lastStepTime = 0;
                
                window.addEventListener('devicemotion', (event) => {
                    if (event.accelerationIncludingGravity && this.isTracking) {
                        const { x, y, z } = event.accelerationIncludingGravity;
                        
                        const magnitude = Math.sqrt(x*x + y*y + z*z);
                        const lastMagnitude = Math.sqrt(
                            lastAcceleration.x * lastAcceleration.x +
                            lastAcceleration.y * lastAcceleration.y +
                            lastAcceleration.z * lastAcceleration.z
                        );
                        
                        const deltaAcceleration = Math.abs(magnitude - lastMagnitude);
                        const currentTime = Date.now();
                        
                        // Prevent double counting steps (minimum 300ms between steps)
                        if (deltaAcceleration > stepThreshold && (currentTime - lastStepTime) > 300) {
                            this.stepCount++;
                            lastStepTime = currentTime;
                            
                            // Update UI
                            this.updateStepDisplay();
                            
                            // Save to storage every 10 steps
                            if (this.stepCount % 10 === 0) {
                                this.saveCurrentSteps();
                            }
                        }
                        
                        lastAcceleration = { x, y, z };
                    }
                });
            }

            updateTrackingStatus(isTracking) {
                this.isTracking = isTracking;
                const trackingElement = document.getElementById('tracking-status');
                if (trackingElement) {
                    trackingElement.textContent = isTracking ? 'Active' : 'Inactive';
                    trackingElement.className = isTracking 
                        ? 'text-green-600 dark:text-green-400' 
                        : 'text-gray-600 dark:text-gray-400';
                }
            }

            async initializeAccelerometer() {
                try {
                    let sensor = new Accelerometer({ frequency: 60 });
                    sensor.addEventListener('reading', () => {
                        console.log("Acceleration along the X-axis " + sensor.x);
                        console.log("Acceleration along the Y-axis " + sensor.y);
                        console.log("Acceleration along the Z-axis " + sensor.z);
                    });
                    sensor.start();
                } catch (error) {
                    console.log('Accelerometer API not available:', error);
                }
            }

            setupIOSDataSharing() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        console.log('Ready to receive health data');
                    });
                }

                this.checkForSharedHealthData();
            }

            checkForSharedHealthData() {
                const urlParams = new URLSearchParams(window.location.search);
                const healthData = urlParams.get('healthData');
                const steps = urlParams.get('steps');
                
                if (healthData) {
                    try {
                        const data = JSON.parse(decodeURIComponent(healthData));
                        this.processHealthData(data);
                    } catch (error) {
                        console.error('Error parsing shared health data:', error);
                    }
                }
                
                if (steps) {
                    this.saveStepsData({
                        date: new Date().toISOString().split('T')[0],
                        steps: parseInt(steps),
                        source: 'url_param'
                    });
                }
                
                if (healthData || steps) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }

            async initializeGenericApis() {
                if ('serviceWorker' in navigator && 'share' in navigator) {
                    console.log('Web Share API available');
                }

                if (window.location.search.includes('fitbit')) {
                    await this.handleFitbitData();
                }

                if (window.location.search.includes('googlefit')) {
                    await this.handleGoogleFitData();
                }
            }

            async handleFitbitData() {
                console.log('Handling Fitbit data');
            }

            async handleGoogleFitData() {
                console.log('Handling Google Fit data');
            }

            setupManualStepInput() {
                const stepInputModal = this.createStepInputModal();
                document.body.appendChild(stepInputModal);
            }

            createStepInputModal() {
                const modal = document.createElement('div');
                modal.id = 'step-input-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                        <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Add Steps Manually</h3>
                        <input type="number" id="manual-steps" 
                               class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base mb-4 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" 
                               placeholder="Enter step count" min="0" max="100000">
                        <input type="date" id="step-date" 
                               class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base mb-4 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                               value="${new Date().toISOString().split('T')[0]}">
                        <div class="flex space-x-3">
                            <button onclick="this.closest('#step-input-modal').classList.add('hidden')"
                                    class="flex-1 px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                Cancel
                            </button>
                            <button onclick="window.healthManager.saveManualSteps()"
                                    class="flex-1 px-4 py-2 bg-primary text-white hover:bg-purple-600 rounded">
                                Save
                            </button>
                        </div>
                    </div>
                `;
                return modal;
            }

            saveManualSteps() {
                const stepsInput = document.getElementById('manual-steps');
                const dateInput = document.getElementById('step-date');
                
                const steps = parseInt(stepsInput.value);
                const date = dateInput.value;
                
                if (steps > 0) {
                    this.saveStepsData({
                        date: date,
                        steps: steps,
                        source: 'manual_input'
                    });
                    
                    document.getElementById('step-input-modal').classList.add('hidden');
                    stepsInput.value = '';
                    
                    this.swManager.showNotification('Steps Added!', `${steps} steps recorded for ${date}`);
                }
            }

            showStepInputModal() {
                document.getElementById('step-input-modal').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('manual-steps').focus();
                }, 100);
            }

            processHealthData(data) {
                console.log('Processing health data:', data);
                
                if (Array.isArray(data)) {
                    data.forEach(item => this.processSingleHealthItem(item));
                } else {
                    this.processSingleHealthItem(data);
                }
            }

            processSingleHealthItem(item) {
                if (item.type === 'steps' || item.steps !== undefined) {
                    this.saveStepsData({
                        date: item.date || new Date().toISOString().split('T')[0],
                        steps: item.steps || item.value || 0,
                        source: item.source || 'external',
                        metadata: item
                    });
                } else {
                    this.swManager.saveHealthData(item);
                }
            }

            saveStepsData(stepsData) {
                console.log('Saving steps data:', stepsData);
                this.swManager.saveStepsData(stepsData);
                
                this.swManager.updateQuestProgress();
                
                document.dispatchEvent(new CustomEvent('stepsDataSaved', {
                    detail: stepsData
                }));
            }

            saveCurrentSteps() {
                if (this.stepCount > 0) {
                    this.saveStepsData({
                        date: new Date().toISOString().split('T')[0],
                        steps: this.stepCount,
                        source: 'motion_tracking'
                    });
                }
            }

            updateStepDisplay() {
                const stepElement = document.getElementById('current-session-steps');
                if (stepElement) {
                    stepElement.textContent = this.stepCount.toLocaleString();
                }
            }

            toggleTracking() {
                this.isTracking = !this.isTracking;
                this.updateTrackingStatus(this.isTracking);
                
                if (this.isTracking) {
                    this.stepCount = 0;
                    this.updateStepDisplay();
                } else {
                    this.saveCurrentSteps();
                }
            }

            setupDataSyncTimer() {
                setInterval(() => {
                    this.syncAllHealthData();
                }, 5 * 60 * 1000);
                
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.syncAllHealthData();
                    }
                });
            }

            async syncAllHealthData() {
                try {
                    console.log('Syncing health data...');
                    
                    const stepsData = await this.swManager.getData('steps');
                    
                    this.swManager.requestSync('background-sync-health');
                    
                    console.log('Health data sync completed');
                } catch (error) {
                    console.error('Error syncing health data:', error);
                }
            }

            async getStepsForDateRange(startDate, endDate) {
                return await this.swManager.getData('steps');
            }

            async getTodaySteps() {
                const today = new Date().toISOString().split('T')[0];
                const allSteps = await this.getStepsForDateRange(today, today);
                return allSteps.filter(step => step.date === today)
                              .reduce((total, step) => total + step.steps, 0);
            }
        }

        // Quest System Integration
        class QuestSystem {
            constructor(swManager, healthManager) {
                this.swManager = swManager;
                this.healthManager = healthManager;
                this.quests = [];
                this.achievements = [];
                this.totalXP = 0;
                this.init();
            }

            async init() {
                this.quests = await this.swManager.getData('quests') || [];
                
                if (this.quests.length === 0) {
                    this.createDefaultQuests();
                }
                
                this.setupEventListeners();
            }

            createDefaultQuests() {
                const defaultQuests = [
                    {
                        id: 'daily-steps-5000',
                        title: '5,000 Steps Daily',
                        description: 'Walk 5,000 steps in a day',
                        category: 'fitness',
                        type: 'steps',
                        target: { steps: 5000 },
                        progress: 0,
                        completed: false,
                        recurring: 'daily',
                        xp: 50,
                        created: Date.now()
                    },
                    {
                        id: 'daily-steps-10000',
                        title: '10,000 Steps Challenge',
                        description: 'Reach the daily 10,000 step goal',
                        category: 'fitness',
                        type: 'steps',
                        target: { steps: 10000 },
                        progress: 0,
                        completed: false,
                        recurring: 'daily',
                        xp: 100,
                        created: Date.now()
                    },
                    {
                        id: 'weekly-steps-70000',
                        title: 'Weekly Step Master',
                        description: 'Walk 70,000 steps in a week',
                        category: 'fitness',
                        type: 'steps',
                        target: { steps: 70000 },
                        progress: 0,
                        completed: false,
                        recurring: 'weekly',
                        xp: 300,
                        created: Date.now()
                    }
                ];

                this.quests = defaultQuests;
                this.saveQuests();
            }

            setupEventListeners() {
                document.addEventListener('healthDataReceived', (event) => {
                    this.updateQuestProgress();
                });

                document.addEventListener('stepsDataSaved', (event) => {
                    this.updateQuestProgress();
                });

                document.addEventListener('questProgressUpdated', (event) => {
                    this.checkForCompletedQuests(event.detail);
                });
            }

            async updateQuestProgress() {
                const todaySteps = await this.healthManager.getTodaySteps();
                let updated = false;

                for (let quest of this.quests) {
                    if (quest.type === 'steps' && quest.target.steps) {
                        const oldProgress = quest.progress;
                        quest.progress = Math.min(todaySteps, quest.target.steps);
                        quest.completed = quest.progress >= quest.target.steps;
                        
                        if (quest.progress !== oldProgress) {
                            updated = true;
                        }
                    }
                }

                if (updated) {
                    this.saveQuests();
                    this.checkForCompletedQuests({ totalStepsToday: todaySteps });
                    this.updateQuestUI();
                }
            }

            checkForCompletedQuests(data) {
                for (let quest of this.quests) {
                    if (!quest.completedToday && quest.progress >= quest.target.steps) {
                        quest.completed = true;
                        quest.completedAt = Date.now();
                        quest.completedToday = true;
                        
                        this.celebrateQuestCompletion(quest);
                        this.awardXP(quest.xp);
                    }
                }
            }

            celebrateQuestCompletion(quest) {
                this.swManager.showNotification(
                    'üèÜ Quest Completed!', 
                    `${quest.title} - ${quest.xp} XP earned!`
                );

                document.dispatchEvent(new CustomEvent('questCompleted', {
                    detail: quest
                }));

                // Visual celebration
                this.showCelebration(quest);
            }

            showCelebration(quest) {
                const celebrationDiv = document.createElement('div');
                celebrationDiv.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 text-6xl animate-celebration';
                celebrationDiv.innerHTML = 'üèÜ';
                document.body.appendChild(celebrationDiv);

                setTimeout(() => {
                    document.body.removeChild(celebrationDiv);
                }, 1000);
            }

            awardXP(xp) {
                this.totalXP += xp;
                console.log(`Awarded ${xp} XP! Total: ${this.totalXP}`);
                
                const xpElement = document.getElementById('total-xp');
                if (xpElement) {
                    xpElement.textContent = this.totalXP.toLocaleString();
                }
            }

            saveQuests() {
                this.quests.forEach(quest => {
                    this.swManager.saveQuestData(quest);
                });
            }

            updateQuestUI() {
                const questContainer = document.getElementById('quest-list');
                if (!questContainer) return;

                questContainer.innerHTML = '';

                this.getActiveQuests().forEach(quest => {
                    const questElement = this.createQuestElement(quest);
                    questContainer.appendChild(questElement);
                });
            }

            createQuestElement(quest) {
                const div = document.createElement('div');
                const progressPercent = Math.round((quest.progress / quest.target.steps) * 100);
                
                div.className = `quest-item p-4 bg-white dark:bg-gray-800 rounded-lg shadow-lg border-l-4 ${
                    quest.completed ? 'border-green-500' : 'border-primary'
                }`;
                
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-gray-900 dark:text-white">${quest.title}</h4>
                        <span class="text-sm px-2 py-1 rounded ${
                            quest.completed 
                                ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' 
                                : 'bg-primary bg-opacity-10 text-primary'
                        }">
                            ${quest.xp} XP
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">${quest.description}</p>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-700 dark:text-gray-300">
                            ${quest.progress.toLocaleString()} / ${quest.target.steps.toLocaleString()} steps
                        </span>
                        <span class="text-sm font-medium ${quest.completed ? 'text-green-600' : 'text-primary'}">
                            ${progressPercent}%
                        </span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div class="h-2 rounded-full transition-all duration-300 ${
                            quest.completed ? 'bg-green-500' : 'bg-primary'
                        }" style="width: ${Math.min(progressPercent, 100)}%"></div>
                    </div>
                    ${quest.completed ? '<div class="mt-2 text-green-600 dark:text-green-400 text-sm font-medium">‚úÖ Completed!</div>' : ''}
                `;
                
                return div;
            }

            createQuest(questData) {
                const quest = {
                    id: questData.id || `quest-${Date.now()}`,
                    ...questData,
                    progress: 0,
                    completed: false,
                    created: Date.now()
                };

                this.quests.push(quest);
                this.saveQuests();
                return quest;
            }

            getActiveQuests() {
                return this.quests.filter(quest => !quest.completed || quest.recurring);
            }

            getCompletedQuests() {
                return this.quests.filter(quest => quest.completed);
            }
        }
    </script>
</head>
<body class="h-full bg-gradient-to-br from-purple-50 to-blue-50 dark:from-gray-900 dark:to-purple-900 font-sans">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="text-3xl">üèÜ</div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">Quest Tracker Pro</h1>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Complete Wellness Platform</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-600 dark:text-gray-400">Status:</div>
                        <div id="connection-status" class="text-sm font-medium">Checking...</div>
                    </div>
                    <button onclick="toggleDarkMode()" 
                            class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600">
                        <span class="dark:hidden">üåô</span>
                        <span class="hidden dark:inline">‚òÄÔ∏è</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Stats Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- Today's Steps -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-2xl font-bold text-primary" id="today-steps">Loading...</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Steps Today</div>
                    </div>
                    <div class="text-3xl">üëü</div>
                </div>
            </div>

            <!-- Session Steps (for motion tracking) -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-2xl font-bold text-green-600" id="current-session-steps">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Session Steps</div>
                    </div>
                    <div class="text-3xl">üì±</div>
                </div>
            </div>

            <!-- Completed Quests -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-2xl font-bold text-purple-600" id="completed-quests">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Completed Quests</div>
                    </div>
                    <div class="text-3xl">‚úÖ</div>
                </div>
            </div>

            <!-- Total XP -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-2xl font-bold text-yellow-600" id="total-xp">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Total XP</div>
                    </div>
                    <div class="text-3xl">‚≠ê</div>
                </div>
            </div>
        </div>

        <!-- Step Tracking Controls -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Step Tracking</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <!-- Motion Tracking Status -->
                <div class="text-center p-4 bg-blue-50 dark:bg-blue-900 bg-opacity-50 rounded-lg">
                    <div class="text-lg font-semibold text-blue-700 dark:text-blue-300">Motion Tracking</div>
                    <div id="tracking-status" class="text-sm">Inactive</div>
                </div>

                <!-- Notification Status -->
                <div class="text-center p-4 bg-green-50 dark:bg-green-900 bg-opacity-50 rounded-lg">
                    <div class="text-lg font-semibold text-green-700 dark:text-green-300">Notifications</div>
                    <div id="notification-status" class="text-sm">Checking...</div>
                </div>

                <!-- Data Sync Status -->
                <div class="text-center p-4 bg-purple-50 dark:bg-purple-900 bg-opacity-50 rounded-lg">
                    <div class="text-lg font-semibold text-purple-700 dark:text-purple-300">Data Sync</div>
                    <div class="text-sm text-purple-600 dark:text-purple-400">Auto-enabled</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3">
                <button onclick="window.healthManager.showStepInputModal()" 
                        class="flex-1 min-w-[200px] px-4 py-3 bg-primary text-white rounded-lg hover:bg-purple-600 transition-all font-medium">
                    üìù Add Steps Manually
                </button>
                
                <button onclick="window.healthManager.toggleTracking()" 
                        class="flex-1 min-w-[200px] px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-medium">
                    üì± Toggle Motion Tracking
                </button>
                
                <button onclick="window.showHealthInstructions()" 
                        class="flex-1 min-w-[200px] px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium">
                    üí° Sync Instructions
                </button>
            </div>
        </div>

        <!-- Active Quests -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">Active Quests</h2>
                <button onclick="window.questSystem.updateQuestProgress()" 
                        class="px-3 py-1 text-sm bg-primary text-white rounded hover:bg-purple-600">
                    üîÑ Refresh
                </button>
            </div>
            <div id="quest-list" class="space-y-4">
                <!-- Quests will be populated here -->
            </div>
        </div>

        <!-- Data Management -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Data Management</h2>
            
            <div class="flex flex-wrap gap-3">
                <button onclick="window.exportHealthData()" 
                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all">
                    üì§ Export Data
                </button>
                
                <button onclick="window.importHealthData()" 
                        class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-all">
                    üì• Import Data
                </button>
                
                <button onclick="window.swManager.requestSync('background-sync-health')" 
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all">
                    üîÑ Sync Data
                </button>
                
                <button onclick="clearAllData()" 
                        class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all">
                    üóëÔ∏è Clear Data
                </button>
            </div>
        </div>
    </main>

    <!-- Health Data Sharing Instructions Modal -->
    <div id="health-sharing-instructions" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">How to Sync Step Data</h3>
            
            <div class="space-y-4 text-sm">
                <div>
                    <h4 class="font-semibold text-primary mb-2">üì± iOS Health App Integration</h4>
                    <ol class="list-decimal list-inside space-y-1 text-gray-600 dark:text-gray-300">
                        <li>Open the iOS Health app</li>
                        <li>Navigate to "Browse" ‚Üí "Activity" ‚Üí "Steps"</li>
                        <li>Select the data you want to share</li>
                        <li>Tap the share button</li>
                        <li>Choose "Copy" or share to this app if available</li>
                        <li>Return to Quest Tracker and the data will sync automatically</li>
                    </ol>
                </div>
                
                <div>
                    <h4 class="font-semibold text-blue-600 mb-2">üì± Motion Tracking (iOS)</h4>
                    <ol class="list-decimal list-inside space-y-1 text-gray-600 dark:text-gray-300">
                        <li>Tap "Toggle Motion Tracking" button</li>
                        <li>Allow motion and orientation access when prompted</li>
                        <li>Keep the app open while walking</li>
                        <li>Your steps will be counted automatically</li>
                        <li>Data saves every 10 steps automatically</li>
                    </ol>
                </div>
                
                <div>
                    <h4 class="font-semibold text-green-600 mb-2">‚úçÔ∏è Manual Entry</h4>
                    <ul class="list-disc list-inside space-y-1 text-gray-600 dark:text-gray-300">
                        <li>Tap "Add Steps Manually"</li>
                        <li>Enter your step count</li>
                        <li>Select the date</li>
                        <li>Tap "Save"</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-semibold text-purple-600 mb-2">üìä Data Import</h4>
                    <ul class="list-disc list-inside space-y-1 text-gray-600 dark:text-gray-300">
                        <li>Export data from your fitness app as CSV or JSON</li>
                        <li>Use "Import Data" button</li>
                        <li>Select your exported file</li>
                        <li>Data will be automatically processed</li>
                    </ul>
                </div>
                
                <div class="p-3 bg-yellow-50 dark:bg-yellow-900 bg-opacity-50 rounded">
                    <p class="text-sm text-yellow-800 dark:text-yellow-200">
                        <strong>üí° Tip:</strong> Enable notifications to get reminders about completing your daily step goals!
                    </p>
                </div>
            </div>
            
            <button onclick="document.getElementById('health-sharing-instructions').classList.add('hidden')"
                    class="mt-4 w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-purple-600">
                Got it!
            </button>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="fixed bottom-6 right-6 flex flex-col space-y-3">
        <button onclick="window.healthManager.showStepInputModal()" 
                class="bg-primary text-white p-4 rounded-full shadow-lg hover:bg-purple-600 transition-all hover:scale-110"
                title="Add Steps Manually">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
        </button>
        
        <button onclick="window.showHealthInstructions()" 
                class="bg-blue-500 text-white p-4 rounded-full shadow-lg hover:bg-blue-600 transition-all hover:scale-110"
                title="Sync Instructions">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </button>
    </div>

    <!-- Initialization Script -->
    <script>
        // Initialize all managers when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('Initializing Quest Tracker Pro...');
                
                // Initialize Service Worker Manager
                window.swManager = new ServiceWorkerManager();
                
                // Initialize Health Data Manager
                window.healthManager = new HealthDataManager(window.swManager);
                
                // Initialize Quest System
                window.questSystem = new QuestSystem(window.swManager, window.healthManager);
                
                // Set up manual step input
                window.healthManager.setupManualStepInput();
                
                // Set up event listeners for UI updates
                setupEventListeners();
                
                // Initial UI update
                setTimeout(updateHealthUI, 2000);
                
                console.log('Quest Tracker Pro initialized successfully');
                
                // Schedule daily reminder
                window.swManager.scheduleNotification(
                    'Daily Quest Check',
                    "Time to check your daily quests and log your steps!",
                    24 * 60 * 60 * 1000,
                    'daily-reminder'
                );
                
            } catch (error) {
                console.error('Error initializing Quest Tracker Pro:', error);
            }
        });

        // Set up event listeners
        function setupEventListeners() {
            // Listen for data updates
            document.addEventListener('stepsDataSaved', updateHealthUI);
            document.addEventListener('questCompleted', updateHealthUI);
            document.addEventListener('questProgressUpdated', updateHealthUI);
            
            // Update UI every 30 seconds
            setInterval(updateHealthUI, 30000);
        }

        // Update UI with real data
        async function updateHealthUI() {
            if (window.healthManager && window.questSystem) {
                try {
                    const todaySteps = await window.healthManager.getTodaySteps();
                    document.getElementById('today-steps').textContent = todaySteps.toLocaleString();
                    
                    const completedQuests = window.questSystem.getCompletedQuests();
                    document.getElementById('completed-quests').textContent = completedQuests.length;
                    
                    document.getElementById('total-xp').textContent = window.questSystem.totalXP.toLocaleString();
                    
                    // Update quest list
                    window.questSystem.updateQuestUI();
                    
                } catch (error) {
                    console.error('Error updating UI:', error);
                }
            }
        }

        // Utility functions
        window.showHealthInstructions = () => {
            document.getElementById('health-sharing-instructions').classList.remove('hidden');
        };

        // Dark mode toggle
        window.toggleDarkMode = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
        };

        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }

        // Export data function
        window.exportHealthData = async () => {
            if (window.swManager) {
                try {
                    const stepsData = await window.swManager.getData('steps');
                    const questData = await window.swManager.getData('quests');
                    
                    const exportData = {
                        steps: stepsData || [],
                        quests: questData || [],
                        totalXP: window.questSystem?.totalXP || 0,
                        exported: new Date().toISOString()
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `quest-tracker-data-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    window.swManager.showNotification('Export Complete', 'Your data has been exported successfully!');
                } catch (error) {
                    console.error('Error exporting data:', error);
                    alert('Error exporting data. Please try again.');
                }
            }
        };

        // Import data function
        window.importHealthData = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.txt,.csv';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const text = await file.text();
                        let data;
                        
                        if (file.name.endsWith('.json')) {
                            data = JSON.parse(text);
                        } else {
                            // Try to parse CSV
                            data = parseCSVStepsData(text);
                        }
                        
                        if (data.steps && window.healthManager) {
                            data.steps.forEach(step => {
                                window.healthManager.saveStepsData(step);
                            });
                            window.swManager.showNotification('Import Complete!', `Imported ${data.steps.length} step entries`);
                            setTimeout(updateHealthUI, 1000);
                        } else if (data.length && window.healthManager) {
                            // Handle array of step data
                            data.forEach(step => {
                                window.healthManager.saveStepsData(step);
                            });
                            window.swManager.showNotification('Import Complete!', `Imported ${data.length} step entries`);
                            setTimeout(updateHealthUI, 1000);
                        }
                    } catch (error) {
                        console.error('Error importing data:', error);
                        alert('Error importing data. Please check the file format and try again.');
                    }
                }
            };
            input.click();
        };

        // Parse CSV step data
        function parseCSVStepsData(csvText) {
            const lines = csvText.split('\n');
            const data = [];
            
            lines.forEach((line, index) => {
                if (index === 0) return; // Skip header
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const date = parts[0]?.trim();
                    const steps = parseInt(parts[1]?.trim()) || 0;
                    if (date && steps > 0) {
                        data.push({
                            date: date,
                            steps: steps,
                            source: 'csv_import'
                        });
                    }
                }
            });
            
            return data;
        }

        // Clear all data function
        window.clearAllData = () => {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                // Clear localStorage
                localStorage.clear();
                
                // Clear IndexedDB (this will be handled by service worker)
                if (window.swManager) {
                    window.swManager.sendMessage('CLEAR_ALL_DATA');
                }
                
                // Reset UI
                document.getElementById('today-steps').textContent = '0';
                document.getElementById('current-session-steps').textContent = '0';
                document.getElementById('completed-quests').textContent = '0';
                document.getElementById('total-xp').textContent = '0';
                document.getElementById('quest-list').innerHTML = '<p class="text-gray-500 dark:text-gray-400">No quests available. Data cleared.</p>';
                
                alert('All data has been cleared.');
                
                // Reload to reinitialize with default data
                setTimeout(() => location.reload(), 1000);
            }
        };

        // Handle app install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button
            const installButton = document.createElement('button');
            installButton.textContent = '‚¨áÔ∏è Install App';
            installButton.className = 'fixed top-4 right-4 px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 z-50';
            installButton.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    deferredPrompt = null;
                    document.body.removeChild(installButton);
                }
            };
            document.body.appendChild(installButton);
        });

        // PWA install success
        window.addEventListener('appinstalled', (evt) => {
            console.log('Quest Tracker Pro was installed.');
            window.swManager?.showNotification('App Installed!', 'Quest Tracker Pro is now installed on your device.');
        });
    </script>
</body>
</html>
