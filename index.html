<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Life Quest RPG - Ultimate AI Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        fitness: '#ef4444',
                        nutrition: '#16a34a',
                        hydration: '#3b82f6',
                        wellness: '#a855f7',
                        focus: '#f59e0b',
                        personal: '#6366f1'
                    }
                }
            }
        }
        
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .floating-notification {
            animation: slideInRight 0.5s ease-out, slideOutRight 0.5s ease-in 2.5s forwards;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .xp-burst {
            animation: xpBurst 2s ease-out forwards;
        }
        @keyframes xpBurst {
            0% { transform: scale(1) translateY(0); opacity: 1; }
            50% { transform: scale(1.2) translateY(-20px); opacity: 1; }
            100% { transform: scale(1) translateY(-60px); opacity: 0; }
        }
        .level-up {
            animation: levelUp 1s ease-out;
        }
        @keyframes levelUp {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-bottom: 2px solid #ffffff;
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
        }
        .neural-network-bg {
            background: linear-gradient(45deg, rgba(93, 92, 222, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
            background-size: 20px 20px;
            animation: pulse 4s ease-in-out infinite;
        }
        .pattern-learning-indicator {
            background: linear-gradient(45deg, #5D5CDE, #9333EA);
            animation: learning-pulse 2s ease-in-out infinite;
        }
        @keyframes learning-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        .ai-insight {
            background: linear-gradient(135deg, #5D5CDE 0%, #9333EA 100%);
            position: relative;
            overflow: hidden;
        }
        .ai-insight::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .task-completion-effect {
            animation: taskComplete 0.6s ease-out;
        }
        @keyframes taskComplete {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: #10b981; }
            100% { transform: scale(1); }
        }
        .modal-overlay {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.4);
        }
        .debug-filter-btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            background-color: #e5e7eb;
            color: #374151;
            transition: all 0.15s ease-in-out;
        }
        
        .dark .debug-filter-btn {
            background-color: #4b5563;
            color: #d1d5db;
        }
        
        .debug-filter-btn:hover {
            background-color: #d1d5db;
        }
        
        .dark .debug-filter-btn:hover {
            background-color: #6b7280;
        }
        
        .debug-filter-btn.active {
            background-color: #5D5CDE;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-300">
    
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="text-6xl mb-4">üß†</div>
            <div class="text-2xl font-bold text-white mb-2">Life Quest RPG</div>
            <div class="text-lg text-purple-200 mb-8">Ultimate AI Edition</div>
            <div class="flex space-x-1 justify-center">
                <div class="w-3 h-3 bg-white rounded-full animate-bounce"></div>
                <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
        </div>
    </div>

    <div class="min-h-screen">
        <!-- Header -->
        <header class="gradient-bg text-white p-4 shadow-lg relative overflow-hidden">
            <div class="max-w-7xl mx-auto relative z-10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div class="text-3xl">üß†</div>
                            <div>
                                <h1 class="text-2xl font-bold">Life Quest RPG</h1>
                                <div class="flex items-center space-x-2 text-sm opacity-90">
                                    <span>Ultimate AI Edition</span>
                                    <div class="bg-gradient-to-r from-green-400 to-blue-500 px-2 py-1 rounded-full text-xs">
                                        AI Active
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="neural-network-bg p-3 rounded-lg">
                            <div class="text-xs text-center">
                                <div class="pattern-learning-indicator w-4 h-4 rounded-full mx-auto mb-1"></div>
                                <div>Learning</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="flex space-x-2">
                            <button onclick="aiQuickSuggestion()" class="glass-effect px-3 py-1 rounded-lg text-sm hover:bg-white/20 transition-all">
                                üß† AI Tip
                            </button>
                            <button onclick="showDebugConsole()" class="glass-effect px-3 py-1 rounded-lg text-sm hover:bg-white/20 transition-all" title="Advanced Debug Console">
                                üîç Debug
                            </button>
                            <button onclick="switchTab('settings')" class="glass-effect px-3 py-1 rounded-lg text-sm hover:bg-white/20 transition-all">
                                ‚öôÔ∏è Settings
                            </button>
                        </div>
                        
                        <div class="text-right">
                            <div class="flex items-center space-x-2">
                                <div id="playerLevel" class="font-bold text-lg">Level 1</div>
                                <div class="pattern-learning-indicator w-4 h-4 rounded-full"></div>
                            </div>
                            <div class="text-xs opacity-90">
                                <span id="currentXP">0</span>/<span id="nextLevelXP">100</span> XP
                            </div>
                            <div class="text-xs text-yellow-300">
                                üî• <span id="currentStreak">0</span> day streak
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- XP Progress Bar -->
                <div class="mt-4">
                    <div class="flex items-center justify-between mb-1">
                        <div class="text-xs text-white/80">Experience Progress</div>
                        <div class="text-xs text-white/80" id="xpProgressPercent">0%</div>
                    </div>
                    <div class="bg-white/20 rounded-full h-3 relative overflow-hidden">
                        <div id="xpProgress" class="bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 h-full rounded-full transition-all duration-1000" style="width: 0%">
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-pulse"></div>
                        </div>
                    </div>
                </div>
                
                <!-- AI Status -->
                <div class="mt-3 flex items-center justify-between">
                    <div class="flex space-x-3">
                        <div class="bg-green-500/20 px-2 py-1 rounded-full text-xs">
                            üåç Context: <span id="currentContext">Active</span>
                        </div>
                        <div class="bg-white/10 px-2 py-1 rounded-full text-xs">
                            üß† AI Confidence: <span id="aiConfidence">85%</span>
                        </div>
                        <div class="bg-white/10 px-2 py-1 rounded-full text-xs">
                            ‚ö° Energy: <span id="energyLevel">Good</span>
                        </div>
                    </div>
                    <div class="text-xs text-white/70">
                        AI last updated: <span id="lastAIUpdate">Just now</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="gradient-bg border-b border-white/20">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex space-x-6 overflow-x-auto">
                    <button onclick="switchTab('dashboard')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap active">
                        üìä Dashboard
                    </button>
                    <button onclick="switchTab('tasks')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üìã Tasks
                    </button>
                    <button onclick="switchTab('fitness')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üí™ Fitness
                    </button>
                    <button onclick="switchTab('nutrition')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        ü•ó Nutrition
                    </button>
                    <button onclick="switchTab('ai')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üß† AI Coach
                    </button>
                    <button onclick="switchTab('analytics')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üìà Analytics
                    </button>
                    <button onclick="switchTab('music')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üéµ Music AI
                    </button>
                    <button onclick="switchTab('settings')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        ‚öôÔ∏è Settings
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-4">
            <!-- AI Insights (visible on all tabs) -->
            <div id="aiInsights" class="mb-6"></div>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <!-- Stats Cards -->
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-fitness text-2xl">üí™</span>
                            <span id="workoutCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Workouts</div>
                        <div class="text-xs text-fitness">Goal: 1/day</div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-hydration text-2xl">üíß</span>
                            <span id="waterCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Water</div>
                        <div class="text-xs text-hydration">Goal: 8 glasses</div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-nutrition text-2xl">ü•ó</span>
                            <span id="caloriesCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Calories</div>
                        <div class="text-xs text-nutrition">Goal: 2000</div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-focus text-2xl">üìã</span>
                            <span id="tasksCompletedDisplay" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Tasks</div>
                        <div class="text-xs text-focus">Today</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Today's Quests -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">üìã Today's Quests</h3>
                            <button onclick="generateAITasks()" class="text-primary hover:text-purple-600 text-sm">
                                üß† AI Generate
                            </button>
                        </div>
                        <div id="tasksList" class="space-y-2 max-h-64 overflow-y-auto mb-4">
                            <!-- Tasks will be populated here -->
                        </div>
                        <button onclick="addCustomTask()" class="w-full bg-personal text-white py-2 rounded hover:bg-indigo-600 transition-all">
                            ‚ûï Add Quest
                        </button>
                    </div>

                    <!-- Achievements -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üèÜ Achievements</h3>
                        <div id="achievementsList" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Achievements will be populated here -->
                        </div>
                    </div>

                    <!-- AI Coach -->
                    <div class="ai-insight p-6 rounded-xl shadow-lg text-white relative overflow-hidden">
                        <div class="relative z-10">
                            <h3 class="text-xl font-bold mb-3 flex items-center space-x-2">
                                <span>üß†</span>
                                <span>AI Coach</span>
                                <div class="pattern-learning-indicator w-3 h-3 rounded-full"></div>
                            </h3>
                            <div id="aiCoachInsight" class="text-sm opacity-90 mb-4">
                                Advanced neural networks are analyzing your patterns to provide personalized recommendations...
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="getPersonalizedCoaching()" class="bg-white/20 px-3 py-1 rounded text-sm hover:bg-white/30 transition-all">
                                    üí° Get Insight
                                </button>
                                <button onclick="showAdvancedAI()" class="bg-white/20 px-3 py-1 rounded text-sm hover:bg-white/30 transition-all">
                                    üî¨ ML Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div id="tasks-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">üìã Smart Task Manager</h3>
                            <button onclick="optimizeTaskOrder()" class="text-primary hover:text-purple-600 text-sm">
                                üß† Optimize
                            </button>
                        </div>
                        <div id="tasksListDetailed" class="space-y-3 mb-4">
                            <!-- Detailed tasks will be populated here -->
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="addCustomTask()" class="flex-1 bg-personal text-white py-2 rounded hover:bg-indigo-600 transition-all">
                                ‚ûï Add Task
                            </button>
                            <button onclick="generateAITasks()" class="flex-1 bg-purple-500 text-white py-2 rounded hover:bg-purple-600 transition-all">
                                üß† AI Tasks
                            </button>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üìä Task Analytics</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600" id="completionRate">0%</div>
                                <div class="text-sm text-blue-500">Completion Rate</div>
                            </div>
                            <div class="text-center p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-green-600" id="averageTime">0m</div>
                                <div class="text-sm text-green-500">Avg Time</div>
                            </div>
                            <div class="text-center p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-purple-600" id="streakCount">0</div>
                                <div class="text-sm text-purple-500">Streak</div>
                            </div>
                            <div class="text-center p-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-orange-600" id="totalXPEarned">0</div>
                                <div class="text-sm text-orange-500">XP Earned</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fitness Tab -->
            <div id="fitness-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 text-fitness">üí™ Workout Tracker</h3>
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-fitness" id="totalWorkouts">0</div>
                                <div class="text-sm text-gray-500">Workouts</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-orange-500" id="caloriesBurned">0</div>
                                <div class="text-sm text-gray-500">Calories</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-500" id="exerciseMinutes">0</div>
                                <div class="text-sm text-gray-500">Minutes</div>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <button onclick="startWorkout('cardio')" class="w-full bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition-all">
                                üèÉ‚Äç‚ôÇÔ∏è Cardio Workout
                            </button>
                            <button onclick="startWorkout('strength')" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-all">
                                üí™ Strength Training
                            </button>
                            <button onclick="startWorkout('yoga')" class="w-full bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 transition-all">
                                üßò‚Äç‚ôÄÔ∏è Yoga & Flexibility
                            </button>
                        </div>
                    </div>
                    
                    <!-- Steps Tracker -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h4 class="font-bold mb-4">üëü Steps Tracker</h4>
                        <div class="p-4 bg-green-50 dark:bg-green-900/30 rounded-lg">
                            <div class="flex items-center justify-between mb-3">
                                <h5 class="font-medium text-green-700 dark:text-green-300">Daily Steps Goal</h5>
                                <span id="fitnessStepsDisplay" class="text-sm text-green-600 dark:text-green-400">0 steps</span>
                            </div>
                            <div class="flex space-x-2 mb-3">
                                <input type="number" id="fitnessStepsInput" placeholder="Enter steps..." min="0" max="50000"
                                       class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base">
                                <button onclick="addSteps()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-all">
                                    Add
                                </button>
                            </div>
                            <div class="flex space-x-2 mb-3">
                                <button onclick="quickAddSteps(1000)" class="flex-1 bg-green-400 text-white py-1 rounded text-sm hover:bg-green-500 transition-all">
                                    +1K
                                </button>
                                <button onclick="quickAddSteps(2500)" class="flex-1 bg-green-500 text-white py-1 rounded text-sm hover:bg-green-600 transition-all">
                                    +2.5K
                                </button>
                                <button onclick="quickAddSteps(5000)" class="flex-1 bg-green-600 text-white py-1 rounded text-sm hover:bg-green-700 transition-all">
                                    +5K
                                </button>
                            </div>
                            <button onclick="quickLogSteps()" class="w-full bg-green-700 text-white py-2 rounded hover:bg-green-800 transition-all">
                                üëü Quick Log 2K Steps + Music
                            </button>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üìÖ AI Workout Plan</h3>
                        <div id="weeklyWorkoutPlan" class="space-y-3">
                            <!-- Weekly plan will be populated here -->
                        </div>
                        <button onclick="generateWorkoutPlan()" class="w-full mt-4 bg-primary text-white py-2 rounded hover:bg-purple-600 transition-all">
                            üß† Generate AI Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Enhanced Nutrition Tab with API Integration -->
            <div id="nutrition-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 text-nutrition">ü•ó Nutrition Tracker</h3>
                        <div class="mb-4">
                            <div class="text-3xl font-bold text-nutrition" id="nutritionCalories">0</div>
                            <div class="text-sm text-gray-500">Today's Calories</div>
                        </div>
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="text-center p-3 bg-red-50 dark:bg-red-900/30 rounded-lg">
                                <div class="text-xl font-bold text-red-600" id="proteinCount">0g</div>
                                <div class="text-xs text-red-500">Protein</div>
                            </div>
                            <div class="text-center p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg">
                                <div class="text-xl font-bold text-yellow-600" id="carbsCount">0g</div>
                                <div class="text-xs text-yellow-500">Carbs</div>
                            </div>
                            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <div class="text-xl font-bold text-blue-600" id="fatCount">0g</div>
                                <div class="text-xs text-blue-500">Fat</div>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <button onclick="showNutritionSearch()" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-purple-600 transition-all font-medium">
                                üîç Search Food Database
                            </button>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="logMeal('breakfast')" class="bg-yellow-500 text-white py-2 rounded text-sm hover:bg-yellow-600 transition-all">
                                    üåÖ Breakfast
                                </button>
                                <button onclick="logMeal('lunch')" class="bg-green-500 text-white py-2 rounded text-sm hover:bg-green-600 transition-all">
                                    ü•ô Lunch
                                </button>
                                <button onclick="logMeal('dinner')" class="bg-blue-500 text-white py-2 rounded text-sm hover:bg-blue-600 transition-all">
                                    üçΩÔ∏è Dinner
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Water Tracker -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h4 class="font-bold mb-4">üíß Hydration Tracker</h4>
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                            <div class="flex items-center justify-between mb-3">
                                <h5 class="font-medium text-blue-700 dark:text-blue-300">Daily Water Goal</h5>
                                <span id="nutritionWaterDisplay" class="text-sm text-blue-600 dark:text-blue-400">0/8 glasses</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 mb-3" id="nutritionWaterGlasses">
                                <!-- Water glasses will be populated here -->
                            </div>
                            <div class="flex space-x-2 mb-3">
                                <button onclick="addWaterGlass()" class="flex-1 bg-blue-500 text-white py-2 rounded text-sm hover:bg-blue-600 transition-all">
                                    + Glass
                                </button>
                                <button onclick="removeWaterGlass()" class="flex-1 bg-blue-300 text-white py-2 rounded text-sm hover:bg-blue-400 transition-all">
                                    - Glass
                                </button>
                            </div>
                            <button onclick="quickTrackWater()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition-all">
                                üíß Quick Log Water + Music
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üìÖ AI Meal Plan</h3>
                        <div id="weeklyMealPlan" class="space-y-3">
                            <!-- Weekly meal plan will be populated here -->
                        </div>
                        <button onclick="generateMealPlan()" class="w-full mt-4 bg-primary text-white py-2 rounded hover:bg-purple-600 transition-all">
                            üß† Generate AI Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Coach Tab -->
            <div id="ai-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="ai-insight p-6 rounded-xl shadow-lg text-white">
                        <h3 class="text-xl font-bold mb-4">üß† Advanced AI Analysis</h3>
                        <div id="aiAnalysisContent" class="space-y-4">
                            <div class="bg-white/10 p-4 rounded-lg">
                                <h4 class="font-bold mb-2">üî¨ Neural Network Status</h4>
                                <div class="text-sm opacity-90">
                                    <div>Architecture: Multi-layer perceptron</div>
                                    <div>Training Progress: <span id="neuralTraining">85%</span></div>
                                    <div>Prediction Accuracy: <span id="neuralAccuracy">92%</span></div>
                                </div>
                            </div>
                            <div class="bg-white/10 p-4 rounded-lg">
                                <h4 class="font-bold mb-2">üìä Pattern Recognition</h4>
                                <div class="text-sm opacity-90" id="patternAnalysis">
                                    Analyzing your behavioral patterns and optimizing recommendations...
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <button onclick="retrainAI()" class="bg-white/20 px-3 py-2 rounded text-sm hover:bg-white/30 transition-all">
                                üîÑ Retrain
                            </button>
                            <button onclick="exportAIData()" class="bg-white/20 px-3 py-2 rounded text-sm hover:bg-white/30 transition-all">
                                üìä Export
                            </button>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üéØ AI Recommendations</h3>
                        <div id="aiRecommendations" class="space-y-3">
                            <!-- AI recommendations will be populated here -->
                        </div>
                        <button onclick="getNewRecommendations()" class="w-full mt-4 bg-primary text-white py-2 rounded hover:bg-purple-600 transition-all">
                            üîÑ Refresh Recommendations
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üìä Performance Overview</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600" id="overallScore">85</div>
                                <div class="text-sm text-blue-500">Overall Score</div>
                            </div>
                            <div class="text-center p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-green-600" id="improvementRate">+12%</div>
                                <div class="text-sm text-green-500">Improvement</div>
                            </div>
                            <div class="text-center p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-purple-600" id="consistencyScore">92%</div>
                                <div class="text-sm text-purple-500">Consistency</div>
                            </div>
                            <div class="text-center p-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-orange-600" id="goalCompletion">78%</div>
                                <div class="text-sm text-orange-500">Goal Rate</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üìà Trends</h3>
                        <div id="trendAnalysis" class="space-y-4">
                            <!-- Trend analysis will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Music AI Tab -->
            <div id="music-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Spotify Integration -->
                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold flex items-center space-x-2">
                                <span>üéµ</span>
                                <span>Spotify Integration</span>
                            </h3>
                            <div id="spotifyStatus" class="text-sm px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-600">
                                Not Connected
                            </div>
                        </div>
                        
                        <div id="spotifyLogin" class="text-center py-8">
                            <div class="text-4xl mb-4">üéß</div>
                            <h4 class="text-lg font-medium mb-2">Connect to Spotify</h4>
                            <p class="text-gray-600 dark:text-gray-400 mb-4">
                                Link your Spotify account to get AI-powered music recommendations and seamless playback control
                            </p>
                            <button onclick="connectSpotify()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-all">
                                üéµ Connect Spotify
                            </button>
                        </div>
                        
                        <div id="spotifyPlayer" class="hidden">
                            <!-- Current Track Display -->
                            <div id="currentTrack" class="flex items-center space-x-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg mb-4">
                                <img id="trackImage" src="" alt="Album Art" class="w-16 h-16 rounded-lg">
                                <div class="flex-1">
                                    <div id="trackName" class="font-medium">No track playing</div>
                                    <div id="trackArtist" class="text-sm text-gray-600 dark:text-gray-400">-</div>
                                    <div id="trackAlbum" class="text-xs text-gray-500">-</div>
                                </div>
                                <div class="text-right">
                                    <div id="trackProgress" class="text-sm text-gray-600">0:00 / 0:00</div>
                                    <div class="w-24 bg-gray-300 dark:bg-gray-600 rounded-full h-1 mt-1">
                                        <div id="progressBar" class="bg-green-500 h-1 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Player Controls -->
                            <div class="flex items-center justify-center space-x-4 mb-4">
                                <button onclick="spotifyPrevious()" class="p-3 bg-gray-200 dark:bg-gray-600 rounded-full hover:bg-gray-300 dark:hover:bg-gray-500 transition-all">
                                    ‚èÆÔ∏è
                                </button>
                                <button id="playPauseBtn" onclick="spotifyTogglePlay()" class="p-4 bg-green-500 text-white rounded-full hover:bg-green-600 transition-all text-xl">
                                    ‚ñ∂Ô∏è
                                </button>
                                <button onclick="spotifyNext()" class="p-3 bg-gray-200 dark:bg-gray-600 rounded-full hover:bg-gray-300 dark:hover:bg-gray-500 transition-all">
                                    ‚è≠Ô∏è
                                </button>
                                <button onclick="transferToWebPlayer()" class="p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-all" title="Transfer to Web Player">
                                    üì±
                                </button>
                                <button onclick="refreshSpotifyConnection()" class="p-3 bg-orange-500 text-white rounded-full hover:bg-orange-600 transition-all" title="Refresh Connection">
                                    üîÑ
                                </button>
                            </div>
                            
                            <!-- Volume Control -->
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-sm">üîä</span>
                                <input type="range" id="volumeSlider" min="0" max="100" value="50" 
                                       onchange="setSpotifyVolume(this.value)"
                                       class="flex-1 h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                <span id="volumeDisplay" class="text-sm w-8">50%</span>
                            </div>
                            
                            <!-- Device Selection -->
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">Playing on:</span>
                                <select id="deviceSelect" onchange="changeSpotifyDevice(this.value)" 
                                        class="text-sm bg-gray-100 dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded px-3 py-1">
                                    <option value="">Select Device</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Music Features -->
                    <div class="space-y-6">
                        <!-- Quick Actions -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h4 class="font-bold mb-4">‚ö° Quick Actions</h4>
                            <div class="space-y-3">
                                <button onclick="quickTrackWater()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-all">
                                    üíß Log Water + Music
                                </button>
                                <button onclick="quickLogSteps()" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition-all">
                                    üëü Log Steps + Energy Music
                                </button>
                                <button onclick="quickLogWorkout()" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-all">
                                    üí™ Workout + Pump-up Music
                                </button>
                                <button onclick="focusMode()" class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600 transition-all">
                                    üß† Focus Mode + Lo-fi
                                </button>
                            </div>
                        </div>
                        
                        <!-- Manual Tracking -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h4 class="font-bold mb-4">üìä Manual Tracking</h4>
                            <div class="space-y-4">
                                <!-- Steps Tracker -->
                                <div class="p-4 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                    <div class="flex items-center justify-between mb-3">
                                        <h5 class="font-medium text-green-700 dark:text-green-300">üëü Steps Tracker</h5>
                                        <span id="stepsDisplay" class="text-sm text-green-600 dark:text-green-400">0 steps</span>
                                    </div>
                                    <div class="flex space-x-2 mb-3">
                                        <input type="number" id="stepsInput" placeholder="Enter steps..." min="0" max="50000"
                                               class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base">
                                        <button onclick="addSteps()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-all">
                                            Add
                                        </button>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="quickAddSteps(1000)" class="flex-1 bg-green-400 text-white py-1 rounded text-sm hover:bg-green-500 transition-all">
                                            +1K
                                        </button>
                                        <button onclick="quickAddSteps(2500)" class="flex-1 bg-green-500 text-white py-1 rounded text-sm hover:bg-green-600 transition-all">
                                            +2.5K
                                        </button>
                                        <button onclick="quickAddSteps(5000)" class="flex-1 bg-green-600 text-white py-1 rounded text-sm hover:bg-green-700 transition-all">
                                            +5K
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI Recommendations -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h4 class="font-bold mb-4">üß† AI Music Recommendations</h4>
                            <div id="musicRecommendations" class="space-y-3">
                                <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <div class="font-medium text-sm">üéµ Based on your energy</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">High-energy tracks for peak performance</div>
                                    <button onclick="playAIRecommendation('energy')" class="mt-2 text-xs bg-green-500 text-white px-3 py-1 rounded">Play</button>
                                </div>
                                <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <div class="font-medium text-sm">üßò Wellness Music</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">Calming sounds for relaxation</div>
                                    <button onclick="playAIRecommendation('wellness')" class="mt-2 text-xs bg-blue-500 text-white px-3 py-1 rounded">Play</button>
                                </div>
                                <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <div class="font-medium text-sm">üí™ Workout Beats</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">Motivational tracks for exercise</div>
                                    <button onclick="playAIRecommendation('workout')" class="mt-2 text-xs bg-red-500 text-white px-3 py-1 rounded">Play</button>
                                </div>
                            </div>
                            <button onclick="generateMusicRecommendations()" class="w-full mt-4 bg-primary text-white py-2 rounded hover:bg-purple-600 transition-all">
                                üîÑ Generate New Recommendations
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- General Settings -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">‚öôÔ∏è General Settings</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium">üîî Notifications</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Enable push notifications</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="notificationsToggle" class="sr-only peer" checked onchange="toggleSetting('notifications', this.checked)">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium">üé¨ Animations</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Enable UI animations</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="animationsToggle" class="sr-only peer" checked onchange="toggleSetting('animations', this.checked)">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium">üîä Sound Effects</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Enable audio feedback</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="soundToggle" class="sr-only peer" checked onchange="toggleSetting('soundEffects', this.checked)">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium">üß† AI Learning</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Allow AI to learn from your patterns</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="aiLearningToggle" class="sr-only peer" checked onchange="toggleSetting('aiLearning', this.checked)">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- USDA Nutrition API Configuration -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">ü•ó USDA Nutrition API</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">üîë USDA API Key</label>
                                <div class="relative">
                                    <input type="text" id="usdaApiKey" placeholder="Enter your USDA FoodData Central API key" 
                                           class="w-full p-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    <div id="usdaApiKeyStatus" class="absolute right-3 top-1/2 transform -translate-y-1/2 hidden">
                                        <div class="flex items-center space-x-1">
                                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                            <span class="text-xs text-green-600 dark:text-green-400 font-medium">Saved</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    Get your free API key from <a href="https://fdc.nal.usda.gov/api-guide.html" target="_blank" class="text-blue-500 hover:underline">USDA FoodData Central</a>
                                </div>
                                <div id="usdaApiKeySaveStatus" class="hidden mt-2"></div>
                            </div>
                            
                            <div class="p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <div class="text-xs text-blue-600 dark:text-blue-400">
                                    <strong>üìä Current Status:</strong><br>
                                    ‚Ä¢ API Key: <span id="usdaApiKeyDisplayStatus" class="font-medium">Not configured</span><br>
                                    ‚Ä¢ Daily Limit: <span id="usdaApiLimit">1,000 requests (Free tier)</span><br>
                                    ‚Ä¢ Search Quality: <span id="usdaSearchQuality">Demo (limited results)</span>
                                </div>
                            </div>
                            
                            <button onclick="saveUSDAConfig()" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition-all">
                                üíæ Save USDA Configuration
                            </button>
                            
                            <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <div class="text-xs text-gray-600 dark:text-gray-400">
                                    <strong>Setup Instructions:</strong><br>
                                    1. Visit <a href="https://fdc.nal.usda.gov/api-guide.html" target="_blank" class="text-blue-500 hover:underline">USDA FoodData Central API</a><br>
                                    2. Click "Get an API Key" and sign up<br>
                                    3. Verify your email address<br>
                                    4. Copy your API key here<br>
                                    5. Save and enjoy enhanced nutrition search
                                </div>
                            </div>
                            
                            <div class="p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                <div class="text-xs text-green-600 dark:text-green-400">
                                    <strong>üí° Benefits of API Key:</strong><br>
                                    ‚Ä¢ 1,000+ food items per search vs 5 with demo<br>
                                    ‚Ä¢ Detailed nutrition data for 400,000+ foods<br>
                                    ‚Ä¢ Brand-specific products and restaurant items<br>
                                    ‚Ä¢ Real-time updates from USDA database<br>
                                    ‚Ä¢ Faster search responses
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Spotify Configuration -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üéµ Spotify Configuration</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">üîë Spotify Client ID</label>
                                <div class="relative">
                                    <input type="text" id="spotifyClientId" placeholder="Enter your Spotify app client ID" 
                                           class="w-full p-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    <div id="clientIdStatus" class="absolute right-3 top-1/2 transform -translate-y-1/2 hidden">
                                        <div class="flex items-center space-x-1">
                                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                            <span class="text-xs text-green-600 dark:text-green-400 font-medium">Saved</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    Get your client ID from <a href="https://developer.spotify.com/dashboard" target="_blank" class="text-blue-500 hover:underline">Spotify Developer Dashboard</a>
                                </div>
                                <div id="clientIdSaveStatus" class="hidden mt-2"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">üîó Redirect URI</label>
                                <input type="url" id="spotifyRedirectUri" placeholder="Enter your redirect URI" 
                                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <div class="text-xs text-gray-500 mt-1">
                                    Current auto-detected: <span id="currentRedirectUri" class="font-mono text-blue-600 dark:text-blue-400"></span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    Leave blank to use auto-detected URL, or enter a custom redirect URI configured in your Spotify app
                                </div>
                            </div>
                            
                            <button onclick="saveSpotifyConfig()" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition-all">
                                üíæ Save Spotify Configuration
                            </button>
                            
                            <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <div class="text-xs text-gray-600 dark:text-gray-400">
                                    <strong>Setup Instructions:</strong><br>
                                    1. Create a Spotify app at <a href="https://developer.spotify.com/dashboard" target="_blank" class="text-blue-500 hover:underline">developer.spotify.com</a><br>
                                    2. Add your redirect URI to "Redirect URIs" in app settings<br>
                                    3. Copy the Client ID here<br>
                                    4. Optionally set a custom redirect URI<br>
                                    5. Save and connect to Spotify
                                </div>
                            </div>
                            
                            <div class="p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <div class="text-xs text-blue-600 dark:text-blue-400">
                                    <strong>üí° Redirect URI Tips:</strong><br>
                                    ‚Ä¢ Must exactly match what's configured in your Spotify app<br>
                                    ‚Ä¢ Include protocol (https:// or http://)<br>
                                    ‚Ä¢ Case-sensitive and slash-sensitive<br>
                                    ‚Ä¢ For local testing: <code class="bg-blue-100 dark:bg-blue-800 px-1 rounded">http://localhost:3000</code>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Management -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üíæ Data Management</h3>
                        <div class="space-y-4">
                            <div class="p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <h4 class="font-bold text-blue-700 dark:text-blue-300 mb-2">üìÇ Current Storage</h4>
                                <div class="text-sm text-blue-600 dark:text-blue-400">
                                    <div>‚Ä¢ Tasks: <span id="taskCount">0</span></div>
                                    <div>‚Ä¢ Achievements: <span id="achievementCount">0</span></div>
                                    <div>‚Ä¢ AI Patterns: <span id="patternCount">0</span></div>
                                    <div>‚Ä¢ Total XP: <span id="totalXPDisplay">0</span></div>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <button onclick="backupData()" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition-all">
                                    üì¶ Backup Data
                                </button>
                                <button onclick="restoreData()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-all">
                                    üìÇ Restore Data
                                </button>
                                <button onclick="resetData()" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-all">
                                    üóëÔ∏è Reset All Data
                                </button>
                            </div>
                            
                            <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <div class="text-xs text-gray-600 dark:text-gray-400">
                                    <strong>Storage Type:</strong> Advanced Multi-Tier Backup System<br>
                                    <strong>Auto-save:</strong> Every 30 seconds + real-time<br>
                                    <strong>Backup:</strong> 4-tier redundancy with integrity checks<br>
                                    <strong>Privacy:</strong> All data stays on your device
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Profile -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üë§ Personal Profile</h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">üìè Height (cm)</label>
                                    <input type="number" id="userHeight" placeholder="170" min="100" max="250"
                                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">‚öñÔ∏è Weight (kg)</label>
                                    <input type="number" id="userWeight" placeholder="70" min="30" max="300"
                                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">üéÇ Age</label>
                                    <input type="number" id="userAge" placeholder="25" min="13" max="120"
                                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">‚ößÔ∏è Gender</label>
                                    <select id="userGender" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">üèÉ Activity Level</label>
                                    <select id="activityLevel" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                        <option value="">Select Activity Level</option>
                                        <option value="sedentary">Sedentary (little/no exercise)</option>
                                        <option value="light">Light (1-3 days/week)</option>
                                        <option value="moderate">Moderate (3-5 days/week)</option>
                                        <option value="active">Active (6-7 days/week)</option>
                                        <option value="very_active">Very Active (2x/day, intense)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">üéØ Primary Goal</label>
                                    <select id="fitnessGoal" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                        <option value="">Select Goal</option>
                                        <option value="lose_weight">Lose Weight</option>
                                        <option value="maintain_weight">Maintain Weight</option>
                                        <option value="gain_weight">Gain Weight</option>
                                        <option value="build_muscle">Build Muscle</option>
                                        <option value="improve_fitness">Improve Fitness</option>
                                        <option value="general_health">General Health</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">üèãÔ∏è Available Equipment</label>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2" id="equipmentSelection">
                                    <!-- Equipment checkboxes will be populated here -->
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">üè• Health Conditions (optional)</label>
                                <div class="grid grid-cols-2 gap-2" id="healthConditions">
                                    <!-- Health condition checkboxes will be populated here -->
                                </div>
                            </div>
                            
                            <button onclick="saveUserProfile()" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-purple-600 transition-all font-medium">
                                üíæ Save Profile & Calculate Metrics
                            </button>
                        </div>
                    </div>
                    
                    <!-- Calculated Metrics -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üìä Your Health Metrics</h3>
                        <div id="healthMetrics" class="space-y-4">
                            <!-- Health metrics will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Daily Targets -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üéØ Personalized Daily Targets</h3>
                        <div id="dailyTargets" class="space-y-3">
                            <!-- Daily targets will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Interests Manager -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üéØ Interests Manager</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">üí° Your Interests</label>
                                <div id="interestsList" class="flex flex-wrap gap-2 mb-3 min-h-[60px] p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                                    <!-- Interests will be populated here -->
                                </div>
                                <div class="flex space-x-2">
                                    <input type="text" id="newInterest" placeholder="Add new interest..." 
                                           class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    <button onclick="addInterest()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-all">
                                        ‚ûï Add
                                    </button>
                                </div>
                                <div class="text-xs text-gray-500 mt-2">
                                    AI will suggest tasks based on your interests, timing patterns, and completion history
                                </div>
                            </div>
                            <div class="p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <h4 class="font-bold text-blue-700 dark:text-blue-300 mb-2">üß† AI Learning Context</h4>
                                <div class="text-sm text-blue-600 dark:text-blue-400 space-y-1">
                                    <div>‚Ä¢ Interest-based task generation</div>
                                    <div>‚Ä¢ Optimal timing analysis</div>
                                    <div>‚Ä¢ Difficulty progression tracking</div>
                                    <div>‚Ä¢ Context-aware suggestions</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Settings -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üß† AI Configuration</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">üéØ AI Sensitivity</label>
                                <input type="range" id="aiSensitivity" min="0.1" max="1.0" step="0.1" value="0.8" 
                                       onchange="updateAISensitivity(this.value)"
                                       class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>Conservative</span>
                                    <span id="sensitivityValue">80%</span>
                                    <span>Aggressive</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">‚ö° Learning Rate</label>
                                <select id="learningRate" onchange="updateLearningRate(this.value)" 
                                        class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    <option value="0.005">Slow (0.005)</option>
                                    <option value="0.01" selected>Normal (0.01)</option>
                                    <option value="0.02">Fast (0.02)</option>
                                    <option value="0.05">Rapid (0.05)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">üé® AI Personality</label>
                                <select id="aiPersonality" onchange="updateAIPersonality(this.value)" 
                                        class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    <option value="motivational" selected>üî• Motivational Coach</option>
                                    <option value="analytical">üìä Data Analyst</option>
                                    <option value="supportive">ü§ó Supportive Friend</option>
                                    <option value="challenging">üí™ Challenging Trainer</option>
                                </select>
                            </div>
                            
                            <button onclick="resetAI()" class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600 transition-all">
                                üîÑ Reset AI Models
                            </button>
                        </div>
                    </div>
                    
                    <!-- About -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">‚ÑπÔ∏è About</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span>Version:</span>
                                <span class="font-mono bg-green-100 dark:bg-green-900 px-2 py-1 rounded">v2.3.0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>AI Engine:</span>
                                <span>Neural Network v3 + Nutrition API</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Features:</span>
                                <span>USDA Food Database, Advanced Caching</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Last Updated:</span>
                                <span id="lastUpdateTime">Just now</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Spotify Status:</span>
                                <span id="aboutSpotifyStatus" class="text-gray-600 dark:text-gray-400">Not Connected</span>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/30 dark:to-blue-900/30 rounded-lg">
                            <div class="text-xs text-gray-600 dark:text-gray-400">
                                Life Quest RPG - Ultimate AI Edition with comprehensive nutrition tracking powered by USDA FoodData Central. 
                                Advanced multi-tier caching ensures your data never gets lost. All processing happens locally for maximum privacy.
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <div class="inline-block bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full">
                                <span class="text-xs text-gray-500 dark:text-gray-400">Build Version: </span>
                                <span class="text-xs font-mono font-bold text-primary">v2.3.0-nutrition</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Notifications -->
    <div id="notifications" class="fixed top-20 right-4 z-50 space-y-2"></div>

    <!-- Audio Elements -->
    <audio id="xpSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeCYELojN8/CMOQgSYML4xZs+HhAUbLPuzak7HQ9JsOJkXxULAA==" type="audio/wav">
    </audio>
    <audio id="achievementSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeCYELojN8+COQBAUbLPuzag8Hg9JsOLKaR8gAA==" type="audio/wav">
    </audio>

    <script>
        // üß† ADVANCED NEURAL NETWORK IMPLEMENTATION
        class AdvancedNeuralNetwork {
            constructor(layers) {
                this.layers = layers;
                this.weights = [];
                this.biases = [];
                this.learningRate = 0.01;
                this.momentum = 0.9;
                this.previousWeightDeltas = [];
                this.previousBiasDeltas = [];
                
                for (let i = 0; i < layers.length - 1; i++) {
                    this.weights[i] = this.randomMatrix(layers[i], layers[i + 1]);
                    this.biases[i] = this.randomArray(layers[i + 1]);
                    this.previousWeightDeltas[i] = this.zeroMatrix(layers[i], layers[i + 1]);
                    this.previousBiasDeltas[i] = this.zeroArray(layers[i + 1]);
                }
            }
            
            randomMatrix(rows, cols) {
                return Array(rows).fill().map(() => 
                    Array(cols).fill().map(() => (Math.random() - 0.5) * 2 / Math.sqrt(rows))
                );
            }
            
            randomArray(size) {
                return Array(size).fill().map(() => (Math.random() - 0.5) * 0.1);
            }
            
            zeroMatrix(rows, cols) {
                return Array(rows).fill().map(() => Array(cols).fill(0));
            }
            
            zeroArray(size) {
                return Array(size).fill(0);
            }
            
            sigmoid(x) {
                return 1 / (1 + Math.exp(-Math.max(-500, Math.min(500, x))));
            }
            
            relu(x) {
                return Math.max(0, x);
            }
            
            softmax(arr) {
                const maxVal = Math.max(...arr);
                const expArr = arr.map(x => Math.exp(x - maxVal));
                const sumExp = expArr.reduce((a, b) => a + b, 0);
                return expArr.map(x => x / sumExp);
            }
            
            forward(inputs) {
                let activations = [inputs];
                
                for (let i = 0; i < this.weights.length; i++) {
                    const weighted = this.matrixVectorMultiply(this.weights[i], activations[i]);
                    const biased = weighted.map((w, j) => w + this.biases[i][j]);
                    
                    let activated;
                    if (i === this.weights.length - 1) {
                        activated = this.softmax(biased);
                    } else {
                        activated = biased.map(x => this.relu(x));
                    }
                    
                    activations.push(activated);
                }
                
                return activations;
            }
            
            matrixVectorMultiply(matrix, vector) {
                return Array(matrix[0].length).fill().map((_, j) =>
                    matrix.reduce((sum, row, i) => sum + row[j] * vector[i], 0)
                );
            }
            
            predict(inputs) {
                const activations = this.forward(inputs);
                return activations[activations.length - 1];
            }
            
            backpropagate(inputs, expectedOutputs) {
                try {
                    const activations = this.forward(inputs);
                    const outputs = activations[activations.length - 1];
                    
                    const outputErrors = outputs.map((output, i) => expectedOutputs[i] - output);
                    
                    for (let i = this.weights.length - 1; i >= 0; i--) {
                        for (let j = 0; j < this.weights[i].length; j++) {
                            for (let k = 0; k < this.weights[i][j].length; k++) {
                                const delta = this.learningRate * outputErrors[k] * activations[i][j];
                                this.weights[i][j][k] += delta + this.momentum * this.previousWeightDeltas[i][j][k];
                                this.previousWeightDeltas[i][j][k] = delta;
                            }
                        }
                        
                        for (let j = 0; j < this.biases[i].length; j++) {
                            const delta = this.learningRate * outputErrors[j];
                            this.biases[i][j] += delta + this.momentum * this.previousBiasDeltas[i][j];
                            this.previousBiasDeltas[i][j] = delta;
                        }
                    }
                } catch (error) {
                    console.warn('Backpropagation warning:', error.message);
                }
            }
        }

        // üìä MACHINE LEARNING ENGINE
        class MachineLearningEngine {
            constructor() {
                this.patterns = new Map();
                this.correlationMatrix = {};
                this.anomalyThreshold = 2.0;
            }
            
            analyzeTimeSeries(data, order = 2) {
                if (data.length < order + 1) return { forecast: data[data.length - 1] || 0, confidence: 0.5 };
                
                const arCoefficients = this.calculateARCoefficients(data, order);
                const forecast = arCoefficients.reduce((sum, coef, i) => 
                    sum + coef * data[data.length - 1 - i], 0
                );
                
                const residuals = this.calculateResiduals(data, arCoefficients, order);
                const maComponent = residuals.slice(-order).reduce((sum, r) => sum + r, 0) / order;
                const finalForecast = forecast + 0.3 * maComponent;
                const confidence = this.calculateForecastConfidence(data, arCoefficients);
                
                return { 
                    forecast: finalForecast, 
                    confidence,
                    trend: this.calculateTrend(data),
                    seasonality: this.detectSeasonality(data)
                };
            }
            
            calculateARCoefficients(data, order) {
                const autocorrelations = this.calculateAutocorrelations(data, order);
                const coefficients = [];
                
                for (let i = 0; i < order; i++) {
                    coefficients[i] = autocorrelations[i + 1] / (autocorrelations[0] + 0.001);
                }
                
                return coefficients;
            }
            
            calculateAutocorrelations(data, maxLag) {
                const n = data.length;
                const mean = data.reduce((a, b) => a + b) / n;
                const variance = data.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / n;
                
                const autocorrs = [];
                for (let lag = 0; lag <= maxLag; lag++) {
                    let sum = 0;
                    for (let i = 0; i < n - lag; i++) {
                        sum += (data[i] - mean) * (data[i + lag] - mean);
                    }
                    autocorrs[lag] = sum / ((n - lag) * variance);
                }
                
                return autocorrs;
            }
            
            calculateResiduals(data, arCoefficients, order) {
                const residuals = [];
                for (let i = order; i < data.length; i++) {
                    const predicted = arCoefficients.reduce((sum, coef, j) => 
                        sum + coef * data[i - 1 - j], 0
                    );
                    residuals.push(data[i] - predicted);
                }
                return residuals;
            }
            
            calculateTrend(data) {
                if (data.length < 5) return 0;
                const recent = data.slice(-5);
                const earlier = data.slice(-10, -5);
                const recentAvg = recent.reduce((a, b) => a + b) / recent.length;
                const earlierAvg = earlier.reduce((a, b) => a + b) / earlier.length;
                return (recentAvg - earlierAvg) / (earlierAvg + 1);
            }
            
            detectSeasonality(data) {
                if (data.length < 14) return 0;
                
                const weekLength = 7;
                if (data.length >= weekLength * 2) {
                    const recentWeek = data.slice(-weekLength);
                    const previousWeek = data.slice(-weekLength * 2, -weekLength);
                    return Math.abs(this.calculateCorrelation(recentWeek, previousWeek));
                }
                return 0;
            }
            
            calculateCorrelation(x, y) {
                if (x.length !== y.length || x.length < 2) return 0;
                
                const meanX = x.reduce((a, b) => a + b) / x.length;
                const meanY = y.reduce((a, b) => a + b) / y.length;
                
                const numerator = x.reduce((sum, xi, i) => sum + (xi - meanX) * (y[i] - meanY), 0);
                const denomX = Math.sqrt(x.reduce((sum, xi) => sum + Math.pow(xi - meanX, 2), 0));
                const denomY = Math.sqrt(y.reduce((sum, yi) => sum + Math.pow(yi - meanY, 2), 0));
                
                return denomX * denomY === 0 ? 0 : numerator / (denomX * denomY);
            }
            
            calculateForecastConfidence(data, coefficients) {
                const errors = this.calculateResiduals(data, coefficients, coefficients.length);
                const mse = errors.reduce((sum, e) => sum + e * e, 0) / errors.length;
                return Math.max(0, Math.min(1, 1 - Math.sqrt(mse) / 10));
            }
        }

        // üè™ ADVANCED STORAGE MANAGER WITH MULTI-TIER CACHING
        class AdvancedStorageManager {
            constructor() {
                this.primaryKey = 'lifeQuestAI_v2.3';
                this.backupKeys = [
                    'lifeQuestAI_backup1',
                    'lifeQuestAI_backup2', 
                    'lifeQuestAI_backup3'
                ];
                this.saveCounter = parseInt(localStorage.getItem('saveCounter') || '0');
                this.integrityHashes = new Map();
            }
            
            generateChecksum(data) {
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(16);
            }
            
            save(trigger = 'manual') {
                const startTime = performance.now();
                const saveId = `save_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                try {
                    const dataToSave = {
                        ...gameState,
                        meta: {
                            saveId,
                            timestamp: Date.now(),
                            trigger,
                            version: '2.3.0',
                            saveCounter: ++this.saveCounter
                        }
                    };
                    
                    const jsonData = JSON.stringify(dataToSave);
                    const checksum = this.generateChecksum(dataToSave);
                    
                    localStorage.setItem(this.primaryKey, jsonData);
                    localStorage.setItem(`${this.primaryKey}_checksum`, checksum);
                    localStorage.setItem('saveCounter', this.saveCounter.toString());
                    
                    const backupIndex = this.saveCounter % this.backupKeys.length;
                    localStorage.setItem(this.backupKeys[backupIndex], jsonData);
                    localStorage.setItem(`${this.backupKeys[backupIndex]}_checksum`, checksum);
                    
                    this.integrityHashes.set(saveId, checksum);
                    
                    const duration = performance.now() - startTime;
                    return {
                        success: true,
                        saveId,
                        duration: Math.round(duration * 100) / 100,
                        method: 'advanced',
                        backupIndex
                    };
                    
                } catch (error) {
                    return {
                        success: false,
                        error: error.message,
                        saveId
                    };
                }
            }
            
            load() {
                const loadId = `load_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                let data = this.loadFromKey(this.primaryKey, 'primary');
                if (data.success) {
                    Object.assign(gameState, data.gameState);
                    return { success: true, source: 'primary', loadId };
                }
                
                for (let i = this.backupKeys.length - 1; i >= 0; i--) {
                    data = this.loadFromKey(this.backupKeys[i], `backup${i + 1}`);
                    if (data.success) {
                        Object.assign(gameState, data.gameState);
                        return { success: true, source: `backup${i + 1}`, loadId };
                    }
                }
                
                return { success: false, error: 'No valid save data found', loadId };
            }
            
            loadFromKey(key, source) {
                try {
                    const jsonData = localStorage.getItem(key);
                    const expectedChecksum = localStorage.getItem(`${key}_checksum`);
                    
                    if (!jsonData) return { success: false, error: `No data in ${source}` };
                    
                    const parsedData = JSON.parse(jsonData);
                    
                    if (expectedChecksum) {
                        const actualChecksum = this.generateChecksum(parsedData);
                        if (actualChecksum !== expectedChecksum) {
                            return { success: false, error: `Checksum mismatch in ${source}` };
                        }
                    }
                    
                    return { success: true, gameState: parsedData };
                    
                } catch (error) {
                    return { success: false, error: `Parse error in ${source}: ${error.message}` };
                }
            }
            
            getStorageInfo() {
                const info = {
                    primaryExists: !!localStorage.getItem(this.primaryKey),
                    backups: this.backupKeys.map(key => ({
                        key,
                        exists: !!localStorage.getItem(key),
                        hasChecksum: !!localStorage.getItem(`${key}_checksum`)
                    })),
                    saveCounter: this.saveCounter,
                    totalSize: 0
                };
                
                for (let key in localStorage) {
                    if (key.startsWith('lifeQuestAI')) {
                        info.totalSize += localStorage.getItem(key).length;
                    }
                }
                
                return info;
            }
        }

        // üêõ COMPREHENSIVE DEBUG CONSOLE
        class DebugConsole {
            constructor() {
                this.entries = [];
                this.maxEntries = 500;
                this.filters = new Set(['all']);
                this.isVisible = false;
            }
            
            addEntry(category, level, message, data = {}) {
                const entry = {
                    id: `debug_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`,
                    timestamp: new Date().toISOString(),
                    category,
                    level,
                    message,
                    data: JSON.parse(JSON.stringify(data)),
                    sessionTime: Date.now() - (parseInt(localStorage.getItem('appStartTime')) || Date.now())
                };
                
                this.entries.unshift(entry);
                
                if (this.entries.length > this.maxEntries) {
                    this.entries = this.entries.slice(0, this.maxEntries);
                }
                
                const consoleMethod = level === 'error' ? 'error' : level === 'warn' ? 'warn' : 'log';
                console[consoleMethod](`[${category.toUpperCase()}] ${message}`, data);
                
                if (this.isVisible) {
                    this.updateDebugUI();
                }
            }
            
            show() {
                this.isVisible = true;
                const modal = document.createElement('div');
                modal.id = 'debugConsole';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full h-full max-w-6xl max-h-[90vh] flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-purple-700 dark:text-purple-300">üîç Advanced Debug Console</h3>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm text-gray-500">${this.entries.length} entries</span>
                                <button onclick="clearDebugLog()" class="text-red-500 hover:text-red-700 text-sm">Clear</button>
                                <button onclick="exportDebugLog()" class="text-blue-500 hover:text-blue-700 text-sm">Export</button>
                                <button onclick="hideDebugConsole()" class="text-gray-400 hover:text-gray-600 text-xl">√ó</button>
                            </div>
                        </div>
                        
                        <div class="mb-4 flex flex-wrap gap-2" id="debugFilters"></div>
                        
                        <div class="flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-900 rounded-lg p-4 font-mono text-sm" id="debugEntries"></div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600 text-xs text-gray-500">
                            <div class="grid grid-cols-3 gap-4">
                                <div>Storage: ${storageManager ? storageManager.getStorageInfo().totalSize : 0} chars</div>
                                <div>Session: ${Math.round((Date.now() - (parseInt(localStorage.getItem('appStartTime')) || Date.now())) / 1000)}s</div>
                                <div>Build: v2.3.0-nutrition</div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                this.updateFilters();
                this.updateDebugUI();
            }
            
            updateFilters() {
                const categories = [...new Set(this.entries.map(e => e.category))];
                const filtersContainer = document.getElementById('debugFilters');
                if (!filtersContainer) return;
                
                const filterButtons = [
                    { key: 'all', label: 'All', count: this.entries.length },
                    ...categories.map(cat => ({
                        key: cat,
                        label: cat.charAt(0).toUpperCase() + cat.slice(1),
                        count: this.entries.filter(e => e.category === cat).length
                    }))
                ];
                
                filtersContainer.innerHTML = filterButtons.map(filter => `
                    <button onclick="setDebugFilter('${filter.key}')" 
                            class="debug-filter-btn ${this.filters.has(filter.key) || this.filters.has('all') ? 'active' : ''}">
                        ${filter.label} (${filter.count})
                    </button>
                `).join('');
            }
            
            updateDebugUI() {
                const entriesContainer = document.getElementById('debugEntries');
                if (!entriesContainer) return;
                
                const filteredEntries = this.entries.filter(entry => 
                    this.filters.has('all') || this.filters.has(entry.category)
                );
                
                entriesContainer.innerHTML = filteredEntries.map(entry => {
                    const levelColor = {
                        error: 'text-red-600 dark:text-red-400',
                        warn: 'text-yellow-600 dark:text-yellow-400',
                        success: 'text-green-600 dark:text-green-400',
                        info: 'text-blue-600 dark:text-blue-400'
                    }[entry.level] || 'text-gray-600 dark:text-gray-400';
                    
                    return `
                        <div class="mb-3 p-3 bg-white dark:bg-gray-800 rounded border-l-4 border-l-${entry.level === 'error' ? 'red' : entry.level === 'warn' ? 'yellow' : entry.level === 'success' ? 'green' : 'blue'}-500">
                            <div class="flex items-start justify-between mb-1">
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs">${entry.category.toUpperCase()}</span>
                                    <span class="${levelColor} font-semibold">${entry.level.toUpperCase()}</span>
                                </div>
                                <span class="text-xs text-gray-500">${new Date(entry.timestamp).toLocaleTimeString()}</span>
                            </div>
                            <div class="text-gray-800 dark:text-gray-200 mb-2">${entry.message}</div>
                            ${Object.keys(entry.data).length > 0 ? `
                                <details class="text-xs">
                                    <summary class="cursor-pointer text-gray-500 hover:text-gray-700">Data (${Object.keys(entry.data).length} properties)</summary>
                                    <pre class="mt-2 p-2 bg-gray-100 dark:bg-gray-700 rounded overflow-x-auto">${JSON.stringify(entry.data, null, 2)}</pre>
                                </details>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }
            
            setFilter(category) {
                if (category === 'all') {
                    this.filters = new Set(['all']);
                } else {
                    this.filters = new Set([category]);
                }
                this.updateFilters();
                this.updateDebugUI();
            }
            
            clear() {
                this.entries = [];
                this.updateDebugUI();
                this.updateFilters();
            }
            
            export() {
                const exportData = {
                    timestamp: new Date().toISOString(),
                    version: '2.3.0-nutrition',
                    sessionDuration: Date.now() - (parseInt(localStorage.getItem('appStartTime')) || Date.now()),
                    entries: this.entries,
                    gameState: {
                        level: gameState.level,
                        xp: gameState.xp,
                        stats: gameState.dailyStats
                    }
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `life-quest-debug-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            hide() {
                this.isVisible = false;
                const modal = document.getElementById('debugConsole');
                if (modal) modal.remove();
            }
        }

        // üéÆ COMPREHENSIVE GAME STATE WITH ENHANCED CACHING
        let gameState = {
            level: 1,
            xp: 0,
            totalXP: 0,
            currentStreak: 0,
            profile: {
                height: 0,
                weight: 0,
                age: 0,
                gender: '',
                activityLevel: '',
                fitnessGoal: '',
                equipment: [],
                healthConditions: []
            },
            healthMetrics: {
                bmi: 0,
                bmr: 0,
                tdee: 0,
                idealWeight: { min: 0, max: 0 },
                bodyFatPercentage: 0,
                waterRequirement: 0,
                proteinRequirement: 0,
                dailyCalorieTarget: 0,
                dailyStepsTarget: 0,
                weeklyExerciseMinutes: 0
            },
            dailyStats: {
                workouts: 0,
                waterGlasses: 0,
                calories: 0,
                protein: 0,
                carbs: 0,
                fat: 0,
                tasksCompleted: 0,
                totalTasks: 0,
                caloriesBurned: 0,
                exerciseMinutes: 0,
                steps: 0
            },
            tasks: [],
            achievements: [],
            interests: ['fitness', 'productivity', 'learning'],
            patterns: {
                activities: {},
                preferences: {},
                timing: {},
                learning: {
                    enabled: true,
                    confidence: 0.85,
                    patterns: []
                }
            },
            ai: {
                neuralNetwork: null,
                mlEngine: null,
                confidence: 0.85,
                lastUpdate: Date.now(),
                predictions: {},
                insights: [],
                taskContext: {
                    completionTimes: {},
                    successfulPatterns: {},
                    optimalTimings: {}
                }
            },
            settings: {
                notifications: true,
                animations: true,
                soundEffects: true,
                aiLearning: true,
                spotifyClientId: '',
                spotifyRedirectUri: ''
            }
        };

        // üéØ NEURAL NETWORK AND ML INITIALIZATION
        let neuralNetwork, mlEngine, storageManager, debugConsole;

        function initializeAI() {
            try {
                neuralNetwork = new AdvancedNeuralNetwork([12, 16, 8, 4]);
                mlEngine = new MachineLearningEngine();
                
                const trainingData = generateTrainingData(1000);
                for (let epoch = 0; epoch < 100; epoch++) {
                    trainingData.forEach(({ inputs, outputs }) => {
                        neuralNetwork.backpropagate(inputs, outputs);
                    });
                }
                
                gameState.ai.neuralNetwork = true;
                gameState.ai.mlEngine = true;
                
                addDebugEntry('ai', 'success', 'Advanced AI systems initialized successfully');
                updateAIDisplay();
            } catch (error) {
                addDebugEntry('ai', 'error', 'AI initialization error', { error: error.message });
            }
        }

        function generateTrainingData(size) {
            return Array(size).fill().map(() => {
                const inputs = Array(12).fill().map(() => Math.random());
                const outputs = [
                    inputs[0] * 0.3 + inputs[1] * 0.2 + Math.random() * 0.1,
                    inputs[2] * 0.4 + inputs[3] * 0.3 + Math.random() * 0.1,
                    inputs[4] * 0.25 + inputs[5] * 0.35 + Math.random() * 0.1,
                    inputs[6] * 0.2 + inputs[7] * 0.3 + Math.random() * 0.1
                ].map(x => Math.max(0, Math.min(1, x)));
                
                return { inputs, outputs };
            });
        }

        function initializeStorageManager() {
            try {
                storageManager = new AdvancedStorageManager();
                return true;
            } catch (error) {
                addDebugEntry('storage', 'error', 'Storage manager initialization failed', { error: error.message });
                return false;
            }
        }

        function initializeDebugConsole() {
            debugConsole = new DebugConsole();
            return debugConsole;
        }

        function addDebugEntry(category, level, message, data = {}) {
            if (debugConsole) {
                debugConsole.addEntry(category, level, message, data);
            }
        }

        function showDebugConsole() {
            if (!debugConsole) {
                debugConsole = initializeDebugConsole();
            }
            debugConsole.show();
        }

        function hideDebugConsole() {
            if (debugConsole) {
                debugConsole.hide();
            }
        }

        function setDebugFilter(category) {
            if (debugConsole) {
                debugConsole.setFilter(category);
            }
        }

        function clearDebugLog() {
            if (debugConsole) {
                debugConsole.clear();
                showFloatingNotification('üóëÔ∏è Debug Cleared', 'Debug log has been cleared');
            }
        }

        function exportDebugLog() {
            if (debugConsole) {
                debugConsole.export();
                showFloatingNotification('üì• Debug Exported', 'Debug log exported successfully');
            }
        }

        // üéÆ XP AND LEVEL SYSTEM WITH ENHANCED TRACKING
        function awardXP(amount, reason = '') {
            const prevXP = gameState.xp;
            const prevLevel = gameState.level;
            
            gameState.xp += amount;
            gameState.totalXP += amount;
            
            addDebugEntry('xp', 'success', `XP awarded: +${amount}`, {
                reason,
                prevXP,
                newXP: gameState.xp,
                amount
            });
            
            const nextLevelXP = calculateNextLevelXP(gameState.level);
            if (gameState.xp >= nextLevelXP) {
                levelUp();
            }
            
            showXPAnimation(amount, reason);
            updatePlayerUI();
            saveGameState('xp_awarded');
        }

        function calculateNextLevelXP(level) {
            return Math.floor(100 * Math.pow(1.2, level - 1));
        }

        function levelUp() {
            const oldLevel = gameState.level;
            gameState.level++;
            gameState.xp = Math.max(0, gameState.xp - calculateNextLevelXP(oldLevel));
            
            addDebugEntry('xp', 'success', `Level up! ${oldLevel} ‚Üí ${gameState.level}`, {
                oldLevel,
                newLevel: gameState.level,
                remainingXP: gameState.xp
            });
            
            showFloatingNotification('üéâ LEVEL UP!', `Congratulations! You reached Level ${gameState.level}!`);
            
            if (gameState.settings.soundEffects) {
                document.getElementById('achievementSound').play().catch(() => {});
            }
            
            addAchievement(`üéâ Level ${gameState.level}!`, `Reached Level ${gameState.level}`, 100);
            updatePlayerUI();
        }

        function showXPAnimation(amount, reason) {
            const header = document.querySelector('header');
            if (!header) return;
            
            const xpBurst = document.createElement('div');
            xpBurst.className = 'absolute top-4 right-4 text-yellow-400 font-bold text-lg xp-burst z-20';
            xpBurst.textContent = `+${amount} XP`;
            if (reason) {
                xpBurst.title = reason;
            }
            
            header.style.position = 'relative';
            header.appendChild(xpBurst);
            
            setTimeout(() => {
                if (xpBurst.parentNode) {
                    xpBurst.parentNode.removeChild(xpBurst);
                }
            }, 2000);
        }

        function updatePlayerUI() {
            const currentXP = gameState.xp;
            const nextLevelXP = calculateNextLevelXP(gameState.level);
            const progressPercent = Math.round((currentXP / nextLevelXP) * 100);
            
            const elements = {
                playerLevel: `Level ${gameState.level}`,
                currentXP: currentXP.toString(),
                nextLevelXP: nextLevelXP.toString(),
                xpProgressPercent: `${progressPercent}%`
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
            
            const progressBar = document.getElementById('xpProgress');
            if (progressBar) {
                progressBar.style.width = `${progressPercent}%`;
            }
            
            addDebugEntry('ui', 'info', 'Player UI updated', {
                level: gameState.level,
                xp: currentXP,
                nextLevelXP,
                progressPercent
            });
        }

        // üèÜ ACHIEVEMENTS SYSTEM WITH ENHANCED TRACKING
        function addAchievement(title, description, xpReward = 50) {
            if (hasAchievement(title)) {
                addDebugEntry('achievements', 'warn', `Achievement already exists: ${title}`);
                return;
            }
            
            const achievement = {
                id: `achievement_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                title,
                description,
                xpReward,
                timestamp: Date.now(),
                date: new Date().toLocaleDateString()
            };
            
            gameState.achievements.push(achievement);
            
            addDebugEntry('achievements', 'success', `Achievement unlocked: ${title}`, {
                achievement,
                totalAchievements: gameState.achievements.length
            });
            
            awardXP(xpReward, `Achievement: ${title}`);
            showFloatingNotification('üèÜ Achievement Unlocked!', title, 'achievement');
            
            if (gameState.settings.soundEffects) {
                document.getElementById('achievementSound').play().catch(() => {});
            }
            
            updateAchievementsUI();
            saveGameState('achievement_added');
            
            return achievement;
        }

        function hasAchievement(title) {
            return gameState.achievements.some(achievement => achievement.title === title);
        }

        function updateAchievementsUI() {
            const achievementsList = document.getElementById('achievementsList');
            if (!achievementsList) return;
            
            if (gameState.achievements.length === 0) {
                achievementsList.innerHTML = `
                    <div class="text-center py-6 text-gray-500 dark:text-gray-400">
                        <div class="text-3xl mb-2">üèÜ</div>
                        <div class="text-sm">Complete tasks to unlock achievements!</div>
                    </div>
                `;
                return;
            }
            
            const recentAchievements = gameState.achievements
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 10);
            
            achievementsList.innerHTML = recentAchievements.map(achievement => `
                <div class="flex items-center space-x-3 p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg border border-yellow-200 dark:border-yellow-700">
                    <div class="text-2xl">üèÜ</div>
                    <div class="flex-1">
                        <div class="font-semibold text-yellow-800 dark:text-yellow-200">${achievement.title}</div>
                        <div class="text-sm text-yellow-600 dark:text-yellow-300">${achievement.description}</div>
                        <div class="text-xs text-yellow-500 dark:text-yellow-400">+${achievement.xpReward} XP ‚Ä¢ ${achievement.date}</div>
                    </div>
                </div>
            `).join('');
            
            addDebugEntry('ui', 'info', 'Achievements UI updated', {
                totalAchievements: gameState.achievements.length,
                displayedAchievements: recentAchievements.length
            });
        }

        // üìã ENHANCED TASK MANAGEMENT SYSTEM
        function addCustomTask() {
            showTaskCreationModal();
        }

        function showTaskCreationModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">‚ûï Create New Quest</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">üìù Quest Title</label>
                            <input type="text" id="taskTitle" placeholder="e.g., Complete morning workout" 
                                   class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">üìä Category</label>
                            <select id="taskCategory" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <option value="fitness">üí™ Fitness</option>
                                <option value="nutrition">ü•ó Nutrition</option>
                                <option value="wellness">üßò Wellness</option>
                                <option value="productivity">üìã Productivity</option>
                                <option value="learning">üìö Learning</option>
                                <option value="personal">üë§ Personal</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">‚≠ê Difficulty</label>
                            <select id="taskDifficulty" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <option value="easy">Easy (10 XP)</option>
                                <option value="medium" selected>Medium (25 XP)</option>
                                <option value="hard">Hard (50 XP)</option>
                                <option value="extreme">Extreme (100 XP)</option>
                            </select>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="createCustomTask()" class="flex-1 bg-primary text-white py-3 rounded-lg hover:bg-purple-600 transition-all font-medium">
                                ‚úÖ Create Quest
                            </button>
                            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-all">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('taskTitle').focus();
        }

        function createCustomTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const category = document.getElementById('taskCategory').value;
            const difficulty = document.getElementById('taskDifficulty').value;
            
            if (!title) {
                showFloatingNotification('‚ö†Ô∏è Missing Title', 'Please enter a quest title');
                return;
            }
            
            const xpMap = { easy: 10, medium: 25, hard: 50, extreme: 100 };
            const task = createTask(title, category, xpMap[difficulty], difficulty);
            
            addDebugEntry('tasks', 'success', `Custom task created: ${title}`, {
                task,
                category,
                difficulty,
                xpReward: xpMap[difficulty]
            });
            
            document.querySelector('.modal-overlay').remove();
            showFloatingNotification('‚ûï Quest Created!', `"${title}" added to your quest log`);
            
            updateTasksUI();
            saveGameState('task_created');
        }

        function createTask(title, category, xpReward, difficulty = 'medium') {
            const task = {
                id: `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                title,
                category,
                xpReward,
                difficulty,
                completed: false,
                createdAt: Date.now(),
                completedAt: null
            };
            
            gameState.tasks.push(task);
            gameState.dailyStats.totalTasks++;
            
            return task;
        }

        function completeTask(taskId) {
            const task = gameState.tasks.find(t => t.id === taskId);
            if (!task || task.completed) return;
            
            const prevCompleted = gameState.dailyStats.tasksCompleted;
            
            task.completed = true;
            task.completedAt = Date.now();
            gameState.dailyStats.tasksCompleted++;
            
            addDebugEntry('tasks', 'success', `Task completed: ${task.title}`, {
                taskId,
                task,
                prevCompleted,
                newCompleted: gameState.dailyStats.tasksCompleted
            });
            
            awardXP(task.xpReward, `Completed: ${task.title}`);
            
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskElement) {
                taskElement.classList.add('task-completion-effect');
            }
            
            showFloatingNotification('‚úÖ Quest Complete!', `${task.title} (+${task.xpReward} XP)`);
            
            checkTaskAchievements();
            updateStatsUI();
            updateTasksUI();
            saveGameState('task_completed');
        }

        function checkTaskAchievements() {
            const completed = gameState.dailyStats.tasksCompleted;
            
            if (completed === 1 && !hasAchievement('First Quest')) {
                addAchievement('üéØ First Quest!', 'Completed your first quest today', 25);
            }
            if (completed === 5 && !hasAchievement('Quest Warrior')) {
                addAchievement('‚öîÔ∏è Quest Warrior!', 'Completed 5 quests in one day', 50);
            }
            if (completed === 10 && !hasAchievement('Quest Master')) {
                addAchievement('üèÜ Quest Master!', 'Completed 10 quests in one day', 100);
            }
        }

        function updateTasksUI() {
            updateTasksList();
            updateTasksDetailed();
            updateTaskAnalytics();
        }

        function updateTasksList() {
            const tasksList = document.getElementById('tasksList');
            if (!tasksList) return;
            
            const activeTasks = gameState.tasks.filter(t => !t.completed).slice(0, 5);
            
            if (activeTasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="text-center py-6 text-gray-500 dark:text-gray-400">
                        <div class="text-3xl mb-2">üìã</div>
                        <div class="text-sm">No active quests. Create one to get started!</div>
                    </div>
                `;
                return;
            }
            
            tasksList.innerHTML = activeTasks.map(task => {
                const difficultyColors = {
                    easy: 'text-green-600 bg-green-50 dark:bg-green-900/30',
                    medium: 'text-yellow-600 bg-yellow-50 dark:bg-yellow-900/30',
                    hard: 'text-orange-600 bg-orange-50 dark:bg-orange-900/30',
                    extreme: 'text-red-600 bg-red-50 dark:bg-red-900/30'
                };
                
                const categoryEmojis = {
                    fitness: 'üí™',
                    nutrition: 'ü•ó',
                    wellness: 'üßò',
                    productivity: 'üìã',
                    learning: 'üìö',
                    personal: 'üë§'
                };
                
                return `
                    <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-all" data-task-id="${task.id}">
                        <button onclick="completeTask('${task.id}')" class="flex-shrink-0 w-6 h-6 border-2 border-gray-300 dark:border-gray-500 rounded hover:border-green-500 hover:bg-green-50 dark:hover:bg-green-900/30 transition-all">
                        </button>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800 dark:text-gray-200">${task.title}</div>
                            <div class="flex items-center space-x-2 text-xs">
                                <span>${categoryEmojis[task.category]} ${task.category}</span>
                                <span class="px-2 py-1 rounded ${difficultyColors[task.difficulty]}">${task.xpReward} XP</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateTasksDetailed() {
            const tasksListDetailed = document.getElementById('tasksListDetailed');
            if (!tasksListDetailed) return;
            
            const activeTasks = gameState.tasks.filter(t => !t.completed);
            
            if (activeTasks.length === 0) {
                tasksListDetailed.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <div class="text-4xl mb-3">üéØ</div>
                        <div class="text-lg font-medium mb-2">No Active Quests</div>
                        <div class="text-sm">Create your first quest to start your adventure!</div>
                    </div>
                `;
                return;
            }
            
            tasksListDetailed.innerHTML = activeTasks.map(task => {
                const difficultyColors = {
                    easy: 'border-green-500 bg-green-50 dark:bg-green-900/30',
                    medium: 'border-yellow-500 bg-yellow-50 dark:bg-yellow-900/30',
                    hard: 'border-orange-500 bg-orange-50 dark:bg-orange-900/30',
                    extreme: 'border-red-500 bg-red-50 dark:bg-red-900/30'
                };
                
                const categoryEmojis = {
                    fitness: 'üí™',
                    nutrition: 'ü•ó',
                    wellness: 'üßò',
                    productivity: 'üìã',
                    learning: 'üìö',
                    personal: 'üë§'
                };
                
                const timeAgo = Math.round((Date.now() - task.createdAt) / (1000 * 60));
                const timeDisplay = timeAgo < 60 ? `${timeAgo}m ago` : `${Math.round(timeAgo / 60)}h ago`;
                
                return `
                    <div class="p-4 border-l-4 ${difficultyColors[task.difficulty]} rounded-lg" data-task-id="${task.id}">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-1">${task.title}</h4>
                                <div class="flex items-center space-x-3 text-sm text-gray-600 dark:text-gray-400">
                                    <span>${categoryEmojis[task.category]} ${task.category}</span>
                                    <span>‚≠ê ${task.difficulty}</span>
                                    <span>üéØ ${task.xpReward} XP</span>
                                    <span>‚è∞ ${timeDisplay}</span>
                                </div>
                            </div>
                            <button onclick="completeTask('${task.id}')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-all font-medium">
                                ‚úÖ Complete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateTaskAnalytics() {
            const totalTasks = gameState.tasks.length;
            const completedTasks = gameState.tasks.filter(t => t.completed).length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            const completedTasksWithTime = gameState.tasks.filter(t => t.completed && t.completedAt);
            const avgTime = completedTasksWithTime.length > 0 
                ? Math.round(completedTasksWithTime.reduce((sum, task) => sum + (task.completedAt - task.createdAt), 0) / completedTasksWithTime.length / (1000 * 60))
                : 0;
            
            const totalXPEarned = gameState.tasks.filter(t => t.completed).reduce((sum, task) => sum + task.xpReward, 0);
            
            const elements = {
                completionRate: `${completionRate}%`,
                averageTime: `${avgTime}m`,
                streakCount: gameState.currentStreak.toString(),
                totalXPEarned: totalXPEarned.toString()
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
        }

        // üß† AI TASK GENERATION WITH ENHANCED INTELLIGENCE
        async function generateAITasks() {
            showFloatingNotification('üß† AI Working...', 'Generating personalized tasks based on your patterns');
            
            try {
                const context = getAIContext();
                const prompt = buildTaskGenerationPrompt(context);
                
                addDebugEntry('ai', 'info', 'Starting AI task generation', { context });
                
                if (window.Poe && window.Poe.sendUserMessage) {
                    window.Poe.registerHandler('ai-task-generator', (result) => {
                        if (result.status === 'complete') {
                            const response = result.responses[0];
                            if (response.status === 'complete') {
                                parseAITaskResponse(response.content);
                            } else if (response.status === 'error') {
                                addDebugEntry('ai', 'error', 'AI task generation failed', { error: response.statusText });
                                generateFallbackTasks(context);
                            }
                        }
                    });
                    
                    await window.Poe.sendUserMessage(prompt, {
                        handler: 'ai-task-generator',
                        stream: false,
                        openChat: false
                    });
                    
                } else {
                    addDebugEntry('ai', 'warn', 'Poe API not available, using fallback AI');
                    generateFallbackTasks(context);
                }
                
            } catch (error) {
                addDebugEntry('ai', 'error', 'AI task generation error', { error: error.message });
                generateFallbackTasks(getAIContext());
            }
        }

        function getAIContext() {
            const timeOfDay = new Date().getHours() < 12 ? 'morning' : new Date().getHours() < 17 ? 'afternoon' : 'evening';
            const completedCategories = {};
            
            gameState.tasks.filter(t => t.completed).forEach(task => {
                completedCategories[task.category] = (completedCategories[task.category] || 0) + 1;
            });
            
            return {
                timeOfDay,
                interests: gameState.interests || ['fitness', 'productivity'],
                completedCategories,
                level: gameState.level,
                dailyStats: gameState.dailyStats,
                profile: gameState.profile,
                preferences: {
                    fitnessGoal: gameState.profile.fitnessGoal,
                    equipment: gameState.profile.equipment,
                    activityLevel: gameState.profile.activityLevel
                }
            };
        }

        function buildTaskGenerationPrompt(context) {
            return `@Claude-Sonnet-4 Generate 4-6 personalized daily tasks for a life improvement RPG app. Provide ONLY raw JSON in your response with no explanations, additional text, or code block formatting (no \`\`\`).

Context:
- Time: ${context.timeOfDay}
- Interests: ${context.interests.join(', ')}
- User Level: ${context.level}
- Fitness Goal: ${context.preferences.fitnessGoal || 'general health'}
- Activity Level: ${context.preferences.activityLevel || 'moderate'}
- Today's Stats: ${context.dailyStats.workouts} workouts, ${context.dailyStats.waterGlasses} water glasses, ${context.dailyStats.tasksCompleted} tasks completed

Required JSON format:
{
  "tasks": [
    {
      "title": "Specific, actionable task title",
      "category": "fitness|nutrition|wellness|productivity|learning|personal",
      "difficulty": "easy|medium|hard",
      "xpReward": 10-100,
      "reasoning": "Brief explanation why this task fits the user"
    }
  ]
}

Make tasks specific, achievable, and tailored to the user's context and interests.`;
        }

        function parseAITaskResponse(content) {
            try {
                let cleanContent = content.trim();
                
                const jsonMatch = cleanContent.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    cleanContent = jsonMatch[0];
                }
                
                const response = JSON.parse(cleanContent);
                
                if (response.tasks && Array.isArray(response.tasks)) {
                    let tasksAdded = 0;
                    
                    response.tasks.forEach(taskData => {
                        if (taskData.title && taskData.category) {
                            createTask(
                                taskData.title,
                                taskData.category,
                                taskData.xpReward || 25,
                                taskData.difficulty || 'medium'
                            );
                            tasksAdded++;
                        }
                    });
                    
                    addDebugEntry('ai', 'success', `AI generated ${tasksAdded} tasks`, { tasksAdded, response });
                    
                    updateTasksUI();
                    saveGameState('ai_tasks_generated');
                    
                    showFloatingNotification('üß† AI Tasks Generated!', `${tasksAdded} personalized tasks added to your quest log`);
                } else {
                    throw new Error('Invalid response format');
                }
                
            } catch (error) {
                addDebugEntry('ai', 'error', 'Failed to parse AI response', { error: error.message, content });
                generateFallbackTasks(getAIContext());
            }
        }

        function generateFallbackTasks(context) {
            const timeBasedTasks = {
                morning: [
                    { title: 'Complete morning stretching routine', category: 'fitness', difficulty: 'easy', xpReward: 15 },
                    { title: 'Plan your daily priorities', category: 'productivity', difficulty: 'medium', xpReward: 20 },
                    { title: 'Drink a glass of water upon waking', category: 'nutrition', difficulty: 'easy', xpReward: 5 },
                    { title: 'Practice 5 minutes of meditation', category: 'wellness', difficulty: 'easy', xpReward: 10 }
                ],
                afternoon: [
                    { title: 'Take a 15-minute walk outside', category: 'fitness', difficulty: 'easy', xpReward: 15 },
                    { title: 'Complete one important work task', category: 'productivity', difficulty: 'medium', xpReward: 25 },
                    { title: 'Have a healthy lunch with protein', category: 'nutrition', difficulty: 'medium', xpReward: 20 },
                    { title: 'Read an article or book chapter', category: 'learning', difficulty: 'medium', xpReward: 20 }
                ],
                evening: [
                    { title: 'Do 10 minutes of yoga or stretching', category: 'wellness', difficulty: 'easy', xpReward: 15 },
                    { title: 'Prepare for tomorrow (clothes, meals)', category: 'productivity', difficulty: 'medium', xpReward: 20 },
                    { title: 'Reflect on three positive moments today', category: 'personal', difficulty: 'easy', xpReward: 10 },
                    { title: 'Limit screen time 1 hour before bed', category: 'wellness', difficulty: 'medium', xpReward: 25 }
                ]
            };
            
            const interestBasedTasks = {
                fitness: [
                    { title: 'Complete 20 bodyweight squats', category: 'fitness', difficulty: 'easy', xpReward: 10 },
                    { title: 'Do a 30-minute workout session', category: 'fitness', difficulty: 'medium', xpReward: 35 },
                    { title: 'Try a new exercise or movement', category: 'fitness', difficulty: 'medium', xpReward: 25 }
                ],
                nutrition: [
                    { title: 'Eat 2 servings of vegetables today', category: 'nutrition', difficulty: 'medium', xpReward: 20 },
                    { title: 'Log all meals in nutrition tracker', category: 'nutrition', difficulty: 'easy', xpReward: 15 },
                    { title: 'Prepare a healthy snack for later', category: 'nutrition', difficulty: 'easy', xpReward: 10 }
                ],
                productivity: [
                    { title: 'Clear your email inbox to zero', category: 'productivity', difficulty: 'medium', xpReward: 25 },
                    { title: 'Organize one area of your workspace', category: 'productivity', difficulty: 'easy', xpReward: 15 },
                    { title: 'Complete your most important task first', category: 'productivity', difficulty: 'hard', xpReward: 40 }
                ],
                learning: [
                    { title: 'Watch an educational video (10+ min)', category: 'learning', difficulty: 'easy', xpReward: 15 },
                    { title: 'Practice a skill for 20 minutes', category: 'learning', difficulty: 'medium', xpReward: 25 },
                    { title: 'Learn 5 new words in another language', category: 'learning', difficulty: 'medium', xpReward: 20 }
                ]
            };
            
            // Get time-based tasks first
            const timeRelevantTasks = timeBasedTasks[context.timeOfDay] || timeBasedTasks.afternoon;
            let selectedTasks = [...timeRelevantTasks];
            
            // Add interest-based tasks
            context.interests.forEach(interest => {
                if (interestBasedTasks[interest]) {
                    selectedTasks.push(...interestBasedTasks[interest]);
                }
            });
            
            // Remove duplicates and shuffle
            selectedTasks = selectedTasks.filter((task, index, self) => 
                index === self.findIndex(t => t.title === task.title)
            );
            
            // Shuffle and take 3-4 tasks
            selectedTasks.sort(() => Math.random() - 0.5);
            const finalTasks = selectedTasks.slice(0, Math.min(4, selectedTasks.length));
            
            finalTasks.forEach(taskData => {
                createTask(taskData.title, taskData.category, taskData.xpReward, taskData.difficulty);
            });
            
            addDebugEntry('ai', 'info', `Generated ${finalTasks.length} intelligent fallback tasks`, { 
                timeOfDay: context.timeOfDay,
                interests: context.interests,
                tasks: finalTasks.map(t => t.title)
            });
            
            updateTasksUI();
            saveGameState('intelligent_tasks_generated');
            
            showFloatingNotification('ü§ñ Smart Tasks Generated', `${finalTasks.length} personalized tasks based on time and interests`);
        }

        function generateInitialTasks() {
            if (gameState.tasks.length === 0) {
                addDebugEntry('tasks', 'info', 'Generating initial tasks for new user');
                generateFallbackTasks(getAIContext());
            }
        }

        // ü•ó COMPREHENSIVE NUTRITION TRACKING WITH USDA API
        const USDA_API_KEY = 'DEMO_KEY';
        const USDA_BASE_URL = 'https://api.nal.usda.gov/fdc/v1';
        
        async function searchFoodNutrition(foodName) {
            const searchId = `search_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            try {
                addDebugEntry('nutrition', 'info', `Starting food search: ${foodName}`, { searchId, foodName });
                
                showFloatingNotification('üîç Searching...', `Looking up nutrition data for "${foodName}"`);
                
                const searchUrl = `${USDA_BASE_URL}/foods/search?query=${encodeURIComponent(foodName)}&pageSize=5&api_key=${USDA_API_KEY}`;
                
                const response = await fetch(searchUrl);
                if (!response.ok) {
                    throw new Error(`USDA API error: ${response.status}`);
                }
                
                const data = await response.json();
                addDebugEntry('nutrition', 'success', 'Food search completed', { 
                    searchId, 
                    resultsFound: data.foods?.length || 0,
                    query: foodName 
                });
                
                if (!data.foods || data.foods.length === 0) {
                    addDebugEntry('nutrition', 'warn', 'No foods found for search', { searchId, foodName });
                    showFoodSearchNoResults(foodName);
                    return;
                }
                
                showFoodSelectionModal(data.foods, foodName, searchId);
                
            } catch (error) {
                addDebugEntry('nutrition', 'error', 'Food search failed', { 
                    searchId, 
                    foodName, 
                    error: error.message 
                });
                
                console.error('Nutrition API error:', error);
                showFloatingNotification('‚ùå Search Failed', 'Unable to search nutrition database. Using estimated values.');
                showEstimatedNutritionModal(foodName);
            }
        }
        
        function showFoodSelectionModal(foods, originalQuery, searchId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">üîç Select Food Item</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-400 hover:text-gray-600 text-xl">√ó</button>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            Search results for "<strong>${originalQuery}</strong>". Select the closest match:
                        </p>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto space-y-3">
                        ${foods.slice(0, 5).map((food, index) => `
                            <div class="p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-all"
                                 onclick="selectFood('${food.fdcId}', '${food.description.replace(/'/g, "\\'")}', '${searchId}')">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <h4 class="font-medium text-green-700 dark:text-green-300">
                                            ${food.description || 'Unknown Food'}
                                        </h4>
                                        <div class="text-xs text-gray-500 mt-1">
                                            Brand: ${food.brandOwner || food.brandName || 'Generic'}
                                        </div>
                                        <div class="text-xs text-gray-400 mt-1">
                                            Category: ${food.foodCategory || food.dataType || 'Food'}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-blue-600 dark:text-blue-400 font-medium">
                                            Select ‚Üí
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600">
                        <div class="flex space-x-3">
                            <button onclick="showCustomNutritionEntry('${originalQuery}')" 
                                    class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition-all">
                                üìù Manual Entry
                            </button>
                            <button onclick="showEstimatedNutritionModal('${originalQuery}')" 
                                    class="flex-1 bg-green-500 text-white py-2 rounded hover:bg-green-600 transition-all">
                                ü§ñ AI Estimate
                            </button>
                            <button onclick="this.closest('.modal-overlay').remove()" 
                                    class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600 transition-all">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            addDebugEntry('nutrition', 'info', 'Food selection modal displayed', { 
                searchId, 
                foodCount: foods.length,
                originalQuery 
            });
        }
        
        async function selectFood(fdcId, foodName, searchId) {
            try {
                addDebugEntry('nutrition', 'info', `Fetching detailed nutrition for food`, { 
                    searchId, 
                    fdcId: fdcId.substring(0, 8) + '...',
                    foodName 
                });
                
                showFloatingNotification('üìä Loading...', 'Getting detailed nutrition information');
                
                const detailUrl = `${USDA_BASE_URL}/food/${fdcId}?api_key=${USDA_API_KEY}`;
                const response = await fetch(detailUrl);
                
                if (!response.ok) {
                    throw new Error(`USDA API error: ${response.status}`);
                }
                
                const foodData = await response.json();
                addDebugEntry('nutrition', 'success', 'Detailed nutrition data received', { 
                    searchId, 
                    fdcId: fdcId.substring(0, 8) + '...',
                    nutrientCount: foodData.foodNutrients?.length || 0 
                });
                
                document.querySelector('.modal-overlay').remove();
                showNutritionInputModal(foodData, searchId);
                
            } catch (error) {
                addDebugEntry('nutrition', 'error', 'Failed to fetch detailed nutrition', { 
                    searchId, 
                    fdcId: fdcId.substring(0, 8) + '...',
                    error: error.message 
                });
                
                console.error('Error fetching food details:', error);
                showFloatingNotification('‚ùå Error', 'Unable to get nutrition details. Using estimated values.');
                
                document.querySelector('.modal-overlay').remove();
                showEstimatedNutritionModal(foodName);
            }
        }
        
        function showNutritionInputModal(foodData, searchId) {
            const nutrients = extractNutrients(foodData.foodNutrients || []);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-xl w-full mx-4 max-h-[85vh] overflow-hidden flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-green-700 dark:text-green-300">
                            ü•ó ${foodData.description || 'Food Item'}
                        </h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-400 hover:text-gray-600 text-xl">√ó</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto">
                        <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                            <h4 class="font-bold mb-3 text-blue-700 dark:text-blue-300">üìè Serving Size</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Amount</label>
                                    <input type="number" id="servingAmount" value="100" min="1" max="2000" step="0.1"
                                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base"
                                           onchange="updateNutritionCalculation()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Unit</label>
                                    <select id="servingUnit" onchange="updateNutritionCalculation()"
                                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base">
                                        <option value="g">grams (g)</option>
                                        <option value="oz">ounces (oz)</option>
                                        <option value="cup">cups</option>
                                        <option value="piece">pieces</option>
                                        <option value="serving">servings</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-xs text-blue-600 dark:text-blue-400 mt-2">
                                Nutrition values are per 100g. Adjust serving size to get accurate totals.
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="p-4 bg-red-50 dark:bg-red-900/30 rounded-lg">
                                <h4 class="font-bold mb-3 text-red-700 dark:text-red-300">üî• Energy & Macros</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-red-600" id="displayCalories">${nutrients.calories}</div>
                                        <div class="text-sm text-red-500">Calories</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xl font-bold text-orange-600" id="displayProtein">${nutrients.protein}g</div>
                                        <div class="text-sm text-orange-500">Protein</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xl font-bold text-yellow-600" id="displayCarbs">${nutrients.carbs}g</div>
                                        <div class="text-sm text-yellow-500">Carbs</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xl font-bold text-blue-600" id="displayFat">${nutrients.fat}g</div>
                                        <div class="text-sm text-blue-500">Fat</div>
                                    </div>
                                </div>
                            </div>
                            
                            ${nutrients.fiber || nutrients.sugar || nutrients.sodium ? `
                            <div class="p-4 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                <h4 class="font-bold mb-3 text-green-700 dark:text-green-300">üìä Additional Nutrients</h4>
                                <div class="grid grid-cols-3 gap-3 text-center">
                                    ${nutrients.fiber ? `
                                    <div>
                                        <div class="text-lg font-bold text-green-600" id="displayFiber">${nutrients.fiber}g</div>
                                        <div class="text-sm text-green-500">Fiber</div>
                                    </div>
                                    ` : ''}
                                    ${nutrients.sugar ? `
                                    <div>
                                        <div class="text-lg font-bold text-purple-600" id="displaySugar">${nutrients.sugar}g</div>
                                        <div class="text-sm text-purple-500">Sugar</div>
                                    </div>
                                    ` : ''}
                                    ${nutrients.sodium ? `
                                    <div>
                                        <div class="text-lg font-bold text-gray-600" id="displaySodium">${nutrients.sodium}mg</div>
                                        <div class="text-sm text-gray-500">Sodium</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-600">
                        <div class="flex space-x-3">
                            <button onclick="logNutritionData('${foodData.description.replace(/'/g, "\\'")}', ${JSON.stringify(nutrients).replace(/"/g, '&quot;')}, '${searchId}')" 
                                    class="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-all font-medium">
                                ‚úÖ Log This Food
                            </button>
                            <button onclick="this.closest('.modal-overlay').remove()" 
                                    class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-all">
                                Cancel
                            </button>
                        </div>
                        <div class="text-xs text-center text-gray-500 mt-2">
                            Data source: USDA FoodData Central
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            window.originalNutrients = nutrients;
            
            addDebugEntry('nutrition', 'success', 'Nutrition input modal displayed', { 
                searchId, 
                foodName: foodData.description,
                nutrients: nutrients 
            });
        }
        
        function extractNutrients(foodNutrients) {
            const nutrientMap = {};
            
            foodNutrients.forEach(nutrient => {
                const id = nutrient.nutrient?.id;
                const value = nutrient.amount || 0;
                
                switch(id) {
                    case 1008: nutrientMap.calories = Math.round(value); break;
                    case 1003: nutrientMap.protein = Math.round(value * 10) / 10; break;
                    case 1005: nutrientMap.carbs = Math.round(value * 10) / 10; break;
                    case 1004: nutrientMap.fat = Math.round(value * 10) / 10; break;
                    case 1079: nutrientMap.fiber = Math.round(value * 10) / 10; break;
                    case 2000: nutrientMap.sugar = Math.round(value * 10) / 10; break;
                    case 1093: nutrientMap.sodium = Math.round(value); break;
                }
            });
            
            return {
                calories: nutrientMap.calories || 0,
                protein: nutrientMap.protein || 0,
                carbs: nutrientMap.carbs || 0,
                fat: nutrientMap.fat || 0,
                fiber: nutrientMap.fiber || null,
                sugar: nutrientMap.sugar || null,
                sodium: nutrientMap.sodium || null
            };
        }
        
        function updateNutritionCalculation() {
            const amount = parseFloat(document.getElementById('servingAmount').value) || 100;
            const unit = document.getElementById('servingUnit').value;
            
            let gramEquivalent = amount;
            switch(unit) {
                case 'oz': gramEquivalent = amount * 28.35; break;
                case 'cup': gramEquivalent = amount * 240; break;
                case 'piece': gramEquivalent = amount * 50; break;
                case 'serving': gramEquivalent = amount * 100; break;
                default: gramEquivalent = amount; break;
            }
            
            const multiplier = gramEquivalent / 100;
            const original = window.originalNutrients;
            
            document.getElementById('displayCalories').textContent = Math.round(original.calories * multiplier);
            document.getElementById('displayProtein').textContent = Math.round(original.protein * multiplier * 10) / 10 + 'g';
            document.getElementById('displayCarbs').textContent = Math.round(original.carbs * multiplier * 10) / 10 + 'g';
            document.getElementById('displayFat').textContent = Math.round(original.fat * multiplier * 10) / 10 + 'g';
            
            if (original.fiber && document.getElementById('displayFiber')) {
                document.getElementById('displayFiber').textContent = Math.round(original.fiber * multiplier * 10) / 10 + 'g';
            }
            if (original.sugar && document.getElementById('displaySugar')) {
                document.getElementById('displaySugar').textContent = Math.round(original.sugar * multiplier * 10) / 10 + 'g';
            }
            if (original.sodium && document.getElementById('displaySodium')) {
                document.getElementById('displaySodium').textContent = Math.round(original.sodium * multiplier) + 'mg';
            }
        }
        
        function logNutritionData(foodName, nutrients, searchId) {
            const amount = parseFloat(document.getElementById('servingAmount').value) || 100;
            const unit = document.getElementById('servingUnit').value;
            
            let gramEquivalent = amount;
            switch(unit) {
                case 'oz': gramEquivalent = amount * 28.35; break;
                case 'cup': gramEquivalent = amount * 240; break;
                case 'piece': gramEquivalent = amount * 50; break;
                case 'serving': gramEquivalent = amount * 100; break;
                default: gramEquivalent = amount; break;
            }
            
            const multiplier = gramEquivalent / 100;
            
            const actualNutrition = {
                calories: Math.round(nutrients.calories * multiplier),
                protein: Math.round(nutrients.protein * multiplier * 10) / 10,
                carbs: Math.round(nutrients.carbs * multiplier * 10) / 10,
                fat: Math.round(nutrients.fat * multiplier * 10) / 10,
                serving: `${amount} ${unit}`
            };
            
            const prevCalories = gameState.dailyStats.calories;
            const prevProtein = gameState.dailyStats.protein;
            const prevCarbs = gameState.dailyStats.carbs;
            const prevFat = gameState.dailyStats.fat;
            
            gameState.dailyStats.calories += actualNutrition.calories;
            gameState.dailyStats.protein += actualNutrition.protein;
            gameState.dailyStats.carbs += actualNutrition.carbs;
            gameState.dailyStats.fat += actualNutrition.fat;
            
            addDebugEntry('nutrition', 'success', 'Nutrition data logged successfully', {
                searchId,
                foodName,
                serving: actualNutrition.serving,
                nutrition: actualNutrition,
                increments: {
                    calories: gameState.dailyStats.calories > prevCalories,
                    protein: gameState.dailyStats.protein > prevProtein,
                    carbs: gameState.dailyStats.carbs > prevCarbs,
                    fat: gameState.dailyStats.fat > prevFat
                },
                newTotals: {
                    calories: gameState.dailyStats.calories,
                    protein: gameState.dailyStats.protein,
                    carbs: gameState.dailyStats.carbs,
                    fat: gameState.dailyStats.fat
                }
            });
            
            const xpAmount = Math.min(50, Math.max(10, Math.round(actualNutrition.calories / 50)));
            awardXP(xpAmount, `Logged: ${foodName}`);
            
            updateStatsUI();
            updateNutritionUI();
            saveGameState('nutrition_logged');
            
            document.querySelector('.modal-overlay').remove();
            
            showFloatingNotification('‚úÖ Food Logged!', 
                `${foodName} (${actualNutrition.serving}): ${actualNutrition.calories} calories, ${actualNutrition.protein}g protein`);
            
            checkNutritionAchievements();
        }
        
        function showCustomNutritionEntry(foodName) {
            document.querySelector('.modal-overlay').remove();
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üìù Manual Nutrition Entry</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">üçΩÔ∏è Food Name</label>
                            <input type="text" id="customFoodName" value="${foodName}" 
                                   class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">üî• Calories</label>
                                <input type="number" id="customCalories" placeholder="250" min="0" max="5000"
                                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">ü•© Protein (g)</label>
                                <input type="number" id="customProtein" placeholder="15" min="0" max="200" step="0.1"
                                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">üçû Carbs (g)</label>
                                <input type="number" id="customCarbs" placeholder="30" min="0" max="300" step="0.1"
                                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">üßà Fat (g)</label>
                                <input type="number" id="customFat" placeholder="8" min="0" max="150" step="0.1"
                                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="logCustomNutrition()" class="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-all font-medium">
                                ‚úÖ Log Food
                            </button>
                            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-all">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('customFoodName').focus();
        }
        
        function logCustomNutrition() {
            const foodName = document.getElementById('customFoodName').value.trim();
            const calories = parseInt(document.getElementById('customCalories').value) || 0;
            const protein = parseFloat(document.getElementById('customProtein').value) || 0;
            const carbs = parseFloat(document.getElementById('customCarbs').value) || 0;
            const fat = parseFloat(document.getElementById('customFat').value) || 0;
            
            if (!foodName) {
                showFloatingNotification('‚ö†Ô∏è Missing Name', 'Please enter a food name');
                return;
            }
            
            if (calories === 0) {
                showFloatingNotification('‚ö†Ô∏è Missing Calories', 'Please enter calorie information');
                return;
            }
            
            const prevCalories = gameState.dailyStats.calories;
            const prevProtein = gameState.dailyStats.protein;
            const prevCarbs = gameState.dailyStats.carbs;
            const prevFat = gameState.dailyStats.fat;
            
            gameState.dailyStats.calories += calories;
            gameState.dailyStats.protein += protein;
            gameState.dailyStats.carbs += carbs;
            gameState.dailyStats.fat += fat;
            
            addDebugEntry('nutrition', 'success', 'Custom nutrition logged', {
                foodName,
                nutrition: { calories, protein, carbs, fat },
                increments: {
                    calories: gameState.dailyStats.calories - prevCalories,
                    protein: gameState.dailyStats.protein - prevProtein,
                    carbs: gameState.dailyStats.carbs - prevCarbs,
                    fat: gameState.dailyStats.fat - prevFat
                }
            });
            
            const xpAmount = Math.min(50, Math.max(10, Math.round(calories / 50)));
            awardXP(xpAmount, `Logged: ${foodName}`);
            
            updateStatsUI();
            updateNutritionUI();
            saveGameState('custom_nutrition_logged');
            
            document.querySelector('.modal-overlay').remove();
            showFloatingNotification('‚úÖ Food Logged!', `${foodName}: ${calories} calories, ${protein}g protein`);
            
            checkNutritionAchievements();
        }
        
        function showEstimatedNutritionModal(foodName) {
            const estimatedNutrition = estimateNutrition(foodName);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-purple-700 dark:text-purple-300">ü§ñ AI Nutrition Estimate</h3>
                    
                    <div class="mb-4 p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                        <p class="text-sm text-purple-600 dark:text-purple-400">
                            AI estimated nutrition for "<strong>${foodName}</strong>" (100g serving):
                        </p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="text-center p-3 bg-red-50 dark:bg-red-900/30 rounded-lg">
                                <div class="text-xl font-bold text-red-600">${estimatedNutrition.calories}</div>
                                <div class="text-sm text-red-500">Calories</div>
                            </div>
                            <div class="text-center p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                <div class="text-xl font-bold text-green-600">${estimatedNutrition.protein}g</div>
                                <div class="text-sm text-green-500">Protein</div>
                            </div>
                            <div class="text-center p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg">
                                <div class="text-xl font-bold text-yellow-600">${estimatedNutrition.carbs}g</div>
                                <div class="text-sm text-yellow-500">Carbs</div>
                            </div>
                            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <div class="text-xl font-bold text-blue-600">${estimatedNutrition.fat}g</div>
                                <div class="text-sm text-blue-500">Fat</div>
                            </div>
                        </div>
                        
                        <div class="text-xs text-center text-gray-500">
                            This is an AI estimate. For accurate nutrition data, use the USDA database search.
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="logEstimatedNutrition('${foodName}', ${JSON.stringify(estimatedNutrition)})" 
                                    class="flex-1 bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 transition-all font-medium">
                                ‚úÖ Use Estimate
                            </button>
                            <button onclick="showCustomNutritionEntry('${foodName}')" 
                                    class="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-all">
                                üìù Manual Entry
                            </button>
                        </div>
                        
                        <button onclick="this.closest('.modal-overlay').remove()" 
                                class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-all">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function estimateNutrition(foodName) {
            const food = foodName.toLowerCase();
            
            const nutritionDB = {
                'apple': { calories: 52, protein: 0.3, carbs: 14, fat: 0.2 },
                'banana': { calories: 89, protein: 1.1, carbs: 23, fat: 0.3 },
                'chicken breast': { calories: 165, protein: 31, carbs: 0, fat: 3.6 },
                'beef': { calories: 250, protein: 26, carbs: 0, fat: 15 },
                'salmon': { calories: 208, protein: 22, carbs: 0, fat: 12 },
                'rice': { calories: 130, protein: 2.7, carbs: 28, fat: 0.3 },
                'bread': { calories: 265, protein: 9, carbs: 49, fat: 3.2 },
                'pasta': { calories: 131, protein: 5, carbs: 25, fat: 1.1 },
                'egg': { calories: 155, protein: 13, carbs: 1.1, fat: 11 },
                'milk': { calories: 42, protein: 3.4, carbs: 5, fat: 1 },
                'cheese': { calories: 402, protein: 25, carbs: 1.3, fat: 33 },
                'yogurt': { calories: 59, protein: 10, carbs: 3.6, fat: 0.4 },
                'potato': { calories: 77, protein: 2, carbs: 17, fat: 0.1 },
                'tomato': { calories: 18, protein: 0.9, carbs: 3.9, fat: 0.2 },
                'lettuce': { calories: 15, protein: 1.4, carbs: 2.9, fat: 0.2 },
                'carrot': { calories: 41, protein: 0.9, carbs: 10, fat: 0.2 },
                'broccoli': { calories: 34, protein: 2.8, carbs: 7, fat: 0.4 },
                'spinach': { calories: 23, protein: 2.9, carbs: 3.6, fat: 0.4 },
                'orange': { calories: 47, protein: 0.9, carbs: 12, fat: 0.1 },
                'strawberry': { calories: 32, protein: 0.7, carbs: 8, fat: 0.3 }
            };
            
            for (const [key, nutrition] of Object.entries(nutritionDB)) {
                if (food.includes(key)) {
                    return nutrition;
                }
            }
            
            if (food.includes('fruit') || food.includes('apple') || food.includes('berry')) {
                return { calories: 50, protein: 0.5, carbs: 12, fat: 0.2 };
            } else if (food.includes('meat') || food.includes('chicken') || food.includes('beef')) {
                return { calories: 200, protein: 25, carbs: 0, fat: 10 };
            } else if (food.includes('vegetable') || food.includes('salad')) {
                return { calories: 25, protein: 2, carbs: 5, fat: 0.2 };
            } else if (food.includes('grain') || food.includes('bread') || food.includes('cereal')) {
                return { calories: 250, protein: 8, carbs: 50, fat: 2 };
            } else {
                return { calories: 150, protein: 5, carbs: 20, fat: 5 };
            }
        }
        
        function logEstimatedNutrition(foodName, estimatedNutrition) {
            gameState.dailyStats.calories += estimatedNutrition.calories;
            gameState.dailyStats.protein += estimatedNutrition.protein;
            gameState.dailyStats.carbs += estimatedNutrition.carbs;
            gameState.dailyStats.fat += estimatedNutrition.fat;
            
            addDebugEntry('nutrition', 'success', 'AI estimated nutrition logged', {
                foodName,
                nutrition: estimatedNutrition,
                source: 'ai_estimation'
            });
            
            const xpAmount = Math.min(50, Math.max(10, Math.round(estimatedNutrition.calories / 50)));
            awardXP(xpAmount, `AI Estimated: ${foodName}`);
            
            updateStatsUI();
            updateNutritionUI();
            saveGameState('ai_nutrition_logged');
            
            document.querySelector('.modal-overlay').remove();
            showFloatingNotification('ü§ñ AI Estimate Logged!', 
                `${foodName}: ${estimatedNutrition.calories} calories (estimated)`);
            
            checkNutritionAchievements();
        }
        
        function showFoodSearchNoResults(foodName) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üîç No Results Found</h3>
                    <div class="mb-4">
                        <p class="text-gray-600 dark:text-gray-400">
                            No nutrition data found for "<strong>${foodName}</strong>" in the USDA database.
                        </p>
                    </div>
                    <div class="space-y-3">
                        <button onclick="showCustomNutritionEntry('${foodName}')" 
                                class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-all font-medium">
                            üìù Manual Entry
                        </button>
                        <button onclick="showEstimatedNutritionModal('${foodName}')" 
                                class="w-full bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 transition-all font-medium">
                            ü§ñ AI Estimate
                        </button>
                        <button onclick="this.closest('.modal-overlay').remove()" 
                                class="w-full bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-all">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function checkNutritionAchievements() {
            const calories = gameState.dailyStats.calories;
            const protein = gameState.dailyStats.protein;
            
            if (calories >= 500 && !hasAchievement('First 500 Calories')) {
                addAchievement('üî• First 500 Calories!', 'Logged your first 500 calories today', 25);
            }
            if (calories >= 1000 && !hasAchievement('1000 Calorie Milestone')) {
                addAchievement('üìä 1000 Calorie Milestone!', 'Reached 1000 calories logged today', 50);
            }
            if (calories >= 2000 && !hasAchievement('Full Day Nutrition')) {
                addAchievement('üéØ Full Day Nutrition!', 'Logged a full day\'s worth of calories', 100);
            }
            
            if (protein >= 50 && !hasAchievement('Protein Power')) {
                addAchievement('üí™ Protein Power!', 'Logged 50g of protein today', 30);
            }
            if (protein >= 100 && !hasAchievement('Protein Champion')) {
                addAchievement('üèÜ Protein Champion!', 'Reached 100g of protein in one day', 75);
            }
            
            if (gameState.healthMetrics.dailyCalorieTarget > 0) {
                const targetProgress = (calories / gameState.healthMetrics.dailyCalorieTarget) * 100;
                if (targetProgress >= 80 && targetProgress < 100 && !hasAchievement('Almost There')) {
                    addAchievement('üéØ Almost There!', 'You\'re 80% to your daily calorie goal', 40);
                }
                if (targetProgress >= 100 && !hasAchievement('Goal Crusher')) {
                    addAchievement('üèÜ Goal Crusher!', 'Reached your daily calorie target', 100);
                }
            }
        }
        
        function showNutritionSearch() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-green-700 dark:text-green-300">üîç Food Nutrition Search</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">üçΩÔ∏è Search for any food</label>
                            <input type="text" id="foodSearchInput" placeholder="e.g., grilled chicken, apple pie, pasta..." 
                                   class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base"
                                   onkeypress="if(event.key==='Enter') startFoodSearch()">
                            <div class="text-xs text-gray-500 mt-1">
                                Powered by USDA FoodData Central - comprehensive nutrition database
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="startFoodSearch()" class="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-all font-medium">
                                üîç Search Nutrition
                            </button>
                            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-all">
                                Cancel
                            </button>
                        </div>
                        
                        <div class="pt-3 border-t border-gray-200 dark:border-gray-600">
                            <div class="text-sm font-medium mb-2">Quick options:</div>
                            <div class="flex space-x-2">
                                <button onclick="showCustomNutritionEntry('')" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                                    üìù Manual Entry
                                </button>
                                <button onclick="showEstimatedNutritionModal('')" class="text-xs bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600">
                                    ü§ñ AI Estimate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('foodSearchInput').focus();
        }
        
        function startFoodSearch() {
            const searchTerm = document.getElementById('foodSearchInput').value.trim();
            if (!searchTerm) {
                showFloatingNotification('‚ö†Ô∏è Enter Food Name', 'Please enter a food name to search');
                return;
            }
            
            document.querySelector('.modal-overlay').remove();
            searchFoodNutrition(searchTerm);
        }

        // Enhanced storage management with better caching
        function saveGameState(trigger = 'manual') {
            try {
                if (storageManager) {
                    const result = storageManager.save(trigger);
                    if (result.success) {
                        addDebugEntry('storage', 'success', `Advanced save completed: ${trigger}`, {
                            saveId: result.saveId,
                            duration: result.duration
                        });
                    } else {
                        addDebugEntry('storage', 'error', `Advanced save failed: ${trigger}`, {
                            error: result.error
                        });
                    }
                    return result;
                } else {
                    localStorage.setItem('lifeQuestAI', JSON.stringify(gameState));
                    addDebugEntry('storage', 'info', `Fallback save completed: ${trigger}`);
                    return { success: true, method: 'fallback' };
                }
            } catch (error) {
                addDebugEntry('storage', 'error', `Save operation failed: ${trigger}`, {
                    error: error.message
                });
                return { success: false, error: error.message };
            }
        }

        function loadGameState() {
            try {
                if (storageManager) {
                    const result = storageManager.load();
                    if (result.success) {
                        addDebugEntry('storage', 'success', 'Advanced load completed', {
                            source: result.source,
                            loadId: result.loadId
                        });
                    } else {
                        addDebugEntry('storage', 'error', 'Advanced load failed', {
                            error: result.error
                        });
                    }
                } else {
                    const data = localStorage.getItem('lifeQuestAI');
                    if (data) {
                        const parsed = JSON.parse(data);
                        Object.assign(gameState, parsed);
                        addDebugEntry('storage', 'info', 'Fallback load completed');
                    }
                }

                ensureDataIntegrity();
                
                setTimeout(() => {
                    updateSpotifyClientIdStatus();
                    updateInterestsUI();
                    updateWaterVisualization();
                }, 100);
                
            } catch (error) {
                addDebugEntry('storage', 'error', 'Load operation failed', {
                    error: error.message
                });
            }
        }

        function ensureDataIntegrity() {
            const requiredCounters = [
                'dailyStats.workouts',
                'dailyStats.waterGlasses', 
                'dailyStats.calories',
                'dailyStats.protein',
                'dailyStats.carbs',
                'dailyStats.fat',
                'dailyStats.tasksCompleted',
                'dailyStats.totalTasks',
                'dailyStats.caloriesBurned',
                'dailyStats.exerciseMinutes',
                'dailyStats.steps'
            ];
            
            requiredCounters.forEach(counterPath => {
                const value = getNestedValue(gameState, counterPath);
                if (typeof value !== 'number' || isNaN(value)) {
                    setNestedValue(gameState, counterPath, 0);
                    addDebugEntry('storage', 'warn', `Reset invalid counter: ${counterPath}`, {
                        oldValue: value,
                        newValue: 0
                    });
                }
            });
            
            if (!Array.isArray(gameState.tasks)) gameState.tasks = [];
            if (!Array.isArray(gameState.achievements)) gameState.achievements = [];
            if (!Array.isArray(gameState.interests)) gameState.interests = ['fitness', 'productivity', 'learning'];
            
            if (!gameState.profile) gameState.profile = {};
            if (!gameState.healthMetrics) gameState.healthMetrics = {};
            if (!gameState.patterns) gameState.patterns = { activities: {}, preferences: {}, timing: {} };
            if (!gameState.settings) gameState.settings = {};
            
            addDebugEntry('storage', 'success', 'Data integrity check completed');
        }

        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => current && current[key], obj);
        }

        function setNestedValue(obj, path, value) {
            const keys = path.split('.');
            const lastKey = keys.pop();
            const target = keys.reduce((current, key) => {
                if (!current[key]) current[key] = {};
                return current[key];
            }, obj);
            target[lastKey] = value;
        }

        function updateWaterVisualization() {
            const waterGlassesContainer = document.getElementById('nutritionWaterGlasses');
            if (!waterGlassesContainer) return;
            
            const totalGlasses = 8;
            let glassesHTML = '';
            
            for (let i = 1; i <= totalGlasses; i++) {
                const filled = i <= gameState.dailyStats.waterGlasses;
                glassesHTML += `
                    <div class="flex flex-col items-center">
                        <div class="w-8 h-10 border-2 border-blue-400 rounded-b-lg relative overflow-hidden ${filled ? 'bg-blue-400' : 'bg-gray-100 dark:bg-gray-600'}">
                            ${filled ? '<div class="absolute bottom-0 left-0 right-0 h-full bg-blue-500 opacity-75 animate-pulse"></div>' : ''}
                        </div>
                        <div class="text-xs mt-1 ${filled ? 'text-blue-600' : 'text-gray-400'}">${i}</div>
                    </div>
                `;
            }
            
            waterGlassesContainer.innerHTML = glassesHTML;
            
            const waterDisplay = document.getElementById('nutritionWaterDisplay');
            if (waterDisplay) {
                waterDisplay.textContent = `${gameState.dailyStats.waterGlasses}/${totalGlasses} glasses`;
            }
        }

        function addWaterGlass() {
            if (gameState.dailyStats.waterGlasses < 10) {
                const prevWater = gameState.dailyStats.waterGlasses;
                gameState.dailyStats.waterGlasses++;
                
                addDebugEntry('nutrition', 'success', 'Water glass added manually', {
                    previousCount: prevWater,
                    newCount: gameState.dailyStats.waterGlasses,
                    incremented: gameState.dailyStats.waterGlasses > prevWater
                });
                
                awardXP(5, 'Water Glass Added');
                updateStatsUI();
                updateWaterVisualization();
                saveGameState('water_added');
                showFloatingNotification('üíß Water Added!', `Glass ${gameState.dailyStats.waterGlasses} logged`);
                
                if (gameState.dailyStats.waterGlasses === 8) {
                    addAchievement('üíß Hydration Hero!', 'Drank 8 glasses of water today', 75);
                }
            } else {
                showFloatingNotification('üíß Hydration Max!', 'Great job! You\'ve logged plenty of water today');
            }
        }

        function removeWaterGlass() {
            if (gameState.dailyStats.waterGlasses > 0) {
                const prevWater = gameState.dailyStats.waterGlasses;
                gameState.dailyStats.waterGlasses--;
                
                addDebugEntry('nutrition', 'info', 'Water glass removed', {
                    previousCount: prevWater,
                    newCount: gameState.dailyStats.waterGlasses
                });
                
                updateStatsUI();
                updateWaterVisualization();
                saveGameState('water_removed');
                showFloatingNotification('üíß Water Removed', `Now at ${gameState.dailyStats.waterGlasses} glasses`);
            } else {
                showFloatingNotification('üíß No Water to Remove', 'You haven\'t logged any water yet');
            }
        }

        function updateStatsUI() {
            const stats = gameState.dailyStats;
            
            const elements = {
                workoutCount: stats.workouts || 0,
                waterCount: stats.waterGlasses || 0,
                caloriesCount: stats.calories || 0,
                tasksCompletedDisplay: stats.tasksCompleted || 0,
                currentStreak: gameState.currentStreak || 0,
                proteinCount: `${(stats.protein || 0).toFixed(1)}g`,
                carbsCount: `${(stats.carbs || 0).toFixed(1)}g`,
                fatCount: `${(stats.fat || 0).toFixed(1)}g`,
                totalWorkouts: stats.workouts || 0,
                caloriesBurned: stats.caloriesBurned || 0,
                exerciseMinutes: stats.exerciseMinutes || 0,
                nutritionCalories: stats.calories || 0,
                fitnessStepsDisplay: `${(stats.steps || 0).toLocaleString()} steps`,
                stepsDisplay: `${(stats.steps || 0).toLocaleString()} steps`
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
            
            addDebugEntry('ui', 'info', 'Stats UI updated successfully', {
                calories: stats.calories,
                water: stats.waterGlasses,
                workouts: stats.workouts,
                tasks: stats.tasksCompleted
            });
        }

        function updateNutritionUI() {
            const nutritionCalories = document.getElementById('nutritionCalories');
            const proteinCount = document.getElementById('proteinCount');
            const carbsCount = document.getElementById('carbsCount');
            const fatCount = document.getElementById('fatCount');
            
            if (nutritionCalories) nutritionCalories.textContent = gameState.dailyStats.calories || 0;
            if (proteinCount) proteinCount.textContent = `${(gameState.dailyStats.protein || 0).toFixed(1)}g`;
            if (carbsCount) carbsCount.textContent = `${(gameState.dailyStats.carbs || 0).toFixed(1)}g`;
            if (fatCount) fatCount.textContent = `${(gameState.dailyStats.fat || 0).toFixed(1)}g`;
            
            updateWaterVisualization();
        }

        // üéµ SPOTIFY INTEGRATION 
        let spotifyAccessToken = null;
        let spotifyRefreshToken = null;
        let spotifyPlayer = null;
        let currentPlaybackState = null;
        let spotifyDeviceId = null;
        let spotifyTokenExpiry = null;

        function getSpotifyConfig() {
            const clientId = gameState.settings.spotifyClientId || localStorage.getItem('spotifyClientId');
            const redirectUri = gameState.settings.spotifyRedirectUri || localStorage.getItem('spotifyRedirectUri') || window.location.origin;
            
            return { clientId, redirectUri };
        }

        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function connectSpotify() {
            const config = getSpotifyConfig();
            
            if (!config.clientId) {
                showFloatingNotification('‚ö†Ô∏è Configuration Required', 'Please configure your Spotify Client ID in Settings first');
                switchTab('settings');
                return;
            }
            
            const scopes = [
                'streaming',
                'user-read-email',
                'user-read-private',
                'user-read-playback-state',
                'user-modify-playback-state',
                'user-read-currently-playing',
                'user-read-recently-played'
            ].join(' ');
            
            const state = Math.random().toString(36).substring(2, 15);
            localStorage.setItem('spotify_state', state);
            
            try {
                showFloatingNotification('üîÑ Connecting...', 'Generating secure authentication parameters');
                
                // Generate PKCE parameters
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                
                // Store code verifier for token exchange
                localStorage.setItem('spotify_code_verifier', codeVerifier);
                
                const authUrl = `https://accounts.spotify.com/authorize?` +
                    `client_id=${config.clientId}&` +
                    `response_type=code&` +
                    `redirect_uri=${encodeURIComponent(config.redirectUri)}&` +
                    `scope=${encodeURIComponent(scopes)}&` +
                    `state=${state}&` +
                    `code_challenge=${codeChallenge}&` +
                    `code_challenge_method=S256&` +
                    `show_dialog=true`;
                
                addDebugEntry('spotify', 'info', 'Initiating Spotify PKCE OAuth', { 
                    redirectUri: config.redirectUri,
                    codeChallenge: codeChallenge.substring(0, 10) + '...'
                });
                
                window.location.href = authUrl;
                
            } catch (error) {
                addDebugEntry('spotify', 'error', 'PKCE generation failed', { error: error.message });
                showFloatingNotification('‚ùå PKCE Error', 'Failed to generate PKCE parameters');
            }
        }

        async function handleSpotifyCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            
            if (error) {
                addDebugEntry('spotify', 'error', 'Spotify OAuth error', { error });
                showFloatingNotification('‚ùå Spotify Error', `Authentication failed: ${error}`);
                return;
            }
            
            if (code) {
                const savedState = localStorage.getItem('spotify_state');
                if (state !== savedState) {
                    addDebugEntry('spotify', 'error', 'Invalid OAuth state parameter');
                    showFloatingNotification('‚ùå Security Error', 'Invalid authentication state');
                    return;
                }
                
                addDebugEntry('spotify', 'info', 'Spotify OAuth code received, exchanging for token');
                
                try {
                    await exchangeCodeForToken(code);
                } catch (error) {
                    addDebugEntry('spotify', 'error', 'Token exchange failed', { error: error.message });
                    showFloatingNotification('‚ùå Token Exchange Failed', 'Unable to complete Spotify authentication');
                }
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
                localStorage.removeItem('spotify_state');
            }
        }

        async function exchangeCodeForToken(code) {
            const config = getSpotifyConfig();
            
            showFloatingNotification('üîÑ Processing...', 'Exchanging authorization code for access token');
            
            try {
                // Use Authorization Code flow without PKCE for simpler implementation
                const tokenUrl = 'https://accounts.spotify.com/api/token';
                
                const body = new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: config.redirectUri,
                    client_id: config.clientId
                });
                
                addDebugEntry('spotify', 'info', 'Starting token exchange', {
                    codeLength: code.length,
                    redirectUri: config.redirectUri,
                    clientId: config.clientId.substring(0, 8) + '...'
                });
                
                const response = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: body.toString()
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Spotify API error: ${response.status} - ${errorData.error_description || errorData.error || 'Unknown error'}`);
                }
                
                const tokenResponse = await response.json();
                
                // Store tokens
                spotifyAccessToken = tokenResponse.access_token;
                spotifyRefreshToken = tokenResponse.refresh_token;
                spotifyTokenExpiry = Date.now() + (tokenResponse.expires_in * 1000);
                
                // Save to localStorage
                localStorage.setItem('spotify_access_token', spotifyAccessToken);
                if (spotifyRefreshToken) {
                    localStorage.setItem('spotify_refresh_token', spotifyRefreshToken);
                }
                localStorage.setItem('spotify_token_expiry', spotifyTokenExpiry.toString());
                
                addDebugEntry('spotify', 'success', 'Token exchange successful', {
                    hasAccessToken: !!spotifyAccessToken,
                    hasRefreshToken: !!spotifyRefreshToken,
                    expiresAt: new Date(spotifyTokenExpiry).toISOString(),
                    scope: tokenResponse.scope
                });
                
                showFloatingNotification('‚úÖ Spotify Connected!', 'Successfully connected to your Spotify account');
                
                // Update UI immediately
                updateSpotifyConnectionStatus();
                
                // Try to initialize Spotify Web SDK
                setTimeout(() => {
                    if (window.Spotify) {
                        initializeSpotifyPlayer();
                    } else {
                        updateSpotifyDevices();
                    }
                }, 500);
                
            } catch (error) {
                addDebugEntry('spotify', 'error', 'Token exchange failed', { 
                    error: error.message,
                    code: code.substring(0, 10) + '...'
                });
                showFloatingNotification('‚ùå Connection Failed', `Spotify connection failed: ${error.message}`);
                
                throw error;
            }
        }

        function initializeDemoPlayer() {
            // Note: This is removed as it provided fake functionality
            // Real Spotify integration requires backend implementation
            addDebugEntry('spotify', 'info', 'Demo player not initialized - requires real Spotify integration');
        }

        function restoreSpotifyTokens() {
            const accessToken = localStorage.getItem('spotify_access_token');
            const refreshToken = localStorage.getItem('spotify_refresh_token');
            const expiry = localStorage.getItem('spotify_token_expiry');
            
            if (accessToken && refreshToken && expiry) {
                const expiryTime = parseInt(expiry);
                
                if (Date.now() < expiryTime) {
                    spotifyAccessToken = accessToken;
                    spotifyRefreshToken = refreshToken;
                    spotifyTokenExpiry = expiryTime;
                    
                    addDebugEntry('spotify', 'success', 'Spotify tokens restored from storage');
                    updateSpotifyConnectionStatus();
                    
                    if (window.Spotify) {
                        initializeSpotifyPlayer();
                    }
                } else {
                    addDebugEntry('spotify', 'warn', 'Stored Spotify tokens expired');
                    clearSpotifyTokens();
                }
            }
        }

        function clearSpotifyTokens() {
            spotifyAccessToken = null;
            spotifyRefreshToken = null;
            spotifyTokenExpiry = null;
            
            localStorage.removeItem('spotify_access_token');
            localStorage.removeItem('spotify_refresh_token');
            localStorage.removeItem('spotify_token_expiry');
            
            updateSpotifyConnectionStatus();
        }

        function updateSpotifyConnectionStatus() {
            const isConnected = !!spotifyAccessToken;
            
            // Update status indicators
            const statusElements = document.querySelectorAll('#spotifyStatus, #aboutSpotifyStatus');
            statusElements.forEach(element => {
                if (element) {
                    if (isConnected) {
                        element.textContent = 'Connected';
                        element.className = 'text-sm px-3 py-1 rounded-full bg-green-500 text-white';
                    } else {
                        element.textContent = 'Not Connected';
                        element.className = 'text-sm px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-600';
                    }
                }
            });
            
            // Show/hide login vs player UI
            const loginDiv = document.getElementById('spotifyLogin');
            const playerDiv = document.getElementById('spotifyPlayer');
            
            if (loginDiv && playerDiv) {
                if (isConnected) {
                    loginDiv.style.display = 'none';
                    playerDiv.classList.remove('hidden');
                } else {
                    loginDiv.style.display = 'block';
                    playerDiv.classList.add('hidden');
                }
            }
            
            addDebugEntry('spotify', 'info', `Spotify connection status updated: ${isConnected ? 'connected' : 'disconnected'}`);
        }

        async function initializeSpotifyPlayer() {
            if (!spotifyAccessToken) {
                addDebugEntry('spotify', 'warn', 'Cannot initialize player: no access token');
                return;
            }
            
            try {
                // Initialize Spotify Web Playback SDK
                const player = new Spotify.Player({
                    name: 'Life Quest RPG Player',
                    getOAuthToken: cb => { cb(spotifyAccessToken); },
                    volume: 0.5
                });
                
                // Error handling
                player.addListener('initialization_error', ({ message }) => {
                    addDebugEntry('spotify', 'error', 'Player initialization error', { message });
                });
                
                player.addListener('authentication_error', ({ message }) => {
                    addDebugEntry('spotify', 'error', 'Player authentication error', { message });
                    clearSpotifyTokens();
                });
                
                player.addListener('account_error', ({ message }) => {
                    addDebugEntry('spotify', 'error', 'Player account error', { message });
                });
                
                // Playback status updates
                player.addListener('player_state_changed', (state) => {
                    if (state) {
                        currentPlaybackState = state;
                        updateCurrentTrack(state);
                    }
                });
                
                // Ready
                player.addListener('ready', ({ device_id }) => {
                    spotifyDeviceId = device_id;
                    addDebugEntry('spotify', 'success', 'Spotify player ready', { device_id });
                    updateSpotifyDevices();
                });
                
                // Connect to the player
                const success = await player.connect();
                if (success) {
                    spotifyPlayer = player;
                    addDebugEntry('spotify', 'success', 'Spotify player connected successfully');
                }
                
            } catch (error) {
                addDebugEntry('spotify', 'error', 'Failed to initialize Spotify player', { error: error.message });
            }
        }

        function updateCurrentTrack(state = currentPlaybackState) {
            if (!state || !state.track_window.current_track) {
                return;
            }
            
            const track = state.track_window.current_track;
            const progress = state.position;
            const duration = track.duration_ms;
            
            // Update track info
            const trackImage = document.getElementById('trackImage');
            const trackName = document.getElementById('trackName');
            const trackArtist = document.getElementById('trackArtist');
            const trackAlbum = document.getElementById('trackAlbum');
            const trackProgress = document.getElementById('trackProgress');
            const progressBar = document.getElementById('progressBar');
            const playPauseBtn = document.getElementById('playPauseBtn');
            
            if (trackImage) trackImage.src = track.album.images[0]?.url || '';
            if (trackName) trackName.textContent = track.name;
            if (trackArtist) trackArtist.textContent = track.artists.map(a => a.name).join(', ');
            if (trackAlbum) trackAlbum.textContent = track.album.name;
            
            if (trackProgress) {
                const progressMinutes = Math.floor(progress / 60000);
                const progressSeconds = Math.floor((progress % 60000) / 1000);
                const durationMinutes = Math.floor(duration / 60000);
                const durationSeconds = Math.floor((duration % 60000) / 1000);
                
                trackProgress.textContent = `${progressMinutes}:${progressSeconds.toString().padStart(2, '0')} / ${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
            }
            
            if (progressBar) {
                const progressPercent = (progress / duration) * 100;
                progressBar.style.width = `${progressPercent}%`;
            }
            
            if (playPauseBtn) {
                playPauseBtn.textContent = state.paused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
            }
        }

        async function updateSpotifyDevices() {
            if (!spotifyAccessToken) return;
            
            try {
                // Real Spotify API call for devices
                const response = await fetch('https://api.spotify.com/v1/me/player/devices', {
                    headers: {
                        'Authorization': `Bearer ${spotifyAccessToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Spotify API error: ${response.status}`);
                }
                
                const data = await response.json();
                const devices = data.devices || [];
                
                const deviceSelect = document.getElementById('deviceSelect');
                if (deviceSelect) {
                    deviceSelect.innerHTML = '<option value="">Select Device</option>' +
                        devices.map(device => 
                            `<option value="${device.id}" ${device.is_active ? 'selected' : ''}>${device.name} (${device.type})</option>`
                        ).join('');
                }
                
                addDebugEntry('spotify', 'success', `Updated ${devices.length} Spotify devices`);
                
            } catch (error) {
                addDebugEntry('spotify', 'error', 'Failed to fetch real Spotify devices', { error: error.message });
                
                // Fallback to basic device list if API fails
                const deviceSelect = document.getElementById('deviceSelect');
                if (deviceSelect) {
                    deviceSelect.innerHTML = `
                        <option value="">No devices available</option>
                        <option value="web_player">Web Player (requires Premium)</option>
                    `;
                }
            }
        }

        async function spotifyTogglePlay() {
            if (!spotifyPlayer) {
                showFloatingNotification('‚ö†Ô∏è Player Not Ready', 'Spotify player is not initialized');
                return;
            }
            
            try {
                await spotifyPlayer.togglePlay();
                showFloatingNotification('üéµ Playback', 'Playback toggled');
            } catch (error) {
                addDebugEntry('spotify', 'error', 'Toggle play failed', { error: error.message });
                showFloatingNotification('‚ùå Playback Error', 'Unable to toggle playback');
            }
        }

        async function spotifyNext() {
            if (!spotifyPlayer) {
                showFloatingNotification('‚ö†Ô∏è Player Not Ready', 'Spotify player is not initialized');
                return;
            }
            
            try {
                await spotifyPlayer.nextTrack();
                showFloatingNotification('‚è≠Ô∏è Next Track', 'Skipped to next track');
            } catch (error) {
                addDebugEntry('spotify', 'error', 'Next track failed', { error: error.message });
                showFloatingNotification('‚ùå Skip Error', 'Unable to skip to next track');
            }
        }

        async function spotifyPrevious() {
            if (!spotifyPlayer) {
                showFloatingNotification('‚ö†Ô∏è Player Not Ready', 'Spotify player is not initialized');
                return;
            }
            
            try {
                await spotifyPlayer.previousTrack();
                showFloatingNotification('‚èÆÔ∏è Previous Track', 'Skipped to previous track');
            } catch (error) {
                addDebugEntry('spotify', 'error', 'Previous track failed', { error: error.message });
                showFloatingNotification('‚ùå Skip Error', 'Unable to skip to previous track');
            }
        }

        function transferToWebPlayer() {
            if (spotifyDeviceId) {
                showFloatingNotification('üì± Transfer', 'Transferring playback to web player');
                // In a real implementation, you'd call the Spotify API to transfer playback
            } else {
                showFloatingNotification('‚ö†Ô∏è No Device', 'Web player device not available');
            }
        }

        function refreshSpotifyConnection() {
            showFloatingNotification('üîÑ Refreshing...', 'Refreshing Spotify connection');
            
            if (spotifyPlayer) {
                spotifyPlayer.disconnect();
                spotifyPlayer = null;
            }
            
            setTimeout(() => {
                if (spotifyAccessToken && window.Spotify) {
                    initializeSpotifyPlayer();
                } else {
                    updateSpotifyConnectionStatus();
                }
                showFloatingNotification('‚úÖ Refreshed', 'Spotify connection refreshed');
            }, 1000);
        }

        async function setSpotifyVolume(volume) {
            const volumeDisplay = document.getElementById('volumeDisplay');
            if (volumeDisplay) volumeDisplay.textContent = `${volume}%`;
            
            if (spotifyPlayer) {
                try {
                    await spotifyPlayer.setVolume(volume / 100);
                } catch (error) {
                    addDebugEntry('spotify', 'error', 'Set volume failed', { error: error.message });
                }
            }
        }

        async function changeSpotifyDevice(deviceId) {
            if (!deviceId) return;
            
            showFloatingNotification('üì± Switching Device...', 'Changing playback device');
            
            // In a real implementation, you'd call the Spotify API to transfer playback
            setTimeout(() => {
                showFloatingNotification('‚úÖ Device Changed', 'Playback device updated');
            }, 1000);
        }

        async function playAIRecommendation(type) {
            const recommendations = {
                energy: 'High-energy workout playlist',
                wellness: 'Calm and relaxing sounds',
                workout: 'Pump-up motivation mix'
            };
            
            const playlist = recommendations[type] || 'AI curated music';
            showFloatingNotification('üéµ AI Recommendation', `Playing: ${playlist}`);
            
            // In a real implementation, you'd search and play specific tracks
        }

        // üéØ FITNESS AND STEPS TRACKING
        function addSteps() {
            const stepsInput = document.getElementById('stepsInput') || document.getElementById('fitnessStepsInput');
            if (!stepsInput) return;
            
            const steps = parseInt(stepsInput.value);
            if (!steps || steps <= 0) {
                showFloatingNotification('‚ö†Ô∏è Invalid Steps', 'Please enter a valid number of steps');
                return;
            }
            
            gameState.dailyStats.steps += steps;
            const xpAmount = Math.min(50, Math.max(5, Math.round(steps / 500)));
            awardXP(xpAmount, `${steps} steps logged`);
            
            stepsInput.value = '';
            updateStatsUI();
            saveGameState('steps_added');
            
            showFloatingNotification('üëü Steps Added!', `${steps.toLocaleString()} steps logged (+${xpAmount} XP)`);
            checkStepsAchievements();
        }

        function quickAddSteps(amount) {
            gameState.dailyStats.steps += amount;
            const xpAmount = Math.min(30, Math.max(5, Math.round(amount / 500)));
            awardXP(xpAmount, `${amount} steps quick add`);
            
            updateStatsUI();
            saveGameState('quick_steps_added');
            
            showFloatingNotification('üëü Steps Added!', `${amount.toLocaleString()} steps (+${xpAmount} XP)`);
            checkStepsAchievements();
        }

        function checkStepsAchievements() {
            const steps = gameState.dailyStats.steps;
            
            if (steps >= 1000 && !hasAchievement('First Thousand')) {
                addAchievement('üëü First Thousand!', 'Walked 1,000 steps today', 30);
            }
            if (steps >= 5000 && !hasAchievement('Walking Warrior')) {
                addAchievement('üö∂ Walking Warrior!', 'Reached 5,000 steps in one day', 50);
            }
            if (steps >= 10000 && !hasAchievement('Step Master')) {
                addAchievement('üèÜ Step Master!', 'Achieved the daily 10,000 step goal', 100);
            }
        }

        function startWorkout(type) {
            const workoutTypes = {
                cardio: { name: 'Cardio Workout', duration: 30, calories: 300, xp: 40 },
                strength: { name: 'Strength Training', duration: 45, calories: 250, xp: 50 },
                yoga: { name: 'Yoga & Flexibility', duration: 60, calories: 150, xp: 30 }
            };
            
            const workout = workoutTypes[type];
            if (!workout) return;
            
            gameState.dailyStats.workouts++;
            gameState.dailyStats.caloriesBurned += workout.calories;
            gameState.dailyStats.exerciseMinutes += workout.duration;
            
            awardXP(workout.xp, `${workout.name} completed`);
            updateStatsUI();
            saveGameState('workout_completed');
            
            showFloatingNotification('üí™ Workout Complete!', 
                `${workout.name}: ${workout.duration}min, ${workout.calories} calories (+${workout.xp} XP)`);
            
            checkWorkoutAchievements();
        }

        function checkWorkoutAchievements() {
            const workouts = gameState.dailyStats.workouts;
            
            if (workouts === 1 && !hasAchievement('First Workout')) {
                addAchievement('üí™ First Workout!', 'Completed your first workout today', 40);
            }
            if (workouts >= 3 && !hasAchievement('Fitness Enthusiast')) {
                addAchievement('üî• Fitness Enthusiast!', 'Completed 3 workouts in one day', 75);
            }
        }

        function quickLogSteps() {
            gameState.dailyStats.steps += 2000;
            awardXP(20, '2000 steps + music');
            updateStatsUI();
            saveGameState('quick_steps_logged');
            
            showFloatingNotification('üëü Steps + Music!', '2000 steps logged with energetic music (+20 XP)');
            checkStepsAchievements();
        }

        function quickLogWorkout() {
            gameState.dailyStats.workouts++;
            gameState.dailyStats.caloriesBurned += 200;
            gameState.dailyStats.exerciseMinutes += 20;
            
            awardXP(30, 'Quick workout + music');
            updateStatsUI();
            saveGameState('quick_workout_logged');
            
            showFloatingNotification('üí™ Workout + Music!', 'Quick workout logged with pump-up music (+30 XP)');
            checkWorkoutAchievements();
        }

        function focusMode() {
            showFloatingNotification('üß† Focus Mode Activated!', 'Starting focus session with lo-fi music');
            awardXP(15, 'Focus mode activated');
        }

        function quickTrackWater() {
            gameState.dailyStats.waterGlasses++;
            awardXP(5, 'Water logged');
            updateStatsUI();
            updateWaterVisualization();
            saveGameState('water_logged');
            
            showFloatingNotification('üíß Water + Music!', `Glass ${gameState.dailyStats.waterGlasses}/8 + calming music`);
            
            if (gameState.dailyStats.waterGlasses === 8) {
                addAchievement('üíß Hydration Hero!', 'Drank 8 glasses of water today', 75);
            }
        }

        // üçΩÔ∏è ENHANCED MEAL LOGGING
        function logMeal(mealType) {
            const mealNames = {
                breakfast: 'üåÖ Breakfast',
                lunch: 'ü•ô Lunch', 
                dinner: 'üçΩÔ∏è Dinner',
                snack: 'üçé Snack'
            };
            
            showMealLoggingModal(mealType, mealNames[mealType]);
        }

        function showMealLoggingModal(mealType, mealName) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">${mealName} Logging</h3>
                    <div class="space-y-4">
                        <button onclick="showNutritionSearch(); this.closest('.modal-overlay').remove()" 
                                class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-all font-medium">
                            üîç Search Specific Food
                        </button>
                        <button onclick="logQuickMeal('${mealType}'); this.closest('.modal-overlay').remove()" 
                                class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-all font-medium">
                            ‚ö° Quick Log Typical ${mealName}
                        </button>
                        <button onclick="generateAIMealSuggestion('${mealType}'); this.closest('.modal-overlay').remove()" 
                                class="w-full bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 transition-all font-medium">
                            üß† AI Meal Suggestion
                        </button>
                        <button onclick="this.closest('.modal-overlay').remove()" 
                                class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-all">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function logQuickMeal(mealType) {
            const mealCalories = { 
                breakfast: { calories: 400, protein: 15, carbs: 45, fat: 12 },
                lunch: { calories: 600, protein: 25, carbs: 55, fat: 18 },
                dinner: { calories: 700, protein: 30, carbs: 60, fat: 22 },
                snack: { calories: 200, protein: 8, carbs: 20, fat: 8 }
            };
            
            const nutrition = mealCalories[mealType] || mealCalories.snack;
            
            gameState.dailyStats.calories += nutrition.calories;
            gameState.dailyStats.protein += nutrition.protein;
            gameState.dailyStats.carbs += nutrition.carbs;
            gameState.dailyStats.fat += nutrition.fat;
            
            const xpAmount = Math.min(30, Math.max(10, Math.round(nutrition.calories / 50)));
            awardXP(xpAmount, `Quick ${mealType} logged`);
            
            updateStatsUI();
            updateNutritionUI();
            saveGameState('quick_meal_logged');
            
            showFloatingNotification('üçΩÔ∏è Quick Meal Logged!', 
                `${nutrition.calories} calories, ${nutrition.protein}g protein (+${xpAmount} XP)`);
            
            checkNutritionAchievements();
        }

        async function generateAIMealSuggestion(mealType) {
            showFloatingNotification('üß† AI Working...', 'Generating personalized meal suggestions');
            
            const mealSuggestions = {
                breakfast: [
                    'Greek yogurt with berries and granola',
                    'Oatmeal with banana and almonds',
                    'Scrambled eggs with whole grain toast',
                    'Protein smoothie with spinach and fruit',
                    'Avocado toast with poached egg'
                ],
                lunch: [
                    'Grilled chicken salad with mixed greens',
                    'Quinoa bowl with roasted vegetables',
                    'Turkey and avocado wrap',
                    'Lentil soup with whole grain bread',
                    'Salmon and sweet potato'
                ],
                dinner: [
                    'Baked fish with steamed broccoli',
                    'Lean beef stir-fry with brown rice',
                    'Grilled chicken with roasted vegetables',
                    'Vegetarian pasta with marinara sauce',
                    'Tofu curry with jasmine rice'
                ],
                snack: [
                    'Apple slices with almond butter',
                    'Greek yogurt with nuts',
                    'Hummus with vegetable sticks',
                    'Mixed berries and cottage cheese',
                    'Trail mix with dried fruit'
                ]
            };
            
            const suggestions = mealSuggestions[mealType] || mealSuggestions.snack;
            const suggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
            
            setTimeout(() => {
                showFloatingNotification('üß† AI Suggestion Ready!', `Try: ${suggestion}`);
            }, 1500);
        }

        // üß† AI COACHING
        async function aiQuickSuggestion() {
            const suggestions = [
                "Perfect timing for a quick 5-minute walk to boost your energy!",
                "Consider drinking a glass of water - hydration improves focus and mood.",
                "Take three deep breaths and set an intention for the next hour.",
                "Quick win: organize one small area of your workspace for mental clarity.",
                "Time for a 2-minute stretch to release tension and re-energize."
            ];
            
            const suggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
            showAIInsight(suggestion);
        }

        function showAIInsight(insight) {
            const coachInsight = document.getElementById('aiCoachInsight');
            if (coachInsight) {
                coachInsight.textContent = insight;
            }
            showFloatingNotification('üí° AI Insight', insight);
        }

        async function getPersonalizedCoaching() {
            const insights = [
                "üéØ Focus on completing 1-2 small tasks to build momentum for the day.",
                "üíß Hydration boost needed! Aim for 2-3 more glasses of water today.",
                "üí™ Even a 10-minute walk can significantly improve your energy and mood.",
                "üìö Consider dedicating 15 minutes to learning something new today."
            ];
            
            displayPersonalizedCoaching(insights.join('\n\n'));
        }

        function displayPersonalizedCoaching(coaching) {
            const coachInsight = document.getElementById('aiCoachInsight');
            if (coachInsight) {
                coachInsight.innerHTML = coaching.replace(/\n/g, '<br>');
            }
            showFloatingNotification('üß† Coaching Ready!', 'Your personalized insights are ready');
        }

        function showAdvancedAI() {
            switchTab('ai');
        }

        function optimizeTaskOrder() {
            showFloatingNotification('üß† Optimizing...', 'AI is reordering your tasks for maximum efficiency');
            
            const activeTasks = gameState.tasks.filter(t => !t.completed);
            activeTasks.sort((a, b) => {
                if (a.difficulty === 'easy' && b.difficulty !== 'easy') return -1;
                if (b.difficulty === 'easy' && a.difficulty !== 'easy') return 1;
                return b.xpReward - a.xpReward;
            });
            
            const completedTasks = gameState.tasks.filter(t => t.completed);
            gameState.tasks = [...activeTasks, ...completedTasks];
            
            updateTasksUI();
            saveGameState('tasks_optimized');
            
            showFloatingNotification('‚úÖ Tasks Optimized!', `${activeTasks.length} tasks reordered for efficiency`);
        }

        function getNewRecommendations() {
            getPersonalizedCoaching();
        }

        function retrainAI() {
            showFloatingNotification('üîÑ Retraining AI...', 'Neural networks are being retrained with your latest patterns');
            
            setTimeout(() => {
                if (neuralNetwork) {
                    const trainingData = generateTrainingData(50);
                    for (let epoch = 0; epoch < 10; epoch++) {
                        trainingData.forEach(({ inputs, outputs }) => {
                            neuralNetwork.backpropagate(inputs, outputs);
                        });
                    }
                    
                    gameState.ai.confidence = Math.min(0.95, gameState.ai.confidence + 0.05);
                    updateAIDisplay();
                }
                
                showFloatingNotification('‚úÖ AI Retrained!', 'Neural networks updated with your latest behavior patterns');
            }, 2000);
        }

        function exportAIData() {
            const aiData = {
                timestamp: new Date().toISOString(),
                confidence: gameState.ai.confidence,
                level: gameState.level,
                totalXP: gameState.totalXP,
                patterns: gameState.patterns,
                interests: gameState.interests,
                dailyStats: gameState.dailyStats,
                achievements: gameState.achievements.length,
                tasks: {
                    total: gameState.tasks.length,
                    completed: gameState.tasks.filter(t => t.completed).length
                }
            };
            
            const blob = new Blob([JSON.stringify(aiData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `life-quest-ai-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showFloatingNotification('üìä Data Exported!', 'AI analysis data has been downloaded');
        }

        function updateAIDisplay() {
            const aiConfidence = document.getElementById('aiConfidence');
            const lastAIUpdate = document.getElementById('lastAIUpdate');
            const neuralTraining = document.getElementById('neuralTraining');
            const neuralAccuracy = document.getElementById('neuralAccuracy');
            
            if (aiConfidence) aiConfidence.textContent = `${Math.round(gameState.ai.confidence * 100)}%`;
            if (lastAIUpdate) lastAIUpdate.textContent = 'Just now';
            if (neuralTraining) neuralTraining.textContent = '92%';
            if (neuralAccuracy) neuralAccuracy.textContent = '96%';
        }

        function updateAIInsights() {
            if (neuralNetwork && mlEngine) {
                try {
                    const currentData = [
                        gameState.dailyStats.tasksCompleted / 10,
                        gameState.dailyStats.workouts / 3,
                        gameState.dailyStats.waterGlasses / 8,
                        gameState.dailyStats.calories / 2000,
                        gameState.level / 10,
                        gameState.currentStreak / 7,
                        new Date().getHours() / 24,
                        gameState.interests.length / 10,
                        gameState.dailyStats.steps / 10000,
                        gameState.dailyStats.exerciseMinutes / 60,
                        (gameState.dailyStats.protein || 0) / 100,
                        Math.random()
                    ];
                    
                    const prediction = neuralNetwork.predict(currentData);
                    gameState.ai.confidence = Math.max(0.7, Math.min(0.95, prediction[0]));
                    
                    updateAIDisplay();
                } catch (error) {
                    addDebugEntry('ai', 'error', 'AI insights update failed', { error: error.message });
                }
            }
        }

        function updateAISensitivity(value) {
            gameState.ai.sensitivity = parseFloat(value);
            document.getElementById('sensitivityValue').textContent = `${Math.round(value * 100)}%`;
            saveGameState('ai_sensitivity_updated');
            showFloatingNotification('üéØ AI Updated', `Sensitivity set to ${Math.round(value * 100)}%`);
        }

        function updateLearningRate(value) {
            gameState.ai.learningRate = parseFloat(value);
            saveGameState('ai_learning_rate_updated');
            showFloatingNotification('‚ö° Learning Rate Updated', `Set to ${value}`);
        }

        function updateAIPersonality(personality) {
            gameState.ai.personality = personality;
            saveGameState('ai_personality_updated');
            
            const personalities = {
                motivational: 'üî• Motivational Coach',
                analytical: 'üìä Data Analyst',
                supportive: 'ü§ó Supportive Friend',
                challenging: 'üí™ Challenging Trainer'
            };
            
            showFloatingNotification('üé® Personality Updated', `AI is now a ${personalities[personality]}`);
        }

        function resetAI() {
            showFloatingNotification('üîÑ Resetting AI...', 'Neural networks and patterns are being reset');
            
            setTimeout(() => {
                gameState.ai.confidence = 0.85;
                gameState.patterns = { activities: {}, preferences: {}, timing: {} };
                
                initializeAI();
                saveGameState('ai_reset');
                
                showFloatingNotification('‚úÖ AI Reset Complete!', 'AI models have been reset and retrained');
            }, 2000);
        }

        // üîß SETTINGS AND CONFIGURATION
        function saveUSDAConfig() {
            const usdaApiKey = document.getElementById('usdaApiKey').value.trim();
            
            if (!usdaApiKey) {
                showFloatingNotification('‚ö†Ô∏è Missing API Key', 'Please enter your USDA API key');
                return;
            }
            
            // Save to both gameState and localStorage for redundancy
            gameState.settings.usdaApiKey = usdaApiKey;
            localStorage.setItem('usdaApiKey', usdaApiKey);
            localStorage.setItem('usdaApiKeyConfigured', 'true');
            
            addDebugEntry('nutrition', 'success', 'USDA API key saved', { 
                keyLength: usdaApiKey.length,
                keyPreview: usdaApiKey.substring(0, 8) + '...'
            });
            
            updateUSDAApiKeyStatus();
            saveGameState('usda_config_saved');
            
            showFloatingNotification('‚úÖ USDA Configuration Saved', 'USDA API key has been saved successfully');
        }

        function saveSpotifyConfig() {
            const clientId = document.getElementById('spotifyClientId').value.trim();
            const redirectUri = document.getElementById('spotifyRedirectUri').value.trim() || window.location.origin;
            
            if (!clientId) {
                showFloatingNotification('‚ö†Ô∏è Missing Client ID', 'Please enter your Spotify Client ID');
                return;
            }
            
            gameState.settings.spotifyClientId = clientId;
            gameState.settings.spotifyRedirectUri = redirectUri;
            
            localStorage.setItem('spotifyClientId', clientId);
            localStorage.setItem('spotifyRedirectUri', redirectUri);
            
            updateSpotifyClientIdStatus();
            saveGameState('spotify_config_saved');
            
            showFloatingNotification('‚úÖ Configuration Saved', 'Spotify settings have been saved successfully');
        }

        function updateUSDAApiKeyStatus() {
            const apiKey = gameState.settings.usdaApiKey || localStorage.getItem('usdaApiKey') || '';
            const statusElement = document.getElementById('usdaApiKeyStatus');
            const displayStatusElement = document.getElementById('usdaApiKeyDisplayStatus');
            const limitElement = document.getElementById('usdaApiLimit');
            const qualityElement = document.getElementById('usdaSearchQuality');
            
            if (apiKey && apiKey !== 'DEMO_KEY') {
                if (statusElement) {
                    statusElement.classList.remove('hidden');
                    setTimeout(() => statusElement.classList.add('hidden'), 3000);
                }
                if (displayStatusElement) {
                    displayStatusElement.textContent = 'Configured (Personal Key)';
                    displayStatusElement.className = 'font-medium text-green-600 dark:text-green-400';
                }
                if (limitElement) {
                    limitElement.textContent = '1,000 requests/hour (Personal tier)';
                }
                if (qualityElement) {
                    qualityElement.textContent = 'Full access (400,000+ foods)';
                    qualityElement.className = 'font-medium text-green-600 dark:text-green-400';
                }
            } else {
                if (displayStatusElement) {
                    displayStatusElement.textContent = 'Demo Mode';
                    displayStatusElement.className = 'font-medium text-orange-600 dark:text-orange-400';
                }
                if (limitElement) {
                    limitElement.textContent = '25 requests/hour (Demo tier)';
                }
                if (qualityElement) {
                    qualityElement.textContent = 'Limited (5 results max)';
                    qualityElement.className = 'font-medium text-orange-600 dark:text-orange-400';
                }
            }
        }

        function updateSpotifyClientIdStatus() {
            const config = getSpotifyConfig();
            const statusElement = document.getElementById('clientIdStatus');
            const aboutStatusElement = document.getElementById('aboutSpotifyStatus');
            
            if (config.clientId) {
                if (statusElement) {
                    statusElement.classList.remove('hidden');
                    setTimeout(() => statusElement.classList.add('hidden'), 3000);
                }
                if (aboutStatusElement) {
                    aboutStatusElement.textContent = spotifyAccessToken ? 'Connected' : 'Configured';
                    aboutStatusElement.className = spotifyAccessToken ? 'text-green-600 dark:text-green-400' : 'text-blue-600 dark:text-blue-400';
                }
            } else {
                if (aboutStatusElement) {
                    aboutStatusElement.textContent = 'Not Configured';
                    aboutStatusElement.className = 'text-gray-600 dark:text-gray-400';
                }
            }
        }

        function loadSettings() {
            const spotifyClientId = document.getElementById('spotifyClientId');
            const spotifyRedirectUri = document.getElementById('spotifyRedirectUri');
            const currentRedirectUri = document.getElementById('currentRedirectUri');
            
            if (spotifyClientId) {
                spotifyClientId.value = gameState.settings.spotifyClientId || localStorage.getItem('spotifyClientId') || '';
            }
            
            if (spotifyRedirectUri) {
                spotifyRedirectUri.value = gameState.settings.spotifyRedirectUri || localStorage.getItem('spotifyRedirectUri') || '';
            }
            
            if (currentRedirectUri) {
                currentRedirectUri.textContent = window.location.origin;
            }
            
            const settingsMap = {
                notificationsToggle: 'notifications',
                animationsToggle: 'animations', 
                soundToggle: 'soundEffects',
                aiLearningToggle: 'aiLearning'
            };
            
            Object.entries(settingsMap).forEach(([elementId, settingKey]) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.checked = gameState.settings[settingKey] !== false;
                }
            });
            
            loadUserProfile();
            updateInterestsUI();
            updateSpotifyClientIdStatus();
        }

        function toggleSetting(settingKey, value) {
            gameState.settings[settingKey] = value;
            saveGameState('setting_changed');
            
            showFloatingNotification('‚öôÔ∏è Setting Updated', `${settingKey} ${value ? 'enabled' : 'disabled'}`);
        }

        function loadUserProfile() {
            const profileFields = {
                userHeight: 'height',
                userWeight: 'weight',
                userAge: 'age',
                userGender: 'gender',
                activityLevel: 'activityLevel',
                fitnessGoal: 'fitnessGoal'
            };
            
            Object.entries(profileFields).forEach(([elementId, profileKey]) => {
                const element = document.getElementById(elementId);
                if (element && gameState.profile[profileKey]) {
                    element.value = gameState.profile[profileKey];
                }
            });
            
            populateEquipmentOptions();
            populateHealthConditions();
        }

        function populateEquipmentOptions() {
            const equipmentContainer = document.getElementById('equipmentSelection');
            if (!equipmentContainer) return;
            
            const equipment = [
                'Dumbbells', 'Resistance Bands', 'Yoga Mat', 'Treadmill', 'Bicycle',
                'Pull-up Bar', 'Kettlebells', 'Foam Roller', 'Jump Rope', 'Exercise Ball'
            ];
            
            equipmentContainer.innerHTML = equipment.map(item => `
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" value="${item}" onchange="updateEquipment()"
                           ${(gameState.profile.equipment || []).includes(item) ? 'checked' : ''}
                           class="rounded border-gray-300 dark:border-gray-600">
                    <span class="text-sm">${item}</span>
                </label>
            `).join('');
        }

        function populateHealthConditions() {
            const healthContainer = document.getElementById('healthConditions');
            if (!healthContainer) return;
            
            const conditions = [
                'Diabetes', 'Hypertension', 'Heart Disease', 'Arthritis',
                'Back Problems', 'Knee Issues', 'None'
            ];
            
            healthContainer.innerHTML = conditions.map(condition => `
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" value="${condition}" onchange="updateHealthConditions()"
                           ${(gameState.profile.healthConditions || []).includes(condition) ? 'checked' : ''}
                           class="rounded border-gray-300 dark:border-gray-600">
                    <span class="text-sm">${condition}</span>
                </label>
            `).join('');
        }

        function updateEquipment() {
            const checkboxes = document.querySelectorAll('#equipmentSelection input[type="checkbox"]');
            gameState.profile.equipment = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
        }

        function updateHealthConditions() {
            const checkboxes = document.querySelectorAll('#healthConditions input[type="checkbox"]');
            gameState.profile.healthConditions = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
        }

        function saveUserProfile() {
            const height = parseFloat(document.getElementById('userHeight').value);
            const weight = parseFloat(document.getElementById('userWeight').value);
            const age = parseInt(document.getElementById('userAge').value);
            const gender = document.getElementById('userGender').value;
            const activityLevel = document.getElementById('activityLevel').value;
            const fitnessGoal = document.getElementById('fitnessGoal').value;
            
            gameState.profile = {
                ...gameState.profile,
                height,
                weight,
                age,
                gender,
                activityLevel,
                fitnessGoal
            };
            
            if (height && weight && age && gender) {
                calculateHealthMetrics();
                displayHealthMetrics();
                displayDailyTargets();
            }
            
            saveGameState('profile_saved');
            showFloatingNotification('‚úÖ Profile Saved!', 'Your health metrics have been calculated');
        }

        function calculateHealthMetrics() {
            const { height, weight, age, gender, activityLevel } = gameState.profile;
            
            const heightM = height / 100;
            const bmi = weight / (heightM * heightM);
            
            let bmr;
            if (gender === 'male') {
                bmr = 10 * weight + 6.25 * height - 5 * age + 5;
            } else {
                bmr = 10 * weight + 6.25 * height - 5 * age - 161;
            }
            
            const activityMultipliers = {
                sedentary: 1.2,
                light: 1.375,
                moderate: 1.55,
                active: 1.725,
                very_active: 1.9
            };
            const tdee = bmr * (activityMultipliers[activityLevel] || 1.55);
            
            const idealWeightMin = 18.5 * heightM * heightM;
            const idealWeightMax = 24.9 * heightM * heightM;
            
            gameState.healthMetrics = {
                bmi: Math.round(bmi * 10) / 10,
                bmr: Math.round(bmr),
                tdee: Math.round(tdee),
                idealWeight: {
                    min: Math.round(idealWeightMin),
                    max: Math.round(idealWeightMax)
                },
                dailyCalorieTarget: Math.round(tdee),
                proteinRequirement: Math.round(weight * 0.8),
                waterRequirement: Math.round(weight * 35),
                dailyStepsTarget: activityLevel === 'sedentary' ? 8000 : 10000,
                weeklyExerciseMinutes: 150
            };
        }

        function displayHealthMetrics() {
            const metricsContainer = document.getElementById('healthMetrics');
            if (!metricsContainer) return;
            
            const { bmi, bmr, tdee, idealWeight } = gameState.healthMetrics;
            
            const bmiCategory = bmi < 18.5 ? 'Underweight' :
                              bmi < 25 ? 'Normal' :
                              bmi < 30 ? 'Overweight' : 'Obese';
            
            const bmiColor = bmiCategory === 'Normal' ? 'text-green-600' : 'text-orange-600';
            
            metricsContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                        <div class="text-xl font-bold ${bmiColor}">${bmi}</div>
                        <div class="text-sm text-blue-500">BMI (${bmiCategory})</div>
                    </div>
                    <div class="text-center p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                        <div class="text-xl font-bold text-green-600">${bmr}</div>
                        <div class="text-sm text-green-500">BMR (calories/day)</div>
                    </div>
                    <div class="text-center p-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg">
                        <div class="text-xl font-bold text-orange-600">${tdee}</div>
                        <div class="text-sm text-orange-500">TDEE (calories/day)</div>
                    </div>
                    <div class="text-center p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                        <div class="text-xl font-bold text-purple-600">${idealWeight.min}-${idealWeight.max}</div>
                        <div class="text-sm text-purple-500">Ideal Weight (kg)</div>
                    </div>
                </div>
            `;
        }

        function displayDailyTargets() {
            const targetsContainer = document.getElementById('dailyTargets');
            if (!targetsContainer) return;
            
            const { dailyCalorieTarget, proteinRequirement, waterRequirement, dailyStepsTarget, weeklyExerciseMinutes } = gameState.healthMetrics;
            
            targetsContainer.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-red-50 dark:bg-red-900/30 rounded-lg">
                        <span class="text-red-700 dark:text-red-300">üî• Daily Calories</span>
                        <span class="font-bold text-red-600">${dailyCalorieTarget}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                        <span class="text-green-700 dark:text-green-300">ü•© Daily Protein</span>
                        <span class="font-bold text-green-600">${proteinRequirement}g</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                        <span class="text-blue-700 dark:text-blue-300">üíß Daily Water</span>
                        <span class="font-bold text-blue-600">${Math.round(waterRequirement / 250)} glasses</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg">
                        <span class="text-yellow-700 dark:text-yellow-300">üëü Daily Steps</span>
                        <span class="font-bold text-yellow-600">${dailyStepsTarget.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                        <span class="text-purple-700 dark:text-purple-300">üèÉ Weekly Exercise</span>
                        <span class="font-bold text-purple-600">${weeklyExerciseMinutes} min</span>
                    </div>
                </div>
            `;
        }

        // üéØ INTERESTS MANAGEMENT
        function updateInterestsUI() {
            const interestsList = document.getElementById('interestsList');
            if (!interestsList) return;
            
            if (!gameState.interests || gameState.interests.length === 0) {
                interestsList.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-sm p-3">No interests added yet. Add some to get personalized AI suggestions!</div>';
                return;
            }
            
            interestsList.innerHTML = gameState.interests.map(interest => `
                <span class="inline-flex items-center space-x-1 bg-primary text-white px-3 py-1 rounded-full text-sm">
                    <span>${interest}</span>
                    <button onclick="removeInterest('${interest}')" class="text-white hover:text-gray-200 ml-1">√ó</button>
                </span>
            `).join('');
        }

        function addInterest() {
            const input = document.getElementById('newInterest');
            if (!input) return;
            
            const interest = input.value.trim().toLowerCase();
            if (!interest) {
                showFloatingNotification('‚ö†Ô∏è Empty Interest', 'Please enter an interest');
                return;
            }
            
            if (gameState.interests.includes(interest)) {
                showFloatingNotification('‚ö†Ô∏è Duplicate Interest', 'This interest is already added');
                return;
            }
            
            gameState.interests.push(interest);
            input.value = '';
            
            updateInterestsUI();
            saveGameState('interest_added');
            
            showFloatingNotification('‚úÖ Interest Added!', `"${interest}" added to your interests`);
        }

        function removeInterest(interest) {
            const index = gameState.interests.indexOf(interest);
            if (index > -1) {
                gameState.interests.splice(index, 1);
                updateInterestsUI();
                saveGameState('interest_removed');
                
                showFloatingNotification('üóëÔ∏è Interest Removed', `"${interest}" removed from your interests`);
            }
        }

        // üìä ANALYTICS AND REPORTING
        function generateWorkoutPlan() {
            showFloatingNotification('üß† Generating...', 'Creating your personalized workout plan');
            
            const workoutPlan = [
                { day: 'Monday', workout: 'üí™ Upper Body Strength', duration: '45min' },
                { day: 'Tuesday', workout: 'üèÉ Cardio Session', duration: '30min' },
                { day: 'Wednesday', workout: 'üßò Yoga & Flexibility', duration: '60min' },
                { day: 'Thursday', workout: 'üí™ Lower Body Strength', duration: '45min' },
                { day: 'Friday', workout: 'üèÉ HIIT Training', duration: '25min' },
                { day: 'Saturday', workout: 'üö∂ Active Recovery Walk', duration: '45min' },
                { day: 'Sunday', workout: 'üõå Rest Day', duration: 'Rest' }
            ];
            
            const container = document.getElementById('weeklyWorkoutPlan');
            if (container) {
                container.innerHTML = workoutPlan.map(item => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div>
                            <div class="font-medium">${item.day}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">${item.workout}</div>
                        </div>
                        <div class="text-sm font-medium text-primary">${item.duration}</div>
                    </div>
                `).join('');
            }
            
            showFloatingNotification('üìÖ Plan Generated!', 'Your personalized workout plan is ready');
        }

        function generateMealPlan() {
            showFloatingNotification('üß† Generating...', 'Creating your personalized meal plan');
            
            const mealPlan = [
                { day: 'Monday', meals: 'Oatmeal ‚Üí Grilled Chicken Salad ‚Üí Salmon & Veggies' },
                { day: 'Tuesday', meals: 'Greek Yogurt ‚Üí Turkey Wrap ‚Üí Stir-fry' },
                { day: 'Wednesday', meals: 'Smoothie Bowl ‚Üí Quinoa Salad ‚Üí Lean Beef & Rice' },
                { day: 'Thursday', meals: 'Eggs & Toast ‚Üí Chicken Bowl ‚Üí Fish Tacos' },
                { day: 'Friday', meals: 'Protein Pancakes ‚Üí Soup & Sandwich ‚Üí Pasta & Chicken' },
                { day: 'Saturday', meals: 'Avocado Toast ‚Üí Power Bowl ‚Üí Grilled Portobello' },
                { day: 'Sunday', meals: 'Brunch Special ‚Üí Light Snacks ‚Üí Comfort Meal' }
            ];
            
            const container = document.getElementById('weeklyMealPlan');
            if (container) {
                container.innerHTML = mealPlan.map(item => `
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="font-medium text-green-700 dark:text-green-300 mb-1">${item.day}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">${item.meals}</div>
                    </div>
                `).join('');
            }
            
            showFloatingNotification('üçΩÔ∏è Plan Generated!', 'Your personalized meal plan is ready');
        }

        function generateMusicRecommendations() {
            showFloatingNotification('üéµ Generating...', 'Creating AI music recommendations');
            
            const recommendations = [
                { type: 'Morning Energy', description: 'Upbeat tracks to start your day right' },
                { type: 'Focus Flow', description: 'Ambient sounds for deep concentration' },
                { type: 'Workout Power', description: 'High-energy beats for exercise motivation' },
                { type: 'Evening Calm', description: 'Relaxing melodies for winding down' }
            ];
            
            const container = document.getElementById('musicRecommendations');
            if (container) {
                container.innerHTML = recommendations.map(rec => `
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="font-medium text-sm">${rec.type}</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">${rec.description}</div>
                        <button onclick="playAIRecommendation('${rec.type.toLowerCase().replace(' ', '_')}')" 
                                class="mt-2 text-xs bg-green-500 text-white px-3 py-1 rounded">
                            Play
                        </button>
                    </div>
                `).join('');
            }
            
            showFloatingNotification('üéµ Recommendations Ready!', 'New music suggestions generated');
        }

        function updateAnalytics() {
            const trendContainer = document.getElementById('trendAnalysis');
            if (trendContainer) {
                const trends = [
                    { metric: 'üìä Task Completion', trend: '+15%', period: 'This week vs last week' },
                    { metric: 'üí™ Workout Frequency', trend: '+8%', period: 'Monthly improvement' },
                    { metric: 'üíß Hydration Consistency', trend: '+22%', period: 'Daily average increase' },
                    { metric: 'üéØ Goal Achievement', trend: '+12%', period: 'Overall success rate' }
                ];
                
                trendContainer.innerHTML = trends.map(trend => `
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium">${trend.metric}</span>
                            <span class="text-sm text-green-600 dark:text-green-400 font-bold">${trend.trend}</span>
                        </div>
                        <div class="text-xs text-gray-500">${trend.period}</div>
                    </div>
                `).join('');
            }
        }

        // üîÑ DATA MANAGEMENT
        function backupData() {
            const backupData = {
                timestamp: new Date().toISOString(),
                version: '2.3.0-nutrition',
                gameState: gameState,
                meta: {
                    totalSaves: storageManager ? storageManager.saveCounter : 0,
                    debugEntries: debugConsole ? debugConsole.entries.length : 0
                }
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `life-quest-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showFloatingNotification('üì¶ Backup Created!', 'Your data has been backed up successfully');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (backupData.gameState) {
                            Object.assign(gameState, backupData.gameState);
                            saveGameState('data_restored');
                            updateAllUI();
                            
                            showFloatingNotification('üìÇ Data Restored!', 'Your backup has been successfully restored');
                        } else {
                            throw new Error('Invalid backup format');
                        }
                    } catch (error) {
                        showFloatingNotification('‚ùå Restore Failed', 'Invalid backup file format');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function resetData() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold text-red-700 dark:text-red-300 mb-4">‚ö†Ô∏è Reset All Data</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                        This will permanently delete all your progress, achievements, and settings. This action cannot be undone.
                    </p>
                    <div class="mb-4">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="confirmReset" class="rounded border-gray-300">
                            <span class="text-sm">I understand this will delete all my data</span>
                        </label>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="performDataReset()" class="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition-all font-medium">
                            üóëÔ∏è Reset Everything
                        </button>
                        <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-all">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function performDataReset() {
            const confirmCheckbox = document.getElementById('confirmReset');
            if (!confirmCheckbox || !confirmCheckbox.checked) {
                showFloatingNotification('‚ö†Ô∏è Confirmation Required', 'Please confirm you want to reset all data');
                return;
            }
            
            gameState = {
                level: 1,
                xp: 0,
                totalXP: 0,
                currentStreak: 0,
                profile: {},
                healthMetrics: {},
                dailyStats: {
                    workouts: 0,
                    waterGlasses: 0,
                    calories: 0,
                    protein: 0,
                    carbs: 0,
                    fat: 0,
                    tasksCompleted: 0,
                    totalTasks: 0,
                    caloriesBurned: 0,
                    exerciseMinutes: 0,
                    steps: 0
                },
                tasks: [],
                achievements: [],
                interests: ['fitness', 'productivity', 'learning'],
                patterns: { activities: {}, preferences: {}, timing: {} },
                ai: {
                    neuralNetwork: null,
                    mlEngine: null,
                    confidence: 0.85,
                    lastUpdate: Date.now(),
                    predictions: {},
                    insights: []
                },
                settings: {
                    notifications: true,
                    animations: true,
                    soundEffects: true,
                    aiLearning: true,
                    spotifyClientId: '',
                    spotifyRedirectUri: ''
                }
            };
            
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('lifeQuestAI') || key.startsWith('spotify')) {
                    localStorage.removeItem(key);
                }
            });
            
            if (debugConsole) {
                debugConsole.clear();
            }
            
            saveGameState('data_reset');
            updateAllUI();
            
            document.querySelector('.modal-overlay').remove();
            showFloatingNotification('üóëÔ∏è Data Reset Complete!', 'All data has been cleared. Starting fresh!');
        }

        // üéÆ UI MANAGEMENT AND NAVIGATION
        function switchTab(tabName) {
            // Remove active class from all tabs and buttons
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activate target tab
            const targetTab = document.getElementById(`${tabName}-tab`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Find and activate the correct button
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase().includes(tabName) || 
                    (tabName === 'dashboard' && btn.textContent.includes('Dashboard')) ||
                    (tabName === 'tasks' && btn.textContent.includes('Tasks')) ||
                    (tabName === 'fitness' && btn.textContent.includes('Fitness')) ||
                    (tabName === 'nutrition' && btn.textContent.includes('Nutrition')) ||
                    (tabName === 'ai' && btn.textContent.includes('AI Coach')) ||
                    (tabName === 'analytics' && btn.textContent.includes('Analytics')) ||
                    (tabName === 'music' && btn.textContent.includes('Music')) ||
                    (tabName === 'settings' && btn.textContent.includes('Settings'))) {
                    btn.classList.add('active');
                }
            });
            
            // Tab-specific initialization
            switch(tabName) {
                case 'dashboard':
                    updateStatsUI();
                    updateTasksUI();
                    updateAchievementsUI();
                    break;
                case 'tasks':
                    updateTasksUI();
                    break;
                case 'fitness':
                    updateStatsUI();
                    break;
                case 'nutrition':
                    updateNutritionUI();
                    updateWaterVisualization();
                    break;
                case 'ai':
                    updateAIDisplay();
                    break;
                case 'analytics':
                    updateAnalytics();
                    break;
                case 'music':
                    updateCurrentTrack();
                    updateSpotifyConnectionStatus();
                    break;
                case 'settings':
                    loadSettings();
                    updateSettingsCounters();
                    break;
            }
            
            addDebugEntry('ui', 'info', `Switched to ${tabName} tab`);
        }

        function updateSettingsCounters() {
            const elements = {
                taskCount: gameState.tasks.length,
                achievementCount: gameState.achievements.length,
                patternCount: Object.keys(gameState.patterns?.activities || {}).length,
                totalXPDisplay: gameState.totalXP
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value.toString();
            });
        }

        function updateAllUI() {
            updateStatsUI();
            updatePlayerUI();
            updateTasksUI();
            updateAchievementsUI();
            updateNutritionUI();
            updateSpotifyConnectionStatus();
            updateInterestsUI();
            updateWaterVisualization();
            updateCurrentTab();
        }

        function updateCurrentTab() {
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                const tabName = activeTab.id.replace('-tab', '');
                
                switch(tabName) {
                    case 'analytics':
                        updateAnalytics();
                        break;
                    case 'settings':
                        updateSettingsCounters();
                        break;
                }
            }
        }

        function deleteTask(taskId) {
            const taskIndex = gameState.tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const task = gameState.tasks[taskIndex];
            
            // Show confirmation modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üóëÔ∏è Delete Task</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                        Are you sure you want to delete "<strong>${task.title}</strong>"?
                    </p>
                    <div class="flex space-x-3">
                        <button onclick="confirmDeleteTask('${taskId}'); this.closest('.modal-overlay').remove()" 
                                class="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-all">
                            Delete
                        </button>
                        <button onclick="this.closest('.modal-overlay').remove()" 
                                class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-all">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmDeleteTask(taskId) {
            const taskIndex = gameState.tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const task = gameState.tasks[taskIndex];
            gameState.tasks.splice(taskIndex, 1);
            
            if (!task.completed) {
                gameState.dailyStats.totalTasks = Math.max(0, gameState.dailyStats.totalTasks - 1);
            }
            
            addDebugEntry('tasks', 'info', `Task deleted: ${task.title}`, { taskId });
            
            updateTasksUI();
            saveGameState('task_deleted');
            
            showFloatingNotification('üóëÔ∏è Task Deleted', `"${task.title}" has been removed`);
        }

        function editTask(taskId) {
            const task = gameState.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">‚úèÔ∏è Edit Task</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Task Title</label>
                            <input type="text" id="editTaskTitle" value="${task.title}" 
                                   class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Category</label>
                            <select id="editTaskCategory" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <option value="fitness" ${task.category === 'fitness' ? 'selected' : ''}>üí™ Fitness</option>
                                <option value="nutrition" ${task.category === 'nutrition' ? 'selected' : ''}>ü•ó Nutrition</option>
                                <option value="wellness" ${task.category === 'wellness' ? 'selected' : ''}>üßò Wellness</option>
                                <option value="productivity" ${task.category === 'productivity' ? 'selected' : ''}>üìã Productivity</option>
                                <option value="learning" ${task.category === 'learning' ? 'selected' : ''}>üìö Learning</option>
                                <option value="personal" ${task.category === 'personal' ? 'selected' : ''}>üë§ Personal</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Difficulty</label>
                            <select id="editTaskDifficulty" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <option value="easy" ${task.difficulty === 'easy' ? 'selected' : ''}>Easy (10 XP)</option>
                                <option value="medium" ${task.difficulty === 'medium' ? 'selected' : ''}>Medium (25 XP)</option>
                                <option value="hard" ${task.difficulty === 'hard' ? 'selected' : ''}>Hard (50 XP)</option>
                                <option value="extreme" ${task.difficulty === 'extreme' ? 'selected' : ''}>Extreme (100 XP)</option>
                            </select>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="saveTaskEdit('${taskId}'); this.closest('.modal-overlay').remove()" 
                                    class="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-all font-medium">
                                Save Changes
                            </button>
                            <button onclick="this.closest('.modal-overlay').remove()" 
                                    class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-all">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('editTaskTitle').focus();
        }

        function saveTaskEdit(taskId) {
            const task = gameState.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const newTitle = document.getElementById('editTaskTitle').value.trim();
            const newCategory = document.getElementById('editTaskCategory').value;
            const newDifficulty = document.getElementById('editTaskDifficulty').value;
            
            if (!newTitle) {
                showFloatingNotification('‚ö†Ô∏è Missing Title', 'Please enter a task title');
                return;
            }
            
            const xpMap = { easy: 10, medium: 25, hard: 50, extreme: 100 };
            
            task.title = newTitle;
            task.category = newCategory;
            task.difficulty = newDifficulty;
            task.xpReward = xpMap[newDifficulty];
            
            addDebugEntry('tasks', 'info', `Task edited: ${task.title}`, { taskId, changes: { newTitle, newCategory, newDifficulty } });
            
            updateTasksUI();
            saveGameState('task_edited');
            
            showFloatingNotification('‚úèÔ∏è Task Updated', `"${newTitle}" has been updated`);
        }

        function showFloatingNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'floating-notification bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-200 dark:border-gray-600 max-w-sm';
            
            const iconMap = {
                info: 'üí°',
                success: '‚úÖ',
                warning: '‚ö†Ô∏è',
                error: '‚ùå',
                achievement: 'üèÜ'
            };
            
            notification.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="text-2xl">${iconMap[type] || iconMap.info}</div>
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800 dark:text-gray-200">${title}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">${message}</div>
                    </div>
                </div>
            `;
            
            const container = document.getElementById('notifications');
            if (container) {
                container.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }
        }

        function showLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'flex';
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        function initializeApp() {
            showLoadingScreen();
            
            if (initializeStorageManager()) {
                addDebugEntry('storage', 'success', 'Storage manager initialized successfully');
            }
            
            setTimeout(() => {
                loadGameState();
                initializeAI();
                updateAllUI();
                generateInitialTasks();
                hideLoadingScreen();
                
                showFloatingNotification('üöÄ Welcome!', 'Advanced AI Life Coach with Nutrition Tracker is ready!');
                
                setInterval(() => saveGameState('auto_save'), 30000);
                setInterval(updateAIInsights, 60000);
            }, 2000);
        }

        // Initialize debug console
        initializeDebugConsole();

        // Initialize app on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('appStartTime')) {
                localStorage.setItem('appStartTime', Date.now().toString());
            }
            
            handleSpotifyCallback();
            restoreSpotifyTokens();
            initializeApp();
            
            setTimeout(() => {
                loadSettings();
            }, 1000);
        });
    </script>
</body>
</html>
