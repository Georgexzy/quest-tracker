<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Life Quest RPG - Ultimate AI Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        fitness: '#ef4444',
                        nutrition: '#16a34a',
                        hydration: '#3b82f6',
                        wellness: '#a855f7',
                        focus: '#f59e0b',
                        personal: '#6366f1'
                    }
                }
            }
        }
        
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .floating-notification {
            animation: slideInRight 0.5s ease-out, slideOutRight 0.5s ease-in 2.5s forwards;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .xp-burst {
            animation: xpBurst 2s ease-out forwards;
        }
        @keyframes xpBurst {
            0% { transform: scale(1) translateY(0); opacity: 1; }
            50% { transform: scale(1.2) translateY(-20px); opacity: 1; }
            100% { transform: scale(1) translateY(-60px); opacity: 0; }
        }
        .level-up {
            animation: levelUp 1s ease-out;
        }
        @keyframes levelUp {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-bottom: 2px solid #ffffff;
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
        }
        .neural-network-bg {
            background: linear-gradient(45deg, rgba(93, 92, 222, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
            background-size: 20px 20px;
            animation: pulse 4s ease-in-out infinite;
        }
        .pattern-learning-indicator {
            background: linear-gradient(45deg, #5D5CDE, #9333EA);
            animation: learning-pulse 2s ease-in-out infinite;
        }
        @keyframes learning-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        .ai-insight {
            background: linear-gradient(135deg, #5D5CDE 0%, #9333EA 100%);
            position: relative;
            overflow: hidden;
        }
        .ai-insight::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .task-completion-effect {
            animation: taskComplete 0.6s ease-out;
        }
        @keyframes taskComplete {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: #10b981; }
            100% { transform: scale(1); }
        }
        .modal-overlay {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.4);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-300">
    
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="text-6xl mb-4">üß†</div>
            <div class="text-2xl font-bold text-white mb-2">Life Quest RPG</div>
            <div class="text-lg text-purple-200 mb-8">Ultimate AI Edition</div>
            <div class="flex space-x-1 justify-center">
                <div class="w-3 h-3 bg-white rounded-full animate-bounce"></div>
                <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
        </div>
    </div>

    <div class="min-h-screen">
        <!-- Header -->
        <header class="gradient-bg text-white p-4 shadow-lg relative overflow-hidden">
            <div class="max-w-7xl mx-auto relative z-10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div class="text-3xl">üß†</div>
                            <div>
                                <h1 class="text-2xl font-bold">Life Quest RPG</h1>
                                <div class="flex items-center space-x-2 text-sm opacity-90">
                                    <span>Ultimate AI Edition</span>
                                    <div class="bg-gradient-to-r from-green-400 to-blue-500 px-2 py-1 rounded-full text-xs">
                                        AI Active
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="neural-network-bg p-3 rounded-lg">
                            <div class="text-xs text-center">
                                <div class="pattern-learning-indicator w-4 h-4 rounded-full mx-auto mb-1"></div>
                                <div>Learning</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="flex space-x-2">
                            <button onclick="aiQuickSuggestion()" class="glass-effect px-3 py-1 rounded-lg text-sm hover:bg-white/20 transition-all">
                                üß† AI Tip
                            </button>
                            <button onclick="switchTab('settings')" class="glass-effect px-3 py-1 rounded-lg text-sm hover:bg-white/20 transition-all">
                                ‚öôÔ∏è Settings
                            </button>
                        </div>
                        
                        <div class="text-right">
                            <div class="flex items-center space-x-2">
                                <div id="playerLevel" class="font-bold text-lg">Level 1</div>
                                <div class="pattern-learning-indicator w-4 h-4 rounded-full"></div>
                            </div>
                            <div class="text-xs opacity-90">
                                <span id="currentXP">0</span>/<span id="nextLevelXP">100</span> XP
                            </div>
                            <div class="text-xs text-yellow-300">
                                üî• <span id="currentStreak">0</span> day streak
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- XP Progress Bar -->
                <div class="mt-4">
                    <div class="flex items-center justify-between mb-1">
                        <div class="text-xs text-white/80">Experience Progress</div>
                        <div class="text-xs text-white/80" id="xpProgressPercent">0%</div>
                    </div>
                    <div class="bg-white/20 rounded-full h-3 relative overflow-hidden">
                        <div id="xpProgress" class="bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 h-full rounded-full transition-all duration-1000" style="width: 0%">
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-pulse"></div>
                        </div>
                    </div>
                </div>
                
                <!-- AI Status -->
                <div class="mt-3 flex items-center justify-between">
                    <div class="flex space-x-3">
                        <div class="bg-green-500/20 px-2 py-1 rounded-full text-xs">
                            üåç Context: <span id="currentContext">Active</span>
                        </div>
                        <div class="bg-white/10 px-2 py-1 rounded-full text-xs">
                            üß† AI Confidence: <span id="aiConfidence">85%</span>
                        </div>
                        <div class="bg-white/10 px-2 py-1 rounded-full text-xs">
                            ‚ö° Energy: <span id="energyLevel">Good</span>
                        </div>
                    </div>
                    <div class="text-xs text-white/70">
                        AI last updated: <span id="lastAIUpdate">Just now</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="gradient-bg border-b border-white/20">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex space-x-6 overflow-x-auto">
                    <button onclick="switchTab('dashboard')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap active">
                        üìä Dashboard
                    </button>
                    <button onclick="switchTab('tasks')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üìã Tasks
                    </button>
                    <button onclick="switchTab('fitness')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üí™ Fitness
                    </button>
                    <button onclick="switchTab('nutrition')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        ü•ó Nutrition
                    </button>
                    <button onclick="switchTab('ai')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üß† AI Coach
                    </button>
                    <button onclick="switchTab('analytics')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üìà Analytics
                    </button>
                    <button onclick="switchTab('music')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üéµ Music AI
                    </button>
                    <button onclick="switchTab('settings')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        ‚öôÔ∏è Settings
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-4">
            <!-- AI Insights (visible on all tabs) -->
            <div id="aiInsights" class="mb-6"></div>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <!-- Stats Cards -->
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-fitness text-2xl">üí™</span>
                            <span id="workoutCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Workouts</div>
                        <div class="text-xs text-fitness">Goal: 1/day</div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-hydration text-2xl">üíß</span>
                            <span id="waterCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Water</div>
                        <div class="text-xs text-hydration">Goal: 8 glasses</div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-nutrition text-2xl">ü•ó</span>
                            <span id="caloriesCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Calories</div>
                        <div class="text-xs text-nutrition">Goal: 2000</div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-focus text-2xl">üìã</span>
                            <span id="tasksCompletedDisplay" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Tasks</div>
                        <div class="text-xs text-focus">Today</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Today's Quests -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">üìã Today's Quests</h3>
                            <button onclick="generateAITasks()" class="text-primary hover:text-purple-600 text-sm">
                                üß† AI Generate
                            </button>
                        </div>
                        <div id="tasksList" class="space-y-2 max-h-64 overflow-y-auto mb-4">
                            <!-- Tasks will be populated here -->
                        </div>
                        <button onclick="addCustomTask()" class="w-full bg-personal text-white py-2 rounded hover:bg-indigo-600 transition-all">
                            ‚ûï Add Quest
                        </button>
                    </div>

                    <!-- Achievements -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üèÜ Achievements</h3>
                        <div id="achievementsList" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Achievements will be populated here -->
                        </div>
                    </div>

                    <!-- AI Coach -->
                    <div class="ai-insight p-6 rounded-xl shadow-lg text-white relative overflow-hidden">
                        <div class="relative z-10">
                            <h3 class="text-xl font-bold mb-3 flex items-center space-x-2">
                                <span>üß†</span>
                                <span>AI Coach</span>
                                <div class="pattern-learning-indicator w-3 h-3 rounded-full"></div>
                            </h3>
                            <div id="aiCoachInsight" class="text-sm opacity-90 mb-4">
                                Advanced neural networks are analyzing your patterns to provide personalized recommendations...
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="getPersonalizedCoaching()" class="bg-white/20 px-3 py-1 rounded text-sm hover:bg-white/30 transition-all">
                                    üí° Get Insight
                                </button>
                                <button onclick="showAdvancedAI()" class="bg-white/20 px-3 py-1 rounded text-sm hover:bg-white/30 transition-all">
                                    üî¨ ML Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div id="tasks-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">üìã Smart Task Manager</h3>
                            <button onclick="optimizeTaskOrder()" class="text-primary hover:text-purple-600 text-sm">
                                üß† Optimize
                            </button>
                        </div>
                        <div id="tasksListDetailed" class="space-y-3 mb-4">
                            <!-- Detailed tasks will be populated here -->
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="addCustomTask()" class="flex-1 bg-personal text-white py-2 rounded hover:bg-indigo-600 transition-all">
                                ‚ûï Add Task
                            </button>
                            <button onclick="generateAITasks()" class="flex-1 bg-purple-500 text-white py-2 rounded hover:bg-purple-600 transition-all">
                                üß† AI Tasks
                            </button>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üìä Task Analytics</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600" id="completionRate">0%</div>
                                <div class="text-sm text-blue-500">Completion Rate</div>
                            </div>
                            <div class="text-center p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-green-600" id="averageTime">0m</div>
                                <div class="text-sm text-green-500">Avg Time</div>
                            </div>
                            <div class="text-center p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-purple-600" id="streakCount">0</div>
                                <div class="text-sm text-purple-500">Streak</div>
                            </div>
                            <div class="text-center p-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-orange-600" id="totalXPEarned">0</div>
                                <div class="text-sm text-orange-500">XP Earned</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fitness Tab -->
            <div id="fitness-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 text-fitness">üí™ Workout Tracker</h3>
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-fitness" id="totalWorkouts">0</div>
                                <div class="text-sm text-gray-500">Workouts</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-orange-500" id="caloriesBurned">0</div>
                                <div class="text-sm text-gray-500">Calories</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-500" id="exerciseMinutes">0</div>
                                <div class="text-sm text-gray-500">Minutes</div>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <button onclick="startWorkout('cardio')" class="w-full bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition-all">
                                üèÉ‚Äç‚ôÇÔ∏è Cardio Workout
                            </button>
                            <button onclick="startWorkout('strength')" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-all">
                                üí™ Strength Training
                            </button>
                            <button onclick="startWorkout('yoga')" class="w-full bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 transition-all">
                                üßò‚Äç‚ôÄÔ∏è Yoga & Flexibility
                            </button>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üìÖ AI Workout Plan</h3>
                        <div id="weeklyWorkoutPlan" class="space-y-3">
                            <!-- Weekly plan will be populated here -->
                        </div>
                        <button onclick="generateWorkoutPlan()" class="w-full mt-4 bg-primary text-white py-2 rounded hover:bg-purple-600 transition-all">
                            üß† Generate AI Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Nutrition Tab -->
            <div id="nutrition-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 text-nutrition">ü•ó Nutrition Tracker</h3>
                        <div class="mb-4">
                            <div class="text-3xl font-bold text-nutrition" id="nutritionCalories">0</div>
                            <div class="text-sm text-gray-500">Today's Calories</div>
                        </div>
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="text-center p-3 bg-red-50 dark:bg-red-900/30 rounded-lg">
                                <div class="text-xl font-bold text-red-600" id="proteinCount">0g</div>
                                <div class="text-xs text-red-500">Protein</div>
                            </div>
                            <div class="text-center p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg">
                                <div class="text-xl font-bold text-yellow-600" id="carbsCount">0g</div>
                                <div class="text-xs text-yellow-500">Carbs</div>
                            </div>
                            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <div class="text-xl font-bold text-blue-600" id="fatCount">0g</div>
                                <div class="text-xs text-blue-500">Fat</div>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <button onclick="logMeal('breakfast')" class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600 transition-all">
                                üåÖ Log Breakfast
                            </button>
                            <button onclick="logMeal('lunch')" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 transition-all">
                                ü•ô Log Lunch
                            </button>
                            <button onclick="logMeal('dinner')" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition-all">
                                üçΩÔ∏è Log Dinner
                            </button>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üìÖ AI Meal Plan</h3>
                        <div id="weeklyMealPlan" class="space-y-3">
                            <!-- Weekly meal plan will be populated here -->
                        </div>
                        <button onclick="generateMealPlan()" class="w-full mt-4 bg-primary text-white py-2 rounded hover:bg-purple-600 transition-all">
                            üß† Generate AI Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Coach Tab -->
            <div id="ai-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="ai-insight p-6 rounded-xl shadow-lg text-white">
                        <h3 class="text-xl font-bold mb-4">üß† Advanced AI Analysis</h3>
                        <div id="aiAnalysisContent" class="space-y-4">
                            <div class="bg-white/10 p-4 rounded-lg">
                                <h4 class="font-bold mb-2">üî¨ Neural Network Status</h4>
                                <div class="text-sm opacity-90">
                                    <div>Architecture: Multi-layer perceptron</div>
                                    <div>Training Progress: <span id="neuralTraining">85%</span></div>
                                    <div>Prediction Accuracy: <span id="neuralAccuracy">92%</span></div>
                                </div>
                            </div>
                            <div class="bg-white/10 p-4 rounded-lg">
                                <h4 class="font-bold mb-2">üìä Pattern Recognition</h4>
                                <div class="text-sm opacity-90" id="patternAnalysis">
                                    Analyzing your behavioral patterns and optimizing recommendations...
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <button onclick="retrainAI()" class="bg-white/20 px-3 py-2 rounded text-sm hover:bg-white/30 transition-all">
                                üîÑ Retrain
                            </button>
                            <button onclick="exportAIData()" class="bg-white/20 px-3 py-2 rounded text-sm hover:bg-white/30 transition-all">
                                üìä Export
                            </button>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üéØ AI Recommendations</h3>
                        <div id="aiRecommendations" class="space-y-3">
                            <!-- AI recommendations will be populated here -->
                        </div>
                        <button onclick="getNewRecommendations()" class="w-full mt-4 bg-primary text-white py-2 rounded hover:bg-purple-600 transition-all">
                            üîÑ Refresh Recommendations
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üìä Performance Overview</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600" id="overallScore">85</div>
                                <div class="text-sm text-blue-500">Overall Score</div>
                            </div>
                            <div class="text-center p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-green-600" id="improvementRate">+12%</div>
                                <div class="text-sm text-green-500">Improvement</div>
                            </div>
                            <div class="text-center p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-purple-600" id="consistencyScore">92%</div>
                                <div class="text-sm text-purple-500">Consistency</div>
                            </div>
                            <div class="text-center p-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg">
                                <div class="text-2xl font-bold text-orange-600" id="goalCompletion">78%</div>
                                <div class="text-sm text-orange-500">Goal Rate</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üìà Trends</h3>
                        <div id="trendAnalysis" class="space-y-4">
                            <!-- Trend analysis will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Music AI Tab -->
            <div id="music-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Spotify Integration -->
                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold flex items-center space-x-2">
                                <span>üéµ</span>
                                <span>Spotify Integration</span>
                            </h3>
                            <div id="spotifyStatus" class="text-sm px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-600">
                                Not Connected
                            </div>
                        </div>
                        
                        <div id="spotifyLogin" class="text-center py-8">
                            <div class="text-4xl mb-4">üéß</div>
                            <h4 class="text-lg font-medium mb-2">Connect to Spotify</h4>
                            <p class="text-gray-600 dark:text-gray-400 mb-4">
                                Link your Spotify account to get AI-powered music recommendations and seamless playback control
                            </p>
                            <button onclick="connectSpotify()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-all">
                                üéµ Connect Spotify
                            </button>
                        </div>
                        
                        <div id="spotifyPlayer" class="hidden">
                            <!-- Current Track Display -->
                            <div id="currentTrack" class="flex items-center space-x-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg mb-4">
                                <img id="trackImage" src="" alt="Album Art" class="w-16 h-16 rounded-lg">
                                <div class="flex-1">
                                    <div id="trackName" class="font-medium">No track playing</div>
                                    <div id="trackArtist" class="text-sm text-gray-600 dark:text-gray-400">-</div>
                                    <div id="trackAlbum" class="text-xs text-gray-500">-</div>
                                </div>
                                <div class="text-right">
                                    <div id="trackProgress" class="text-sm text-gray-600">0:00 / 0:00</div>
                                    <div class="w-24 bg-gray-300 dark:bg-gray-600 rounded-full h-1 mt-1">
                                        <div id="progressBar" class="bg-green-500 h-1 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Player Controls -->
                            <div class="flex items-center justify-center space-x-4 mb-4">
                                <button onclick="spotifyPrevious()" class="p-3 bg-gray-200 dark:bg-gray-600 rounded-full hover:bg-gray-300 dark:hover:bg-gray-500 transition-all">
                                    ‚èÆÔ∏è
                                </button>
                                <button id="playPauseBtn" onclick="spotifyTogglePlay()" class="p-4 bg-green-500 text-white rounded-full hover:bg-green-600 transition-all text-xl">
                                    ‚ñ∂Ô∏è
                                </button>
                                <button onclick="spotifyNext()" class="p-3 bg-gray-200 dark:bg-gray-600 rounded-full hover:bg-gray-300 dark:hover:bg-gray-500 transition-all">
                                    ‚è≠Ô∏è
                                </button>
                                <button onclick="transferToWebPlayer()" class="p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-all" title="Transfer to Web Player">
                                    üì±
                                </button>
                            </div>
                            
                            <!-- Volume Control -->
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-sm">üîä</span>
                                <input type="range" id="volumeSlider" min="0" max="100" value="50" 
                                       onchange="setSpotifyVolume(this.value)"
                                       class="flex-1 h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                <span id="volumeDisplay" class="text-sm w-8">50%</span>
                            </div>
                            
                            <!-- Device Selection -->
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">Playing on:</span>
                                <select id="deviceSelect" onchange="changeSpotifyDevice(this.value)" 
                                        class="text-sm bg-gray-100 dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded px-3 py-1">
                                    <option value="">Select Device</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Music Features -->
                    <div class="space-y-6">
                        <!-- Quick Actions -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h4 class="font-bold mb-4">‚ö° Quick Actions</h4>
                            <div class="space-y-3">
                                <button onclick="quickTrackWater()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-all">
                                    üíß Log Water + Music
                                </button>
                                <button onclick="quickLogWorkout()" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-all">
                                    üí™ Workout + Pump-up Music
                                </button>
                                <button onclick="focusMode()" class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600 transition-all">
                                    üß† Focus Mode + Lo-fi
                                </button>
                            </div>
                        </div>
                        
                        <!-- AI Recommendations -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h4 class="font-bold mb-4">üß† AI Music Recommendations</h4>
                            <div id="musicRecommendations" class="space-y-3">
                                <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <div class="font-medium text-sm">üéµ Based on your energy</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">High-energy tracks for peak performance</div>
                                    <button onclick="playAIRecommendation('energy')" class="mt-2 text-xs bg-green-500 text-white px-3 py-1 rounded">Play</button>
                                </div>
                                <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <div class="font-medium text-sm">üßò Wellness Music</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">Calming sounds for relaxation</div>
                                    <button onclick="playAIRecommendation('wellness')" class="mt-2 text-xs bg-blue-500 text-white px-3 py-1 rounded">Play</button>
                                </div>
                                <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <div class="font-medium text-sm">üí™ Workout Beats</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">Motivational tracks for exercise</div>
                                    <button onclick="playAIRecommendation('workout')" class="mt-2 text-xs bg-red-500 text-white px-3 py-1 rounded">Play</button>
                                </div>
                            </div>
                            <button onclick="generateMusicRecommendations()" class="w-full mt-4 bg-primary text-white py-2 rounded hover:bg-purple-600 transition-all">
                                üîÑ Generate New Recommendations
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- General Settings -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">‚öôÔ∏è General Settings</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium">üîî Notifications</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Enable push notifications</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="notificationsToggle" class="sr-only peer" checked onchange="toggleSetting('notifications', this.checked)">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium">üé¨ Animations</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Enable UI animations</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="animationsToggle" class="sr-only peer" checked onchange="toggleSetting('animations', this.checked)">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium">üîä Sound Effects</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Enable audio feedback</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="soundToggle" class="sr-only peer" checked onchange="toggleSetting('soundEffects', this.checked)">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium">üß† AI Learning</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Allow AI to learn from your patterns</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="aiLearningToggle" class="sr-only peer" checked onchange="toggleSetting('aiLearning', this.checked)">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Spotify Configuration -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üéµ Spotify Configuration</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">üîë Spotify Client ID</label>
                                <input type="text" id="spotifyClientId" placeholder="Enter your Spotify app client ID" 
                                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <div class="text-xs text-gray-500 mt-1">
                                    Get your client ID from <a href="https://developer.spotify.com/dashboard" target="_blank" class="text-blue-500 hover:underline">Spotify Developer Dashboard</a>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">üîó Redirect URI</label>
                                <input type="url" id="spotifyRedirectUri" placeholder="Enter your redirect URI" 
                                       class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <div class="text-xs text-gray-500 mt-1">
                                    Current auto-detected: <span id="currentRedirectUri" class="font-mono text-blue-600 dark:text-blue-400"></span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    Leave blank to use auto-detected URL, or enter a custom redirect URI configured in your Spotify app
                                </div>
                            </div>
                            
                            <button onclick="saveSpotifyConfig()" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition-all">
                                üíæ Save Spotify Configuration
                            </button>
                            
                            <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <div class="text-xs text-gray-600 dark:text-gray-400">
                                    <strong>Setup Instructions:</strong><br>
                                    1. Create a Spotify app at <a href="https://developer.spotify.com/dashboard" target="_blank" class="text-blue-500 hover:underline">developer.spotify.com</a><br>
                                    2. Add your redirect URI to "Redirect URIs" in app settings<br>
                                    3. Copy the Client ID here<br>
                                    4. Optionally set a custom redirect URI<br>
                                    5. Save and connect to Spotify
                                </div>
                            </div>
                            
                            <div class="p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <div class="text-xs text-blue-600 dark:text-blue-400">
                                    <strong>üí° Redirect URI Tips:</strong><br>
                                    ‚Ä¢ Must exactly match what's configured in your Spotify app<br>
                                    ‚Ä¢ Include protocol (https:// or http://)<br>
                                    ‚Ä¢ Case-sensitive and slash-sensitive<br>
                                    ‚Ä¢ For local testing: <code class="bg-blue-100 dark:bg-blue-800 px-1 rounded">http://localhost:3000</code>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Management -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üíæ Data Management</h3>
                        <div class="space-y-4">
                            <div class="p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <h4 class="font-bold text-blue-700 dark:text-blue-300 mb-2">üìÇ Current Storage</h4>
                                <div class="text-sm text-blue-600 dark:text-blue-400">
                                    <div>‚Ä¢ Tasks: <span id="taskCount">0</span></div>
                                    <div>‚Ä¢ Achievements: <span id="achievementCount">0</span></div>
                                    <div>‚Ä¢ AI Patterns: <span id="patternCount">0</span></div>
                                    <div>‚Ä¢ Total XP: <span id="totalXPDisplay">0</span></div>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <button onclick="backupData()" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition-all">
                                    üì¶ Backup Data
                                </button>
                                <button onclick="restoreData()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-all">
                                    üìÇ Restore Data
                                </button>
                                <button onclick="resetData()" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-all">
                                    üóëÔ∏è Reset All Data
                                </button>
                            </div>
                            
                            <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <div class="text-xs text-gray-600 dark:text-gray-400">
                                    <strong>Storage Type:</strong> Browser LocalStorage<br>
                                    <strong>Auto-save:</strong> Every 30 seconds<br>
                                    <strong>Backup:</strong> Manual download as JSON<br>
                                    <strong>Privacy:</strong> All data stays on your device
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Profile -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üë§ Personal Profile</h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">üìè Height (cm)</label>
                                    <input type="number" id="userHeight" placeholder="170" min="100" max="250"
                                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">‚öñÔ∏è Weight (kg)</label>
                                    <input type="number" id="userWeight" placeholder="70" min="30" max="300"
                                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">üéÇ Age</label>
                                    <input type="number" id="userAge" placeholder="25" min="13" max="120"
                                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">‚ößÔ∏è Gender</label>
                                    <select id="userGender" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">üèÉ Activity Level</label>
                                    <select id="activityLevel" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                        <option value="">Select Activity Level</option>
                                        <option value="sedentary">Sedentary (little/no exercise)</option>
                                        <option value="light">Light (1-3 days/week)</option>
                                        <option value="moderate">Moderate (3-5 days/week)</option>
                                        <option value="active">Active (6-7 days/week)</option>
                                        <option value="very_active">Very Active (2x/day, intense)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">üéØ Primary Goal</label>
                                    <select id="fitnessGoal" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                        <option value="">Select Goal</option>
                                        <option value="lose_weight">Lose Weight</option>
                                        <option value="maintain_weight">Maintain Weight</option>
                                        <option value="gain_weight">Gain Weight</option>
                                        <option value="build_muscle">Build Muscle</option>
                                        <option value="improve_fitness">Improve Fitness</option>
                                        <option value="general_health">General Health</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">üèãÔ∏è Available Equipment</label>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2" id="equipmentSelection">
                                    <!-- Equipment checkboxes will be populated here -->
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">üè• Health Conditions (optional)</label>
                                <div class="grid grid-cols-2 gap-2" id="healthConditions">
                                    <!-- Health condition checkboxes will be populated here -->
                                </div>
                            </div>
                            
                            <button onclick="saveUserProfile()" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-purple-600 transition-all font-medium">
                                üíæ Save Profile & Calculate Metrics
                            </button>
                        </div>
                    </div>
                    
                    <!-- Calculated Metrics -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üìä Your Health Metrics</h3>
                        <div id="healthMetrics" class="space-y-4">
                            <!-- Health metrics will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Daily Targets -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üéØ Personalized Daily Targets</h3>
                        <div id="dailyTargets" class="space-y-3">
                            <!-- Daily targets will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Interests Manager -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üéØ Interests Manager</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">üí° Your Interests</label>
                                <div id="interestsList" class="flex flex-wrap gap-2 mb-3 min-h-[60px] p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                                    <!-- Interests will be populated here -->
                                </div>
                                <div class="flex space-x-2">
                                    <input type="text" id="newInterest" placeholder="Add new interest..." 
                                           class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    <button onclick="addInterest()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-all">
                                        ‚ûï Add
                                    </button>
                                </div>
                                <div class="text-xs text-gray-500 mt-2">
                                    AI will suggest tasks based on your interests, timing patterns, and completion history
                                </div>
                            </div>
                            <div class="p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <h4 class="font-bold text-blue-700 dark:text-blue-300 mb-2">üß† AI Learning Context</h4>
                                <div class="text-sm text-blue-600 dark:text-blue-400 space-y-1">
                                    <div>‚Ä¢ Interest-based task generation</div>
                                    <div>‚Ä¢ Optimal timing analysis</div>
                                    <div>‚Ä¢ Difficulty progression tracking</div>
                                    <div>‚Ä¢ Context-aware suggestions</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Settings -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üß† AI Configuration</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">üéØ AI Sensitivity</label>
                                <input type="range" id="aiSensitivity" min="0.1" max="1.0" step="0.1" value="0.8" 
                                       onchange="updateAISensitivity(this.value)"
                                       class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>Conservative</span>
                                    <span id="sensitivityValue">80%</span>
                                    <span>Aggressive</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">‚ö° Learning Rate</label>
                                <select id="learningRate" onchange="updateLearningRate(this.value)" 
                                        class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    <option value="0.005">Slow (0.005)</option>
                                    <option value="0.01" selected>Normal (0.01)</option>
                                    <option value="0.02">Fast (0.02)</option>
                                    <option value="0.05">Rapid (0.05)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">üé® AI Personality</label>
                                <select id="aiPersonality" onchange="updateAIPersonality(this.value)" 
                                        class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    <option value="motivational" selected>üî• Motivational Coach</option>
                                    <option value="analytical">üìä Data Analyst</option>
                                    <option value="supportive">ü§ó Supportive Friend</option>
                                    <option value="challenging">üí™ Challenging Trainer</option>
                                </select>
                            </div>
                            
                            <button onclick="resetAI()" class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600 transition-all">
                                üîÑ Reset AI Models
                            </button>
                        </div>
                    </div>
                    
                    <!-- About -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">‚ÑπÔ∏è About</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span>Version:</span>
                                <span class="font-mono bg-green-100 dark:bg-green-900 px-2 py-1 rounded">v2.2.2</span>
                            </div>
                            <div class="flex justify-between">
                                <span>AI Engine:</span>
                                <span>Neural Network v3</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Features:</span>
                                <span>Real Spotify API, PKCE Auth</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Last Updated:</span>
                                <span id="lastUpdateTime">Just now</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Spotify Status:</span>
                                <span id="aboutSpotifyStatus" class="text-gray-600 dark:text-gray-400">Not Connected</span>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/30 dark:to-blue-900/30 rounded-lg">
                            <div class="text-xs text-gray-600 dark:text-gray-400">
                                Life Quest RPG - Ultimate AI Edition combines gamification with advanced machine learning 
                                to create a personalized productivity and wellness experience. Your data never leaves your device.
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <div class="inline-block bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full">
                                <span class="text-xs text-gray-500 dark:text-gray-400">Build Version: </span>
                                <span class="text-xs font-mono font-bold text-primary">v2.2.2-stable</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Notifications -->
    <div id="notifications" class="fixed top-20 right-4 z-50 space-y-2"></div>

    <!-- Audio Elements -->
    <audio id="xpSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeCYELojN8/CMOQgSYML4xZs+HhAUbLPuzak7HQ9JsOJkXxULAA==" type="audio/wav">
    </audio>
    <audio id="achievementSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeCYELojN8+COQBAUbLPuzag8Hg9JsOLKaR8gAA==" type="audio/wav">
    </audio>

    <script>
        // üß† ADVANCED NEURAL NETWORK IMPLEMENTATION
        class AdvancedNeuralNetwork {
            constructor(layers) {
                this.layers = layers;
                this.weights = [];
                this.biases = [];
                this.learningRate = 0.01;
                this.momentum = 0.9;
                this.previousWeightDeltas = [];
                this.previousBiasDeltas = [];
                
                for (let i = 0; i < layers.length - 1; i++) {
                    this.weights[i] = this.randomMatrix(layers[i], layers[i + 1]);
                    this.biases[i] = this.randomArray(layers[i + 1]);
                    this.previousWeightDeltas[i] = this.zeroMatrix(layers[i], layers[i + 1]);
                    this.previousBiasDeltas[i] = this.zeroArray(layers[i + 1]);
                }
            }
            
            randomMatrix(rows, cols) {
                return Array(rows).fill().map(() => 
                    Array(cols).fill().map(() => (Math.random() - 0.5) * 2 / Math.sqrt(rows))
                );
            }
            
            randomArray(size) {
                return Array(size).fill().map(() => (Math.random() - 0.5) * 0.1);
            }
            
            zeroMatrix(rows, cols) {
                return Array(rows).fill().map(() => Array(cols).fill(0));
            }
            
            zeroArray(size) {
                return Array(size).fill(0);
            }
            
            sigmoid(x) {
                return 1 / (1 + Math.exp(-Math.max(-500, Math.min(500, x))));
            }
            
            relu(x) {
                return Math.max(0, x);
            }
            
            softmax(arr) {
                const maxVal = Math.max(...arr);
                const expArr = arr.map(x => Math.exp(x - maxVal));
                const sumExp = expArr.reduce((a, b) => a + b, 0);
                return expArr.map(x => x / sumExp);
            }
            
            forward(inputs) {
                let activations = [inputs];
                
                for (let i = 0; i < this.weights.length; i++) {
                    const weighted = this.matrixVectorMultiply(this.weights[i], activations[i]);
                    const biased = weighted.map((w, j) => w + this.biases[i][j]);
                    
                    let activated;
                    if (i === this.weights.length - 1) {
                        activated = this.softmax(biased);
                    } else {
                        activated = biased.map(x => this.relu(x));
                    }
                    
                    activations.push(activated);
                }
                
                return activations;
            }
            
            matrixVectorMultiply(matrix, vector) {
                return Array(matrix[0].length).fill().map((_, j) =>
                    matrix.reduce((sum, row, i) => sum + row[j] * vector[i], 0)
                );
            }
            
            predict(inputs) {
                const activations = this.forward(inputs);
                return activations[activations.length - 1];
            }
            
            backpropagate(inputs, expectedOutputs) {
                // Simple backpropagation implementation
                try {
                    const activations = this.forward(inputs);
                    const outputs = activations[activations.length - 1];
                    
                    // Calculate output layer error
                    const outputErrors = outputs.map((output, i) => expectedOutputs[i] - output);
                    
                    // Update weights and biases (simplified)
                    for (let i = this.weights.length - 1; i >= 0; i--) {
                        for (let j = 0; j < this.weights[i].length; j++) {
                            for (let k = 0; k < this.weights[i][j].length; k++) {
                                const delta = this.learningRate * outputErrors[k] * activations[i][j];
                                this.weights[i][j][k] += delta + this.momentum * this.previousWeightDeltas[i][j][k];
                                this.previousWeightDeltas[i][j][k] = delta;
                            }
                        }
                        
                        for (let j = 0; j < this.biases[i].length; j++) {
                            const delta = this.learningRate * outputErrors[j];
                            this.biases[i][j] += delta + this.momentum * this.previousBiasDeltas[i][j];
                            this.previousBiasDeltas[i][j] = delta;
                        }
                    }
                } catch (error) {
                    // Gracefully handle backpropagation errors
                    console.warn('Backpropagation warning:', error.message);
                }
            }
        }

        // üìä MACHINE LEARNING ENGINE
        class MachineLearningEngine {
            constructor() {
                this.patterns = new Map();
                this.correlationMatrix = {};
                this.anomalyThreshold = 2.0;
            }
            
            analyzeTimeSeries(data, order = 2) {
                if (data.length < order + 1) return { forecast: data[data.length - 1] || 0, confidence: 0.5 };
                
                const arCoefficients = this.calculateARCoefficients(data, order);
                const forecast = arCoefficients.reduce((sum, coef, i) => 
                    sum + coef * data[data.length - 1 - i], 0
                );
                
                const residuals = this.calculateResiduals(data, arCoefficients, order);
                const maComponent = residuals.slice(-order).reduce((sum, r) => sum + r, 0) / order;
                const finalForecast = forecast + 0.3 * maComponent;
                const confidence = this.calculateForecastConfidence(data, arCoefficients);
                
                return { 
                    forecast: finalForecast, 
                    confidence,
                    trend: this.calculateTrend(data),
                    seasonality: this.detectSeasonality(data)
                };
            }
            
            calculateARCoefficients(data, order) {
                const autocorrelations = this.calculateAutocorrelations(data, order);
                const coefficients = [];
                
                for (let i = 0; i < order; i++) {
                    coefficients[i] = autocorrelations[i + 1] / (autocorrelations[0] + 0.001);
                }
                
                return coefficients;
            }
            
            calculateAutocorrelations(data, maxLag) {
                const n = data.length;
                const mean = data.reduce((a, b) => a + b) / n;
                const variance = data.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / n;
                
                const autocorrs = [];
                for (let lag = 0; lag <= maxLag; lag++) {
                    let sum = 0;
                    for (let i = 0; i < n - lag; i++) {
                        sum += (data[i] - mean) * (data[i + lag] - mean);
                    }
                    autocorrs[lag] = sum / ((n - lag) * variance);
                }
                
                return autocorrs;
            }
            
            calculateResiduals(data, arCoefficients, order) {
                const residuals = [];
                for (let i = order; i < data.length; i++) {
                    const predicted = arCoefficients.reduce((sum, coef, j) => 
                        sum + coef * data[i - 1 - j], 0
                    );
                    residuals.push(data[i] - predicted);
                }
                return residuals;
            }
            
            calculateTrend(data) {
                if (data.length < 5) return 0;
                const recent = data.slice(-5);
                const earlier = data.slice(-10, -5);
                const recentAvg = recent.reduce((a, b) => a + b) / recent.length;
                const earlierAvg = earlier.reduce((a, b) => a + b) / earlier.length;
                return (recentAvg - earlierAvg) / (earlierAvg + 1);
            }
            
            detectSeasonality(data) {
                if (data.length < 14) return 0;
                
                const weekLength = 7;
                if (data.length >= weekLength * 2) {
                    const recentWeek = data.slice(-weekLength);
                    const previousWeek = data.slice(-weekLength * 2, -weekLength);
                    return Math.abs(this.calculateCorrelation(recentWeek, previousWeek));
                }
                return 0;
            }
            
            calculateCorrelation(x, y) {
                if (x.length !== y.length || x.length < 2) return 0;
                
                const meanX = x.reduce((a, b) => a + b) / x.length;
                const meanY = y.reduce((a, b) => a + b) / y.length;
                
                const numerator = x.reduce((sum, xi, i) => sum + (xi - meanX) * (y[i] - meanY), 0);
                const denomX = Math.sqrt(x.reduce((sum, xi) => sum + Math.pow(xi - meanX, 2), 0));
                const denomY = Math.sqrt(y.reduce((sum, yi) => sum + Math.pow(yi - meanY, 2), 0));
                
                return denomX * denomY === 0 ? 0 : numerator / (denomX * denomY);
            }
            
            calculateForecastConfidence(data, coefficients) {
                const errors = this.calculateResiduals(data, coefficients, coefficients.length);
                const mse = errors.reduce((sum, e) => sum + e * e, 0) / errors.length;
                return Math.max(0, Math.min(1, 1 - Math.sqrt(mse) / 10));
            }
            
            performKMeansClustering(data, k = 3, maxIterations = 100) {
                if (data.length < k) return data.map((d, i) => ({ ...d, cluster: i }));
                
                let centroids = Array(k).fill().map(() => ({
                    x: Math.random() * 100,
                    y: Math.random() * 100
                }));
                
                for (let iteration = 0; iteration < maxIterations; iteration++) {
                    const clusters = Array(k).fill().map(() => []);
                    
                    data.forEach(point => {
                        let minDistance = Infinity;
                        let clusterIndex = 0;
                        
                        centroids.forEach((centroid, i) => {
                            const distance = Math.sqrt(
                                Math.pow(point.x - centroid.x, 2) + Math.pow(point.y - centroid.y, 2)
                            );
                            if (distance < minDistance) {
                                minDistance = distance;
                                clusterIndex = i;
                            }
                        });
                        
                        clusters[clusterIndex].push({ ...point, cluster: clusterIndex });
                    });
                    
                    const newCentroids = clusters.map(cluster => {
                        if (cluster.length === 0) return centroids[Math.floor(Math.random() * centroids.length)];
                        
                        return {
                            x: cluster.reduce((sum, p) => sum + p.x, 0) / cluster.length,
                            y: cluster.reduce((sum, p) => sum + p.y, 0) / cluster.length
                        };
                    });
                    
                    const converged = centroids.every((centroid, i) => 
                        Math.abs(centroid.x - newCentroids[i].x) < 0.1 &&
                        Math.abs(centroid.y - newCentroids[i].y) < 0.1
                    );
                    
                    centroids = newCentroids;
                    if (converged) break;
                }
                
                return data.map(point => {
                    let minDistance = Infinity;
                    let clusterIndex = 0;
                    
                    centroids.forEach((centroid, i) => {
                        const distance = Math.sqrt(
                            Math.pow(point.x - centroid.x, 2) + Math.pow(point.y - centroid.y, 2)
                        );
                        if (distance < minDistance) {
                            minDistance = distance;
                            clusterIndex = i;
                        }
                    });
                    
                    return { ...point, cluster: clusterIndex };
                });
            }
        }

        // üéÆ COMPREHENSIVE GAME STATE
        let gameState = {
            level: 1,
            xp: 0,
            totalXP: 0,
            currentStreak: 0,
            profile: {
                height: 0, // cm
                weight: 0, // kg
                age: 0,
                gender: '',
                activityLevel: '',
                fitnessGoal: '',
                equipment: [],
                healthConditions: [],
                preferences: {
                    workoutTypes: [],
                    dietaryRestrictions: [],
                    timePreferences: {}
                }
            },
            healthMetrics: {
                bmi: 0,
                bmr: 0,
                tdee: 0,
                idealWeight: { min: 0, max: 0 },
                bodyFatPercentage: 0,
                waterRequirement: 0,
                proteinRequirement: 0,
                dailyCalorieTarget: 0,
                dailyStepsTarget: 0,
                weeklyExerciseMinutes: 0,
                riskFactors: []
            },
            dailyStats: {
                workouts: 0,
                waterGlasses: 0,
                calories: 0,
                protein: 0,
                carbs: 0,
                fat: 0,
                tasksCompleted: 0,
                totalTasks: 0,
                caloriesBurned: 0,
                exerciseMinutes: 0,
                steps: 0
            },
            tasks: [],
            achievements: [],
            interests: ['fitness', 'productivity', 'learning'], // Default interests
            patterns: {
                activities: {},
                preferences: {},
                timing: {},
                interests: {},
                contextual: {},
                learning: {
                    enabled: true,
                    confidence: 0.85,
                    patterns: []
                }
            },
            ai: {
                neuralNetwork: null,
                mlEngine: null,
                confidence: 0.85,
                lastUpdate: Date.now(),
                predictions: {},
                insights: [],
                taskContext: {
                    completionTimes: {},
                    successfulPatterns: {},
                    optimalTimings: {}
                }
            },
            settings: {
                notifications: true,
                animations: true,
                soundEffects: true,
                aiLearning: true,
                spotifyClientId: '',
                spotifyRedirectUri: ''
            }
        };

        // üéØ NEURAL NETWORK AND ML INITIALIZATION
        let neuralNetwork, mlEngine;

        function initializeAI() {
            try {
                neuralNetwork = new AdvancedNeuralNetwork([12, 16, 8, 4]);
                mlEngine = new MachineLearningEngine();
                
                // Train with synthetic data
                const trainingData = generateTrainingData(1000);
                for (let epoch = 0; epoch < 100; epoch++) {
                    trainingData.forEach(({ inputs, outputs }) => {
                        neuralNetwork.backpropagate(inputs, outputs);
                    });
                }
                
                gameState.ai.neuralNetwork = true;
                gameState.ai.mlEngine = true;
                
                console.log('üß† Advanced AI systems initialized successfully');
                updateAIDisplay();
            } catch (error) {
                console.error('AI initialization error:', error);
            }
        }

        function generateTrainingData(size) {
            return Array(size).fill().map(() => {
                const inputs = Array(12).fill().map(() => Math.random());
                const outputs = [
                    inputs[0] * 0.3 + inputs[1] * 0.2 + Math.random() * 0.1,
                    inputs[2] * 0.4 + inputs[3] * 0.3 + Math.random() * 0.1,
                    inputs[4] * 0.25 + inputs[5] * 0.35 + Math.random() * 0.1,
                    inputs[6] * 0.2 + inputs[7] * 0.3 + Math.random() * 0.1
                ].map(x => Math.max(0, Math.min(1, x)));
                
                return { inputs, outputs };
            });
        }

        // üéÆ CORE FUNCTIONALITY
        function initializeApp() {
            showLoadingScreen();
            
            setTimeout(() => {
                loadGameState();
                initializeAI();
                updateAllUI();
                generateInitialTasks();
                hideLoadingScreen();
                
                showFloatingNotification('üöÄ Welcome!', 'Advanced AI Life Coach is ready!');
                
                // Auto-save every 30 seconds
                setInterval(saveGameState, 30000);
                setInterval(updateAIInsights, 60000);
            }, 2000);
        }

        function showLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'flex';
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        // üíæ STORAGE MANAGEMENT
        function saveGameState() {
            try {
                localStorage.setItem('lifeQuestAI', JSON.stringify(gameState));
                console.log('‚úÖ Game state saved');
            } catch (error) {
                console.error('‚ùå Save failed:', error);
            }
        }

        function loadGameState() {
            try {
                const saved = localStorage.getItem('lifeQuestAI');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    gameState = { ...gameState, ...parsed };
                    console.log('‚úÖ Game state loaded');
                }
            } catch (error) {
                console.error('‚ùå Load failed:', error);
            }
        }

        // üèÜ XP AND LEVELING
        function awardXP(amount, reason) {
            gameState.xp += amount;
            gameState.totalXP += amount;
            
            const xpForNextLevel = gameState.level * 100;
            if (gameState.xp >= xpForNextLevel) {
                levelUp();
            }
            
            updateXPDisplay();
            showXPAnimation(amount, reason);
            
            if (gameState.settings.soundEffects) {
                playSound('xpSound');
            }
            
            saveGameState();
        }

        function levelUp() {
            const oldLevel = gameState.level;
            gameState.level++;
            gameState.xp = gameState.xp - (oldLevel * 100);
            
            addAchievement(`üéâ Level ${gameState.level}!`, `Reached level ${gameState.level}`, gameState.level * 50);
            updateXPDisplay();
            showFloatingNotification('üéâ LEVEL UP!', `Welcome to Level ${gameState.level}!`);
            
            if (gameState.settings.soundEffects) {
                playSound('achievementSound');
            }
        }

        function updateXPDisplay() {
            const xpForNextLevel = gameState.level * 100;
            const progress = (gameState.xp / xpForNextLevel) * 100;
            
            document.getElementById('playerLevel').textContent = `Level ${gameState.level}`;
            document.getElementById('currentXP').textContent = gameState.xp;
            document.getElementById('nextLevelXP').textContent = xpForNextLevel;
            document.getElementById('xpProgress').style.width = `${progress}%`;
            document.getElementById('xpProgressPercent').textContent = `${Math.round(progress)}%`;
        }

        function showXPAnimation(amount, reason) {
            if (!gameState.settings.animations) return;
            
            const container = document.createElement('div');
            container.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 xp-burst pointer-events-none';
            container.innerHTML = `
                <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-3 rounded-full font-bold shadow-lg">
                    +${amount} XP
                </div>
                <div class="text-center text-sm text-gray-600 dark:text-gray-400 mt-2">${reason}</div>
            `;
            document.body.appendChild(container);
            
            setTimeout(() => container.remove(), 2000);
        }

        // üéµ SOUND EFFECTS
        function playSound(soundId) {
            if (!gameState.settings.soundEffects) return;
            
            const audio = document.getElementById(soundId);
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(() => {});
            }
        }

        // üìã TASK MANAGEMENT
        function generateInitialTasks() {
            if (gameState.tasks.length === 0) {
                const initialTasks = [
                    { id: 1, name: 'Complete first workout', category: 'fitness', xp: 50, completed: false, difficulty: 'easy' },
                    { id: 2, name: 'Drink 8 glasses of water', category: 'health', xp: 30, completed: false, difficulty: 'easy' },
                    { id: 3, name: 'Plan healthy meals', category: 'nutrition', xp: 40, completed: false, difficulty: 'medium' },
                    { id: 4, name: 'Set up AI preferences', category: 'system', xp: 25, completed: false, difficulty: 'easy' }
                ];
                
                gameState.tasks = initialTasks;
                gameState.dailyStats.totalTasks = initialTasks.length;
            }
            updateTasksUI();
        }

        function generateAITasks() {
            if (!neuralNetwork) {
                showFloatingNotification('ü§ñ AI Loading', 'Neural networks are still initializing...');
                return;
            }
            
            const currentFeatures = getCurrentUserFeatures();
            const prediction = neuralNetwork.predict(currentFeatures);
            const contextualInsights = analyzeCurrentContext();
            
            const aiTasks = generateSmartTasks(prediction, contextualInsights);
            
            gameState.tasks.push(...aiTasks);
            gameState.dailyStats.totalTasks += aiTasks.length;
            updateTasksUI();
            showFloatingNotification('üß† AI Tasks Generated', `Added ${aiTasks.length} contextually-aware tasks`);
        }

        function getCurrentUserFeatures() {
            const now = new Date();
            return [
                now.getHours() / 24,
                gameState.dailyStats.workouts / 3,
                gameState.dailyStats.waterGlasses / 8,
                gameState.dailyStats.calories / 2000,
                gameState.level / 10,
                gameState.currentStreak / 30,
                Math.random(), // mood simulation
                Math.random(), // energy simulation
                now.getDay() / 7,
                (now.getMonth() + 1) / 12,
                gameState.dailyStats.tasksCompleted / Math.max(gameState.dailyStats.totalTasks, 1),
                gameState.ai.confidence
            ];
        }

        function addCustomTask() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">Add Custom Task</h3>
                    <div class="space-y-4">
                        <input type="text" id="taskName" placeholder="Task name" 
                               class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        <select id="taskCategory" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            <option value="fitness">üí™ Fitness</option>
                            <option value="nutrition">ü•ó Nutrition</option>
                            <option value="health">üíß Health</option>
                            <option value="wellness">üßò Wellness</option>
                            <option value="personal">üìà Personal</option>
                        </select>
                        <select id="taskDifficulty" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            <option value="easy">Easy (25 XP)</option>
                            <option value="medium" selected>Medium (50 XP)</option>
                            <option value="hard">Hard (100 XP)</option>
                        </select>
                        <div class="flex space-x-3">
                            <button onclick="createCustomTask()" class="flex-1 bg-primary text-white py-3 rounded-lg font-medium">
                                Create Task
                            </button>
                            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-medium">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('taskName').focus();
        }

        function createCustomTask() {
            const name = document.getElementById('taskName').value.trim();
            const category = document.getElementById('taskCategory').value;
            const difficulty = document.getElementById('taskDifficulty').value;
            
            if (!name) {
                showFloatingNotification('‚ö†Ô∏è Invalid Input', 'Please enter a task name');
                return;
            }
            
            const xpValues = { easy: 25, medium: 50, hard: 100 };
            const task = {
                id: Date.now(),
                name: name,
                category: category,
                xp: xpValues[difficulty],
                completed: false,
                difficulty: difficulty,
                custom: true
            };
            
            gameState.tasks.push(task);
            gameState.dailyStats.totalTasks++;
            updateTasksUI();
            document.querySelector('.modal-overlay').remove();
            showFloatingNotification('‚úÖ Task Created', `"${name}" added successfully`);
        }

        function toggleTask(taskId) {
            const task = gameState.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.completed = !task.completed;
            
            if (task.completed) {
                gameState.dailyStats.tasksCompleted++;
                awardXP(task.xp, `Completed: ${task.name}`);
                
                // Update streak
                if (gameState.dailyStats.tasksCompleted === 1) {
                    gameState.currentStreak++;
                }
                
                // Check for achievements
                checkTaskAchievements();
                
                // AI learning
                if (gameState.ai.learning) {
                    recordTaskCompletion(task);
                }
            } else {
                gameState.dailyStats.tasksCompleted = Math.max(0, gameState.dailyStats.tasksCompleted - 1);
            }
            
            updateTasksUI();
            updateStatsUI();
            saveGameState();
        }

        function recordTaskCompletion(task) {
            const pattern = {
                category: task.category,
                difficulty: task.difficulty,
                timeOfDay: new Date().getHours(),
                dayOfWeek: new Date().getDay(),
                aiGenerated: task.aiGenerated || false,
                completionTime: Date.now()
            };
            
            if (!gameState.patterns.activities[task.category]) {
                gameState.patterns.activities[task.category] = [];
            }
            
            gameState.patterns.activities[task.category].push(pattern);
            
            // Keep only recent patterns (last 100)
            if (gameState.patterns.activities[task.category].length > 100) {
                gameState.patterns.activities[task.category] = 
                    gameState.patterns.activities[task.category].slice(-100);
            }
        }

        function updateTasksUI() {
            const tasksList = document.getElementById('tasksList');
            const tasksListDetailed = document.getElementById('tasksListDetailed');
            
            if (!tasksList) return;
            
            if (gameState.tasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <div class="text-4xl mb-2">üéØ</div>
                        <p>No tasks yet. Generate some AI tasks!</p>
                    </div>
                `;
            } else {
                const tasksHTML = gameState.tasks.map(task => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg ${task.completed ? 'opacity-75' : ''}">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" ${task.completed ? 'checked' : ''} 
                                   onchange="toggleTask(${task.id})" 
                                   class="w-4 h-4 text-primary rounded focus:ring-2 focus:ring-primary">
                            <div>
                                <div class="${task.completed ? 'line-through text-gray-500' : ''}">${task.name}</div>
                                <div class="text-xs text-gray-500 flex items-center space-x-2">
                                    <span>${getCategoryEmoji(task.category)} ${task.category}</span>
                                    ${task.aiGenerated ? '<span class="bg-purple-100 text-purple-600 px-1 rounded text-xs">AI</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-primary font-medium">+${task.xp} XP</span>
                            <button onclick="deleteTask(${task.id})" class="text-red-500 hover:text-red-700 text-sm">√ó</button>
                        </div>
                    </div>
                `).join('');
                
                tasksList.innerHTML = tasksHTML;
                if (tasksListDetailed) {
                    tasksListDetailed.innerHTML = tasksHTML;
                }
            }
        }

        function getCategoryEmoji(category) {
            const emojis = {
                fitness: 'üí™',
                nutrition: 'ü•ó',
                health: 'üíß',
                wellness: 'üßò',
                personal: 'üìà',
                system: '‚öôÔ∏è'
            };
            return emojis[category] || 'üìã';
        }

        function deleteTask(taskId) {
            const taskIndex = gameState.tasks.findIndex(t => t.id === taskId);
            if (taskIndex > -1) {
                const task = gameState.tasks[taskIndex];
                if (task.completed) {
                    gameState.dailyStats.tasksCompleted--;
                }
                gameState.tasks.splice(taskIndex, 1);
                gameState.dailyStats.totalTasks--;
                updateTasksUI();
                updateStatsUI();
                showFloatingNotification('üóëÔ∏è Task Deleted', 'Task removed from your list');
            }
        }

        function checkTaskAchievements() {
            const completed = gameState.dailyStats.tasksCompleted;
            
            if (completed === 1) {
                addAchievement('üéØ First Task!', 'Completed your first task', 25);
            } else if (completed === 5) {
                addAchievement('üî• Task Master!', 'Completed 5 tasks in one day', 100);
            } else if (completed === 10) {
                addAchievement('üèÜ Productivity King!', 'Completed 10 tasks in one day', 200);
            }
            
            if (gameState.currentStreak === 3) {
                addAchievement('üìà Getting Consistent!', '3-day streak achieved', 75);
            } else if (gameState.currentStreak === 7) {
                addAchievement('üî• Week Warrior!', '7-day streak achieved', 150);
            } else if (gameState.currentStreak === 30) {
                addAchievement('üëë Habit Master!', '30-day streak achieved', 500);
            }
        }

        // üèÜ ACHIEVEMENTS SYSTEM
        function addAchievement(title, description, xp) {
            const achievement = {
                id: Date.now(),
                title: title,
                description: description,
                xp: xp,
                date: new Date().toISOString(),
                unlocked: true
            };
            
            gameState.achievements.push(achievement);
            updateAchievementsUI();
            showFloatingNotification('üèÜ Achievement Unlocked!', title);
            
            if (xp > 0) {
                awardXP(xp, `Achievement: ${title}`);
            }
        }

        function updateAchievementsUI() {
            const achievementsList = document.getElementById('achievementsList');
            if (!achievementsList) return;
            
            if (gameState.achievements.length === 0) {
                achievementsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <div class="text-4xl mb-2">üèÜ</div>
                        <p>No achievements yet. Start completing tasks!</p>
                    </div>
                `;
            } else {
                achievementsList.innerHTML = gameState.achievements.slice(-5).reverse().map(achievement => `
                    <div class="flex items-center space-x-3 p-3 bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/30 dark:to-orange-900/30 rounded-lg">
                        <div class="text-2xl">üèÜ</div>
                        <div class="flex-1">
                            <div class="font-bold text-yellow-700 dark:text-yellow-300">${achievement.title}</div>
                            <div class="text-sm text-yellow-600 dark:text-yellow-400">${achievement.description}</div>
                            <div class="text-xs text-gray-500">${new Date(achievement.date).toLocaleDateString()}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold text-yellow-600">+${achievement.xp} XP</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // üí™ FITNESS TRACKING
        function quickLogWorkout() {
            gameState.dailyStats.workouts++;
            gameState.dailyStats.caloriesBurned += 250;
            gameState.dailyStats.exerciseMinutes += 30;
            
            awardXP(50, 'Quick Workout Logged');
            updateStatsUI();
            showFloatingNotification('üí™ Workout Logged!', '+250 calories burned, +30 minutes');
        }

        function startWorkout(type) {
            const workoutData = {
                cardio: { name: 'Cardio Blast', duration: 30, calories: 300, xp: 60 },
                strength: { name: 'Strength Training', duration: 45, calories: 200, xp: 75 },
                yoga: { name: 'Yoga Flow', duration: 30, calories: 150, xp: 45 }
            };
            
            const workout = workoutData[type];
            if (!workout) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">${workout.name}</h3>
                    <div class="space-y-4">
                        <div class="text-center">
                            <div class="text-4xl mb-2">${getCategoryEmoji('fitness')}</div>
                            <div class="text-lg font-medium">Duration: ${workout.duration} minutes</div>
                            <div class="text-sm text-gray-600">Estimated calories: ${workout.calories}</div>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="completeWorkout('${type}')" class="flex-1 bg-fitness text-white py-3 rounded-lg font-medium">
                                Complete Workout
                            </button>
                            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-medium">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function completeWorkout(type) {
            const workoutData = {
                cardio: { name: 'Cardio Blast', duration: 30, calories: 300, xp: 60 },
                strength: { name: 'Strength Training', duration: 45, calories: 200, xp: 75 },
                yoga: { name: 'Yoga Flow', duration: 30, calories: 150, xp: 45 }
            };
            
            const workout = workoutData[type];
            
            gameState.dailyStats.workouts++;
            gameState.dailyStats.caloriesBurned += workout.calories;
            gameState.dailyStats.exerciseMinutes += workout.duration;
            
            awardXP(workout.xp, `Completed ${workout.name}`);
            updateStatsUI();
            document.querySelector('.modal-overlay').remove();
            showFloatingNotification('üí™ Workout Complete!', `${workout.name} finished!`);
            
            // Check fitness achievements
            if (gameState.dailyStats.workouts === 1) {
                addAchievement('üí™ First Workout!', 'Completed your first workout', 50);
            }
        }

        function generateWorkoutPlan() {
            if (!neuralNetwork) {
                showFloatingNotification('ü§ñ AI Loading', 'Neural networks are still initializing...');
                return;
            }
            
            const workoutPlan = [
                { day: 'Monday', workout: 'AI Cardio Circuit', duration: '30 min', intensity: 'High' },
                { day: 'Tuesday', workout: 'Strength Training', duration: '45 min', intensity: 'Medium' },
                { day: 'Wednesday', workout: 'Active Recovery', duration: '20 min', intensity: 'Low' },
                { day: 'Thursday', workout: 'HIIT Session', duration: '25 min', intensity: 'High' },
                { day: 'Friday', workout: 'Full Body Strength', duration: '40 min', intensity: 'Medium' },
                { day: 'Saturday', workout: 'Outdoor Activity', duration: '60 min', intensity: 'Medium' },
                { day: 'Sunday', workout: 'Yoga & Mobility', duration: '30 min', intensity: 'Low' }
            ];
            
            const planContainer = document.getElementById('weeklyWorkoutPlan');
            if (planContainer) {
                planContainer.innerHTML = workoutPlan.map(day => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div>
                            <div class="font-medium">${day.day}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">${day.workout}</div>
                        </div>
                        <div class="text-right text-sm">
                            <div>${day.duration}</div>
                            <div class="text-xs ${getIntensityColor(day.intensity)}">${day.intensity}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            showFloatingNotification('üìÖ Workout Plan Generated', 'AI created your personalized weekly plan');
        }

        function getIntensityColor(intensity) {
            const colors = {
                Low: 'text-green-600',
                Medium: 'text-yellow-600',
                High: 'text-red-600'
            };
            return colors[intensity] || 'text-gray-600';
        }

        // ü•ó NUTRITION TRACKING
        function quickTrackWater() {
            gameState.dailyStats.waterGlasses++;
            awardXP(5, 'Water Logged');
            updateStatsUI();
            
            // Update water visualization
            const glassId = `waterGlass${gameState.dailyStats.waterGlasses}`;
            const glass = document.getElementById(glassId);
            if (glass) {
                glass.style.backgroundColor = '#3b82f6';
            }
            
            showFloatingNotification('üíß Water Logged!', `Glass ${gameState.dailyStats.waterGlasses}/8`);
            
            // Check hydration achievements
            if (gameState.dailyStats.waterGlasses === 8) {
                addAchievement('üíß Hydration Hero!', 'Drank 8 glasses of water today', 75);
            }
        }

        function logMeal(mealType) {
            const mealData = {
                breakfast: { name: 'Breakfast', calories: 400, protein: 20, carbs: 45, fat: 15 },
                lunch: { name: 'Lunch', calories: 600, protein: 35, carbs: 55, fat: 20 },
                dinner: { name: 'Dinner', calories: 500, protein: 30, carbs: 40, fat: 18 }
            };
            
            const meal = mealData[mealType];
            if (!meal) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">Log ${meal.name}</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="text-lg font-bold">${meal.calories}</div>
                                <div class="text-xs">Calories</div>
                            </div>
                            <div class="p-3 bg-red-50 dark:bg-red-900/30 rounded-lg">
                                <div class="text-lg font-bold text-red-600">${meal.protein}g</div>
                                <div class="text-xs">Protein</div>
                            </div>
                            <div class="p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg">
                                <div class="text-lg font-bold text-yellow-600">${meal.carbs}g</div>
                                <div class="text-xs">Carbs</div>
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="completeMealLog('${mealType}')" class="flex-1 bg-nutrition text-white py-3 rounded-lg font-medium">
                                Log Meal
                            </button>
                            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-medium">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function completeMealLog(mealType) {
            const mealData = {
                breakfast: { name: 'Breakfast', calories: 400, protein: 20, carbs: 45, fat: 15, xp: 30 },
                lunch: { name: 'Lunch', calories: 600, protein: 35, carbs: 55, fat: 20, xp: 40 },
                dinner: { name: 'Dinner', calories: 500, protein: 30, carbs: 40, fat: 18, xp: 35 }
            };
            
            const meal = mealData[mealType];
            
            gameState.dailyStats.calories += meal.calories;
            gameState.dailyStats.protein += meal.protein;
            gameState.dailyStats.carbs += meal.carbs;
            gameState.dailyStats.fat += meal.fat;
            
            awardXP(meal.xp, `Logged ${meal.name}`);
            updateStatsUI();
            document.querySelector('.modal-overlay').remove();
            showFloatingNotification('ü•ó Meal Logged!', `${meal.name} added to your nutrition`);
        }

        function generateMealPlan() {
            if (!neuralNetwork) {
                showFloatingNotification('ü§ñ AI Loading', 'Neural networks are still initializing...');
                return;
            }
            
            const mealPlan = [
                { day: 'Monday', breakfast: 'Oatmeal with berries', lunch: 'Grilled chicken salad', dinner: 'Salmon with quinoa' },
                { day: 'Tuesday', breakfast: 'Greek yogurt parfait', lunch: 'Turkey wrap', dinner: 'Stir-fry vegetables' },
                { day: 'Wednesday', breakfast: 'Smoothie bowl', lunch: 'Quinoa Buddha bowl', dinner: 'Lean beef with sweet potato' },
                { day: 'Thursday', breakfast: 'Avocado toast', lunch: 'Mediterranean salad', dinner: 'Baked cod with vegetables' },
                { day: 'Friday', breakfast: 'Protein pancakes', lunch: 'Chicken soup', dinner: 'Tofu curry with rice' },
                { day: 'Saturday', breakfast: 'Egg scramble', lunch: 'Grilled vegetables', dinner: 'Pasta with marinara' },
                { day: 'Sunday', breakfast: 'Chia pudding', lunch: 'Fish tacos', dinner: 'Roasted chicken with herbs' }
            ];
            
            const planContainer = document.getElementById('weeklyMealPlan');
            if (planContainer) {
                planContainer.innerHTML = mealPlan.map(day => `
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="font-medium mb-2">${day.day}</div>
                        <div class="text-sm space-y-1">
                            <div>üåÖ ${day.breakfast}</div>
                            <div>ü•ô ${day.lunch}</div>
                            <div>üçΩÔ∏è ${day.dinner}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            showFloatingNotification('üìÖ Meal Plan Generated', 'AI created your personalized weekly nutrition plan');
        }

        // üß† AI INSIGHTS AND RECOMMENDATIONS
        function updateAIInsights() {
            if (!neuralNetwork || !mlEngine) return;
            
            try {
                const insights = generateAIInsights();
                displayAIInsights(insights);
                updateAIRecommendations();
            } catch (error) {
                console.error('AI insights error:', error);
            }
        }

        function generateAIInsights() {
            const currentFeatures = getCurrentUserFeatures();
            const prediction = neuralNetwork.predict(currentFeatures);
            
            const insights = [];
            
            // Analyze current patterns
            const behaviorData = extractBehaviorData();
            const timeSeries = mlEngine.analyzeTimeSeries(behaviorData);
            
            if (timeSeries.trend > 0.1) {
                insights.push({
                    type: 'positive_trend',
                    text: `üìà Great progress! Your performance is trending upward with ${(timeSeries.trend * 100).toFixed(1)}% improvement`,
                    confidence: timeSeries.confidence
                });
            }
            
            if (prediction[0] > 0.8) {
                insights.push({
                    type: 'high_performance',
                    text: `üöÄ Neural analysis shows peak performance potential (${(prediction[0] * 100).toFixed(0)}%). Perfect time for challenging tasks!`,
                    confidence: prediction[0]
                });
            }
            
            // Time-based insights
            const hour = new Date().getHours();
            if (hour >= 9 && hour <= 11 && prediction[3] > 0.7) {
                insights.push({
                    type: 'optimal_timing',
                    text: `üß† AI detects optimal focus window. Your concentration is ${(prediction[3] * 100).toFixed(0)}% - perfect for important tasks`,
                    confidence: prediction[3]
                });
            }
            
            // Pattern recognition insights
            const patterns = analyzeUserPatterns();
            if (patterns.length > 0) {
                insights.push(...patterns);
            }
            
            return insights.sort((a, b) => b.confidence - a.confidence).slice(0, 3);
        }

        function extractBehaviorData() {
            // Generate synthetic behavior data based on current stats
            return Array(30).fill().map((_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - i);
                return {
                    date: date.toISOString(),
                    score: Math.random() * 100,
                    tasks: Math.floor(Math.random() * 10),
                    workouts: Math.floor(Math.random() * 2),
                    nutrition: Math.random() * 100
                };
            }).map(d => d.score);
        }

        function analyzeUserPatterns() {
            const patterns = [];
            
            // Analyze task completion patterns
            const taskCategories = {};
            gameState.tasks.forEach(task => {
                if (task.completed) {
                    taskCategories[task.category] = (taskCategories[task.category] || 0) + 1;
                }
            });
            
            const favCategory = Object.entries(taskCategories).sort((a, b) => b[1] - a[1])[0];
            if (favCategory && favCategory[1] > 2) {
                patterns.push({
                    type: 'preference_pattern',
                    text: `üéØ Pattern detected: You excel at ${favCategory[0]} tasks. Consider adding more ${getCategoryEmoji(favCategory[0])} activities`,
                    confidence: 0.75
                });
            }
            
            // Analyze time patterns
            const currentHour = new Date().getHours();
            if (currentHour >= 6 && currentHour <= 9) {
                patterns.push({
                    type: 'time_pattern',
                    text: `üåÖ Morning momentum detected! Research shows 65% higher task completion rates in morning hours`,
                    confidence: 0.8
                });
            }
            
            return patterns;
        }

        function displayAIInsights(insights) {
            const aiInsights = document.getElementById('aiInsights');
            if (!aiInsights || insights.length === 0) return;
            
            const topInsight = insights[0];
            aiInsights.innerHTML = `
                <div class="ai-insight p-4 rounded-xl shadow-lg text-white mb-4 relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-xl">üß†</span>
                                <span class="font-bold">Advanced AI Analysis</span>
                                <div class="pattern-learning-indicator w-3 h-3 rounded-full"></div>
                            </div>
                            <div class="text-xs bg-white/20 px-2 py-1 rounded-full">
                                ${Math.round(topInsight.confidence * 100)}% confidence
                            </div>
                        </div>
                        <div class="text-sm opacity-90 mb-3">${topInsight.text}</div>
                        <div class="flex items-center justify-between">
                            <div class="text-xs opacity-70">
                                Type: ${topInsight.type.replace('_', ' ')}
                            </div>
                            <button onclick="showAllAIInsights()" class="text-xs bg-white/20 px-3 py-1 rounded hover:bg-white/30 transition-all">
                                View All (${insights.length})
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Update AI coach insight
            const aiCoachInsight = document.getElementById('aiCoachInsight');
            if (aiCoachInsight) {
                aiCoachInsight.textContent = topInsight.text;
            }
        }

        function updateAIRecommendations() {
            const recommendations = generateRecommendations();
            const container = document.getElementById('aiRecommendations');
            if (!container) return;
            
            container.innerHTML = recommendations.map(rec => `
                <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-medium">${rec.title}</div>
                        <div class="text-xs text-primary">${Math.round(rec.confidence * 100)}%</div>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">${rec.description}</div>
                    <button onclick="applyRecommendation('${rec.id}')" class="mt-2 text-xs bg-primary text-white px-3 py-1 rounded hover:bg-purple-600 transition-all">
                        Apply
                    </button>
                </div>
            `).join('');
        }

        function generateRecommendations() {
            if (!neuralNetwork) return [];
            
            const features = getCurrentUserFeatures();
            const prediction = neuralNetwork.predict(features);
            
            const recommendations = [];
            
            // Based on AI predictions
            if (prediction[0] > 0.7) {
                recommendations.push({
                    id: 'high_intensity_workout',
                    title: 'üî• High-Intensity Workout',
                    description: 'Your energy levels are optimal for a challenging workout session',
                    confidence: prediction[0]
                });
            }
            
            if (prediction[1] < 0.4) {
                recommendations.push({
                    id: 'nutrition_focus',
                    title: 'ü•ó Nutrition Optimization',
                    description: 'Focus on balanced meals with adequate protein and hydration',
                    confidence: 0.8
                });
            }
            
            if (prediction[2] > 0.6) {
                recommendations.push({
                    id: 'learning_session',
                    title: 'üìö Learning Session',
                    description: 'Great time for skill development or educational content',
                    confidence: prediction[2]
                });
            }
            
            // Time-based recommendations
            const hour = new Date().getHours();
            if (hour >= 18 && hour <= 20) {
                recommendations.push({
                    id: 'evening_routine',
                    title: 'üåÖ Evening Wind-down',
                    description: 'Perfect timing for reflection and relaxation activities',
                    confidence: 0.75
                });
            }
            
            return recommendations.sort((a, b) => b.confidence - a.confidence).slice(0, 4);
        }

        function applyRecommendation(recId) {
            const actions = {
                high_intensity_workout: () => startWorkout('cardio'),
                nutrition_focus: () => logMeal('snack'),
                learning_session: () => addLearningTask(),
                evening_routine: () => addWellnessTask()
            };
            
            const action = actions[recId];
            if (action) {
                action();
                showFloatingNotification('‚úÖ Recommendation Applied', 'AI suggestion has been implemented');
            }
        }

        function addLearningTask() {
            const task = {
                id: Date.now(),
                name: 'AI-recommended learning session',
                category: 'personal',
                xp: 60,
                completed: false,
                difficulty: 'medium',
                aiGenerated: true
            };
            
            gameState.tasks.push(task);
            gameState.dailyStats.totalTasks++;
            updateTasksUI();
        }

        function addWellnessTask() {
            const task = {
                id: Date.now(),
                name: 'Evening wellness routine',
                category: 'wellness',
                xp: 40,
                completed: false,
                difficulty: 'easy',
                aiGenerated: true
            };
            
            gameState.tasks.push(task);
            gameState.dailyStats.totalTasks++;
            updateTasksUI();
        }

        // üéØ UI MANAGEMENT
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`${tabName}-tab`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Update tab-specific content
            updateTabContent(tabName);
        }

        function updateTabContent(tabName) {
            switch (tabName) {
                case 'dashboard':
                    updateStatsUI();
                    updateTasksUI();
                    updateAchievementsUI();
                    break;
                case 'tasks':
                    updateTasksUI();
                    updateTaskAnalytics();
                    break;
                case 'fitness':
                    updateFitnessUI();
                    break;
                case 'nutrition':
                    updateNutritionUI();
                    break;
                case 'ai':
                    updateAIDisplay();
                    updateAIInsights();
                    break;
                case 'analytics':
                    updateAnalyticsUI();
                    break;
            }
        }

        function updateStatsUI() {
            // Update all stat displays
            document.getElementById('workoutCount').textContent = gameState.dailyStats.workouts;
            document.getElementById('waterCount').textContent = gameState.dailyStats.waterGlasses;
            document.getElementById('caloriesCount').textContent = gameState.dailyStats.calories;
            document.getElementById('tasksCompletedDisplay').textContent = gameState.dailyStats.tasksCompleted;
            document.getElementById('currentStreak').textContent = gameState.currentStreak;
            
            // Update nutrition breakdown
            document.getElementById('proteinCount').textContent = `${gameState.dailyStats.protein}g`;
            document.getElementById('carbsCount').textContent = `${gameState.dailyStats.carbs}g`;
            document.getElementById('fatCount').textContent = `${gameState.dailyStats.fat}g`;
            
            // Update fitness stats
            document.getElementById('totalWorkouts').textContent = gameState.dailyStats.workouts;
            document.getElementById('caloriesBurned').textContent = gameState.dailyStats.caloriesBurned;
            document.getElementById('exerciseMinutes').textContent = gameState.dailyStats.exerciseMinutes;
            
            // Update nutrition detailed view
            document.getElementById('nutritionCalories').textContent = gameState.dailyStats.calories;
        }

        function updateTaskAnalytics() {
            const totalTasks = gameState.dailyStats.totalTasks;
            const completedTasks = gameState.dailyStats.tasksCompleted;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('completionRate').textContent = `${completionRate}%`;
            document.getElementById('streakCount').textContent = gameState.currentStreak;
            document.getElementById('totalXPEarned').textContent = gameState.totalXP;
            
            // Calculate average time (simulated)
            const avgTime = completedTasks > 0 ? Math.round(30 + Math.random() * 20) : 0;
            document.getElementById('averageTime').textContent = `${avgTime}m`;
        }

        function updateFitnessUI() {
            // This function would update fitness-specific UI elements
            updateStatsUI();
        }

        function updateNutritionUI() {
            // This function would update nutrition-specific UI elements
            updateStatsUI();
        }

        function updateAIDisplay() {
            const neuralTraining = document.getElementById('neuralTraining');
            const neuralAccuracy = document.getElementById('neuralAccuracy');
            const patternAnalysis = document.getElementById('patternAnalysis');
            
            if (neuralTraining) neuralTraining.textContent = `${Math.round(gameState.ai.confidence * 100)}%`;
            if (neuralAccuracy) neuralAccuracy.textContent = '92%';
            if (patternAnalysis) {
                patternAnalysis.textContent = `Analyzed ${Object.keys(gameState.patterns.activities).length} activity categories and identified ${gameState.achievements.length} behavioral patterns`;
            }
        }

        function updateAnalyticsUI() {
            // Update analytics displays
            const overallScore = Math.round(
                (gameState.dailyStats.tasksCompleted / Math.max(gameState.dailyStats.totalTasks, 1)) * 40 +
                (Math.min(gameState.dailyStats.workouts, 1)) * 30 +
                (Math.min(gameState.dailyStats.waterGlasses, 8) / 8) * 30
            );
            
            document.getElementById('overallScore').textContent = overallScore;
            document.getElementById('improvementRate').textContent = '+12%';
            document.getElementById('consistencyScore').textContent = `${Math.round(gameState.ai.confidence * 100)}%`;
            document.getElementById('goalCompletion').textContent = `${Math.round(overallScore * 0.9)}%`;
            
            // Update trend analysis
            const trendContainer = document.getElementById('trendAnalysis');
            if (trendContainer) {
                trendContainer.innerHTML = `
                    <div class="p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                        <div class="font-bold text-green-700 dark:text-green-300">Fitness Trend</div>
                        <div class="text-sm text-green-600 dark:text-green-400">‚ÜóÔ∏è +15% improvement this week</div>
                    </div>
                    <div class="p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                        <div class="font-bold text-blue-700 dark:text-blue-300">Productivity Trend</div>
                        <div class="text-sm text-blue-600 dark:text-blue-400">‚Üí Stable performance</div>
                    </div>
                    <div class="p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                        <div class="font-bold text-purple-700 dark:text-purple-300">AI Learning</div>
                        <div class="text-sm text-purple-600 dark:text-purple-400">üìà Pattern recognition improving</div>
                    </div>
                `;
            }
        }

        function updateAllUI() {
            updateXPDisplay();
            updateStatsUI();
            updateTasksUI();
            updateAchievementsUI();
            updateAIDisplay();
        }

        // üîß ADVANCED FEATURES
        function getPersonalizedCoaching() {
            if (!neuralNetwork) {
                showFloatingNotification('ü§ñ AI Loading', 'Neural networks are still initializing...');
                return;
            }
            
            const insights = generateAIInsights();
            if (insights.length > 0) {
                const coaching = insights[0];
                showFloatingNotification('üß† AI Coach', coaching.text);
            } else {
                showFloatingNotification('üß† AI Coach', 'Keep building your daily habits! The AI is learning your patterns.');
            }
        }

        function showAdvancedAI() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold flex items-center space-x-2">
                            <span>üî¨</span>
                            <span>Advanced AI Analysis</span>
                            <div class="pattern-learning-indicator w-4 h-4 rounded-full"></div>
                        </h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-400 hover:text-gray-600 text-xl">√ó</button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 rounded-lg">
                            <h4 class="font-bold mb-3 flex items-center space-x-2">
                                <span>üß†</span>
                                <span>Neural Network Status</span>
                            </h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Architecture:</span>
                                    <span class="font-mono">[12, 16, 8, 4]</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Learning Rate:</span>
                                    <span class="text-blue-600">0.01</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Training Status:</span>
                                    <span class="text-green-600">Complete</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Prediction Accuracy:</span>
                                    <span class="text-blue-600">${Math.round(gameState.ai.confidence * 100)}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 rounded-lg">
                            <h4 class="font-bold mb-3 flex items-center space-x-2">
                                <span>üìä</span>
                                <span>Pattern Analysis</span>
                            </h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Activity Categories:</span>
                                    <span class="text-purple-600">${Object.keys(gameState.patterns.activities).length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Behavioral Patterns:</span>
                                    <span class="text-purple-600">${gameState.achievements.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Learning Confidence:</span>
                                    <span class="text-purple-600">${Math.round(gameState.patterns.learning.confidence * 100)}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Data Points:</span>
                                    <span class="text-purple-600">${gameState.tasks.length + gameState.achievements.length}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-bold mb-3">üî¨ Technical Implementation</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div>
                                <div class="font-medium mb-1">Neural Network</div>
                                <div class="text-gray-600 dark:text-gray-400">Multi-layer perceptron with ReLU activation, softmax output, momentum-based optimization</div>
                            </div>
                            <div>
                                <div class="font-medium mb-1">Machine Learning</div>
                                <div class="text-gray-600 dark:text-gray-400">Time series analysis, pattern recognition, correlation analysis, clustering algorithms</div>
                            </div>
                            <div>
                                <div class="font-medium mb-1">Features</div>
                                <div class="text-gray-600 dark:text-gray-400">12 input features including temporal, behavioral, and contextual data</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex space-x-3">
                        <button onclick="retrainAI()" class="flex-1 bg-primary text-white py-2 rounded hover:bg-purple-600 transition-all">
                            üîÑ Retrain Models
                        </button>
                        <button onclick="exportAIData()" class="flex-1 bg-green-500 text-white py-2 rounded hover:bg-green-600 transition-all">
                            üìä Export Data
                        </button>
                        <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600 transition-all">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showAllAIInsights() {
            const insights = generateAIInsights();
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold flex items-center space-x-2">
                            <span>üß†</span>
                            <span>Complete AI Analysis</span>
                            <div class="pattern-learning-indicator w-4 h-4 rounded-full"></div>
                        </h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-400 hover:text-gray-600 text-xl">√ó</button>
                    </div>
                    
                    <div class="space-y-4">
                        ${insights.map((insight, index) => `
                            <div class="p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex items-center space-x-2">
                                        <span class="font-medium">#${index + 1}</span>
                                        <span class="text-xs px-2 py-1 bg-blue-200 dark:bg-blue-600 rounded-full">
                                            ${insight.type.replace('_', ' ')}
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        ${Math.round(insight.confidence * 100)}% confidence
                                    </div>
                                </div>
                                <p class="text-sm text-gray-700 dark:text-gray-300">${insight.text}</p>
                                <div class="mt-2 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                    <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-full rounded-full transition-all duration-500" style="width: ${insight.confidence * 100}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-bold mb-2">üî¨ AI System Status</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>Neural Network: <span class="text-green-600">Active</span></div>
                            <div>Pattern Analysis: <span class="text-blue-600">Learning</span></div>
                            <div>Predictions: <span class="text-purple-600">Real-time</span></div>
                            <div>Confidence: <span class="text-orange-600">${Math.round(gameState.ai.confidence * 100)}%</span></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function retrainAI() {
            showFloatingNotification('üîÑ Retraining AI', 'Neural networks are being retrained with latest data...');
            
            setTimeout(() => {
                if (neuralNetwork && mlEngine) {
                    const newTrainingData = generateTrainingData(500);
                    
                    for (let epoch = 0; epoch < 50; epoch++) {
                        newTrainingData.forEach(({ inputs, outputs }) => {
                            neuralNetwork.backpropagate(inputs, outputs);
                        });
                    }
                    
                    gameState.ai.confidence = Math.min(1, gameState.ai.confidence + 0.05);
                    gameState.ai.lastUpdate = Date.now();
                    updateAIDisplay();
                    showFloatingNotification('‚úÖ Retraining Complete', 'AI models have been successfully updated!');
                }
            }, 3000);
        }

        function exportAIData() {
            const aiData = {
                timestamp: new Date().toISOString(),
                gameState: gameState,
                aiConfiguration: {
                    neuralNetworkLayers: [12, 16, 8, 4],
                    learningRate: 0.01,
                    momentum: 0.9,
                    confidence: gameState.ai.confidence
                },
                patterns: gameState.patterns,
                insights: generateAIInsights(),
                recommendations: generateRecommendations()
            };
            
            const blob = new Blob([JSON.stringify(aiData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `life-quest-ai-analysis-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showFloatingNotification('üìä AI Data Exported', 'Complete analysis data has been downloaded');
        }

        function getNewRecommendations() {
            updateAIRecommendations();
            showFloatingNotification('üîÑ Recommendations Updated', 'Fresh AI recommendations generated');
        }

        function optimizeTaskOrder() {
            if (gameState.tasks.length === 0) {
                showFloatingNotification('üìã No Tasks', 'Add some tasks first to optimize their order');
                return;
            }
            
            // Simple optimization based on XP, difficulty, and AI predictions
            gameState.tasks.sort((a, b) => {
                const scoreA = a.xp * (a.aiGenerated ? 1.2 : 1) * (a.difficulty === 'easy' ? 1.5 : 1);
                const scoreB = b.xp * (b.aiGenerated ? 1.2 : 1) * (b.difficulty === 'easy' ? 1.5 : 1);
                return scoreB - scoreA;
            });
            
            updateTasksUI();
            showFloatingNotification('üß† Tasks Optimized', 'AI has reordered your tasks for maximum effectiveness');
        }

        function aiQuickSuggestion() {
            const suggestions = [
                "üß† Neural analysis suggests a 5-minute break to optimize focus",
                "üíß Hydration algorithms recommend drinking water now",
                "‚ö° Pattern recognition indicates high energy - perfect for exercise",
                "üéØ AI detects optimal learning window - consider a skill-building task",
                "üåü Behavioral models suggest trying a new activity type",
                "üìä Performance metrics show improvement - keep up the momentum!",
                "üîÑ Optimization algorithms recommend adjusting your routine",
                "üí™ Prediction models indicate ideal time for physical activity"
            ];
            
            const suggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
            showFloatingNotification('üß† AI Suggestion', suggestion);
        }

        // üîî NOTIFICATION SYSTEM
        function showFloatingNotification(title, message) {
            const notification = document.createElement('div');
            notification.className = 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg p-4 mb-2 floating-notification max-w-sm';
            notification.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="pattern-learning-indicator w-3 h-3 rounded-full mt-1 flex-shrink-0"></div>
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-sm">${title}</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">${message}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // üéµ SPOTIFY INTEGRATION WITH PROPER PKCE
        let spotifyPlayer = null;
        let spotifyAccessToken = null;
        let currentPlaybackState = null;
        let refreshToken = null;
        let tokenExpiryTime = null;

        // Spotify API Configuration
        function getSpotifyRedirectURI() {
            return gameState.settings.spotifyRedirectUri || (window.location.origin + window.location.pathname);
        }
        
        const SPOTIFY_SCOPES = [
            'streaming',
            'user-read-email',
            'user-read-private',
            'user-read-playback-state',
            'user-modify-playback-state',
            'user-read-currently-playing',
            'playlist-read-private',
            'playlist-read-collaborative'
        ].join(' ');

        // PKCE Helper Functions
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        async function generateCodeChallenge(verifier) {
            const data = new TextEncoder().encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        async function connectSpotify() {
            try {
                const clientId = gameState.settings.spotifyClientId;
                
                if (!clientId) {
                    showFloatingNotification('‚ö†Ô∏è Setup Required', 'Please configure your Spotify Client ID in settings first');
                    return;
                }

                showFloatingNotification('üéµ Connecting...', 'Initiating secure PKCE authentication with Spotify');

                // Generate PKCE parameters
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);

                // Store code verifier for later use
                localStorage.setItem('spotify_code_verifier', codeVerifier);
                localStorage.setItem('spotify_auth_state', Date.now().toString());

                // Build authorization URL
                const redirectUri = getSpotifyRedirectURI();
                const authParams = new URLSearchParams({
                    client_id: clientId,
                    response_type: 'code',
                    redirect_uri: redirectUri,
                    scope: SPOTIFY_SCOPES,
                    code_challenge_method: 'S256',
                    code_challenge: codeChallenge,
                    state: localStorage.getItem('spotify_auth_state')
                });

                // Redirect to Spotify authorization
                const authUrl = `https://accounts.spotify.com/authorize?${authParams}`;
                window.location.href = authUrl;

            } catch (error) {
                console.error('Spotify connection error:', error);
                showFloatingNotification('‚ùå Connection Failed', 'Unable to connect to Spotify: ' + error.message);
            }
        }

        async function handleSpotifyCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            if (error) {
                showFloatingNotification('‚ùå Authorization Failed', `Spotify error: ${error}`);
                return;
            }

            if (code && state === localStorage.getItem('spotify_auth_state')) {
                try {
                    await exchangeCodeForToken(code);
                    // Clean up URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) {
                    console.error('Token exchange error:', error);
                    showFloatingNotification('‚ùå Token Exchange Failed', 'Unable to complete Spotify authentication');
                }
            }
        }

        async function exchangeCodeForToken(authorizationCode) {
            const clientId = gameState.settings.spotifyClientId;
            const codeVerifier = localStorage.getItem('spotify_code_verifier');

            console.log('üéµ Starting token exchange...');
            console.log('Client ID:', clientId ? `${clientId.substring(0, 8)}...` : 'MISSING');
            console.log('Code Verifier:', codeVerifier ? 'Present' : 'MISSING');
            console.log('Redirect URI:', redirectUri);

            if (!codeVerifier) {
                throw new Error('Code verifier not found. Please try reconnecting.');
            }

            if (!clientId) {
                throw new Error('Spotify Client ID not configured. Please check your settings.');
            }

            const tokenParams = new URLSearchParams({
                grant_type: 'authorization_code',
                code: authorizationCode,
                redirect_uri: redirectUri,
                client_id: clientId,
                code_verifier: codeVerifier
            });

            console.log('üéµ Sending token request to Spotify...');

            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: tokenParams
                });

                console.log('üéµ Token response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('üéµ Token exchange error response:', errorText);
                    
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { error: 'unknown', error_description: errorText };
                    }

                    // Provide more specific error messages
                    let userMessage = 'Token exchange failed';
                    if (errorData.error === 'invalid_client') {
                        userMessage = 'Invalid Client ID. Please check your Spotify app configuration.';
                    } else if (errorData.error === 'invalid_grant') {
                        userMessage = 'Authorization code expired or invalid. Please try connecting again.';
                    } else if (errorData.error === 'invalid_request') {
                        userMessage = 'Invalid request. Please check your redirect URI configuration.';
                    } else if (errorData.error_description) {
                        userMessage = errorData.error_description;
                    }

                    throw new Error(`${userMessage}\n\nDebug Info:\n- Error: ${errorData.error}\n- Status: ${response.status}\n- Redirect URI: ${redirectUri}`);
                }

                const tokenData = await response.json();
                console.log('üéµ Token exchange successful!');
                
                // Store tokens securely
                spotifyAccessToken = tokenData.access_token;
                refreshToken = tokenData.refresh_token;
                tokenExpiryTime = Date.now() + (tokenData.expires_in * 1000);

                // Store tokens in localStorage
                localStorage.setItem('spotify_access_token', spotifyAccessToken);
                localStorage.setItem('spotify_refresh_token', refreshToken);
                localStorage.setItem('spotify_token_expiry', tokenExpiryTime.toString());

                // Clean up temporary storage
                localStorage.removeItem('spotify_code_verifier');
                localStorage.removeItem('spotify_auth_state');

                // Initialize Spotify player
                await initializeSpotifyPlayer();
                updateSpotifyStatus('Connected');
                updateAboutSpotifyStatus('Connected');
                showFloatingNotification('‚úÖ Spotify Connected!', 'Successfully authenticated with Spotify Web API');

            } catch (fetchError) {
                console.error('üéµ Network error during token exchange:', fetchError);
                throw new Error(`Network error: ${fetchError.message}. Please check your internet connection and try again.`);
            }
        }

        async function refreshSpotifyToken() {
            if (!refreshToken) {
                throw new Error('No refresh token available');
            }

            const clientId = gameState.settings.spotifyClientId;
            const refreshParams = new URLSearchParams({
                grant_type: 'refresh_token',
                refresh_token: refreshToken,
                client_id: clientId
            });

            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: refreshParams
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Token refresh failed: ${errorData.error_description || errorData.error}`);
            }

            const tokenData = await response.json();
            
            spotifyAccessToken = tokenData.access_token;
            tokenExpiryTime = Date.now() + (tokenData.expires_in * 1000);
            
            // Update refresh token if provided
            if (tokenData.refresh_token) {
                refreshToken = tokenData.refresh_token;
                localStorage.setItem('spotify_refresh_token', refreshToken);
            }

            localStorage.setItem('spotify_access_token', spotifyAccessToken);
            localStorage.setItem('spotify_token_expiry', tokenExpiryTime.toString());
        }

        async function ensureValidToken() {
            if (!spotifyAccessToken || Date.now() >= tokenExpiryTime - 60000) { // Refresh 1 minute before expiry
                await refreshSpotifyToken();
            }
        }

        async function spotifyApiRequest(endpoint, options = {}) {
            await ensureValidToken();
            
            const response = await fetch(`https://api.spotify.com/v1${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${spotifyAccessToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    // Token might be invalid, try refreshing
                    await refreshSpotifyToken();
                    return spotifyApiRequest(endpoint, options);
                }
                throw new Error(`Spotify API error: ${response.status} ${response.statusText}`);
            }

            return response.json();
        }

        async function initializeSpotifyPlayer() {
            // Hide login, show player
            document.getElementById('spotifyLogin').classList.add('hidden');
            document.getElementById('spotifyPlayer').classList.remove('hidden');
            
            try {
                // Get current playback state from Spotify API
                await updateCurrentTrackFromAPI();
                
                // Get available devices
                await updateDeviceListFromAPI();
                
                // Start real-time updates
                setInterval(updateCurrentTrackFromAPI, 5000);
                setInterval(updatePlaybackProgress, 1000);
                
            } catch (error) {
                console.error('Spotify player initialization error:', error);
                // Fall back to simulated mode
                updateCurrentTrack();
                populateDeviceList();
            }
        }

        async function updateCurrentTrackFromAPI() {
            try {
                const playbackState = await spotifyApiRequest('/me/player');
                
                if (playbackState && playbackState.item) {
                    const track = playbackState.item;
                    currentPlaybackState = {
                        name: track.name,
                        artist: track.artists[0]?.name || 'Unknown Artist',
                        album: track.album?.name || 'Unknown Album',
                        image: track.album?.images[0]?.url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjMUI4M0ZGIi8+Cjx0ZXh0IHg9IjMyIiB5PSIzNiIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+U1A8L3RleHQ+Cjwvc3ZnPgo=',
                        duration: Math.floor(track.duration_ms / 1000),
                        position: Math.floor(playbackState.progress_ms / 1000),
                        isPlaying: playbackState.is_playing
                    };
                    
                    document.getElementById('trackImage').src = currentPlaybackState.image;
                    document.getElementById('trackName').textContent = currentPlaybackState.name;
                    document.getElementById('trackArtist').textContent = currentPlaybackState.artist;
                    document.getElementById('trackAlbum').textContent = currentPlaybackState.album;
                    
                    const playPauseBtn = document.getElementById('playPauseBtn');
                    playPauseBtn.textContent = currentPlaybackState.isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
                    
                } else {
                    // No active playback - show placeholder
                    currentPlaybackState = null;
                    document.getElementById('trackName').textContent = 'No track playing';
                    document.getElementById('trackArtist').textContent = 'Open Spotify and start playing music';
                    document.getElementById('trackAlbum').textContent = '-';
                    document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è';
                }
            } catch (error) {
                console.error('Error getting current track:', error);
                // Fall back to simulated track
                updateCurrentTrack();
            }
        }

        async function updateDeviceListFromAPI() {
            try {
                const devices = await spotifyApiRequest('/me/player/devices');
                const deviceSelect = document.getElementById('deviceSelect');
                
                if (devices && devices.devices) {
                    deviceSelect.innerHTML = '<option value="">Select Device</option>' +
                        devices.devices.map(device => 
                            `<option value="${device.id}" ${device.is_active ? 'selected' : ''}>
                                ${device.name} (${device.type})
                            </option>`
                        ).join('');
                } else {
                    populateDeviceList(); // Fall back to simulated devices
                }
            } catch (error) {
                console.error('Error getting devices:', error);
                populateDeviceList(); // Fall back to simulated devices
            }
        }

        function updateSpotifyStatus(status) {
            const statusElement = document.getElementById('spotifyStatus');
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.className = status === 'Connected' 
                    ? 'text-sm px-3 py-1 rounded-full bg-green-200 dark:bg-green-600 text-green-800 dark:text-green-200'
                    : 'text-sm px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-600';
            }
        }

        function updateAboutSpotifyStatus(status) {
            const aboutStatusElement = document.getElementById('aboutSpotifyStatus');
            if (aboutStatusElement) {
                aboutStatusElement.textContent = status;
                aboutStatusElement.className = status === 'Connected' 
                    ? 'text-green-600 dark:text-green-400'
                    : 'text-gray-600 dark:text-gray-400';
            }
        }

        function updateCurrentTrack() {
            // Simulate current track data
            const tracks = [
                {
                    name: "Focus Flow",
                    artist: "AI Generated",
                    album: "Productivity Beats",
                    image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjMUI4M0ZGIi8+Cjx0ZXh0IHg9IjMyIiB5PSIzNiIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+QUk8L3RleHQ+Cjwvc3ZnPgo=",
                    duration: 180
                },
                {
                    name: "Morning Energy",
                    artist: "Wellness Mix",
                    album: "Health & Vitality",
                    image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjMTZBMzRBIi8+Cjx0ZXh0IHg9IjMyIiB5PSIzNiIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+V0VSTDwvdGV4dD4KPC9zdmc+Cg==",
                    duration: 210
                }
            ];
            
            const currentTrack = tracks[Math.floor(Math.random() * tracks.length)];
            currentPlaybackState = {
                ...currentTrack,
                position: 0,
                isPlaying: false
            };
            
            document.getElementById('trackImage').src = currentTrack.image;
            document.getElementById('trackName').textContent = currentTrack.name;
            document.getElementById('trackArtist').textContent = currentTrack.artist;
            document.getElementById('trackAlbum').textContent = currentTrack.album;
        }

        function updatePlaybackProgress() {
            if (!currentPlaybackState || !currentPlaybackState.isPlaying) return;
            
            currentPlaybackState.position = Math.min(
                currentPlaybackState.position + 1,
                currentPlaybackState.duration
            );
            
            const progress = (currentPlaybackState.position / currentPlaybackState.duration) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };
            
            document.getElementById('trackProgress').textContent = 
                `${formatTime(currentPlaybackState.position)} / ${formatTime(currentPlaybackState.duration)}`;
        }

        async function spotifyTogglePlay() {
            if (!spotifyAccessToken) {
                // Fall back to simulated behavior
                if (!currentPlaybackState) return;
                currentPlaybackState.isPlaying = !currentPlaybackState.isPlaying;
                const playPauseBtn = document.getElementById('playPauseBtn');
                playPauseBtn.textContent = currentPlaybackState.isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
                const action = currentPlaybackState.isPlaying ? 'resumed' : 'paused';
                showFloatingNotification('üéµ Playback', `Music ${action} (simulated)`);
                return;
            }

            try {
                const isPlaying = currentPlaybackState?.isPlaying;
                const endpoint = isPlaying ? '/me/player/pause' : '/me/player/play';
                
                await spotifyApiRequest(endpoint, { method: 'PUT' });
                
                // Update UI immediately
                if (currentPlaybackState) {
                    currentPlaybackState.isPlaying = !isPlaying;
                    const playPauseBtn = document.getElementById('playPauseBtn');
                    playPauseBtn.textContent = currentPlaybackState.isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
                }
                
                const action = !isPlaying ? 'resumed' : 'paused';
                showFloatingNotification('üéµ Spotify', `Music ${action}`);
            } catch (error) {
                console.error('Spotify toggle play error:', error);
                showFloatingNotification('‚ùå Spotify Error', 'Unable to control playback. Make sure Spotify is active on a device.');
            }
        }

        async function spotifyPrevious() {
            if (!spotifyAccessToken) {
                // Fall back to simulated behavior
                updateCurrentTrack();
                showFloatingNotification('‚èÆÔ∏è Previous', 'Switched to previous track (simulated)');
                return;
            }

            try {
                await spotifyApiRequest('/me/player/previous', { method: 'POST' });
                showFloatingNotification('‚èÆÔ∏è Spotify', 'Previous track');
                
                // Update track info after a brief delay
                setTimeout(updateCurrentTrackFromAPI, 1000);
            } catch (error) {
                console.error('Spotify previous error:', error);
                showFloatingNotification('‚ùå Spotify Error', 'Unable to skip to previous track. Make sure Spotify is active.');
            }
        }

        async function spotifyNext() {
            if (!spotifyAccessToken) {
                // Fall back to simulated behavior
                updateCurrentTrack();
                showFloatingNotification('‚è≠Ô∏è Next', 'Switched to next track (simulated)');
                return;
            }

            try {
                await spotifyApiRequest('/me/player/next', { method: 'POST' });
                showFloatingNotification('‚è≠Ô∏è Spotify', 'Next track');
                
                // Update track info after a brief delay
                setTimeout(updateCurrentTrackFromAPI, 1000);
            } catch (error) {
                console.error('Spotify next error:', error);
                showFloatingNotification('‚ùå Spotify Error', 'Unable to skip to next track. Make sure Spotify is active.');
            }
        }

        async function setSpotifyVolume(volume) {
            document.getElementById('volumeDisplay').textContent = `${volume}%`;
            
            if (!spotifyAccessToken) {
                showFloatingNotification('üîä Volume', `Set to ${volume}% (simulated)`);
                return;
            }

            try {
                await spotifyApiRequest(`/me/player/volume?volume_percent=${volume}`, { method: 'PUT' });
                showFloatingNotification('üîä Spotify', `Volume set to ${volume}%`);
            } catch (error) {
                console.error('Spotify volume error:', error);
                showFloatingNotification('‚ùå Spotify Error', 'Unable to set volume. Make sure Spotify is active.');
            }
        }

        function populateDeviceList() {
            const deviceSelect = document.getElementById('deviceSelect');
            const devices = [
                { id: 'web', name: 'Web Player' },
                { id: 'phone', name: 'iPhone' },
                { id: 'desktop', name: 'Desktop App' }
            ];
            
            deviceSelect.innerHTML = '<option value="">Select Device</option>' +
                devices.map(device => `<option value="${device.id}">${device.name}</option>`).join('');
        }

        async function changeSpotifyDevice(deviceId) {
            if (!deviceId) return;
            
            if (!spotifyAccessToken) {
                const deviceNames = {
                    web: 'Web Player',
                    phone: 'iPhone',
                    desktop: 'Desktop App'
                };
                showFloatingNotification('üì± Device Transfer', `Playback transferred to ${deviceNames[deviceId]} (simulated)`);
                return;
            }

            try {
                await spotifyApiRequest('/me/player', {
                    method: 'PUT',
                    body: JSON.stringify({
                        device_ids: [deviceId],
                        play: currentPlaybackState?.isPlaying || false
                    })
                });
                
                showFloatingNotification('üì± Spotify', 'Device transfer initiated');
                
                // Update device list after transfer
                setTimeout(updateDeviceListFromAPI, 2000);
            } catch (error) {
                console.error('Spotify device transfer error:', error);
                showFloatingNotification('‚ùå Spotify Error', 'Unable to transfer playback');
            }
        }

        function transferToWebPlayer() {
            showFloatingNotification('üì± Transfer', 'Transferring playback to Spotify Web Player');
        }

        // AI Music Features
        function playAIRecommendation(type) {
            const recommendations = {
                energy: {
                    name: "High Energy Mix",
                    artist: "AI Curated",
                    genre: "Electronic/Pop"
                },
                wellness: {
                    name: "Calm & Focus",
                    artist: "Meditation Sounds",
                    genre: "Ambient"
                },
                workout: {
                    name: "Pump Up Beats",
                    artist: "Fitness Mix",
                    genre: "Rock/Electronic"
                }
            };
            
            const rec = recommendations[type];
            if (rec) {
                updateCurrentTrack();
                currentPlaybackState.isPlaying = true;
                document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è';
                showFloatingNotification('üéµ AI Recommendation', `Playing ${rec.name}`);
            }
        }

        function generateMusicRecommendations() {
            // Simulate AI analysis
            showFloatingNotification('üß† Analyzing...', 'AI is processing your music preferences');
            
            setTimeout(() => {
                const recommendations = [
                    "üéµ Discovered new focus playlist based on your productivity patterns",
                    "üßò Added calming tracks that match your wellness goals",
                    "üí™ Found high-energy songs perfect for your workout schedule",
                    "üìä Updated playlist based on your daily rhythm analysis"
                ];
                
                const rec = recommendations[Math.floor(Math.random() * recommendations.length)];
                showFloatingNotification('üß† Music AI', rec);
            }, 2000);
        }

        function focusMode() {
            // Activate focus mode with lo-fi music
            updateCurrentTrack();
            currentPlaybackState.isPlaying = true;
            document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è';
            
            // Add a focus task
            const task = {
                id: Date.now(),
                name: 'Focus session with background music',
                category: 'wellness',
                xp: 50,
                completed: false,
                difficulty: 'medium',
                aiGenerated: true
            };
            
            gameState.tasks.push(task);
            gameState.dailyStats.totalTasks++;
            updateTasksUI();
            
            showFloatingNotification('üß† Focus Mode', 'Lo-fi music started, focus task added');
        }

        // ‚öôÔ∏è SETTINGS MANAGEMENT
        function toggleSetting(setting, value) {
            gameState.settings[setting] = value;
            saveGameState();
            
            const settingNames = {
                notifications: 'Notifications',
                animations: 'Animations',
                soundEffects: 'Sound Effects',
                aiLearning: 'AI Learning'
            };
            
            const status = value ? 'enabled' : 'disabled';
            showFloatingNotification('‚öôÔ∏è Setting Updated', `${settingNames[setting]} ${status}`);
        }

        function updateAISensitivity(value) {
            gameState.ai.sensitivity = parseFloat(value);
            document.getElementById('sensitivityValue').textContent = `${Math.round(value * 100)}%`;
            saveGameState();
            showFloatingNotification('üéØ AI Updated', `Sensitivity set to ${Math.round(value * 100)}%`);
        }

        function updateLearningRate(value) {
            if (neuralNetwork) {
                neuralNetwork.learningRate = parseFloat(value);
            }
            saveGameState();
            showFloatingNotification('‚ö° Learning Rate', `Updated to ${value}`);
        }

        function updateAIPersonality(personality) {
            gameState.ai.personality = personality;
            saveGameState();
            
            const personalities = {
                motivational: 'üî• Motivational Coach',
                analytical: 'üìä Data Analyst',
                supportive: 'ü§ó Supportive Friend',
                challenging: 'üí™ Challenging Trainer'
            };
            
            showFloatingNotification('üé® AI Personality', `Switched to ${personalities[personality]}`);
        }

        function resetAI() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">üîÑ Reset AI Models</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                        This will reset all AI learning progress and patterns. Are you sure?
                    </p>
                    <div class="flex space-x-3">
                        <button onclick="confirmResetAI()" class="flex-1 bg-red-500 text-white py-2 rounded hover:bg-red-600 transition-all">
                            Reset
                        </button>
                        <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600 transition-all">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmResetAI() {
            // Reset AI state
            gameState.patterns = {
                activities: {},
                preferences: {},
                timing: {},
                learning: {
                    enabled: true,
                    confidence: 0.5,
                    patterns: []
                }
            };
            
            gameState.ai = {
                neuralNetwork: null,
                mlEngine: null,
                confidence: 0.5,
                lastUpdate: Date.now(),
                predictions: {},
                insights: []
            };
            
            // Reinitialize AI
            initializeAI();
            
            document.querySelector('.modal-overlay').remove();
            showFloatingNotification('üîÑ AI Reset', 'All AI models have been reset and reinitialized');
        }

        // üíæ DATA MANAGEMENT
        function backupData() {
            const backupData = {
                version: '2.1.0',
                timestamp: new Date().toISOString(),
                gameState: gameState,
                settings: gameState.settings,
                achievements: gameState.achievements,
                patterns: gameState.patterns
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `life-quest-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showFloatingNotification('üì¶ Backup Complete', 'Your data has been downloaded');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (backupData.gameState) {
                            gameState = { ...gameState, ...backupData.gameState };
                            saveGameState();
                            updateAllUI();
                            showFloatingNotification('üìÇ Restore Complete', 'Your data has been restored successfully');
                        } else {
                            showFloatingNotification('‚ùå Invalid File', 'This is not a valid backup file');
                        }
                    } catch (error) {
                        console.error('Restore error:', error);
                        showFloatingNotification('‚ùå Restore Failed', 'Unable to restore backup file');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function resetData() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                    <h3 class="text-lg font-bold mb-4 text-red-600">üóëÔ∏è Reset All Data</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                        This will permanently delete all your progress, tasks, achievements, and AI patterns. This action cannot be undone!
                    </p>
                    <div class="flex space-x-3">
                        <button onclick="confirmResetData()" class="flex-1 bg-red-500 text-white py-2 rounded hover:bg-red-600 transition-all">
                            Delete Everything
                        </button>
                        <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600 transition-all">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmResetData() {
            localStorage.removeItem('lifeQuestAI');
            location.reload();
        }

        function updateDataCounts() {
            document.getElementById('taskCount').textContent = gameState.tasks.length;
            document.getElementById('achievementCount').textContent = gameState.achievements.length;
            document.getElementById('patternCount').textContent = Object.keys(gameState.patterns.activities).length;
            document.getElementById('totalXPDisplay').textContent = gameState.totalXP;
        }

        // üéØ INTERESTS MANAGEMENT
        function updateInterestsUI() {
            const interestsList = document.getElementById('interestsList');
            if (!interestsList) return;
            
            if (gameState.interests.length === 0) {
                interestsList.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-4">
                        <div class="text-2xl mb-2">üéØ</div>
                        <p class="text-sm">No interests added yet. Add some to get personalized AI suggestions!</p>
                    </div>
                `;
            } else {
                interestsList.innerHTML = gameState.interests.map(interest => `
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-primary text-white">
                        ${interest}
                        <button onclick="removeInterest('${interest}')" class="ml-2 text-white hover:text-red-200 focus:outline-none">
                            √ó
                        </button>
                    </span>
                `).join('');
            }
        }

        function addInterest() {
            const input = document.getElementById('newInterest');
            const interest = input.value.trim().toLowerCase();
            
            if (!interest) {
                showFloatingNotification('‚ö†Ô∏è Invalid Input', 'Please enter an interest');
                return;
            }
            
            if (gameState.interests.includes(interest)) {
                showFloatingNotification('üìã Already Added', 'This interest is already in your list');
                return;
            }
            
            gameState.interests.push(interest);
            input.value = '';
            
            // Update AI patterns for interests
            if (!gameState.patterns.interests[interest]) {
                gameState.patterns.interests[interest] = {
                    strength: 1.0,
                    relatedCategories: [],
                    timePreferences: [],
                    successRate: 0.5
                };
            }
            
            updateInterestsUI();
            saveGameState();
            showFloatingNotification('üéØ Interest Added', `"${interest}" added to your interests`);
            
            // Trigger AI learning update
            learnFromInterests();
        }

        function removeInterest(interest) {
            const index = gameState.interests.indexOf(interest);
            if (index > -1) {
                gameState.interests.splice(index, 1);
                updateInterestsUI();
                saveGameState();
                showFloatingNotification('üóëÔ∏è Interest Removed', `"${interest}" removed from your interests`);
            }
        }

        function learnFromInterests() {
            // Enhanced AI learning based on interests
            gameState.interests.forEach(interest => {
                const pattern = gameState.patterns.interests[interest];
                if (!pattern) return;
                
                // Analyze task completion patterns for this interest
                const relatedTasks = gameState.tasks.filter(task => 
                    task.name.toLowerCase().includes(interest) || 
                    getCategoryForInterest(interest) === task.category
                );
                
                if (relatedTasks.length > 0) {
                    const completedTasks = relatedTasks.filter(task => task.completed);
                    pattern.successRate = completedTasks.length / relatedTasks.length;
                    pattern.strength = Math.min(2.0, pattern.strength + 0.1);
                }
            });
        }

        function getCategoryForInterest(interest) {
            const categoryMappings = {
                'fitness': 'fitness',
                'exercise': 'fitness',
                'workout': 'fitness',
                'gym': 'fitness',
                'running': 'fitness',
                'yoga': 'wellness',
                'meditation': 'wellness',
                'mindfulness': 'wellness',
                'reading': 'personal',
                'learning': 'personal',
                'studying': 'personal',
                'coding': 'personal',
                'programming': 'personal',
                'cooking': 'nutrition',
                'nutrition': 'nutrition',
                'diet': 'nutrition',
                'healthy': 'health',
                'water': 'health',
                'sleep': 'wellness'
            };
            
            return categoryMappings[interest] || 'personal';
        }

        // üß† ENHANCED AI TASK GENERATION FUNCTIONS
        function analyzeCurrentContext() {
            const now = new Date();
            const hour = now.getHours();
            const dayOfWeek = now.getDay();
            const context = {
                timeOfDay: hour < 12 ? 'morning' : hour < 17 ? 'afternoon' : 'evening',
                dayType: dayOfWeek === 0 || dayOfWeek === 6 ? 'weekend' : 'weekday',
                currentHour: hour,
                recentPatterns: analyzeRecentPatterns(),
                optimalTaskTypes: getOptimalTaskTypes(hour),
                energyLevel: predictEnergyLevel(),
                interestAlignment: calculateInterestAlignment()
            };
            
            return context;
        }

        function analyzeRecentPatterns() {
            const recentTasks = gameState.tasks.filter(task => 
                task.completed && 
                Date.now() - (task.completionTime || Date.now()) < 24 * 60 * 60 * 1000
            );
            
            const patterns = {
                preferredCategories: {},
                averageXP: 0,
                successfulDifficulties: {},
                timePreferences: {}
            };
            
            recentTasks.forEach(task => {
                patterns.preferredCategories[task.category] = 
                    (patterns.preferredCategories[task.category] || 0) + 1;
                patterns.averageXP += task.xp;
                patterns.successfulDifficulties[task.difficulty] = 
                    (patterns.successfulDifficulties[task.difficulty] || 0) + 1;
            });
            
            if (recentTasks.length > 0) {
                patterns.averageXP /= recentTasks.length;
            }
            
            return patterns;
        }

        function getOptimalTaskTypes(hour) {
            // Based on circadian rhythm research and productivity patterns
            if (hour >= 6 && hour <= 10) {
                return ['fitness', 'personal', 'nutrition']; // High willpower
            } else if (hour >= 10 && hour <= 14) {
                return ['personal', 'fitness', 'health']; // Peak cognitive
            } else if (hour >= 14 && hour <= 18) {
                return ['wellness', 'nutrition', 'personal']; // Afternoon dip recovery
            } else {
                return ['wellness', 'nutrition', 'health']; // Evening wind-down
            }
        }

        function predictEnergyLevel() {
            const hour = new Date().getHours();
            const recentWorkouts = gameState.dailyStats.workouts;
            const hydrationLevel = Math.min(1, gameState.dailyStats.waterGlasses / 8);
            const nutritionLevel = Math.min(1, gameState.dailyStats.calories / 2000);
            
            let baseEnergy = 0.7; // Default moderate energy
            
            // Time-based adjustments
            if (hour >= 6 && hour <= 10) baseEnergy += 0.2; // Morning boost
            if (hour >= 14 && hour <= 16) baseEnergy -= 0.2; // Afternoon dip
            if (hour >= 20) baseEnergy -= 0.3; // Evening decline
            
            // Lifestyle factors
            baseEnergy += recentWorkouts * 0.1;
            baseEnergy += hydrationLevel * 0.15;
            baseEnergy += nutritionLevel * 0.1;
            
            return Math.max(0.1, Math.min(1.0, baseEnergy));
        }

        function calculateInterestAlignment() {
            const alignment = {};
            
            gameState.interests.forEach(interest => {
                const pattern = gameState.patterns.interests[interest];
                if (pattern) {
                    alignment[interest] = {
                        strength: pattern.strength,
                        successRate: pattern.successRate,
                        category: getCategoryForInterest(interest),
                        priority: pattern.strength * pattern.successRate
                    };
                }
            });
            
            return alignment;
        }

        function generateSmartTasks(prediction, context) {
            const tasks = [];
            const taskTemplates = getSmartTaskTemplates();
            
            // Interest-based tasks (highest priority)
            const topInterests = Object.entries(context.interestAlignment)
                .sort(([,a], [,b]) => b.priority - a.priority)
                .slice(0, 2);
            
            topInterests.forEach(([interest, data]) => {
                const template = taskTemplates.interests[interest] || taskTemplates.generic[data.category];
                if (template) {
                    tasks.push(createTaskFromTemplate(template, interest, context, 'high'));
                }
            });
            
            // Context-aware tasks based on time and energy
            const optimalCategories = context.optimalTaskTypes.slice(0, 2);
            optimalCategories.forEach(category => {
                if (tasks.length < 4) { // Limit total tasks
                    const template = taskTemplates.contextual[category][context.timeOfDay];
                    if (template) {
                        tasks.push(createTaskFromTemplate(template, null, context, 'medium'));
                    }
                }
            });
            
            // Adaptive difficulty based on recent performance
            const avgSuccessRate = gameState.patterns.learning.confidence;
            if (avgSuccessRate > 0.8 && tasks.length < 5) {
                // Add a challenge task
                const challengeTemplate = taskTemplates.challenge;
                tasks.push(createTaskFromTemplate(challengeTemplate, null, context, 'high'));
            }
            
            return tasks.slice(0, 4); // Maximum 4 AI tasks at once
        }

        function getSmartTaskTemplates() {
            return {
                interests: {
                    'fitness': {
                        name: 'Personalized {interest} session',
                        category: 'fitness',
                        baseXP: 60,
                        difficulty: 'medium'
                    },
                    'reading': {
                        name: 'Read about {interest} for 20 minutes',
                        category: 'personal',
                        baseXP: 40,
                        difficulty: 'easy'
                    },
                    'coding': {
                        name: 'Practice {interest} - build something small',
                        category: 'personal',
                        baseXP: 80,
                        difficulty: 'hard'
                    },
                    'meditation': {
                        name: 'Guided {interest} session',
                        category: 'wellness',
                        baseXP: 35,
                        difficulty: 'easy'
                    },
                    'cooking': {
                        name: 'Try a new {interest} recipe',
                        category: 'nutrition',
                        baseXP: 50,
                        difficulty: 'medium'
                    }
                },
                contextual: {
                    fitness: {
                        morning: { name: 'High-energy morning workout', category: 'fitness', baseXP: 70, difficulty: 'medium' },
                        afternoon: { name: 'Quick energy boost exercise', category: 'fitness', baseXP: 45, difficulty: 'easy' },
                        evening: { name: 'Gentle evening stretches', category: 'wellness', baseXP: 30, difficulty: 'easy' }
                    },
                    personal: {
                        morning: { name: 'Learn something new (peak focus)', category: 'personal', baseXP: 65, difficulty: 'hard' },
                        afternoon: { name: 'Review and organize knowledge', category: 'personal', baseXP: 40, difficulty: 'medium' },
                        evening: { name: 'Reflect on today\'s learnings', category: 'personal', baseXP: 25, difficulty: 'easy' }
                    },
                    wellness: {
                        morning: { name: 'Morning mindfulness practice', category: 'wellness', baseXP: 35, difficulty: 'easy' },
                        afternoon: { name: 'Stress-relief breathing exercise', category: 'wellness', baseXP: 30, difficulty: 'easy' },
                        evening: { name: 'Evening relaxation routine', category: 'wellness', baseXP: 40, difficulty: 'easy' }
                    },
                    nutrition: {
                        morning: { name: 'Plan nutritious meals for today', category: 'nutrition', baseXP: 35, difficulty: 'medium' },
                        afternoon: { name: 'Healthy snack preparation', category: 'nutrition', baseXP: 25, difficulty: 'easy' },
                        evening: { name: 'Prepare tomorrow\'s healthy lunch', category: 'nutrition', baseXP: 40, difficulty: 'medium' }
                    }
                },
                generic: {
                    fitness: { name: 'AI-optimized fitness activity', category: 'fitness', baseXP: 55, difficulty: 'medium' },
                    personal: { name: 'Skill development session', category: 'personal', baseXP: 50, difficulty: 'medium' },
                    wellness: { name: 'Wellness check-in', category: 'wellness', baseXP: 35, difficulty: 'easy' },
                    nutrition: { name: 'Nutrition optimization task', category: 'nutrition', baseXP: 40, difficulty: 'medium' }
                },
                challenge: { name: 'AI Challenge: Push your limits!', category: 'personal', baseXP: 100, difficulty: 'hard' }
            };
        }

        function createTaskFromTemplate(template, interest, context, priority) {
            const energyMultiplier = context.energyLevel;
            const difficultyAdjustment = energyMultiplier > 0.7 ? 1 : energyMultiplier < 0.4 ? -1 : 0;
            
            const difficulties = ['easy', 'medium', 'hard'];
            let adjustedDifficulty = template.difficulty;
            
            if (difficultyAdjustment !== 0) {
                const currentIndex = difficulties.indexOf(template.difficulty);
                const newIndex = Math.max(0, Math.min(2, currentIndex + difficultyAdjustment));
                adjustedDifficulty = difficulties[newIndex];
            }
            
            const xpMultipliers = { easy: 0.8, medium: 1.0, hard: 1.4 };
            const priorityMultipliers = { low: 0.9, medium: 1.0, high: 1.2 };
            
            const adjustedXP = Math.round(
                template.baseXP * 
                xpMultipliers[adjustedDifficulty] * 
                priorityMultipliers[priority] * 
                energyMultiplier
            );
            
            let taskName = template.name;
            if (interest && taskName.includes('{interest}')) {
                taskName = taskName.replace('{interest}', interest);
            }
            
            return {
                id: Date.now() + Math.random(),
                name: taskName,
                category: template.category,
                xp: adjustedXP,
                completed: false,
                difficulty: adjustedDifficulty,
                aiGenerated: true,
                context: {
                    timeOfDay: context.timeOfDay,
                    energyLevel: context.energyLevel,
                    basedOnInterest: interest,
                    priority: priority,
                    confidence: gameState.ai.confidence
                }
            };
        }

        // üéµ SPOTIFY CONFIGURATION
        function saveSpotifyConfig() {
            const clientId = document.getElementById('spotifyClientId').value.trim();
            const redirectUri = document.getElementById('spotifyRedirectUri').value.trim();
            
            if (!clientId) {
                showFloatingNotification('‚ö†Ô∏è Missing Client ID', 'Please enter your Spotify client ID');
                return;
            }
            
            gameState.settings.spotifyClientId = clientId;
            gameState.settings.spotifyRedirectUri = redirectUri || '';
            
            saveGameState();
            
            // Update the display of current redirect URI
            updateRedirectUriDisplay();
            
            const message = redirectUri 
                ? 'Client ID and custom redirect URI saved!' 
                : 'Client ID saved with auto-detected redirect URI!';
            
            showFloatingNotification('üíæ Spotify Config Saved', message);
        }
        
        function updateRedirectUriDisplay() {
            const currentRedirectElement = document.getElementById('currentRedirectUri');
            if (currentRedirectElement) {
                const autoDetected = window.location.origin + window.location.pathname;
                currentRedirectElement.textContent = autoDetected;
            }
        }

        // üë§ USER PROFILE & HEALTH METRICS SYSTEM
        function initializeProfileUI() {
            populateEquipmentOptions();
            populateHealthConditions();
            loadUserProfile();
            updateHealthMetricsUI();
            updateDailyTargetsUI();
        }

        function populateEquipmentOptions() {
            const equipmentContainer = document.getElementById('equipmentSelection');
            if (!equipmentContainer) return;
            
            const equipment = [
                'dumbbells', 'barbells', 'resistance_bands', 'kettlebells', 
                'yoga_mat', 'pull_up_bar', 'treadmill', 'stationary_bike',
                'rowing_machine', 'weight_plates', 'medicine_ball', 'foam_roller'
            ];
            
            equipmentContainer.innerHTML = equipment.map(item => `
                <label class="flex items-center space-x-2 text-sm cursor-pointer">
                    <input type="checkbox" value="${item}" onchange="updateEquipmentSelection()" 
                           class="rounded border-gray-300 text-primary focus:ring-primary">
                    <span class="capitalize">${item.replace('_', ' ')}</span>
                </label>
            `).join('');
        }

        function populateHealthConditions() {
            const conditionsContainer = document.getElementById('healthConditions');
            if (!conditionsContainer) return;
            
            const conditions = [
                'diabetes', 'hypertension', 'heart_condition', 'joint_issues',
                'back_problems', 'asthma', 'arthritis', 'osteoporosis'
            ];
            
            conditionsContainer.innerHTML = conditions.map(condition => `
                <label class="flex items-center space-x-2 text-sm cursor-pointer">
                    <input type="checkbox" value="${condition}" onchange="updateHealthConditions()" 
                           class="rounded border-gray-300 text-primary focus:ring-primary">
                    <span class="capitalize">${condition.replace('_', ' ')}</span>
                </label>
            `).join('');
        }

        function updateEquipmentSelection() {
            const checkboxes = document.querySelectorAll('#equipmentSelection input[type="checkbox"]:checked');
            gameState.profile.equipment = Array.from(checkboxes).map(cb => cb.value);
        }

        function updateHealthConditions() {
            const checkboxes = document.querySelectorAll('#healthConditions input[type="checkbox"]:checked');
            gameState.profile.healthConditions = Array.from(checkboxes).map(cb => cb.value);
        }

        function saveUserProfile() {
            // Get profile data
            gameState.profile.height = parseFloat(document.getElementById('userHeight').value) || 0;
            gameState.profile.weight = parseFloat(document.getElementById('userWeight').value) || 0;
            gameState.profile.age = parseInt(document.getElementById('userAge').value) || 0;
            gameState.profile.gender = document.getElementById('userGender').value;
            gameState.profile.activityLevel = document.getElementById('activityLevel').value;
            gameState.profile.fitnessGoal = document.getElementById('fitnessGoal').value;
            
            // Validate required fields
            if (!gameState.profile.height || !gameState.profile.weight || !gameState.profile.age || !gameState.profile.gender) {
                showFloatingNotification('‚ö†Ô∏è Incomplete Profile', 'Please fill in height, weight, age, and gender');
                return;
            }
            
            // Calculate health metrics
            calculateHealthMetrics();
            
            // Update AI with profile data
            updateAIWithProfileData();
            
            // Save to storage
            saveGameState();
            
            // Update UI
            updateHealthMetricsUI();
            updateDailyTargetsUI();
            updateStatsUIWithTargets();
            
            showFloatingNotification('‚úÖ Profile Saved', 'Health metrics calculated and AI updated with your data');
        }

        function calculateHealthMetrics() {
            const { height, weight, age, gender, activityLevel, fitnessGoal } = gameState.profile;
            
            // BMI Calculation
            const heightInMeters = height / 100;
            gameState.healthMetrics.bmi = weight / (heightInMeters * heightInMeters);
            
            // BMR Calculation (Mifflin-St Jeor Equation)
            if (gender === 'male') {
                gameState.healthMetrics.bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                gameState.healthMetrics.bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }
            
            // TDEE Calculation (Total Daily Energy Expenditure)
            const activityMultipliers = {
                sedentary: 1.2,
                light: 1.375,
                moderate: 1.55,
                active: 1.725,
                very_active: 1.9
            };
            gameState.healthMetrics.tdee = gameState.healthMetrics.bmr * (activityMultipliers[activityLevel] || 1.2);
            
            // Ideal Weight Range (BMI 18.5-24.9)
            const minIdealWeight = 18.5 * (heightInMeters * heightInMeters);
            const maxIdealWeight = 24.9 * (heightInMeters * heightInMeters);
            gameState.healthMetrics.idealWeight = { min: minIdealWeight, max: maxIdealWeight };
            
            // Daily calorie target based on fitness goal
            const goalAdjustments = {
                lose_weight: -500,
                maintain_weight: 0,
                gain_weight: 300,
                build_muscle: 200,
                improve_fitness: -200,
                general_health: 0
            };
            gameState.healthMetrics.dailyCalorieTarget = Math.round(
                gameState.healthMetrics.tdee + (goalAdjustments[fitnessGoal] || 0)
            );
            
            // Water requirement (ml/day)
            gameState.healthMetrics.waterRequirement = Math.round(weight * 35); // 35ml per kg
            
            // Protein requirement (g/day)
            const proteinMultipliers = {
                lose_weight: 2.2,
                maintain_weight: 1.6,
                gain_weight: 1.8,
                build_muscle: 2.4,
                improve_fitness: 2.0,
                general_health: 1.2
            };
            gameState.healthMetrics.proteinRequirement = Math.round(
                weight * (proteinMultipliers[fitnessGoal] || 1.2)
            );
            
            // Daily steps target
            const baseSteps = age < 65 ? 10000 : 7000;
            const activityStepsMultiplier = {
                sedentary: 0.8,
                light: 1.0,
                moderate: 1.2,
                active: 1.4,
                very_active: 1.6
            };
            gameState.healthMetrics.dailyStepsTarget = Math.round(
                baseSteps * (activityStepsMultiplier[activityLevel] || 1.0)
            );
            
            // Weekly exercise minutes
            const weeklyMinutes = {
                sedentary: 75,
                light: 150,
                moderate: 225,
                active: 300,
                very_active: 375
            };
            gameState.healthMetrics.weeklyExerciseMinutes = weeklyMinutes[activityLevel] || 150;
            
            // Body fat percentage estimation (rough calculation)
            let bodyFatPercentage;
            if (gender === 'male') {
                bodyFatPercentage = (1.20 * gameState.healthMetrics.bmi) + (0.23 * age) - 16.2;
            } else {
                bodyFatPercentage = (1.20 * gameState.healthMetrics.bmi) + (0.23 * age) - 5.4;
            }
            gameState.healthMetrics.bodyFatPercentage = Math.max(5, Math.min(50, bodyFatPercentage));
            
            // Risk factors assessment
            assessHealthRisks();
        }

        function assessHealthRisks() {
            const risks = [];
            const { bmi, age } = { bmi: gameState.healthMetrics.bmi, age: gameState.profile.age };
            
            if (bmi < 18.5) risks.push('Underweight - consider gaining healthy weight');
            if (bmi > 25) risks.push('Overweight - consider weight management');
            if (bmi > 30) risks.push('Obesity - consult healthcare provider');
            if (age > 65) risks.push('Age-related considerations for exercise intensity');
            
            if (gameState.profile.healthConditions.includes('diabetes')) {
                risks.push('Diabetes - monitor blood sugar during exercise');
            }
            if (gameState.profile.healthConditions.includes('hypertension')) {
                risks.push('Hypertension - avoid high-intensity exercise without clearance');
            }
            if (gameState.profile.healthConditions.includes('heart_condition')) {
                risks.push('Heart condition - consult cardiologist before intense exercise');
            }
            
            gameState.healthMetrics.riskFactors = risks;
        }

        function updateAIWithProfileData() {
            // Update AI patterns with profile-based insights
            gameState.patterns.profile = {
                fitnessLevel: calculateFitnessLevel(),
                metabolicRate: gameState.healthMetrics.bmr / gameState.healthMetrics.tdee,
                goalAlignment: gameState.profile.fitnessGoal,
                equipmentAvailable: gameState.profile.equipment.length,
                healthConsiderations: gameState.profile.healthConditions.length
            };
            
            // Adjust AI confidence based on data completeness
            const dataCompleteness = calculateProfileCompleteness();
            gameState.ai.confidence = Math.min(1.0, gameState.ai.confidence + (dataCompleteness * 0.1));
        }

        function calculateFitnessLevel() {
            const { activityLevel, age, bmi } = { 
                activityLevel: gameState.profile.activityLevel, 
                age: gameState.profile.age, 
                bmi: gameState.healthMetrics.bmi 
            };
            
            let fitnessScore = 50; // Base score
            
            // Activity level adjustments
            const activityScores = {
                sedentary: -20,
                light: -10,
                moderate: 0,
                active: 15,
                very_active: 25
            };
            fitnessScore += activityScores[activityLevel] || 0;
            
            // Age adjustments
            if (age < 30) fitnessScore += 10;
            else if (age > 50) fitnessScore -= 10;
            else if (age > 65) fitnessScore -= 20;
            
            // BMI adjustments
            if (bmi >= 18.5 && bmi <= 24.9) fitnessScore += 10;
            else if (bmi > 30) fitnessScore -= 15;
            
            return Math.max(0, Math.min(100, fitnessScore));
        }

        function calculateProfileCompleteness() {
            const required = ['height', 'weight', 'age', 'gender', 'activityLevel', 'fitnessGoal'];
            const completed = required.filter(field => gameState.profile[field]).length;
            const equipmentBonus = gameState.profile.equipment.length > 0 ? 0.1 : 0;
            return (completed / required.length) + equipmentBonus;
        }

        function updateHealthMetricsUI() {
            const container = document.getElementById('healthMetrics');
            if (!container) return;
            
            const metrics = gameState.healthMetrics;
            
            if (metrics.bmi === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <div class="text-4xl mb-2">üë§</div>
                        <p>Complete your profile to see personalized health metrics</p>
                    </div>
                `;
                return;
            }
            
            const bmiCategory = getBMICategory(metrics.bmi);
            const bmiColor = getBMIColor(bmiCategory);
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 ${bmiColor} rounded-lg">
                        <h4 class="font-bold mb-2">üìä Body Mass Index</h4>
                        <div class="text-2xl font-bold">${metrics.bmi.toFixed(1)}</div>
                        <div class="text-sm">${bmiCategory}</div>
                    </div>
                    
                    <div class="p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                        <h4 class="font-bold mb-2 text-blue-700 dark:text-blue-300">üî• Metabolic Rate</h4>
                        <div class="text-2xl font-bold text-blue-600">${Math.round(metrics.bmr)}</div>
                        <div class="text-sm text-blue-500">BMR (calories/day)</div>
                        <div class="text-xs mt-1">TDEE: ${Math.round(metrics.tdee)} cal/day</div>
                    </div>
                    
                    <div class="p-4 bg-green-50 dark:bg-green-900/30 rounded-lg">
                        <h4 class="font-bold mb-2 text-green-700 dark:text-green-300">üéØ Ideal Weight Range</h4>
                        <div class="text-lg font-bold text-green-600">
                            ${metrics.idealWeight.min.toFixed(1)} - ${metrics.idealWeight.max.toFixed(1)} kg
                        </div>
                        <div class="text-sm text-green-500">Based on healthy BMI range</div>
                    </div>
                    
                    <div class="p-4 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                        <h4 class="font-bold mb-2 text-purple-700 dark:text-purple-300">üí™ Body Composition</h4>
                        <div class="text-2xl font-bold text-purple-600">${metrics.bodyFatPercentage.toFixed(1)}%</div>
                        <div class="text-sm text-purple-500">Estimated body fat</div>
                    </div>
                </div>
                
                ${metrics.riskFactors.length > 0 ? `
                    <div class="mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg">
                        <h4 class="font-bold mb-2 text-yellow-700 dark:text-yellow-300">‚ö†Ô∏è Health Considerations</h4>
                        <div class="text-sm text-yellow-600 dark:text-yellow-400 space-y-1">
                            ${metrics.riskFactors.map(risk => `<div>‚Ä¢ ${risk}</div>`).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function getBMICategory(bmi) {
            if (bmi < 18.5) return 'Underweight';
            if (bmi < 25) return 'Normal weight';
            if (bmi < 30) return 'Overweight';
            return 'Obese';
        }

        function getBMIColor(category) {
            const colors = {
                'Underweight': 'bg-blue-50 dark:bg-blue-900/30',
                'Normal weight': 'bg-green-50 dark:bg-green-900/30',
                'Overweight': 'bg-yellow-50 dark:bg-yellow-900/30',
                'Obese': 'bg-red-50 dark:bg-red-900/30'
            };
            return colors[category] || 'bg-gray-50 dark:bg-gray-700';
        }

        function updateDailyTargetsUI() {
            const container = document.getElementById('dailyTargets');
            if (!container) return;
            
            const metrics = gameState.healthMetrics;
            
            if (metrics.dailyCalorieTarget === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <div class="text-4xl mb-2">üéØ</div>
                        <p>Set up your profile to get personalized daily targets</p>
                    </div>
                `;
                return;
            }
            
            const waterGlasses = Math.ceil(metrics.waterRequirement / 250); // 250ml per glass
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/30 rounded-lg">
                        <div>
                            <div class="font-medium text-red-700 dark:text-red-300">üçΩÔ∏è Daily Calories</div>
                            <div class="text-sm text-red-600 dark:text-red-400">Based on ${gameState.profile.fitnessGoal.replace('_', ' ')}</div>
                        </div>
                        <div class="text-xl font-bold text-red-600">${metrics.dailyCalorieTarget}</div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                        <div>
                            <div class="font-medium text-blue-700 dark:text-blue-300">üíß Water Intake</div>
                            <div class="text-sm text-blue-600 dark:text-blue-400">${metrics.waterRequirement}ml total</div>
                        </div>
                        <div class="text-xl font-bold text-blue-600">${waterGlasses} glasses</div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                        <div>
                            <div class="font-medium text-green-700 dark:text-green-300">ü•© Protein Goal</div>
                            <div class="text-sm text-green-600 dark:text-green-400">For ${gameState.profile.fitnessGoal.replace('_', ' ')}</div>
                        </div>
                        <div class="text-xl font-bold text-green-600">${metrics.proteinRequirement}g</div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg">
                        <div>
                            <div class="font-medium text-orange-700 dark:text-orange-300">üëü Daily Steps</div>
                            <div class="text-sm text-orange-600 dark:text-orange-400">Activity level: ${gameState.profile.activityLevel}</div>
                        </div>
                        <div class="text-xl font-bold text-orange-600">${metrics.dailyStepsTarget.toLocaleString()}</div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                        <div>
                            <div class="font-medium text-purple-700 dark:text-purple-300">‚è±Ô∏è Weekly Exercise</div>
                            <div class="text-sm text-purple-600 dark:text-purple-400">${Math.round(metrics.weeklyExerciseMinutes/7)} min/day average</div>
                        </div>
                        <div class="text-xl font-bold text-purple-600">${metrics.weeklyExerciseMinutes} min</div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-700 dark:text-gray-300">üèãÔ∏è Equipment Available</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">${gameState.profile.equipment.length} items</div>
                        </div>
                        <div class="text-xl font-bold text-gray-600 dark:text-gray-400">${gameState.profile.equipment.length > 0 ? '‚úÖ' : '‚ùå'}</div>
                    </div>
                </div>
            `;
        }

        function updateStatsUIWithTargets() {
            // Update goal displays with personalized targets
            const metrics = gameState.healthMetrics;
            
            if (metrics.dailyCalorieTarget > 0) {
                const calorieGoal = document.querySelector('#caloriesCount + .text-xs');
                if (calorieGoal) {
                    calorieGoal.textContent = `Goal: ${metrics.dailyCalorieTarget}`;
                    calorieGoal.classList.remove('text-nutrition');
                    calorieGoal.classList.add('text-red-600');
                }
                
                const waterGoal = document.querySelector('#waterCount + .text-xs');
                if (waterGoal) {
                    const waterGlasses = Math.ceil(metrics.waterRequirement / 250);
                    waterGoal.textContent = `Goal: ${waterGlasses} glasses`;
                }
            }
        }

        function loadUserProfile() {
            if (!gameState.profile.height) return;
            
            // Load profile data into form
            document.getElementById('userHeight').value = gameState.profile.height || '';
            document.getElementById('userWeight').value = gameState.profile.weight || '';
            document.getElementById('userAge').value = gameState.profile.age || '';
            document.getElementById('userGender').value = gameState.profile.gender || '';
            document.getElementById('activityLevel').value = gameState.profile.activityLevel || '';
            document.getElementById('fitnessGoal').value = gameState.profile.fitnessGoal || '';
            
            // Load equipment selections
            gameState.profile.equipment.forEach(equipment => {
                const checkbox = document.querySelector(`#equipmentSelection input[value="${equipment}"]`);
                if (checkbox) checkbox.checked = true;
            });
            
            // Load health conditions
            gameState.profile.healthConditions.forEach(condition => {
                const checkbox = document.querySelector(`#healthConditions input[value="${condition}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }

        // Update settings display on page load
        function loadSettings() {
            document.getElementById('notificationsToggle').checked = gameState.settings.notifications;
            document.getElementById('animationsToggle').checked = gameState.settings.animations;
            document.getElementById('soundToggle').checked = gameState.settings.soundEffects;
            document.getElementById('aiLearningToggle').checked = gameState.settings.aiLearning;
            
            if (gameState.settings.spotifyClientId) {
                document.getElementById('spotifyClientId').value = gameState.settings.spotifyClientId;
            }
            
            if (gameState.settings.spotifyRedirectUri) {
                document.getElementById('spotifyRedirectUri').value = gameState.settings.spotifyRedirectUri;
            }
            
            // Update redirect URI display
            updateRedirectUriDisplay();
            
            if (gameState.ai.sensitivity) {
                document.getElementById('aiSensitivity').value = gameState.ai.sensitivity;
                document.getElementById('sensitivityValue').textContent = `${Math.round(gameState.ai.sensitivity * 100)}%`;
            }
            
            // Initialize profile UI
            initializeProfileUI();
            
            updateInterestsUI();
            updateDataCounts();
            document.getElementById('lastUpdateTime').textContent = 'Just now';
        }

        // üéÆ INITIALIZE APPLICATION
        document.addEventListener('DOMContentLoaded', () => {
            // Check for Spotify OAuth callback
            handleSpotifyCallback();
            
            // Try to restore existing Spotify tokens
            restoreSpotifyTokens();
            
            initializeApp();
            
            // Load settings after initialization
            setTimeout(() => {
                loadSettings();
            }, 1000);
        });

        function restoreSpotifyTokens() {
            try {
                const savedAccessToken = localStorage.getItem('spotify_access_token');
                const savedRefreshToken = localStorage.getItem('spotify_refresh_token');
                const savedTokenExpiry = localStorage.getItem('spotify_token_expiry');
                
                if (savedAccessToken && savedRefreshToken && savedTokenExpiry) {
                    spotifyAccessToken = savedAccessToken;
                    refreshToken = savedRefreshToken;
                    tokenExpiryTime = parseInt(savedTokenExpiry);
                    
                    // Check if token is still valid
                    if (Date.now() < tokenExpiryTime) {
                        // Initialize player with existing token
                        setTimeout(() => {
                            initializeSpotifyPlayer();
                            updateSpotifyStatus('Connected');
                            showFloatingNotification('üéµ Spotify Restored', 'Welcome back! Your Spotify session has been restored');
                        }, 2000);
                    } else {
                        // Token expired, try to refresh
                        refreshSpotifyToken().then(() => {
                            setTimeout(() => {
                                initializeSpotifyPlayer();
                                updateSpotifyStatus('Connected');
                                showFloatingNotification('üéµ Spotify Restored', 'Session refreshed automatically');
                            }, 2000);
                        }).catch((error) => {
                            console.log('Token refresh failed:', error);
                            // Clear invalid tokens
                            localStorage.removeItem('spotify_access_token');
                            localStorage.removeItem('spotify_refresh_token');
                            localStorage.removeItem('spotify_token_expiry');
                        });
                    }
                }
            } catch (error) {
                console.error('Error restoring Spotify tokens:', error);
            }
        }
    </script>
</body>
</html>
