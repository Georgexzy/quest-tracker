<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Life Quest RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        fitness: '#ef4444',
                        nutrition: '#16a34a',
                        hydration: '#3b82f6',
                        wellness: '#a855f7',
                        focus: '#f59e0b',
                        personal: '#6366f1'
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .floating-notification {
            animation: slideInRight 0.5s ease-out, slideOutRight 0.5s ease-in 2.5s forwards;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .xp-burst {
            animation: xpBurst 2s ease-out forwards;
        }
        @keyframes xpBurst {
            0% { transform: scale(1) translateY(0); opacity: 1; }
            50% { transform: scale(1.2) translateY(-20px); opacity: 1; }
            100% { transform: scale(1) translateY(-60px); opacity: 0; }
        }
        .level-up {
            animation: levelUp 1s ease-out;
        }
        @keyframes levelUp {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-bottom: 2px solid #ffffff;
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-300">
    
    <div class="min-h-screen">
        <!-- Header -->
        <header class="gradient-bg text-white p-4 shadow-lg">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold">üèÜ Life Quest RPG</h1>
                        <span class="text-sm opacity-90">Ultimate AI Edition</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="showStorageInfo()" class="glass-effect px-3 py-1 rounded-lg text-sm hover:bg-white/20">
                            üíæ Storage
                        </button>
                        <button onclick="showProfile()" class="glass-effect px-3 py-1 rounded-lg text-sm hover:bg-white/20">
                            ‚öôÔ∏è Profile
                        </button>
                        <div class="text-right">
                            <div id="playerLevel" class="font-bold">Level 1</div>
                            <div class="text-xs opacity-90">
                                <span id="currentXP">0</span>/<span id="nextLevelXP">100</span> XP
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- XP Progress Bar -->
                <div class="mt-3">
                    <div class="bg-white/20 rounded-full h-2">
                        <div id="xpProgress" class="bg-yellow-400 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="gradient-bg border-b border-white/20">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex space-x-6 overflow-x-auto">
                    <button onclick="switchTab('dashboard')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap active">
                        üìä Dashboard
                    </button>
                    <button onclick="switchTab('exercise')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üí™ Exercise
                    </button>
                    <button onclick="switchTab('nutrition')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        ü•ó Nutrition
                    </button>
                    <button onclick="switchTab('health')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üèÉ‚Äç‚ôÇÔ∏è Health
                    </button>
                    <button onclick="switchTab('ai')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üß† AI Coach
                    </button>
                    <button onclick="switchTab('tasks')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üìã Tasks
                    </button>
                    <button onclick="switchTab('music')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üéµ Music
                    </button>
                    <button onclick="switchTab('settings')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        ‚öôÔ∏è Settings
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-4">
            <!-- AI Insights (visible on all tabs) -->
            <div id="aiInsights" class="mb-6"></div>

            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <!-- Stats Grid -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border border-fitness/20">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-fitness">üèÉ‚Äç‚ôÇÔ∏è</span>
                            <span id="stepsCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Steps</div>
                        <div class="text-xs text-fitness">Goal: 8,000</div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border border-hydration/20">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-hydration">üíß</span>
                            <span id="waterCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Water</div>
                        <div class="text-xs text-hydration">Goal: 8 glasses</div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border border-nutrition/20">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-nutrition">ü•ó</span>
                            <span id="caloriesCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Calories</div>
                        <div class="text-xs text-nutrition">Target: 2000</div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border border-focus/20">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-focus">üß†</span>
                            <span id="focusCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Focus (min)</div>
                        <div class="text-xs text-focus">Goal: 120</div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border border-wellness/20">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-wellness">üò¥</span>
                            <span id="sleepCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Sleep (hrs)</div>
                        <div class="text-xs text-wellness">Goal: 8</div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border border-fitness/20">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-fitness">üí™</span>
                            <span id="workoutCount" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Workouts</div>
                        <div class="text-xs text-fitness">Goal: 1</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üìã Today's Quests</h3>
                        <div id="tasksList" class="space-y-2 max-h-64 overflow-y-auto mb-4">
                            <!-- Tasks will be populated here -->
                        </div>
                        <button onclick="addCustomTask()" class="w-full bg-personal text-white py-2 rounded hover:bg-indigo-600">
                            ‚ûï Add Custom Quest
                        </button>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üèÜ Recent Achievements</h3>
                        <div id="achievementsList" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Achievements will be populated here -->
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">‚ö° Quick Actions</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="trackWater()" class="bg-hydration text-white p-3 rounded-lg hover:bg-blue-600 text-sm">
                                üíß Water
                            </button>
                            <button onclick="logWorkout()" class="bg-fitness text-white p-3 rounded-lg hover:bg-red-600 text-sm">
                                üí™ Workout
                            </button>
                            <button onclick="logMeal()" class="bg-nutrition text-white p-3 rounded-lg hover:bg-green-600 text-sm">
                                ü•ó Meal
                            </button>
                            <button onclick="startPomodoro()" class="bg-focus text-white p-3 rounded-lg hover:bg-yellow-600 text-sm">
                                üçÖ Focus
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exercise Tab -->
            <div id="exercise-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <!-- Daily Steps Tracker -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4 text-orange-500">üö∂‚Äç‚ôÇÔ∏è Daily Steps</h3>
                            
                            <div class="mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <div class="text-3xl font-bold text-orange-500" id="exerciseSteps">0</div>
                                        <div class="text-sm text-gray-500">Today's Steps</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-gray-700 dark:text-gray-300" id="stepGoal">8,000</div>
                                        <div class="text-xs text-gray-500">Daily Goal</div>
                                    </div>
                                </div>
                                
                                <!-- Steps Progress Bar -->
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-3">
                                    <div id="stepsProgress" class="bg-orange-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                                
                                <div class="text-xs text-center text-gray-600 dark:text-gray-400" id="stepsStatus">
                                    Start walking to reach your goal!
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="quickLogSteps()" class="bg-orange-500 text-white py-3 px-4 rounded-lg hover:bg-orange-600 font-medium">
                                    üìù Log Steps
                                </button>
                                <button onclick="adjustStepGoal()" class="bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 font-medium">
                                    üéØ Set Goal
                                </button>
                            </div>
                            
                            <div class="mt-4 text-center">
                                <div class="text-xs text-purple-600 dark:text-purple-400" id="stepInsight">
                                    <!-- AI insight about steps will appear here -->
                                </div>
                            </div>
                        </div>

                        <!-- Today's Exercise Progress -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4 text-fitness">üí™ Today's Exercise</h3>
                            
                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-fitness" id="exerciseWorkouts">0</div>
                                    <div class="text-sm text-gray-500">Workouts</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-orange-500" id="exerciseCalories">0</div>
                                    <div class="text-sm text-gray-500">Calories</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-500" id="exerciseMinutes">0</div>
                                    <div class="text-sm text-gray-500">Minutes</div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <button onclick="quickStartWorkout('cardio')" class="w-full text-left px-4 py-3 bg-red-50 dark:bg-red-900/30 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/50 border border-red-200 dark:border-red-800">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <span class="text-2xl">üèÉ‚Äç‚ôÇÔ∏è</span>
                                            <div>
                                                <div class="font-medium">Cardio Blast</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">15-30 min high intensity</div>
                                            </div>
                                        </div>
                                        <div class="text-red-600 font-bold">START</div>
                                    </div>
                                </button>
                                
                                <button onclick="quickStartWorkout('strength')" class="w-full text-left px-4 py-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50 border border-blue-200 dark:border-blue-800">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <span class="text-2xl">üí™</span>
                                            <div>
                                                <div class="font-medium">Strength Training</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">20-45 min muscle building</div>
                                            </div>
                                        </div>
                                        <div class="text-blue-600 font-bold">START</div>
                                    </div>
                                </button>
                                
                                <button onclick="quickStartWorkout('yoga')" class="w-full text-left px-4 py-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/50 border border-purple-200 dark:border-purple-800">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <span class="text-2xl">üßò‚Äç‚ôÄÔ∏è</span>
                                            <div>
                                                <div class="font-medium">Yoga & Flexibility</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">15-30 min stretching</div>
                                            </div>
                                        </div>
                                        <div class="text-purple-600 font-bold">START</div>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Exercise Library -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üìö Exercise Library</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="showExerciseCategory('bodyweight')" class="bg-orange-500 text-white p-3 rounded-lg hover:bg-orange-600 text-sm">
                                    ü§∏‚Äç‚ôÇÔ∏è Bodyweight
                                </button>
                                <button onclick="showExerciseCategory('weights')" class="bg-gray-600 text-white p-3 rounded-lg hover:bg-gray-700 text-sm">
                                    üèãÔ∏è‚Äç‚ôÇÔ∏è Weights
                                </button>
                                <button onclick="showExerciseCategory('cardio')" class="bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 text-sm">
                                    üèÉ‚Äç‚ôÇÔ∏è Cardio
                                </button>
                                <button onclick="showExerciseCategory('flexibility')" class="bg-purple-500 text-white p-3 rounded-lg hover:bg-purple-600 text-sm">
                                    ü§∏‚Äç‚ôÄÔ∏è Flexibility
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Weekly Exercise Plan -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üìÖ Weekly Plan</h3>
                            <div id="weeklyExercisePlan" class="space-y-3">
                                <!-- Weekly plan will be populated here -->
                            </div>
                            <button onclick="generateWeeklyPlan()" class="w-full mt-4 bg-primary text-white py-2 rounded hover:bg-purple-600">
                                üîÑ Generate New Plan
                            </button>
                        </div>

                        <!-- Exercise Streaks & Goals -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üî• Streaks & Goals</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/30 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-xl">üî•</span>
                                        <div>
                                            <div class="font-medium">Workout Streak</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Current streak</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xl font-bold text-red-600" id="workoutStreak">0</div>
                                        <div class="text-xs text-red-500">days</div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-xl">üéØ</span>
                                        <div>
                                            <div class="font-medium">Weekly Goal</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Workouts this week</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xl font-bold text-blue-600" id="weeklyProgress">0/5</div>
                                        <div class="text-xs text-blue-500">goal</div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-xl">üí™</span>
                                        <div>
                                            <div class="font-medium">Total Minutes</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">This week</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xl font-bold text-green-600" id="totalMinutes">0</div>
                                        <div class="text-xs text-green-500">min</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nutrition Tab -->
            <div id="nutrition-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <!-- Daily Nutrition Tracker -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4 text-nutrition">ü•ó Daily Nutrition</h3>
                            
                            <div class="mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <div class="text-3xl font-bold text-nutrition" id="nutritionCalories">0</div>
                                        <div class="text-sm text-gray-500">Today's Calories</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-gray-700 dark:text-gray-300" id="calorieTarget">2000</div>
                                        <div class="text-xs text-gray-500">Daily Target</div>
                                    </div>
                                </div>
                                
                                <!-- Calories Progress Bar -->
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-3">
                                    <div id="caloriesProgress" class="bg-nutrition h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                                
                                <div class="text-xs text-center text-gray-600 dark:text-gray-400" id="caloriesStatus">
                                    Start tracking meals to reach your goal!
                                </div>
                            </div>
                            
                            <!-- Macro Breakdown -->
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                <div class="text-center p-3 bg-red-50 dark:bg-red-900/30 rounded-lg">
                                    <div class="text-xl font-bold text-red-600" id="proteinCount">0g</div>
                                    <div class="text-xs text-red-500">Protein</div>
                                    <div class="text-xs text-gray-500" id="proteinTarget">25%</div>
                                </div>
                                <div class="text-center p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg">
                                    <div class="text-xl font-bold text-yellow-600" id="carbsCount">0g</div>
                                    <div class="text-xs text-yellow-500">Carbs</div>
                                    <div class="text-xs text-gray-500" id="carbsTarget">50%</div>
                                </div>
                                <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                    <div class="text-xl font-bold text-blue-600" id="fatCount">0g</div>
                                    <div class="text-xs text-blue-500">Fat</div>
                                    <div class="text-xs text-gray-500" id="fatTarget">25%</div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="quickLogMeal()" class="bg-nutrition text-white py-3 px-4 rounded-lg hover:bg-green-600 font-medium">
                                    üìù Log Meal
                                </button>
                                <button onclick="adjustNutritionGoals()" class="bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 font-medium">
                                    üéØ Set Goals
                                </button>
                            </div>
                            
                            <div class="mt-4 text-center">
                                <div class="text-xs text-purple-600 dark:text-purple-400" id="nutritionInsight">
                                    <!-- AI insight about nutrition will appear here -->
                                </div>
                            </div>
                        </div>

                        <!-- Today's Meals Progress -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4 text-nutrition">üçΩÔ∏è Today's Meals</h3>
                            
                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-nutrition" id="mealsCount">0</div>
                                    <div class="text-sm text-gray-500">Meals</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-500" id="waterDaily">0</div>
                                    <div class="text-sm text-gray-500">Water</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-orange-500" id="snacksCount">0</div>
                                    <div class="text-sm text-gray-500">Snacks</div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <button onclick="quickAddMeal('breakfast')" class="w-full text-left px-4 py-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg hover:bg-yellow-100 dark:hover:bg-yellow-900/50 border border-yellow-200 dark:border-yellow-800">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <span class="text-2xl">üåÖ</span>
                                            <div>
                                                <div class="font-medium">Breakfast</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">Start your day right</div>
                                            </div>
                                        </div>
                                        <div class="text-yellow-600 font-bold">ADD</div>
                                    </div>
                                </button>
                                
                                <button onclick="quickAddMeal('lunch')" class="w-full text-left px-4 py-3 bg-green-50 dark:bg-green-900/30 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/50 border border-green-200 dark:border-green-800">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <span class="text-2xl">ü•ô</span>
                                            <div>
                                                <div class="font-medium">Lunch</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">Midday fuel</div>
                                            </div>
                                        </div>
                                        <div class="text-green-600 font-bold">ADD</div>
                                    </div>
                                </button>
                                
                                <button onclick="quickAddMeal('dinner')" class="w-full text-left px-4 py-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50 border border-blue-200 dark:border-blue-800">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <span class="text-2xl">üçΩÔ∏è</span>
                                            <div>
                                                <div class="font-medium">Dinner</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">Evening nourishment</div>
                                            </div>
                                        </div>
                                        <div class="text-blue-600 font-bold">ADD</div>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Food Library -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üìö Food Library</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="showFoodCategory('proteins')" class="bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 text-sm">
                                    üçñ Proteins
                                </button>
                                <button onclick="showFoodCategory('grains')" class="bg-yellow-600 text-white p-3 rounded-lg hover:bg-yellow-700 text-sm">
                                    üåæ Grains
                                </button>
                                <button onclick="showFoodCategory('vegetables')" class="bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 text-sm">
                                    ü•¨ Vegetables
                                </button>
                                <button onclick="showFoodCategory('fruits')" class="bg-orange-500 text-white p-3 rounded-lg hover:bg-orange-600 text-sm">
                                    üçé Fruits
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Weekly Meal Plan -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üìÖ Weekly Meal Plan</h3>
                            <div id="weeklyMealPlan" class="space-y-3">
                                <!-- Weekly meal plan will be populated here -->
                            </div>
                            <button onclick="generateWeeklyMealPlan()" class="w-full mt-4 bg-primary text-white py-2 rounded hover:bg-purple-600">
                                üîÑ Generate AI Meal Plan
                            </button>
                        </div>

                        <!-- Nutrition Streaks & Goals -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üî• Nutrition Tracking</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-xl">üî•</span>
                                        <div>
                                            <div class="font-medium">Meal Streak</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Daily tracking</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xl font-bold text-green-600" id="mealStreak">0</div>
                                        <div class="text-xs text-green-500">days</div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-xl">üíß</span>
                                        <div>
                                            <div class="font-medium">Hydration Goal</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Glasses today</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xl font-bold text-blue-600" id="hydrationProgress">0/8</div>
                                        <div class="text-xs text-blue-500">goal</div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-xl">‚öñÔ∏è</span>
                                        <div>
                                            <div class="font-medium">Macro Balance</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Protein-Carbs-Fat</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xl font-bold text-purple-600" id="macroBalance">25-50-25</div>
                                        <div class="text-xs text-purple-500">ratio</div>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-xl">üìä</span>
                                        <div>
                                            <div class="font-medium">Weekly Average</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Daily calories</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xl font-bold text-orange-600" id="weeklyAverage">0</div>
                                        <div class="text-xs text-orange-500">cal/day</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health Tab -->
            <div id="health-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <!-- Apple Health Integration -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-3xl">üì±</span>
                                <div>
                                    <h3 class="text-xl font-bold">Apple Health</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Sync your health data automatically</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 gap-3">
                                <button onclick="showAppleHealthSetup()" class="w-full text-left px-4 py-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50">
                                    <div class="font-medium">‚öôÔ∏è Setup Auto-Sync</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Configure iOS shortcuts</div>
                                </button>
                                <button onclick="importHealthData()" class="w-full text-left px-4 py-3 bg-green-50 dark:bg-green-900/30 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/50">
                                    <div class="font-medium">üì• Import Data</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Manual import options</div>
                                </button>
                                <button onclick="showHealthStatus()" class="w-full text-left px-4 py-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                    <div class="font-medium">üìä Sync Status</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">View connection status</div>
                                </button>
                            </div>
                        </div>

                        <!-- Manual Logging -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üìù Manual Logging</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="logSteps()" class="bg-orange-500 text-white p-3 rounded-lg hover:bg-orange-600">
                                    üö∂‚Äç‚ôÇÔ∏è Steps
                                </button>
                                <button onclick="logWorkout()" class="bg-fitness text-white p-3 rounded-lg hover:bg-red-600">
                                    üí™ Workout
                                </button>
                                <button onclick="logSleep()" class="bg-wellness text-white p-3 rounded-lg hover:bg-purple-600">
                                    üò¥ Sleep
                                </button>
                                <button onclick="logMeal()" class="bg-nutrition text-white p-3 rounded-lg hover:bg-green-600">
                                    ü•ó Meal
                                </button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <!-- Health Progress -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üìä Health Progress</h3>
                            <div id="healthProgressContainer" class="space-y-4">
                                <!-- Health progress will be populated here -->
                            </div>
                            <button onclick="showHabitTracker()" class="w-full mt-4 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-2 rounded hover:bg-gray-200 dark:hover:bg-gray-600">
                                View Detailed Tracker
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Coach Tab -->
            <div id="ai-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-3xl">üß†</span>
                                <div>
                                    <h3 class="text-xl font-bold">AI Nutrition Coach</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Personalized meal recommendations</p>
                                </div>
                            </div>
                            <button onclick="generateAINutritionPlan()" class="w-full bg-nutrition text-white py-3 rounded-lg hover:bg-green-600">
                                üçΩÔ∏è Generate Nutrition Plan
                            </button>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-3xl">üí™</span>
                                <div>
                                    <h3 class="text-xl font-bold">AI Workout Coach</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Smart exercise recommendations</p>
                                </div>
                            </div>
                            <button onclick="generateAIWorkoutPlan()" class="w-full bg-fitness text-white py-3 rounded-lg hover:bg-red-600">
                                üèãÔ∏è‚Äç‚ôÇÔ∏è Generate Workout Plan
                            </button>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-3xl">üéØ</span>
                                <div>
                                    <h3 class="text-xl font-bold">AI Task Generator</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Context-aware task suggestions</p>
                                </div>
                            </div>
                            <button onclick="generateAdvancedAITasks()" class="w-full bg-personal text-white py-3 rounded-lg hover:bg-indigo-600">
                                ‚ú® Generate Smart Tasks
                            </button>
                        </div>
                    </div>

                    <div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg h-full">
                            <h3 class="text-xl font-bold mb-4">ü§ñ AI Insights</h3>
                            <div class="space-y-4">
                                <div class="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/30 dark:to-blue-900/30 p-4 rounded-lg">
                                    <h4 class="font-bold mb-2">How AI Coaching Works</h4>
                                    <ul class="text-sm space-y-2 text-gray-600 dark:text-gray-400">
                                        <li>‚Ä¢ Analyzes your current stats and patterns</li>
                                        <li>‚Ä¢ Considers your goals and preferences</li>
                                        <li>‚Ä¢ Adapts to time of day and energy levels</li>
                                        <li>‚Ä¢ Provides personalized recommendations</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 p-4 rounded-lg">
                                    <h4 class="font-bold mb-2">AI Features</h4>
                                    <ul class="text-sm space-y-2 text-gray-600 dark:text-gray-400">
                                        <li>‚Ä¢ Smart meal planning with macro tracking</li>
                                        <li>‚Ä¢ Adaptive workout routines</li>
                                        <li>‚Ä¢ Context-aware task generation</li>
                                        <li>‚Ä¢ Pattern recognition and insights</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div id="tasks-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold">üìã Today's Quests</h3>
                                <button onclick="generateDailyTasks()" class="text-primary hover:text-purple-600 text-sm">
                                    üîÑ Refresh
                                </button>
                            </div>
                            <div id="tasksListDetailed" class="space-y-2 max-h-96 overflow-y-auto mb-4">
                                <!-- Tasks will be populated here -->
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="addCustomTask()" class="flex-1 bg-personal text-white py-2 rounded hover:bg-indigo-600">
                                    ‚ûï Add Custom Quest
                                </button>
                                <button onclick="generateAdvancedAITasks()" class="flex-1 bg-purple-500 text-white py-2 rounded hover:bg-purple-600">
                                    üß† AI Tasks
                                </button>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üéØ Productivity Tools</h3>
                            <div class="grid grid-cols-1 gap-3">
                                <button onclick="startPomodoro()" class="w-full text-left px-4 py-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg hover:bg-orange-100 dark:hover:bg-orange-900/50">
                                    <div class="font-medium">üçÖ Pomodoro Timer</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">25-minute focus sessions</div>
                                </button>
                                <button onclick="showHabitTracker()" class="w-full text-left px-4 py-3 bg-green-50 dark:bg-green-900/30 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/50">
                                    <div class="font-medium">üìä Habit Tracker</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Track your daily habits</div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üèÜ Achievements</h3>
                            <div id="achievementsListDetailed" class="space-y-3 max-h-96 overflow-y-auto">
                                <!-- Achievements will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Music Tab -->
            <div id="music-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <!-- Spotify Connection -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-3xl">üéµ</span>
                                <div>
                                    <h3 class="text-xl font-bold">Spotify Integration</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm" id="spotifyStatus">
                                        Connect your Spotify account for AI music coaching
                                    </p>
                                </div>
                            </div>
                            
                            <div id="spotifyAuthSection" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Spotify Client ID</label>
                                    <input type="text" id="spotifyClientId" placeholder="Enter your Spotify app client ID..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    <div class="text-xs text-gray-500 mt-1">
                                        Get this from your <a href="https://developer.spotify.com/dashboard" target="_blank" class="text-blue-500 hover:underline">Spotify Developer Dashboard</a>
                                    </div>
                                </div>
                                
                                <button onclick="connectSpotify()" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-medium">
                                    üéµ Connect to Spotify
                                </button>
                            </div>
                            
                            <div id="spotifyConnectedSection" class="space-y-4" style="display: none;">
                                <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-green-600">‚úì</span>
                                        <span class="font-medium">Connected to Spotify</span>
                                    </div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400" id="spotifyUserInfo"></div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="refreshSpotifyData()" class="bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                                        üîÑ Refresh Data
                                    </button>
                                    <button onclick="disconnectSpotify()" class="bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                                        üö´ Disconnect
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Music Player -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üéµ Music Player</h3>
                            
                            <div id="currentTrack" class="mb-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="flex items-center space-x-4">
                                    <div class="w-16 h-16 bg-gray-300 dark:bg-gray-600 rounded-lg flex items-center justify-center" id="albumArt">
                                        üéµ
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-bold" id="trackName">No track playing</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400" id="artistName">Connect Spotify to see current track</div>
                                    </div>
                                </div>
                                
                                <!-- Progress Bar -->
                                <div class="mt-4">
                                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                                        <span id="currentTime">0:00</span>
                                        <span id="totalTime">0:00</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1">
                                        <div id="progressBar" class="bg-green-500 h-full rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Player Controls -->
                            <div class="flex justify-center items-center space-x-4">
                                <button onclick="previousTrack()" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
                                    ‚èÆÔ∏è
                                </button>
                                <button onclick="togglePlayPause()" class="p-4 bg-green-500 text-white rounded-full hover:bg-green-600" id="playPauseButton">
                                    ‚ñ∂Ô∏è
                                </button>
                                <button onclick="nextTrack()" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
                                    ‚è≠Ô∏è
                                </button>
                            </div>
                            
                            <div class="text-center mt-4 space-y-2">
                                <div class="text-xs text-gray-500">Connect Spotify for full playback control</div>
                                <button onclick="transferToWebPlayer()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 text-sm" id="transferButton" style="display: none;">
                                    üì±‚û°Ô∏èüíª Transfer to Web Player
                                </button>
                                <div class="text-xs text-blue-600" id="webPlayerStatus" style="display: none;">
                                    Web player ready - you can now control music here!
                                </div>
                            </div>
                        </div>

                        <!-- Workout Playlists -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üèÉ‚Äç‚ôÇÔ∏è Workout Playlists</h3>
                            
                            <div id="workoutPlaylists" class="space-y-3">
                                <!-- Playlists will be populated here -->
                            </div>
                            
                            <button onclick="generateWorkoutPlaylist()" class="w-full mt-4 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                                üéµ Generate AI Workout Playlist
                            </button>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- AI Music Coach -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üß† AI Music Coach</h3>
                            
                            <div id="musicCoachInsights" class="space-y-4 mb-6">
                                <div class="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg">
                                    <h4 class="font-bold mb-2 text-purple-700 dark:text-purple-300">üéØ Smart Recommendations</h4>
                                    <div class="text-sm text-purple-600 dark:text-purple-400" id="musicRecommendation">
                                        Connect Spotify to get personalized music recommendations for your activities!
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 gap-3">
                                <button onclick="getMusicForActivity('workout')" class="w-full text-left px-4 py-3 bg-red-50 dark:bg-red-900/30 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/50">
                                    <div class="font-medium">üèÉ‚Äç‚ôÇÔ∏è Workout Music</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">High-energy tracks for exercise</div>
                                </button>
                                <button onclick="getMusicForActivity('focus')" class="w-full text-left px-4 py-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg hover:bg-yellow-100 dark:hover:bg-yellow-900/50">
                                    <div class="font-medium">üß† Focus Music</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Concentration-enhancing sounds</div>
                                </button>
                                <button onclick="getMusicForActivity('relaxation')" class="w-full text-left px-4 py-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50">
                                    <div class="font-medium">üòå Relaxation Music</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Calming tracks for wellness</div>
                                </button>
                            </div>
                        </div>

                        <!-- Music Analytics -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üìä Your Music Profile</h3>
                            
                            <div id="musicAnalytics" class="space-y-4">
                                <div class="text-center text-gray-500 py-8">
                                    <div class="text-4xl mb-2">üéµ</div>
                                    <div>Connect Spotify to analyze your music preferences</div>
                                </div>
                            </div>
                        </div>

                        <!-- Music Achievements -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üèÜ Music Achievements</h3>
                            
                            <div id="musicAchievements" class="space-y-3">
                                <div class="text-center text-gray-500 py-8">
                                    Start listening to music during activities to unlock achievements!
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üë§ Profile</h3>
                            <button onclick="showProfile()" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-purple-600">
                                Edit Profile Settings
                            </button>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üîî Notifications</h3>
                            <button onclick="showNotificationSettings()" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600">
                                Manage Reminders
                            </button>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üíæ Data</h3>
                            <button onclick="showStorageInfo()" class="w-full bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Storage Information
                            </button>
                        </div>
                    </div>

                    <div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg h-full">
                            <h3 class="text-xl font-bold mb-4">üìä Statistics</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-blue-600" id="settingsLevel">1</div>
                                    <div class="text-sm text-blue-500">Current Level</div>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-green-600" id="settingsTotalXP">0</div>
                                    <div class="text-sm text-green-500">Total XP</div>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-purple-600" id="settingsAchievements">0</div>
                                    <div class="text-sm text-purple-500">Achievements</div>
                                </div>
                                <div class="bg-orange-50 dark:bg-orange-900/30 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-orange-600" id="settingsTasks">0</div>
                                    <div class="text-sm text-orange-500">Total Tasks</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Notifications Container -->
    <div id="notificationsContainer" class="fixed top-20 right-4 z-50 space-y-2"></div>

    <script>
        // üéÆ GAME STATE MANAGEMENT
        let gameState = {
            level: 1,
            xp: 0,
            totalXP: 0,
            dailyStats: {
                steps: 0,
                waterGlasses: 0,
                calories: 0,
                protein: 0,
                carbs: 0,
                fat: 0,
                meals: 0,
                focusMinutes: 0,
                sleepHours: 0,
                workouts: 0,
                caloriesBurned: 0,
                exerciseMinutes: 0
            },
            tasks: [],
            achievements: [],
            profile: {
                age: null,
                weight: null,
                height: null,
                activityLevel: 'moderate',
                fitnessGoal: 'maintain',
                bmr: null
            },
            streaks: {
                workout: 0,
                water: 0,
                sleep: 0
            },
            exercise: {
                weeklyPlan: [],
                preferences: {
                    favoriteTypes: ['cardio', 'strength'],
                    timePreference: 'morning',
                    difficulty: 'intermediate'
                },
                history: []
            },
            settings: {
                notifications: true,
                darkMode: 'auto',
                reminders: false,
                reminderTimes: {
                    water: ['09:00', '12:00', '15:00', '18:00'],
                    workout: ['07:00', '17:00'],
                    tasks: ['09:00', '14:00'],
                    sleep: ['22:00']
                }
            }
        };

        // üéØ INITIALIZATION
        function initializeApp() {
            // Apply dark mode based on system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });

            loadGameState();
            updateAllUI();
            generateDailyTasks();
            generateWeeklyExercisePlan();
            showAIInsights();
            
            // Auto-save every 30 seconds
            setInterval(saveGameState, 30000);
            
            console.log('üéÆ Life Quest RPG - Ultimate AI Edition Initialized!');
            
            // Check for health data on load
            checkForHealthData();
        }

        // üíæ STORAGE MANAGEMENT
        function saveGameState() {
            try {
                const serializedState = JSON.stringify(gameState);
                localStorage.setItem('lifeQuestRPG', serializedState);
                localStorage.setItem('lifeQuestRPG_lastSave', new Date().toISOString());
                console.log('‚úÖ Game state saved successfully');
            } catch (error) {
                console.error('‚ùå Failed to save game state:', error);
                showFloatingNotification('‚ö†Ô∏è Save Error', 'Unable to save progress');
            }
        }

        function loadGameState() {
            try {
                const savedState = localStorage.getItem('lifeQuestRPG');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    gameState = { ...gameState, ...parsedState };
                    console.log('‚úÖ Game state loaded successfully');
                    showFloatingNotification('üíæ Progress Loaded', 'Your data has been restored');
                } else {
                    console.log('üì± No saved data found, starting fresh');
                }
            } catch (error) {
                console.error('‚ùå Failed to load game state:', error);
                console.log('üÜï Using default game state');
            }
        }

        function showStorageInfo() {
            const stateSize = JSON.stringify(gameState).length;
            const approximateMemoryUsage = stateSize * 2;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üíæ Storage Information</h3>
                    
                    <div class="space-y-4">
                        <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">üìä Current Usage</h4>
                            <div class="text-sm space-y-1">
                                <div>Game State Size: <span class="font-mono">${(stateSize/1024).toFixed(2)} KB</span></div>
                                <div>Memory Usage: <span class="font-mono">${(approximateMemoryUsage/1024).toFixed(2)} KB</span></div>
                                <div>Tasks Count: <span class="font-mono">${gameState.tasks.length}</span></div>
                                <div>Achievements: <span class="font-mono">${gameState.achievements.length}</span></div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-2 text-blue-700 dark:text-blue-300">üí° Data Persistence</h4>
                            <div class="text-sm text-blue-600 dark:text-blue-400 space-y-1">
                                <p>‚Ä¢ All progress saved automatically</p>
                                <p>‚Ä¢ Data persists across browser sessions</p>
                                <p>‚Ä¢ No internet required for saving</p>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="exportData()" class="flex-1 bg-green-500 text-white py-2 rounded hover:bg-green-600">
                                üì§ Export
                            </button>
                            <button onclick="importData()" class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                                üì• Import
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function exportData() {
            const dataStr = JSON.stringify(gameState, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `lifequest-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showFloatingNotification('üì§ Data Exported', 'Backup file downloaded successfully');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            gameState = { ...gameState, ...importedData };
                            saveGameState();
                            updateAllUI();
                            showFloatingNotification('üì• Data Imported', 'Your backup has been restored');
                            document.querySelector('.fixed')?.remove();
                        } catch (error) {
                            showFloatingNotification('‚ùå Import Failed', 'Invalid backup file');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // üö∂‚Äç‚ôÇÔ∏è STEPS SYSTEM
        function quickLogSteps() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-orange-500">üö∂‚Äç‚ôÇÔ∏è Log Today's Steps</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Step Count</label>
                            <input type="number" id="quickStepsInput" placeholder="Enter your steps..." min="0" max="50000" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        
                        <!-- Quick buttons for common step counts -->
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setQuickSteps(5000)" class="bg-gray-100 dark:bg-gray-700 p-2 rounded text-sm hover:bg-gray-200 dark:hover:bg-gray-600">
                                5,000
                            </button>
                            <button onclick="setQuickSteps(8000)" class="bg-orange-100 dark:bg-orange-900/30 p-2 rounded text-sm hover:bg-orange-200 dark:hover:bg-orange-900/50">
                                8,000
                            </button>
                            <button onclick="setQuickSteps(10000)" class="bg-green-100 dark:bg-green-900/30 p-2 rounded text-sm hover:bg-green-200 dark:hover:bg-green-900/50">
                                10,000
                            </button>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="saveQuickSteps()" class="flex-1 bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600">
                                Log Steps
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function setQuickSteps(steps) {
            document.getElementById('quickStepsInput').value = steps;
        }

        function saveQuickSteps() {
            const steps = parseInt(document.getElementById('quickStepsInput').value) || 0;

            if (steps > 0) {
                gameState.dailyStats.steps = steps;
                updateStepsDisplay();
                updateAllUI();
                saveGameState();
                
                const xpAmount = Math.floor(steps / 100);
                awardXP(xpAmount, `${steps.toLocaleString()} steps logged! üö∂‚Äç‚ôÇÔ∏è`);

                // Check for step-based achievements
                checkStepAchievements(steps);

                document.querySelector('.fixed').remove();
                showFloatingNotification('üö∂‚Äç‚ôÇÔ∏è Steps Logged!', `${steps.toLocaleString()} steps added`);
                
                // Update step insight
                updateStepInsight(steps);
            } else {
                showFloatingNotification('‚ùå Invalid Input', 'Please enter a valid step count');
            }
        }

        function adjustStepGoal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üéØ Set Daily Step Goal</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Daily Step Goal</label>
                            <input type="number" id="stepGoalInput" value="${gameState.profile.stepGoal || 8000}" min="1000" max="30000" step="500" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        
                        <!-- Preset goals -->
                        <div class="space-y-2">
                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300">Popular Goals:</div>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="setStepGoal(5000)" class="bg-blue-100 dark:bg-blue-900/30 p-2 rounded text-sm hover:bg-blue-200 dark:hover:bg-blue-900/50">
                                    5,000 (Beginner)
                                </button>
                                <button onclick="setStepGoal(8000)" class="bg-orange-100 dark:bg-orange-900/30 p-2 rounded text-sm hover:bg-orange-200 dark:hover:bg-orange-900/50">
                                    8,000 (Moderate)
                                </button>
                                <button onclick="setStepGoal(10000)" class="bg-green-100 dark:bg-green-900/30 p-2 rounded text-sm hover:bg-green-200 dark:hover:bg-green-900/50">
                                    10,000 (Active)
                                </button>
                                <button onclick="setStepGoal(12000)" class="bg-purple-100 dark:bg-purple-900/30 p-2 rounded text-sm hover:bg-purple-200 dark:hover:bg-purple-900/50">
                                    12,000 (Athlete)
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="saveStepGoal()" class="flex-1 bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600">
                                Save Goal
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function setStepGoal(goal) {
            document.getElementById('stepGoalInput').value = goal;
        }

        function saveStepGoal() {
            const goal = parseInt(document.getElementById('stepGoalInput').value) || 8000;
            
            gameState.profile.stepGoal = goal;
            updateStepsDisplay();
            saveGameState();
            
            document.querySelector('.fixed').remove();
            showFloatingNotification('üéØ Goal Updated!', `Daily step goal set to ${goal.toLocaleString()}`);
            awardXP(10, 'Step goal customized!');
        }

        function updateStepsDisplay() {
            const steps = gameState.dailyStats.steps;
            const goal = gameState.profile.stepGoal || 8000;
            const progress = Math.min(100, (steps / goal) * 100);
            
            // Update steps counter
            const stepsElement = document.getElementById('exerciseSteps');
            if (stepsElement) stepsElement.textContent = steps.toLocaleString();
            
            // Update goal display
            const goalElement = document.getElementById('stepGoal');
            if (goalElement) goalElement.textContent = goal.toLocaleString();
            
            // Update progress bar
            const progressElement = document.getElementById('stepsProgress');
            if (progressElement) {
                progressElement.style.width = `${progress}%`;
                
                // Change color based on progress
                if (progress >= 100) {
                    progressElement.className = 'bg-green-500 h-full rounded-full transition-all duration-500';
                } else if (progress >= 75) {
                    progressElement.className = 'bg-orange-500 h-full rounded-full transition-all duration-500';
                } else if (progress >= 50) {
                    progressElement.className = 'bg-yellow-500 h-full rounded-full transition-all duration-500';
                } else {
                    progressElement.className = 'bg-gray-400 h-full rounded-full transition-all duration-500';
                }
            }
            
            // Update status text
            const statusElement = document.getElementById('stepsStatus');
            if (statusElement) {
                if (progress >= 100) {
                    statusElement.textContent = `üéâ Goal achieved! ${((steps - goal)).toLocaleString()} steps over goal!`;
                    statusElement.className = 'text-xs text-center text-green-600 dark:text-green-400';
                } else if (progress >= 75) {
                    const remaining = goal - steps;
                    statusElement.textContent = `üî• Almost there! Only ${remaining.toLocaleString()} steps to go!`;
                    statusElement.className = 'text-xs text-center text-orange-600 dark:text-orange-400';
                } else if (progress >= 50) {
                    const remaining = goal - steps;
                    statusElement.textContent = `üí™ Halfway there! ${remaining.toLocaleString()} steps remaining.`;
                    statusElement.className = 'text-xs text-center text-yellow-600 dark:text-yellow-400';
                } else if (steps > 0) {
                    const remaining = goal - steps;
                    statusElement.textContent = `üö∂‚Äç‚ôÇÔ∏è Good start! ${remaining.toLocaleString()} steps to reach your goal.`;
                    statusElement.className = 'text-xs text-center text-gray-600 dark:text-gray-400';
                } else {
                    statusElement.textContent = 'Start walking to reach your goal!';
                    statusElement.className = 'text-xs text-center text-gray-600 dark:text-gray-400';
                }
            }
        }

        function checkStepAchievements(steps) {
            const achievements = [];
            
            if (steps >= 5000 && !gameState.achievements.find(a => a.title.includes('5K Walker'))) {
                achievements.push(['üö∂‚Äç‚ôÇÔ∏è 5K Walker', 'Walked 5,000+ steps in a day!', 25]);
            }
            
            if (steps >= 8000 && !gameState.achievements.find(a => a.title.includes('Step Master'))) {
                achievements.push(['üéØ Step Master', 'Hit your 8,000 step daily goal!', 40]);
            }
            
            if (steps >= 10000 && !gameState.achievements.find(a => a.title.includes('10K Hero'))) {
                achievements.push(['üèÜ 10K Hero', 'Conquered the classic 10,000 steps!', 50]);
            }
            
            if (steps >= 15000 && !gameState.achievements.find(a => a.title.includes('Step Champion'))) {
                achievements.push(['üëë Step Champion', 'Amazing! 15,000+ steps in one day!', 75]);
            }
            
            if (steps >= 20000 && !gameState.achievements.find(a => a.title.includes('Walking Machine'))) {
                achievements.push(['ü§ñ Walking Machine', 'Incredible! 20,000+ steps!', 100]);
            }
            
            achievements.forEach(([title, desc, xp]) => {
                addAchievement(title, desc, xp);
            });
        }

        function updateStepInsight(steps) {
            const insightElement = document.getElementById('stepInsight');
            if (!insightElement) return;
            
            const goal = gameState.profile.stepGoal || 8000;
            const progress = (steps / goal) * 100;
            const hour = new Date().getHours();
            
            let insight = '';
            
            if (progress >= 100) {
                insight = 'üéâ Goal smashed! Consider increasing your daily target for even better health benefits.';
            } else if (progress >= 75) {
                insight = 'üî• You\'re crushing it today! A few more steps and you\'ll hit your goal!';
            } else if (progress >= 50) {
                insight = 'üí™ Solid progress! Try taking the stairs or a quick walk to boost your count.';
            } else if (hour > 18) {
                insight = 'üåÖ Tomorrow is a new day! Start early with a morning walk to build momentum.';
            } else if (hour > 12) {
                insight = '‚è∞ Afternoon energy dip? A quick walk can boost both steps and mood!';
            } else {
                insight = 'üåü Great time to get moving! Morning steps set the tone for an active day.';
            }
            
            insightElement.textContent = insight;
        }

        // üí™ EXERCISE SYSTEM
        function quickStartWorkout(type) {
            const workouts = {
                cardio: {
                    name: 'Cardio Blast',
                    exercises: [
                        { name: 'Jumping Jacks', duration: 30, rest: 10 },
                        { name: 'High Knees', duration: 30, rest: 10 },
                        { name: 'Burpees', duration: 30, rest: 15 },
                        { name: 'Mountain Climbers', duration: 30, rest: 10 }
                    ],
                    estimatedCalories: 150,
                    color: 'red'
                },
                strength: {
                    name: 'Strength Training',
                    exercises: [
                        { name: 'Push-ups', reps: 10, rest: 30 },
                        { name: 'Squats', reps: 15, rest: 30 },
                        { name: 'Lunges', reps: 12, rest: 30 },
                        { name: 'Plank Hold', duration: 30, rest: 30 }
                    ],
                    estimatedCalories: 120,
                    color: 'blue'
                },
                yoga: {
                    name: 'Yoga & Flexibility',
                    exercises: [
                        { name: 'Cat-Cow Pose', duration: 60, rest: 5 },
                        { name: 'Downward Dog', duration: 45, rest: 5 },
                        { name: 'Warrior Pose', duration: 30, rest: 5 },
                        { name: 'Child\'s Pose', duration: 45, rest: 5 }
                    ],
                    estimatedCalories: 80,
                    color: 'purple'
                }
            };
            
            const workout = workouts[type];
            if (workout) {
                startGuidedWorkout(workout);
            }
        }

        function startGuidedWorkout(workout) {
            let currentExercise = 0;
            let isResting = false;
            let timeRemaining = 0;
            let workoutTimer = null;
            let totalDuration = 0;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-center text-fitness">üí™ ${workout.name}</h3>
                    
                    <!-- Progress -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span>Exercise ${currentExercise + 1} of ${workout.exercises.length}</span>
                            <span id="workoutStatus">Get Ready!</span>
                        </div>
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div id="workoutProgress" class="bg-fitness h-full rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Current Exercise -->
                    <div class="text-center mb-6">
                        <div class="text-6xl font-bold mb-4" id="workoutTimer">3</div>
                        <div class="text-xl font-bold mb-2" id="exerciseName">Get Ready</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400" id="exerciseDetails"></div>
                    </div>
                    
                    <!-- Controls -->
                    <div class="flex space-x-3">
                        <button id="workoutPause" onclick="pauseWorkout()" class="flex-1 bg-yellow-500 text-white py-3 rounded-lg">
                            ‚è∏Ô∏è Pause
                        </button>
                        <button onclick="skipExercise()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg">
                            ‚è≠Ô∏è Skip
                        </button>
                        <button onclick="stopWorkout()" class="flex-1 bg-red-500 text-white py-3 rounded-lg">
                            ‚èπÔ∏è Stop
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Start countdown
            startCountdown();
            
            function startCountdown() {
                timeRemaining = 3;
                updateDisplay();
                
                workoutTimer = setInterval(() => {
                    timeRemaining--;
                    updateDisplay();
                    
                    if (timeRemaining <= 0) {
                        clearInterval(workoutTimer);
                        startExercise();
                    }
                }, 1000);
            }
            
            function startExercise() {
                if (currentExercise >= workout.exercises.length) {
                    completeWorkout();
                    return;
                }
                
                const exercise = workout.exercises[currentExercise];
                isResting = false;
                timeRemaining = exercise.duration || (exercise.reps ? 45 : 30);
                totalDuration += timeRemaining;
                
                document.getElementById('exerciseName').textContent = exercise.name;
                document.getElementById('exerciseDetails').textContent = exercise.reps ? 
                    `${exercise.reps} reps` : `${exercise.duration} seconds`;
                document.getElementById('workoutStatus').textContent = 'Exercise';
                
                workoutTimer = setInterval(() => {
                    timeRemaining--;
                    updateDisplay();
                    
                    if (timeRemaining <= 0) {
                        clearInterval(workoutTimer);
                        startRest();
                    }
                }, 1000);
            }
            
            function startRest() {
                const exercise = workout.exercises[currentExercise];
                isResting = true;
                timeRemaining = exercise.rest;
                
                document.getElementById('exerciseName').textContent = 'Rest';
                document.getElementById('exerciseDetails').textContent = 'Take a breather';
                document.getElementById('workoutStatus').textContent = 'Rest';
                
                workoutTimer = setInterval(() => {
                    timeRemaining--;
                    updateDisplay();
                    
                    if (timeRemaining <= 0) {
                        clearInterval(workoutTimer);
                        currentExercise++;
                        updateProgress();
                        startExercise();
                    }
                }, 1000);
            }
            
            function updateDisplay() {
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                document.getElementById('workoutTimer').textContent = 
                    minutes > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : seconds;
            }
            
            function updateProgress() {
                const progress = (currentExercise / workout.exercises.length) * 100;
                document.getElementById('workoutProgress').style.width = `${progress}%`;
            }
            
            function completeWorkout() {
                clearInterval(workoutTimer);
                
                // Update stats
                gameState.dailyStats.workouts++;
                gameState.dailyStats.caloriesBurned += workout.estimatedCalories;
                gameState.dailyStats.exerciseMinutes += Math.floor(totalDuration / 60);
                
                // Add to exercise history
                gameState.exercise.history.push({
                    name: workout.name,
                    date: new Date().toISOString(),
                    duration: Math.floor(totalDuration / 60),
                    calories: workout.estimatedCalories,
                    type: workout.name.toLowerCase().includes('cardio') ? 'cardio' : 
                          workout.name.toLowerCase().includes('strength') ? 'strength' : 'flexibility'
                });
                
                updateAllUI();
                saveGameState();
                awardXP(workout.estimatedCalories + 50, `${workout.name} completed! üí™`);
                
                // Show completion
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4 text-center">
                        <div class="text-6xl mb-4">üèÜ</div>
                        <h3 class="text-xl font-bold mb-2">Workout Complete!</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">${workout.name}</p>
                        
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4">
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <div class="text-2xl font-bold text-fitness">${Math.floor(totalDuration / 60)}</div>
                                    <div class="text-sm text-gray-500">Minutes</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-orange-500">${workout.estimatedCalories}</div>
                                    <div class="text-sm text-gray-500">Calories</div>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-fitness text-white py-3 rounded-lg">
                            Amazing Work! üöÄ
                        </button>
                    </div>
                `;
            }
            
            // Global functions for workout controls
            window.pauseWorkout = function() {
                clearInterval(workoutTimer);
                document.getElementById('workoutPause').textContent = '‚ñ∂Ô∏è Resume';
                document.getElementById('workoutPause').onclick = () => {
                    if (isResting) startRest(); else startExercise();
                    document.getElementById('workoutPause').textContent = '‚è∏Ô∏è Pause';
                    document.getElementById('workoutPause').onclick = pauseWorkout;
                };
            };
            
            window.skipExercise = function() {
                clearInterval(workoutTimer);
                currentExercise++;
                updateProgress();
                if (currentExercise >= workout.exercises.length) {
                    completeWorkout();
                } else {
                    startExercise();
                }
            };
            
            window.stopWorkout = function() {
                clearInterval(workoutTimer);
                modal.remove();
                showFloatingNotification('Workout Stopped', 'Every step counts! Keep moving forward!');
            };
        }

        function showExerciseCategory(category) {
            const exercises = {
                bodyweight: [
                    { name: 'Push-ups', muscle: 'Chest, Arms', difficulty: 'Beginner' },
                    { name: 'Squats', muscle: 'Legs, Glutes', difficulty: 'Beginner' },
                    { name: 'Burpees', muscle: 'Full Body', difficulty: 'Advanced' },
                    { name: 'Lunges', muscle: 'Legs', difficulty: 'Intermediate' },
                    { name: 'Plank', muscle: 'Core', difficulty: 'Beginner' },
                    { name: 'Jump Squats', muscle: 'Legs, Cardio', difficulty: 'Intermediate' }
                ],
                weights: [
                    { name: 'Dumbbell Rows', muscle: 'Back', difficulty: 'Intermediate' },
                    { name: 'Goblet Squats', muscle: 'Legs', difficulty: 'Beginner' },
                    { name: 'Overhead Press', muscle: 'Shoulders', difficulty: 'Intermediate' },
                    { name: 'Deadlifts', muscle: 'Full Body', difficulty: 'Advanced' },
                    { name: 'Bicep Curls', muscle: 'Arms', difficulty: 'Beginner' },
                    { name: 'Chest Press', muscle: 'Chest', difficulty: 'Intermediate' }
                ],
                cardio: [
                    { name: 'Jumping Jacks', muscle: 'Full Body', difficulty: 'Beginner' },
                    { name: 'High Knees', muscle: 'Legs, Core', difficulty: 'Beginner' },
                    { name: 'Mountain Climbers', muscle: 'Core, Arms', difficulty: 'Intermediate' },
                    { name: 'Sprint Intervals', muscle: 'Legs, Cardio', difficulty: 'Advanced' },
                    { name: 'Step-ups', muscle: 'Legs', difficulty: 'Beginner' },
                    { name: 'Box Jumps', muscle: 'Legs, Power', difficulty: 'Advanced' }
                ],
                flexibility: [
                    { name: 'Cat-Cow Stretch', muscle: 'Spine', difficulty: 'Beginner' },
                    { name: 'Hip Flexor Stretch', muscle: 'Hips', difficulty: 'Beginner' },
                    { name: 'Shoulder Rolls', muscle: 'Shoulders', difficulty: 'Beginner' },
                    { name: 'Hamstring Stretch', muscle: 'Legs', difficulty: 'Beginner' },
                    { name: 'Pigeon Pose', muscle: 'Hips', difficulty: 'Intermediate' },
                    { name: 'Spinal Twist', muscle: 'Spine', difficulty: 'Beginner' }
                ]
            };
            
            const categoryEmojis = {
                bodyweight: 'ü§∏‚Äç‚ôÇÔ∏è',
                weights: 'üèãÔ∏è‚Äç‚ôÇÔ∏è',
                cardio: 'üèÉ‚Äç‚ôÇÔ∏è',
                flexibility: 'ü§∏‚Äç‚ôÄÔ∏è'
            };
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center">${categoryEmojis[category]} ${category.charAt(0).toUpperCase() + category.slice(1)} Exercises</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${exercises[category].map(exercise => `
                            <div class="border rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700">
                                <div class="font-bold mb-2">${exercise.name}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                    Target: ${exercise.muscle}
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs px-2 py-1 rounded ${
                                        exercise.difficulty === 'Beginner' ? 'bg-green-100 text-green-800' :
                                        exercise.difficulty === 'Intermediate' ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800'
                                    }">${exercise.difficulty}</span>
                                    <button onclick="addExerciseToWorkout('${exercise.name}')" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                                        Add to Workout
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="flex justify-center mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function addExerciseToWorkout(exerciseName) {
            showFloatingNotification('üí™ Exercise Added!', `${exerciseName} added to your custom workout`);
            // In a full implementation, this would add to a custom workout builder
        }

        function generateWeeklyPlan() {
            const plans = [
                { day: 'Monday', workout: 'Full Body Strength', icon: 'üí™', duration: '30 min' },
                { day: 'Tuesday', workout: 'Cardio Blast', icon: 'üèÉ‚Äç‚ôÇÔ∏è', duration: '25 min' },
                { day: 'Wednesday', workout: 'Yoga & Flexibility', icon: 'üßò‚Äç‚ôÄÔ∏è', duration: '20 min' },
                { day: 'Thursday', workout: 'Upper Body Focus', icon: 'üí™', duration: '35 min' },
                { day: 'Friday', workout: 'HIIT Training', icon: 'üî•', duration: '20 min' },
                { day: 'Saturday', workout: 'Active Recovery', icon: 'üö∂‚Äç‚ôÇÔ∏è', duration: '15 min' },
                { day: 'Sunday', workout: 'Rest Day', icon: 'üò¥', duration: 'Rest' }
            ];
            
            gameState.exercise.weeklyPlan = plans;
            saveGameState();
            updateWeeklyPlan();
            showFloatingNotification('üìÖ Plan Generated!', 'Your weekly exercise plan is ready');
        }

        function generateWeeklyExercisePlan() {
            if (gameState.exercise.weeklyPlan.length === 0) {
                generateWeeklyPlan();
            } else {
                updateWeeklyPlan();
            }
        }

        function updateWeeklyPlan() {
            const container = document.getElementById('weeklyExercisePlan');
            if (!container) return;
            
            const today = new Date().getDay(); // 0 = Sunday, 1 = Monday, etc.
            const dayMap = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            container.innerHTML = gameState.exercise.weeklyPlan.map((plan, index) => {
                const isToday = dayMap[today] === plan.day;
                return `
                    <div class="flex items-center justify-between p-3 rounded-lg ${isToday ? 'bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800' : 'bg-gray-50 dark:bg-gray-700'}">
                        <div class="flex items-center space-x-3">
                            <span class="text-xl">${plan.icon}</span>
                            <div>
                                <div class="font-medium ${isToday ? 'text-blue-700 dark:text-blue-300' : ''}">${plan.day}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${plan.workout}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium">${plan.duration}</div>
                            ${isToday ? '<div class="text-xs text-blue-600">Today</div>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // üß† AI FEATURES - All original AI functions preserved
        function generateAINutritionPlan() {
            const profile = gameState.profile;
            const stats = gameState.dailyStats;
            const hour = new Date().getHours();
            
            const nutritionNeeds = calculateNutritionNeeds(profile);
            const mealPlan = generatePersonalizedMealPlan(nutritionNeeds, hour, stats);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center text-nutrition">üß† AI Nutrition Coach</h3>
                    
                    <!-- Personalized Needs -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">${nutritionNeeds.calories}</div>
                            <div class="text-sm text-blue-500">Daily Calories</div>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-red-600">${nutritionNeeds.protein}g</div>
                            <div class="text-sm text-red-500">Protein</div>
                        </div>
                        <div class="bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-600">${nutritionNeeds.carbs}g</div>
                            <div class="text-sm text-yellow-500">Carbs</div>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600">${nutritionNeeds.fat}g</div>
                            <div class="text-sm text-green-500">Fat</div>
                        </div>
                    </div>
                    
                    <!-- AI Meal Suggestions -->
                    <div class="mb-6">
                        <h4 class="font-bold mb-3">üçΩÔ∏è Smart Meal Suggestions</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${mealPlan.map(meal => `
                                <div class="border rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="font-bold">${meal.name}</div>
                                        <div class="text-sm bg-nutrition text-white px-2 py-1 rounded">${meal.calories} cal</div>
                                    </div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-3">${meal.description}</div>
                                    <div class="grid grid-cols-3 gap-2 text-xs">
                                        <div class="text-center">
                                            <div class="font-bold">${meal.protein}g</div>
                                            <div class="text-gray-500">Protein</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="font-bold">${meal.carbs}g</div>
                                            <div class="text-gray-500">Carbs</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="font-bold">${meal.fat}g</div>
                                            <div class="text-gray-500">Fat</div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="text-xs text-purple-600 dark:text-purple-400 mb-2">
                                            ${meal.aiReasoning}
                                        </div>
                                        <button onclick="adoptAIMeal('${meal.id}')" class="w-full bg-nutrition text-white py-2 rounded hover:bg-green-600 text-sm">
                                            Add to My Plan
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="flex justify-center">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function calculateNutritionNeeds(profile) {
            let bmr = profile.bmr || 1800;
            const activityMultipliers = {
                'sedentary': 1.2,
                'light': 1.375,
                'moderate': 1.55,
                'very': 1.725
            };
            
            const tdee = bmr * (activityMultipliers[profile.activityLevel] || 1.4);
            let calories = tdee;
            
            if (profile.fitnessGoal === 'lose_weight') calories = tdee - 500;
            else if (profile.fitnessGoal === 'gain_weight') calories = tdee + 300;
            else if (profile.fitnessGoal === 'build_muscle') calories = tdee + 200;
            
            let proteinPercent = 0.25;
            let fatPercent = 0.25;
            let carbsPercent = 0.50;
            
            if (profile.fitnessGoal === 'build_muscle') {
                proteinPercent = 0.30;
                fatPercent = 0.25;
                carbsPercent = 0.45;
            } else if (profile.fitnessGoal === 'lose_weight') {
                proteinPercent = 0.35;
                fatPercent = 0.30;
                carbsPercent = 0.35;
            }
            
            return {
                calories: Math.round(calories),
                protein: Math.round((calories * proteinPercent) / 4),
                carbs: Math.round((calories * carbsPercent) / 4),
                fat: Math.round((calories * fatPercent) / 9)
            };
        }
        
        function generatePersonalizedMealPlan(needs, hour, stats) {
            const mealDatabase = [
                {
                    id: 'protein_oats',
                    name: 'Protein Power Oats',
                    type: 'breakfast',
                    calories: 380,
                    protein: 25,
                    carbs: 45,
                    fat: 8,
                    description: 'Oatmeal with protein powder, berries, and almond butter',
                    aiReasoning: 'High protein start for sustained energy and muscle recovery'
                },
                {
                    id: 'quinoa_bowl',
                    name: 'Recovery Quinoa Bowl',
                    type: 'lunch',
                    calories: 450,
                    protein: 20,
                    carbs: 55,
                    fat: 15,
                    description: 'Quinoa with grilled chicken, vegetables, and tahini',
                    aiReasoning: 'Complete protein and complex carbs for afternoon energy'
                },
                {
                    id: 'lean_stir_fry',
                    name: 'Lean Muscle Stir-Fry',
                    type: 'dinner',
                    calories: 380,
                    protein: 30,
                    carbs: 35,
                    fat: 12,
                    description: 'Lean beef with vegetables and brown rice',
                    aiReasoning: 'High protein for overnight muscle repair and growth'
                }
            ];
            
            let recommendedMeals = [];
            
            if (hour < 11) {
                recommendedMeals.push(...mealDatabase.filter(m => m.type === 'breakfast'));
            }
            if (hour >= 11 && hour < 16) {
                recommendedMeals.push(...mealDatabase.filter(m => m.type === 'lunch'));
            }
            if (hour >= 16) {
                recommendedMeals.push(...mealDatabase.filter(m => m.type === 'dinner'));
            }
            
            return recommendedMeals.slice(0, 3);
        }
        
        function adoptAIMeal(mealId) {
            const mealPlans = generatePersonalizedMealPlan(calculateNutritionNeeds(gameState.profile), new Date().getHours(), gameState.dailyStats);
            const meal = mealPlans.find(m => m.id === mealId);
            
            if (meal) {
                gameState.dailyStats.calories += meal.calories;
                gameState.dailyStats.protein = (gameState.dailyStats.protein || 0) + meal.protein;
                gameState.dailyStats.carbs = (gameState.dailyStats.carbs || 0) + meal.carbs;
                gameState.dailyStats.fat = (gameState.dailyStats.fat || 0) + meal.fat;
                gameState.dailyStats.meals++;
                
                updateAllUI();
                saveGameState();
                awardXP(25, 'Following AI nutrition advice!');
                showFloatingNotification('üß† AI Meal Added!', `${meal.name} logged successfully`);
            }
        }

        function generateAIWorkoutPlan() {
            const profile = gameState.profile;
            const stats = gameState.dailyStats;
            const workoutPlan = generatePersonalizedWorkout(profile, stats);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center text-fitness">üß† AI Workout Coach</h3>
                    
                    <div class="space-y-4">
                        ${workoutPlan.map(workout => `
                            <div class="border rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="text-2xl">${workout.icon}</div>
                                        <div>
                                            <div class="font-bold">${workout.name}</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">${workout.duration} min ‚Ä¢ ${workout.difficulty}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold text-fitness">${workout.calories} cal</div>
                                        <div class="text-xs text-gray-500">Estimated burn</div>
                                    </div>
                                </div>
                                
                                <div class="text-sm text-purple-600 dark:text-purple-400 mb-3">
                                    üß† ${workout.aiReasoning}
                                </div>
                                
                                <button onclick="startAIWorkout('${workout.id}')" class="w-full bg-fitness text-white py-2 rounded-lg hover:bg-red-600">
                                    Start AI Workout
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="flex justify-center mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function generatePersonalizedWorkout(profile, stats) {
            return [
                {
                    id: 'hiit_beginner',
                    name: 'AI HIIT Starter',
                    icon: 'üî•',
                    duration: 15,
                    difficulty: 'Beginner',
                    calories: 150,
                    aiReasoning: 'Perfect for building cardiovascular base and introducing HIIT principles'
                },
                {
                    id: 'strength_functional',
                    name: 'AI Functional Strength',
                    icon: 'üí™',
                    duration: 25,
                    difficulty: 'Intermediate',
                    calories: 200,
                    aiReasoning: 'Builds real-world strength patterns for daily activities'
                }
            ];
        }
        
        function startAIWorkout(workoutId) {
            const workouts = generatePersonalizedWorkout(gameState.profile, gameState.dailyStats);
            const workout = workouts.find(w => w.id === workoutId);
            
            if (workout) {
                document.querySelector('.fixed').remove();
                showFloatingNotification('üß† AI Workout Started!', workout.name);
            }
        }

        function generateAdvancedAITasks() {
            const profile = gameState.profile;
            const stats = gameState.dailyStats;
            const hour = new Date().getHours();
            const dayOfWeek = new Date().getDay();
            
            const aiTasks = generateContextualTasks(profile, stats, hour, dayOfWeek);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center">üß† AI Task Generator</h3>
                    
                    <div class="space-y-4 mb-6">
                        ${aiTasks.map(task => `
                            <div class="border rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="text-2xl">${task.icon}</div>
                                        <div>
                                            <div class="font-bold">${task.text}</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400 capitalize">${task.category} ‚Ä¢ ${task.xp} XP</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-sm text-purple-600 dark:text-purple-400 mb-3">
                                    üß† ${task.aiReasoning}
                                </div>
                                
                                <button onclick="adoptAITask('${task.text}', '${task.category}', ${task.xp}, '${task.icon}')" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 text-sm">
                                    ‚úÖ Add to My Tasks
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="flex justify-center">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function generateContextualTasks(profile, stats, hour, dayOfWeek) {
            const tasks = [
                {
                    id: 'hydration_' + Date.now(),
                    text: 'Drink a glass of water',
                    category: 'hydration',
                    icon: 'üíß',
                    xp: 10,
                    aiReasoning: 'Hydration is fundamental to all body functions. A simple but powerful habit.'
                },
                {
                    id: 'movement_' + Date.now(),
                    text: 'Do 20 bodyweight squats',
                    category: 'fitness',
                    icon: 'üí™',
                    xp: 15,
                    aiReasoning: 'Quick movement breaks improve circulation and energy levels.'
                },
                {
                    id: 'mindfulness_' + Date.now(),
                    text: 'Take 10 deep breaths mindfully',
                    category: 'wellness',
                    icon: 'üßò‚Äç‚ôÇÔ∏è',
                    xp: 15,
                    aiReasoning: 'Mindful breathing reduces stress and increases present-moment awareness.'
                }
            ];
            
            return tasks;
        }
        
        function adoptAITask(text, category, xp, icon) {
            const task = {
                id: Date.now() + Math.random(),
                text: text,
                category: category,
                xp: xp,
                completed: false,
                icon: icon,
                aiGenerated: true,
                createdAt: new Date().toISOString()
            };
            
            gameState.tasks.push(task);
            updateTasksList();
            saveGameState();
            
            awardXP(10, 'Adopted AI task suggestion!');
            showFloatingNotification('üß† AI Task Added!', 'Smart choice! This task is optimized for your current state.');
            
            document.querySelector('.fixed')?.remove();
        }

        function generateSmartInsights() {
            const insights = [];
            const stats = gameState.dailyStats;
            
            if (stats.steps > 8000 && stats.focusMinutes > 60) {
                insights.push({
                    type: 'positive',
                    icon: 'üåü',
                    title: 'Peak Performance Day!',
                    message: 'Your combination of movement and focus is creating optimal productivity.',
                    action: 'Keep this balanced approach for sustained energy!'
                });
            }
            
            if (stats.waterGlasses < 4 && stats.focusMinutes < 30) {
                insights.push({
                    type: 'warning',
                    icon: '‚ö†Ô∏è',
                    title: 'Hydration & Focus Alert',
                    message: 'Low water intake may be affecting your concentration.',
                    action: 'Try drinking a glass of water before your next focus session.'
                });
            }
            
            return insights.length > 0 ? insights[0] : null;
        }

        function showAIInsights() {
            const insight = generateSmartInsights();
            const container = document.getElementById('aiInsights');
            
            if (insight) {
                const typeClasses = {
                    positive: 'bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800',
                    warning: 'bg-yellow-50 dark:bg-yellow-900/30 border-yellow-200 dark:border-yellow-800',
                    suggestion: 'bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800'
                };
                
                container.innerHTML = `
                    <div class="rounded-xl p-4 border ${typeClasses[insight.type]}">
                        <div class="flex items-start space-x-3">
                            <div class="text-2xl">${insight.icon}</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-900 dark:text-white mb-1">${insight.title}</h4>
                                <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">${insight.message}</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400 italic">${insight.action}</p>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">√ó</button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = '';
            }
        }

        // üìù TASK MANAGEMENT - All original functions preserved
        function generateDailyTasks() {
            const dailyTasks = [
                { text: "Drink 8 glasses of water", category: "hydration", xp: 40, icon: "üíß" },
                { text: "Take 8,000 steps", category: "fitness", xp: 50, icon: "üö∂‚Äç‚ôÇÔ∏è" },
                { text: "Eat 3 balanced meals", category: "nutrition", xp: 60, icon: "ü•ó" },
                { text: "Do a 30-minute workout", category: "fitness", xp: 100, icon: "üí™" },
                { text: "Focus work for 2+ hours", category: "personal", xp: 80, icon: "üß†" },
                { text: "Get 8 hours of sleep", category: "wellness", xp: 60, icon: "üò¥" }
            ];

            dailyTasks.forEach(task => {
                const exists = gameState.tasks.some(existingTask => existingTask.text === task.text);
                if (!exists) {
                    gameState.tasks.push({
                        id: Date.now() + Math.random(),
                        ...task,
                        completed: false,
                        createdAt: new Date().toISOString()
                    });
                }
            });

            updateTasksList();
            saveGameState();
        }

        function addCustomTask() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">‚ûï Add Custom Quest</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Quest Description</label>
                            <input type="text" id="taskText" placeholder="Enter your quest..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Category</label>
                                <select id="taskCategory" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    <option value="fitness">üèÉ‚Äç‚ôÇÔ∏è Fitness</option>
                                    <option value="nutrition">ü•ó Nutrition</option>
                                    <option value="wellness">üßò‚Äç‚ôÄÔ∏è Wellness</option>
                                    <option value="personal">üìö Personal</option>
                                    <option value="hydration">üíß Hydration</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">XP Reward</label>
                                <input type="number" id="taskXP" value="25" min="10" max="100" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="createCustomTask()" class="flex-1 bg-primary text-white py-3 rounded-lg hover:bg-purple-600">
                                Create Quest
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function createCustomTask() {
            const text = document.getElementById('taskText').value.trim();
            const category = document.getElementById('taskCategory').value;
            const xp = parseInt(document.getElementById('taskXP').value);

            if (!text) {
                showFloatingNotification('‚ùå Error', 'Please enter a quest description');
                return;
            }

            const categoryIcons = {
                fitness: 'üèÉ‚Äç‚ôÇÔ∏è',
                nutrition: 'ü•ó',
                wellness: 'üßò‚Äç‚ôÄÔ∏è',
                personal: 'üìö',
                hydration: 'üíß'
            };

            const task = {
                id: Date.now() + Math.random(),
                text: text,
                category: category,
                xp: xp,
                icon: categoryIcons[category],
                completed: false,
                createdAt: new Date().toISOString()
            };

            gameState.tasks.push(task);
            updateTasksList();
            saveGameState();

            document.querySelector('.fixed').remove();
            showFloatingNotification('‚úÖ Quest Created!', `"${text}" added to your quests`);
        }

        function updateTasksList() {
            const container = document.getElementById('tasksList');
            if (!container) return;
            
            const todayTasks = gameState.tasks.filter(task => {
                const taskDate = new Date(task.createdAt).toDateString();
                const today = new Date().toDateString();
                return taskDate === today;
            }).sort((a, b) => a.completed - b.completed);

            container.innerHTML = todayTasks.map(task => `
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg ${task.completed ? 'opacity-60' : ''}">
                    <div class="flex items-center space-x-3">
                        <button onclick="toggleTask('${task.id}')" class="text-2xl hover:scale-110 transition-transform">
                            ${task.completed ? '‚úÖ' : '‚¨ú'}
                        </button>
                        <div>
                            <div class="font-medium ${task.completed ? 'line-through' : ''}">${task.text}</div>
                            <div class="text-xs text-gray-500 capitalize flex items-center space-x-2">
                                <span>${task.icon} ${task.category}</span>
                                ${task.aiGenerated ? '<span class="bg-purple-100 dark:bg-purple-800 text-purple-600 dark:text-purple-300 px-2 py-0.5 rounded text-xs">üß† AI</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="text-sm font-bold text-primary">+${task.xp} XP</div>
                </div>
            `).join('');

            if (todayTasks.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No quests yet! Add some tasks to get started.</div>';
            }
        }

        function toggleTask(taskId) {
            const task = gameState.tasks.find(t => t.id == taskId);
            if (task) {
                task.completed = !task.completed;
                if (task.completed) {
                    task.completedAt = new Date().toISOString();
                    awardXP(task.xp, `Completed: ${task.text}`);
                    
                    if (task.aiGenerated) {
                        addAchievement('üß† AI Trainee', 'Completed your first AI-generated task!', 50);
                    }
                    
                    checkForStreaks();
                }
                updateTasksList();
                updateAllUI();
                saveGameState();
            }
        }

        // üèÜ XP AND LEVELING SYSTEM - All original functions preserved
        function awardXP(amount, reason) {
            gameState.xp += amount;
            gameState.totalXP += amount;
            
            const xpForNextLevel = gameState.level * 100;
            if (gameState.xp >= xpForNextLevel) {
                levelUp();
            }
            
            updateXPDisplay();
            showXPAnimation(amount, reason);
            saveGameState();
        }

        function levelUp() {
            const oldLevel = gameState.level;
            gameState.level++;
            gameState.xp = gameState.xp - (oldLevel * 100);
            
            addAchievement(`üéâ Level ${gameState.level}!`, `Reached level ${gameState.level}`, gameState.level * 50);
            
            updateXPDisplay();
            showFloatingNotification('üéâ LEVEL UP!', `Welcome to Level ${gameState.level}!`);
            
            const levelElement = document.getElementById('playerLevel');
            levelElement.classList.add('level-up');
            setTimeout(() => levelElement.classList.remove('level-up'), 1000);
        }

        function updateXPDisplay() {
            const xpForNextLevel = gameState.level * 100;
            const progress = (gameState.xp / xpForNextLevel) * 100;
            
            document.getElementById('playerLevel').textContent = `Level ${gameState.level}`;
            document.getElementById('currentXP').textContent = gameState.xp;
            document.getElementById('nextLevelXP').textContent = xpForNextLevel;
            document.getElementById('xpProgress').style.width = `${progress}%`;
        }

        function showXPAnimation(amount, reason) {
            const container = document.createElement('div');
            container.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 xp-burst pointer-events-none';
            container.innerHTML = `
                <div class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-full font-bold shadow-lg">
                    +${amount} XP
                </div>
                <div class="text-center text-sm text-gray-600 dark:text-gray-400 mt-1">${reason}</div>
            `;
            document.body.appendChild(container);
            
            setTimeout(() => container.remove(), 2000);
        }

        // üìä STATS TRACKING - All original functions preserved
        function trackWater() {
            gameState.dailyStats.waterGlasses++;
            updateAllUI();
            saveGameState();
            awardXP(5, 'Stayed hydrated! üíß');
            
            if (gameState.dailyStats.waterGlasses >= 8) {
                addAchievement('üíß Hydration Hero', 'Drank 8+ glasses of water today!', 25);
            }
        }

        function logMeal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">ü•ó Log Meal</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Calories</label>
                            <input type="number" id="mealCalories" placeholder="Enter calories..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-2">Protein (g)</label>
                                <input type="number" id="mealProtein" placeholder="0" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Carbs (g)</label>
                                <input type="number" id="mealCarbs" placeholder="0" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Fat (g)</label>
                                <input type="number" id="mealFat" placeholder="0" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="saveMeal()" class="flex-1 bg-nutrition text-white py-3 rounded-lg hover:bg-green-600">
                                Log Meal
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveMeal() {
            const calories = parseInt(document.getElementById('mealCalories').value) || 0;
            const protein = parseInt(document.getElementById('mealProtein').value) || 0;
            const carbs = parseInt(document.getElementById('mealCarbs').value) || 0;
            const fat = parseInt(document.getElementById('mealFat').value) || 0;

            if (calories > 0) {
                gameState.dailyStats.calories += calories;
                gameState.dailyStats.protein = (gameState.dailyStats.protein || 0) + protein;
                gameState.dailyStats.carbs = (gameState.dailyStats.carbs || 0) + carbs;
                gameState.dailyStats.fat = (gameState.dailyStats.fat || 0) + fat;
                gameState.dailyStats.meals++;

                updateAllUI();
                saveGameState();
                awardXP(15, 'Meal logged! ü•ó');

                document.querySelector('.fixed').remove();
                showFloatingNotification('ü•ó Meal Logged!', `${calories} calories added`);
            }
        }

        function logWorkout() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üí™ Log Workout</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Workout Type</label>
                            <select id="workoutType" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <option value="cardio">üèÉ‚Äç‚ôÇÔ∏è Cardio</option>
                                <option value="strength">üí™ Strength Training</option>
                                <option value="yoga">üßò‚Äç‚ôÄÔ∏è Yoga</option>
                                <option value="sports">‚öΩ Sports</option>
                                <option value="other">üèãÔ∏è‚Äç‚ôÇÔ∏è Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Duration (minutes)</label>
                            <input type="number" id="workoutDuration" placeholder="30" min="5" max="300" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Estimated Calories Burned</label>
                            <input type="number" id="workoutCalories" placeholder="200" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="saveWorkout()" class="flex-1 bg-fitness text-white py-3 rounded-lg hover:bg-red-600">
                                Log Workout
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveWorkout() {
            const duration = parseInt(document.getElementById('workoutDuration').value) || 0;
            const calories = parseInt(document.getElementById('workoutCalories').value) || 0;
            const type = document.getElementById('workoutType').value;

            if (duration > 0) {
                gameState.dailyStats.workouts++;
                gameState.dailyStats.caloriesBurned += calories;
                gameState.dailyStats.exerciseMinutes += duration;

                updateAllUI();
                saveGameState();
                awardXP(duration * 2, `${type} workout completed! üí™`);

                if (gameState.dailyStats.workouts >= 1) {
                    addAchievement('üí™ Workout Warrior', 'Completed a workout today!', 30);
                }

                document.querySelector('.fixed').remove();
                showFloatingNotification('üí™ Workout Logged!', `${duration} minutes of ${type}`);
            }
        }

        function logSteps() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üö∂‚Äç‚ôÇÔ∏è Log Steps</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Steps Count</label>
                            <input type="number" id="stepsInput" placeholder="Enter step count..." min="100" max="50000" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="saveSteps()" class="flex-1 bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600">
                                Log Steps
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveSteps() {
            const steps = parseInt(document.getElementById('stepsInput').value) || 0;

            if (steps > 0) {
                gameState.dailyStats.steps = steps;
                updateAllUI();
                saveGameState();
                awardXP(Math.floor(steps / 100), `${steps.toLocaleString()} steps logged! üö∂‚Äç‚ôÇÔ∏è`);

                if (steps >= 8000) {
                    addAchievement('üö∂‚Äç‚ôÇÔ∏è Step Master', 'Walked 8,000+ steps today!', 40);
                }

                document.querySelector('.fixed').remove();
                showFloatingNotification('üö∂‚Äç‚ôÇÔ∏è Steps Logged!', `${steps.toLocaleString()} steps added`);
            }
        }

        function logSleep() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üò¥ Log Sleep</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Hours of Sleep</label>
                            <input type="number" id="sleepHours" placeholder="8" min="1" max="12" step="0.5" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="saveSleep()" class="flex-1 bg-wellness text-white py-3 rounded-lg hover:bg-purple-600">
                                Log Sleep
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveSleep() {
            const hours = parseFloat(document.getElementById('sleepHours').value) || 0;

            if (hours > 0) {
                gameState.dailyStats.sleepHours = hours;
                updateAllUI();
                saveGameState();
                awardXP(hours * 10, `${hours} hours of sleep logged! üò¥`);

                if (hours >= 8) {
                    addAchievement('üò¥ Sleep Champion', 'Got 8+ hours of quality sleep!', 35);
                }

                document.querySelector('.fixed').remove();
                showFloatingNotification('üò¥ Sleep Logged!', `${hours} hours of rest`);
            }
        }

        // üçÖ POMODORO TIMER - All original functions preserved
        function startPomodoro() {
            let timeLeft = 25 * 60;
            let isRunning = false;
            let interval = null;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-center">üçÖ Pomodoro Timer</h3>
                    <div class="text-center">
                        <div id="pomodoroTimer" class="text-6xl font-bold mb-6 text-focus">25:00</div>
                        <div id="pomodoroStatus" class="text-lg mb-6 text-gray-600 dark:text-gray-400">Ready to focus?</div>
                        <div class="flex space-x-3">
                            <button id="pomodoroStart" onclick="togglePomodoro()" class="flex-1 bg-focus text-white py-3 rounded-lg hover:bg-yellow-600">
                                ‚ñ∂Ô∏è Start
                            </button>
                            <button onclick="resetPomodoro()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                üîÑ Reset
                            </button>
                            <button onclick="this.closest('.fixed').remove(); if(interval) clearInterval(interval);" class="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600">
                                ‚ùå Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            function updateDisplay() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('pomodoroTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            window.togglePomodoro = function() {
                if (isRunning) {
                    clearInterval(interval);
                    isRunning = false;
                    document.getElementById('pomodoroStart').innerHTML = '‚ñ∂Ô∏è Resume';
                    document.getElementById('pomodoroStatus').textContent = 'Paused';
                } else {
                    isRunning = true;
                    document.getElementById('pomodoroStart').innerHTML = '‚è∏Ô∏è Pause';
                    document.getElementById('pomodoroStatus').textContent = 'Focus time! üß†';
                    
                    interval = setInterval(() => {
                        timeLeft--;
                        updateDisplay();
                        
                        if (timeLeft <= 0) {
                            clearInterval(interval);
                            gameState.dailyStats.focusMinutes += 25;
                            updateAllUI();
                            saveGameState();
                            awardXP(50, 'Completed 25-minute focus session! üçÖ');
                            
                            document.getElementById('pomodoroStatus').textContent = 'üéâ Session Complete!';
                            document.getElementById('pomodoroStart').innerHTML = 'üéä Done!';
                            showFloatingNotification('üçÖ Pomodoro Complete!', '25 minutes of focused work!');
                        }
                    }, 1000);
                }
            };

            window.resetPomodoro = function() {
                clearInterval(interval);
                timeLeft = 25 * 60;
                isRunning = false;
                updateDisplay();
                document.getElementById('pomodoroStart').innerHTML = '‚ñ∂Ô∏è Start';
                document.getElementById('pomodoroStatus').textContent = 'Ready to focus?';
            };
        }

        // üèÜ ACHIEVEMENTS - All original functions preserved
        function addAchievement(title, description, xp) {
            const achievement = {
                id: Date.now(),
                title: title,
                description: description,
                xp: xp,
                unlockedAt: new Date().toISOString()
            };

            gameState.achievements.push(achievement);
            updateAchievementsList();
            saveGameState();
            
            showFloatingNotification('üèÜ Achievement Unlocked!', title);
            awardXP(xp, `Achievement: ${title}`);
        }

        function updateAchievementsList() {
            const container = document.getElementById('achievementsList');
            if (!container) return;
            
            const recentAchievements = gameState.achievements
                .sort((a, b) => new Date(b.unlockedAt) - new Date(a.unlockedAt))
                .slice(0, 5);

            container.innerHTML = recentAchievements.map(achievement => `
                <div class="flex items-center space-x-3 p-3 bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/30 dark:to-orange-900/30 rounded-lg">
                    <div class="text-2xl">üèÜ</div>
                    <div class="flex-1">
                        <div class="font-bold">${achievement.title}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">${achievement.description}</div>
                    </div>
                    <div class="text-sm font-bold text-yellow-600">+${achievement.xp} XP</div>
                </div>
            `).join('');

            if (recentAchievements.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Complete tasks to unlock achievements!</div>';
            }
        }

        function checkForStreaks() {
            const completedToday = gameState.tasks.filter(t => t.completed && 
                new Date(t.completedAt).toDateString() === new Date().toDateString()).length;
            
            if (completedToday >= 5) {
                addAchievement('üî• Task Master', 'Completed 5+ tasks in one day!', 50);
            }
        }

        // üìä HABIT TRACKER - All original functions preserved
        function showHabitTracker() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center">üìä Habit Tracker</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-bold mb-4">üéØ Today's Goals</h4>
                            <div class="space-y-3">
                                ${getHabitProgress().map(habit => `
                                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div class="flex items-center space-x-3">
                                            <div class="text-xl">${habit.icon}</div>
                                            <div>
                                                <div class="font-medium">${habit.name}</div>
                                                <div class="text-xs text-gray-500">${habit.current}/${habit.goal} ${habit.unit}</div>
                                            </div>
                                        </div>
                                        <div class="w-20 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                            <div class="bg-${habit.color} h-full rounded-full" style="width: ${Math.min(100, (habit.current/habit.goal)*100)}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-bold mb-4">üìà Quick Stats</h4>
                            <div class="space-y-3">
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-600">${gameState.level}</div>
                                    <div class="text-sm text-blue-500">Current Level</div>
                                </div>
                                <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600">${gameState.totalXP.toLocaleString()}</div>
                                    <div class="text-sm text-green-500">Total XP Earned</div>
                                </div>
                                <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/30 dark:to-pink-900/30 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-purple-600">${gameState.achievements.length}</div>
                                    <div class="text-sm text-purple-500">Achievements Unlocked</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-center mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function getHabitProgress() {
            return [
                {
                    name: 'Steps',
                    icon: 'üö∂‚Äç‚ôÇÔ∏è',
                    current: gameState.dailyStats.steps,
                    goal: 8000,
                    unit: 'steps',
                    color: 'orange-500'
                },
                {
                    name: 'Water',
                    icon: 'üíß',
                    current: gameState.dailyStats.waterGlasses,
                    goal: 8,
                    unit: 'glasses',
                    color: 'blue-500'
                },
                {
                    name: 'Focus',
                    icon: 'üß†',
                    current: gameState.dailyStats.focusMinutes,
                    goal: 120,
                    unit: 'minutes',
                    color: 'yellow-500'
                },
                {
                    name: 'Sleep',
                    icon: 'üò¥',
                    current: gameState.dailyStats.sleepHours,
                    goal: 8,
                    unit: 'hours',
                    color: 'purple-500'
                },
                {
                    name: 'Workouts',
                    icon: 'üí™',
                    current: gameState.dailyStats.workouts,
                    goal: 1,
                    unit: 'sessions',
                    color: 'red-500'
                }
            ];
        }

        // üë§ PROFILE MANAGEMENT - All original functions preserved
        function showProfile() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center">üë§ Player Profile</h3>
                    
                    <div class="space-y-4">
                        <div class="text-center mb-6">
                            <div class="text-4xl mb-2">üéÆ</div>
                            <div class="text-xl font-bold">Level ${gameState.level} Player</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">${gameState.totalXP.toLocaleString()} Total XP</div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Age</label>
                                <input type="number" id="profileAge" value="${gameState.profile.age || ''}" placeholder="25" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Weight (lbs)</label>
                                <input type="number" id="profileWeight" value="${gameState.profile.weight || ''}" placeholder="150" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Height (inches)</label>
                            <input type="number" id="profileHeight" value="${gameState.profile.height || ''}" placeholder="68" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Activity Level</label>
                            <select id="profileActivity" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <option value="sedentary" ${gameState.profile.activityLevel === 'sedentary' ? 'selected' : ''}>Sedentary (desk job)</option>
                                <option value="light" ${gameState.profile.activityLevel === 'light' ? 'selected' : ''}>Light activity</option>
                                <option value="moderate" ${gameState.profile.activityLevel === 'moderate' ? 'selected' : ''}>Moderate activity</option>
                                <option value="very" ${gameState.profile.activityLevel === 'very' ? 'selected' : ''}>Very active</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Fitness Goal</label>
                            <select id="profileGoal" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <option value="lose_weight" ${gameState.profile.fitnessGoal === 'lose_weight' ? 'selected' : ''}>Lose weight</option>
                                <option value="maintain" ${gameState.profile.fitnessGoal === 'maintain' ? 'selected' : ''}>Maintain weight</option>
                                <option value="gain_weight" ${gameState.profile.fitnessGoal === 'gain_weight' ? 'selected' : ''}>Gain weight</option>
                                <option value="build_muscle" ${gameState.profile.fitnessGoal === 'build_muscle' ? 'selected' : ''}>Build muscle</option>
                            </select>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="saveProfile()" class="flex-1 bg-primary text-white py-3 rounded-lg hover:bg-purple-600">
                                Save Profile
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveProfile() {
            const age = parseInt(document.getElementById('profileAge').value);
            const weight = parseInt(document.getElementById('profileWeight').value);
            const height = parseInt(document.getElementById('profileHeight').value);
            const activityLevel = document.getElementById('profileActivity').value;
            const fitnessGoal = document.getElementById('profileGoal').value;

            gameState.profile = {
                age: age || null,
                weight: weight || null,
                height: height || null,
                activityLevel: activityLevel,
                fitnessGoal: fitnessGoal,
                bmr: calculateBMR(age, weight, height, 'male')
            };

            saveGameState();
            showFloatingNotification('‚úÖ Profile Saved!', 'Your health profile has been updated');
            
            document.querySelector('.fixed').remove();
            showAIInsights();
        }

        function calculateBMR(age, weight, height, gender) {
            if (!age || !weight || !height) return 1800;
            
            const bmr = (10 * (weight * 0.453592)) + (6.25 * (height * 2.54)) - (5 * age);
            return gender === 'male' ? bmr + 5 : bmr - 161;
        }

        // üîî NOTIFICATION SYSTEM - All original functions preserved
        function showNotificationSettings() {
            if (!gameState.settings.reminderTimes) {
                gameState.settings.reminderTimes = {
                    water: ['09:00', '12:00', '15:00', '18:00'],
                    workout: ['07:00', '17:00'],
                    tasks: ['09:00', '14:00'],
                    sleep: ['22:00']
                };
            }
            
            const hasNotifications = 'Notification' in window;
            const notificationStatus = hasNotifications ? Notification.permission : 'Not supported';
            const canEnable = hasNotifications && Notification.permission !== 'granted';
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4">üîî Reminder Settings</h3>
                    
                    <div class="space-y-4">
                        <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">Browser Notifications</h4>
                            <div class="text-sm mb-3">
                                Status: <span class="font-mono">${notificationStatus}</span>
                                ${canEnable ? '<button onclick="requestNotificationPermission()" class="ml-2 bg-primary text-white px-3 py-1 rounded text-xs">Enable</button>' : ''}
                                ${notificationStatus === 'granted' ? '<span class="ml-2 text-green-600">‚úì Enabled</span>' : ''}
                            </div>
                        </div>
                        
                        <div>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="enableReminders" ${gameState.settings.reminders ? 'checked' : ''} onchange="toggleReminders()" class="rounded">
                                <span>Enable Smart Reminders</span>
                            </label>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="saveReminderSettings()" class="flex-1 bg-primary text-white py-2 rounded hover:bg-purple-600">
                                Save Settings
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(function(permission) {
                    if (permission === 'granted') {
                        showFloatingNotification('üîî Notifications Enabled', 'You will now receive smart reminders!');
                    } else {
                        showFloatingNotification('‚ùå Notifications Blocked', 'Enable in browser settings to get reminders');
                    }
                    
                    document.querySelector('.fixed').remove();
                    showNotificationSettings();
                });
            }
        }

        function toggleReminders() {
            gameState.settings.reminders = document.getElementById('enableReminders').checked;
            saveGameState();
        }

        function saveReminderSettings() {
            toggleReminders();
            saveGameState();
            
            document.querySelector('.fixed').remove();
            showFloatingNotification('üíæ Settings Saved', 'Reminder preferences updated');
        }

        // üì± APPLE HEALTH INTEGRATION - All original functions preserved
        function showAppleHealthSetup() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center">üì± Apple Health Auto-Sync Setup</h3>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg mb-6">
                        <h4 class="font-bold mb-3">‚ú® Coming Soon!</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            Automatic Apple Health sync will be available in a future update. 
                            For now, you can manually log your health data.
                        </p>
                    </div>
                    
                    <div class="flex justify-center">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function importHealthData() {
            showFloatingNotification('üì± Health Import', 'Manual logging available - use the Health tab options');
        }

        function showHealthStatus() {
            showFloatingNotification('üìä Health Status', 'All health features are working normally');
        }

        function checkForHealthData() {
            const urlParams = new URLSearchParams(window.location.search);
            const healthData = {};
            
            if (urlParams.get('steps')) healthData.steps = parseInt(urlParams.get('steps'));
            if (urlParams.get('sleep')) healthData.sleep = parseFloat(urlParams.get('sleep'));
            if (urlParams.get('workouts')) healthData.workouts = parseInt(urlParams.get('workouts'));
            
            if (Object.keys(healthData).length > 0) {
                processHealthData(healthData);
                
                setTimeout(() => {
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }, 5000);
                
                return true;
            }
            return false;
        }

        function processHealthData(data) {
            let xpAwarded = 0;
            let updates = [];
            
            if (data.steps && data.steps > 0) {
                const oldSteps = gameState.dailyStats.steps;
                gameState.dailyStats.steps = data.steps;
                
                if (data.steps > oldSteps) {
                    xpAwarded += Math.floor((data.steps - oldSteps) / 100);
                }
                
                updates.push(`${data.steps.toLocaleString()} steps`);
                
                if (data.steps >= 8000) {
                    addAchievement('üì± Health Sync Step Master', 'Reached 8,000+ steps via health sync!', 50);
                }
            }
            
            if (data.sleep && data.sleep > 0) {
                const oldSleep = gameState.dailyStats.sleepHours;
                gameState.dailyStats.sleepHours = data.sleep;
                
                if (data.sleep > oldSleep) {
                    xpAwarded += (data.sleep - oldSleep) * 10;
                }
                
                updates.push(`${data.sleep}h sleep`);
                
                if (data.sleep >= 8) {
                    addAchievement('üì± Health Sync Sleep Champion', 'Logged 8+ hours sleep via health sync!', 40);
                }
            }
            
            if (data.workouts && data.workouts >= 0) {
                const oldWorkouts = gameState.dailyStats.workouts;
                gameState.dailyStats.workouts = data.workouts;
                
                if (data.workouts > oldWorkouts) {
                    xpAwarded += (data.workouts - oldWorkouts) * 50;
                }
                
                updates.push(`${data.workouts} workouts`);
            }
            
            updateAllUI();
            saveGameState();
            
            if (xpAwarded > 0) {
                awardXP(xpAwarded, 'Health data synced! üì±');
            }
            
            showFloatingNotification('üì± Health Synced!', updates.join(', '));
            
            if (!gameState.achievements.find(a => a.title.includes('Health Sync'))) {
                addAchievement('üì± Health Connected', 'Successfully synced health data!', 100);
            }
        }

        // üöÄ UI UPDATES
        function updateAllUI() {
            updateStatsDisplay();
            updateXPDisplay();
            updateTasksList();
            updateAchievementsList();
            updateExerciseStats();
            updateWeeklyPlan();
            showAIInsights();
        }

        function updateStatsDisplay() {
            const stats = gameState.dailyStats;
            
            const elements = {
                'stepsCount': stats.steps.toLocaleString(),
                'waterCount': stats.waterGlasses,
                'caloriesCount': stats.calories.toLocaleString(),
                'focusCount': stats.focusMinutes,
                'sleepCount': stats.sleepHours || 0,
                'workoutCount': stats.workouts,
                'exerciseWorkouts': stats.workouts,
                'exerciseCalories': stats.caloriesBurned,
                'exerciseMinutes': stats.exerciseMinutes || 0,
                'workoutStreak': gameState.streaks.workout || 0,
                'totalMinutes': stats.exerciseMinutes || 0
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });

            // Update weekly progress
            const weeklyProgress = document.getElementById('weeklyProgress');
            if (weeklyProgress) {
                weeklyProgress.textContent = `${stats.workouts}/5`;
            }
        }

        function updateExerciseStats() {
            const stats = gameState.dailyStats;
            
            const exerciseElements = {
                'exerciseWorkouts': stats.workouts,
                'exerciseCalories': stats.caloriesBurned,
                'exerciseMinutes': stats.exerciseMinutes || 0
            };

            Object.entries(exerciseElements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
        }

        function updateTasksListDetailed() {
            const container = document.getElementById('tasksListDetailed');
            if (!container) return;
            
            const todayTasks = gameState.tasks.filter(task => {
                const taskDate = new Date(task.createdAt).toDateString();
                const today = new Date().toDateString();
                return taskDate === today;
            }).sort((a, b) => a.completed - b.completed);

            container.innerHTML = todayTasks.map(task => `
                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg ${task.completed ? 'opacity-60' : ''}">
                    <div class="flex items-center space-x-3">
                        <button onclick="toggleTask('${task.id}')" class="text-3xl hover:scale-110 transition-transform">
                            ${task.completed ? '‚úÖ' : '‚¨ú'}
                        </button>
                        <div>
                            <div class="font-medium ${task.completed ? 'line-through' : ''}">${task.text}</div>
                            <div class="text-sm text-gray-500 capitalize flex items-center space-x-2">
                                <span>${task.icon} ${task.category}</span>
                                ${task.aiGenerated ? '<span class="bg-purple-100 dark:bg-purple-800 text-purple-600 dark:text-purple-300 px-2 py-0.5 rounded text-xs">üß† AI</span>' : ''}
                                ${task.completed ? `<span class="text-xs text-green-600">Completed ${new Date(task.completedAt).toLocaleTimeString()}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-primary">+${task.xp} XP</div>
                        ${task.completed ? '<div class="text-xs text-green-600">‚úì Earned</div>' : ''}
                    </div>
                </div>
            `).join('');

            if (todayTasks.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12">No quests yet! Add some tasks to get started.</div>';
            }
        }

        function updateAchievementsListDetailed() {
            const container = document.getElementById('achievementsListDetailed');
            if (!container) return;
            
            const allAchievements = gameState.achievements
                .sort((a, b) => new Date(b.unlockedAt) - new Date(a.unlockedAt));

            container.innerHTML = allAchievements.map(achievement => `
                <div class="flex items-center space-x-4 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/30 dark:to-orange-900/30 rounded-lg border border-yellow-200 dark:border-yellow-800">
                    <div class="text-3xl">üèÜ</div>
                    <div class="flex-1">
                        <div class="font-bold text-yellow-800 dark:text-yellow-200">${achievement.title}</div>
                        <div class="text-sm text-yellow-700 dark:text-yellow-300">${achievement.description}</div>
                        <div class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">
                            Unlocked ${new Date(achievement.unlockedAt).toLocaleDateString()} at ${new Date(achievement.unlockedAt).toLocaleTimeString()}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold text-yellow-600">+${achievement.xp}</div>
                        <div class="text-xs text-yellow-500">XP</div>
                    </div>
                </div>
            `).join('');

            if (allAchievements.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12">Complete tasks to unlock achievements!</div>';
            }
        }

        function updateHealthProgress() {
            const container = document.getElementById('healthProgressContainer');
            if (!container) return;
            
            const habits = getHabitProgress();
            
            container.innerHTML = habits.map(habit => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="text-xl">${habit.icon}</div>
                        <div>
                            <div class="font-medium">${habit.name}</div>
                            <div class="text-xs text-gray-500">${habit.current}/${habit.goal} ${habit.unit}</div>
                        </div>
                    </div>
                    <div class="w-24 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                        <div class="bg-${habit.color} h-full rounded-full" style="width: ${Math.min(100, (habit.current/habit.goal)*100)}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function updateSettingsStats() {
            const elements = {
                'settingsLevel': gameState.level,
                'settingsTotalXP': gameState.totalXP.toLocaleString(),
                'settingsAchievements': gameState.achievements.length,
                'settingsTasks': gameState.tasks.length
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
        }

        // üí´ NOTIFICATIONS
        function showFloatingNotification(title, message) {
            const notification = document.createElement('div');
            notification.className = 'floating-notification bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg border-l-4 border-primary max-w-sm';
            notification.innerHTML = `
                <div class="font-bold text-gray-900 dark:text-white">${title}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">${message}</div>
            `;
            
            document.getElementById('notificationsContainer').appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // üß≠ TAB NAVIGATION
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            event.target.classList.add('active');
            
            switch(tabName) {
                case 'exercise':
                    updateExerciseStats();
                    updateWeeklyPlan();
                    break;
                case 'tasks':
                    updateTasksListDetailed();
                    updateAchievementsListDetailed();
                    break;
                case 'health':
                    updateHealthProgress();
                    break;
                case 'settings':
                    updateSettingsStats();
                    break;
            }
        }

        // üéµ SPOTIFY INTEGRATION SYSTEM
        let spotifyState = {
            accessToken: null,
            refreshToken: null,
            expiresAt: null,
            clientId: null,
            isConnected: false,
            currentTrack: null,
            userProfile: null,
            topTracks: [],
            topArtists: [],
            recentlyPlayed: [],
            musicPreferences: {
                workoutGenres: [],
                focusGenres: [],
                relaxationGenres: [],
                tempo: { min: 60, max: 180 },
                energy: { min: 0.3, max: 1.0 }
            }
        };

        // PKCE helper functions
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        function connectSpotify() {
            const clientId = document.getElementById('spotifyClientId').value.trim();
            
            if (!clientId) {
                showFloatingNotification('‚ùå Missing Client ID', 'Please enter your Spotify app client ID');
                return;
            }
            
            // Save client ID
            spotifyState.clientId = clientId;
            localStorage.setItem('spotify_client_id', clientId);
            
            // Start PKCE flow
            initiateSpotifyAuth();
        }

        async function initiateSpotifyAuth() {
            try {
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                
                // Store code verifier for later use
                localStorage.setItem('spotify_code_verifier', codeVerifier);
                
                const authUrl = new URL('https://accounts.spotify.com/authorize');
                authUrl.searchParams.append('client_id', spotifyState.clientId);
                authUrl.searchParams.append('response_type', 'code');
                authUrl.searchParams.append('redirect_uri', window.location.origin + window.location.pathname);
                authUrl.searchParams.append('code_challenge_method', 'S256');
                authUrl.searchParams.append('code_challenge', codeChallenge);
                authUrl.searchParams.append('scope', 'user-read-playback-state user-modify-playback-state user-read-currently-playing playlist-read-private playlist-read-collaborative user-top-read user-read-recently-played streaming user-library-read user-library-modify');
                
                showFloatingNotification('üéµ Redirecting to Spotify', 'Please authorize the app to continue');
                
                // Redirect to Spotify authorization
                window.location.href = authUrl.toString();
                
            } catch (error) {
                console.error('Error initiating Spotify auth:', error);
                showFloatingNotification('‚ùå Auth Error', 'Failed to start Spotify authorization');
            }
        }

        async function handleSpotifyCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                showFloatingNotification('‚ùå Spotify Auth Failed', 'Authorization was denied or failed');
                return;
            }
            
            if (code) {
                try {
                    await exchangeCodeForToken(code);
                    
                    // Clean up URL
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                    
                } catch (error) {
                    console.error('Error handling Spotify callback:', error);
                    showFloatingNotification('‚ùå Token Exchange Failed', 'Failed to complete Spotify authentication');
                }
            }
        }

        async function exchangeCodeForToken(code) {
            const codeVerifier = localStorage.getItem('spotify_code_verifier');
            const clientId = localStorage.getItem('spotify_client_id');
            
            if (!codeVerifier || !clientId) {
                throw new Error('Missing code verifier or client ID');
            }
            
            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: window.location.origin + window.location.pathname,
                    client_id: clientId,
                    code_verifier: codeVerifier
                })
            });
            
            if (!response.ok) {
                throw new Error('Token exchange failed');
            }
            
            const tokenData = await response.json();
            
            // Store tokens
            spotifyState.accessToken = tokenData.access_token;
            spotifyState.refreshToken = tokenData.refresh_token;
            spotifyState.expiresAt = Date.now() + (tokenData.expires_in * 1000);
            spotifyState.isConnected = true;
            
            // Save to localStorage
            localStorage.setItem('spotify_access_token', spotifyState.accessToken);
            localStorage.setItem('spotify_refresh_token', spotifyState.refreshToken);
            localStorage.setItem('spotify_expires_at', spotifyState.expiresAt.toString());
            
            // Clean up
            localStorage.removeItem('spotify_code_verifier');
            
            showFloatingNotification('üéµ Spotify Connected!', 'Successfully connected to your Spotify account');
            
            // Initialize Spotify data
            await initializeSpotifyData();
            updateSpotifyUI();
        }

        async function refreshSpotifyToken() {
            if (!spotifyState.refreshToken) {
                throw new Error('No refresh token available');
            }
            
            const clientId = localStorage.getItem('spotify_client_id');
            
            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    grant_type: 'refresh_token',
                    refresh_token: spotifyState.refreshToken,
                    client_id: clientId
                })
            });
            
            if (!response.ok) {
                throw new Error('Token refresh failed');
            }
            
            const tokenData = await response.json();
            
            spotifyState.accessToken = tokenData.access_token;
            spotifyState.expiresAt = Date.now() + (tokenData.expires_in * 1000);
            
            // Update refresh token if provided
            if (tokenData.refresh_token) {
                spotifyState.refreshToken = tokenData.refresh_token;
                localStorage.setItem('spotify_refresh_token', spotifyState.refreshToken);
            }
            
            localStorage.setItem('spotify_access_token', spotifyState.accessToken);
            localStorage.setItem('spotify_expires_at', spotifyState.expiresAt.toString());
        }

        async function makeSpotifyRequest(url, options = {}) {
            // Check if token needs refresh
            if (Date.now() >= spotifyState.expiresAt - 60000) { // Refresh 1 minute before expiry
                await refreshSpotifyToken();
            }
            
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${spotifyState.accessToken}`,
                    ...options.headers
                }
            });
            
            if (!response.ok) {
                throw new Error(`Spotify API error: ${response.status}`);
            }
            
            return response.json();
        }

        async function initializeSpotifyData() {
            try {
                console.log('üéµ Starting Spotify data initialization...');
                
                // Get user profile
                console.log('üéµ Fetching user profile...');
                spotifyState.userProfile = await makeSpotifyRequest('https://api.spotify.com/v1/me');
                console.log('‚úÖ User profile loaded:', spotifyState.userProfile?.display_name);
                
                // Get user's top tracks
                console.log('üéµ Fetching top tracks...');
                spotifyState.topTracks = await makeSpotifyRequest('https://api.spotify.com/v1/me/top/tracks?limit=50&time_range=medium_term');
                console.log('‚úÖ Top tracks loaded:', spotifyState.topTracks?.items?.length || 0);
                
                // If no medium_term data, try short_term
                if (!spotifyState.topTracks?.items?.length) {
                    console.log('üéµ No medium-term data, trying short-term...');
                    spotifyState.topTracks = await makeSpotifyRequest('https://api.spotify.com/v1/me/top/tracks?limit=50&time_range=short_term');
                    console.log('‚úÖ Short-term top tracks loaded:', spotifyState.topTracks?.items?.length || 0);
                }
                
                // Get user's top artists
                console.log('üéµ Fetching top artists...');
                spotifyState.topArtists = await makeSpotifyRequest('https://api.spotify.com/v1/me/top/artists?limit=50&time_range=medium_term');
                console.log('‚úÖ Top artists loaded:', spotifyState.topArtists?.items?.length || 0);
                
                // If no medium_term data, try short_term
                if (!spotifyState.topArtists?.items?.length) {
                    console.log('üéµ No medium-term artists, trying short-term...');
                    spotifyState.topArtists = await makeSpotifyRequest('https://api.spotify.com/v1/me/top/artists?limit=50&time_range=short_term');
                    console.log('‚úÖ Short-term top artists loaded:', spotifyState.topArtists?.items?.length || 0);
                }
                
                // Get recently played
                console.log('üéµ Fetching recently played...');
                try {
                    spotifyState.recentlyPlayed = await makeSpotifyRequest('https://api.spotify.com/v1/me/player/recently-played?limit=50');
                    console.log('‚úÖ Recently played loaded:', spotifyState.recentlyPlayed?.items?.length || 0);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not load recently played tracks:', error);
                    spotifyState.recentlyPlayed = { items: [] };
                }
                
                // Analyze music preferences
                console.log('üéµ Analyzing music preferences...');
                analyzeMusicPreferences();
                
                // Update music achievements
                checkMusicAchievements();
                
                // Update UI
                updateMusicAnalytics();
                updateMusicRecommendations();
                
                // Initialize web player after successful data load
                console.log('üéµ Initializing web player after data load...');
                if (window.Spotify && !webPlayerInstance) {
                    initializeWebPlayer();
                } else if (webPlayerInstance) {
                    console.log('üéµ Web player already exists, ensuring it\'s connected...');
                    // Reconnect if needed
                    webPlayerInstance.connect().then(success => {
                        if (success) {
                            console.log('‚úÖ Web player reconnected successfully');
                        } else {
                            console.log('üîÑ Reinitializing web player...');
                            webPlayerInstance = null;
                            initializeWebPlayer();
                        }
                    });
                }
                
                showFloatingNotification('üéµ Data Loaded!', 'Your Spotify music profile has been analyzed');
                
            } catch (error) {
                console.error('‚ùå Error initializing Spotify data:', error);
                showFloatingNotification('‚ö†Ô∏è Data Load Error', 'Some Spotify features may be limited. Check console for details.');
            }
        }

        function analyzeMusicPreferences() {
            if (!spotifyState.topTracks.items) return;
            
            // Analyze genres from top artists
            const genres = [];
            spotifyState.topArtists.items?.forEach(artist => {
                genres.push(...artist.genres);
            });
            
            // Categorize genres for different activities
            const workoutGenres = genres.filter(g => 
                g.includes('hip hop') || g.includes('rock') || g.includes('electronic') || 
                g.includes('pop') || g.includes('dance') || g.includes('edm')
            );
            
            const focusGenres = genres.filter(g => 
                g.includes('ambient') || g.includes('classical') || g.includes('jazz') ||
                g.includes('instrumental') || g.includes('lo-fi') || g.includes('chill')
            );
            
            const relaxationGenres = genres.filter(g => 
                g.includes('ambient') || g.includes('new age') || g.includes('meditation') ||
                g.includes('nature') || g.includes('acoustic') || g.includes('folk')
            );
            
            spotifyState.musicPreferences = {
                workoutGenres: [...new Set(workoutGenres)],
                focusGenres: [...new Set(focusGenres)],
                relaxationGenres: [...new Set(relaxationGenres)],
                tempo: { min: 60, max: 180 },
                energy: { min: 0.3, max: 1.0 }
            };
            
            // Save preferences
            localStorage.setItem('spotify_music_preferences', JSON.stringify(spotifyState.musicPreferences));
        }

        function loadSpotifyState() {
            const accessToken = localStorage.getItem('spotify_access_token');
            const refreshToken = localStorage.getItem('spotify_refresh_token');
            const expiresAt = localStorage.getItem('spotify_expires_at');
            const clientId = localStorage.getItem('spotify_client_id');
            const preferences = localStorage.getItem('spotify_music_preferences');
            
            if (accessToken && refreshToken && expiresAt && clientId) {
                spotifyState.accessToken = accessToken;
                spotifyState.refreshToken = refreshToken;
                spotifyState.expiresAt = parseInt(expiresAt);
                spotifyState.clientId = clientId;
                spotifyState.isConnected = Date.now() < spotifyState.expiresAt;
                
                if (preferences) {
                    spotifyState.musicPreferences = JSON.parse(preferences);
                }
                
                if (spotifyState.isConnected) {
                    updateSpotifyUI();
                    getCurrentlyPlaying();
                    
                    // Set up periodic checks for currently playing
                    setInterval(getCurrentlyPlaying, 5000);
                }
            }
        }

        function updateSpotifyUI() {
            const authSection = document.getElementById('spotifyAuthSection');
            const connectedSection = document.getElementById('spotifyConnectedSection');
            const statusElement = document.getElementById('spotifyStatus');
            const userInfoElement = document.getElementById('spotifyUserInfo');
            
            if (spotifyState.isConnected) {
                if (authSection) authSection.style.display = 'none';
                if (connectedSection) connectedSection.style.display = 'block';
                if (statusElement) statusElement.textContent = 'Connected and syncing your music data';
                if (userInfoElement && spotifyState.userProfile) {
                    userInfoElement.textContent = `Logged in as ${spotifyState.userProfile.display_name}`;
                }
                
                updateMusicAnalytics();
                updateMusicRecommendations();
            } else {
                if (authSection) authSection.style.display = 'block';
                if (connectedSection) connectedSection.style.display = 'none';
                if (statusElement) statusElement.textContent = 'Connect your Spotify account for AI music coaching';
            }
        }

        async function getCurrentlyPlaying() {
            if (!spotifyState.isConnected) return;
            
            try {
                const currentTrack = await makeSpotifyRequest('https://api.spotify.com/v1/me/player/currently-playing');
                
                if (currentTrack && currentTrack.item) {
                    spotifyState.currentTrack = currentTrack;
                    updatePlayerUI(currentTrack);
                } else {
                    // No track playing
                    updatePlayerUI(null);
                }
            } catch (error) {
                console.error('Error getting currently playing:', error);
            }
        }

        function updatePlayerUI(trackData) {
            const trackNameElement = document.getElementById('trackName');
            const artistNameElement = document.getElementById('artistName');
            const albumArtElement = document.getElementById('albumArt');
            const playPauseButton = document.getElementById('playPauseButton');
            const currentTimeElement = document.getElementById('currentTime');
            const totalTimeElement = document.getElementById('totalTime');
            const progressBarElement = document.getElementById('progressBar');
            
            if (trackData && trackData.item) {
                const track = trackData.item;
                
                if (trackNameElement) trackNameElement.textContent = track.name;
                if (artistNameElement) artistNameElement.textContent = track.artists.map(a => a.name).join(', ');
                
                if (albumArtElement && track.album.images.length > 0) {
                    albumArtElement.innerHTML = `<img src="${track.album.images[0].url}" alt="Album Art" class="w-full h-full object-cover rounded-lg">`;
                }
                
                if (playPauseButton) {
                    playPauseButton.textContent = trackData.is_playing ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
                }
                
                // Update progress
                if (currentTimeElement && totalTimeElement && progressBarElement) {
                    const currentMs = trackData.progress_ms || 0;
                    const totalMs = track.duration_ms;
                    
                    currentTimeElement.textContent = formatTime(currentMs);
                    totalTimeElement.textContent = formatTime(totalMs);
                    
                    const progress = (currentMs / totalMs) * 100;
                    progressBarElement.style.width = `${progress}%`;
                }
                
                // Check for music-related achievements
                checkMusicListeningAchievements(track);
                
            } else {
                // No track playing
                if (trackNameElement) trackNameElement.textContent = 'No track playing';
                if (artistNameElement) artistNameElement.textContent = 'Start playing music on Spotify';
                if (albumArtElement) albumArtElement.innerHTML = 'üéµ';
                if (playPauseButton) playPauseButton.textContent = '‚ñ∂Ô∏è';
                if (currentTimeElement) currentTimeElement.textContent = '0:00';
                if (totalTimeElement) totalTimeElement.textContent = '0:00';
                if (progressBarElement) progressBarElement.style.width = '0%';
            }
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        async function togglePlayPause() {
            if (!spotifyState.isConnected) {
                showFloatingNotification('üéµ Not Connected', 'Connect Spotify to control playback');
                return;
            }
            
            try {
                // Use web player if active, otherwise use Web API
                if (webPlayerActive && webPlayerInstance) {
                    console.log('üéµ Using web player for play/pause');
                    webPlayerInstance.togglePlay().then(() => {
                        console.log('‚úÖ Web player toggle successful');
                        // Update state immediately
                        setTimeout(() => {
                            webPlayerInstance.getCurrentState().then(state => {
                                if (state) {
                                    updatePlayerUI({
                                        item: state.track_window.current_track,
                                        is_playing: !state.paused,
                                        progress_ms: state.position,
                                        duration_ms: state.track_window.current_track.duration_ms
                                    });
                                }
                            });
                        }, 200);
                    }).catch(error => {
                        console.error('Web player toggle error:', error);
                        showFloatingNotification('‚ö†Ô∏è Playback Error', 'Web player control failed');
                    });
                } else {
                    console.log('üéµ Using Web API for play/pause');
                    if (spotifyState.currentTrack && spotifyState.currentTrack.is_playing) {
                        await makeSpotifyRequest('https://api.spotify.com/v1/me/player/pause', { method: 'PUT' });
                    } else {
                        await makeSpotifyRequest('https://api.spotify.com/v1/me/player/play', { method: 'PUT' });
                    }
                    
                    awardXP(5, 'Playback toggled! üéµ');
                    setTimeout(getCurrentlyPlaying, 500);
                }
                
            } catch (error) {
                console.error('Error toggling playback:', error);
                showFloatingNotification('‚ö†Ô∏è Playback Error', 'Unable to control playback');
            }
        }

        async function nextTrack() {
            if (!spotifyState.isConnected) {
                showFloatingNotification('üéµ Not Connected', 'Connect Spotify to control playback');
                return;
            }
            
            try {
                // Use web player if active, otherwise use Web API
                if (webPlayerActive && webPlayerInstance) {
                    console.log('üéµ Using web player for next track');
                    webPlayerInstance.nextTrack().then(() => {
                        console.log('‚úÖ Web player next track successful');
                        showFloatingNotification('‚è≠Ô∏è Next Track', 'Skipped to next track');
                        // Update state after a short delay
                        setTimeout(() => {
                            webPlayerInstance.getCurrentState().then(state => {
                                if (state) {
                                    updatePlayerUI({
                                        item: state.track_window.current_track,
                                        is_playing: !state.paused,
                                        progress_ms: state.position,
                                        duration_ms: state.track_window.current_track.duration_ms
                                    });
                                }
                            });
                        }, 500);
                    }).catch(error => {
                        console.error('Web player next track error:', error);
                        showFloatingNotification('‚ö†Ô∏è Skip Error', 'Web player skip failed');
                    });
                } else {
                    console.log('üéµ Using Web API for next track');
                    await makeSpotifyRequest('https://api.spotify.com/v1/me/player/next', { method: 'POST' });
                    setTimeout(getCurrentlyPlaying, 1000);
                    awardXP(5, 'Track skipped! üéµ');
                    showFloatingNotification('‚è≠Ô∏è Next Track', 'Skipped to next track');
                }
            } catch (error) {
                console.error('Error skipping track:', error);
                showFloatingNotification('‚ö†Ô∏è Skip Error', 'Unable to skip track');
            }
        }

        async function previousTrack() {
            if (!spotifyState.isConnected) {
                showFloatingNotification('üéµ Not Connected', 'Connect Spotify to control playback');
                return;
            }
            
            try {
                // Use web player if active, otherwise use Web API
                if (webPlayerActive && webPlayerInstance) {
                    console.log('üéµ Using web player for previous track');
                    webPlayerInstance.previousTrack().then(() => {
                        console.log('‚úÖ Web player previous track successful');
                        showFloatingNotification('‚èÆÔ∏è Previous Track', 'Went to previous track');
                        // Update state after a short delay
                        setTimeout(() => {
                            webPlayerInstance.getCurrentState().then(state => {
                                if (state) {
                                    updatePlayerUI({
                                        item: state.track_window.current_track,
                                        is_playing: !state.paused,
                                        progress_ms: state.position,
                                        duration_ms: state.track_window.current_track.duration_ms
                                    });
                                }
                            });
                        }, 500);
                    }).catch(error => {
                        console.error('Web player previous track error:', error);
                        showFloatingNotification('‚ö†Ô∏è Previous Error', 'Web player previous failed');
                    });
                } else {
                    console.log('üéµ Using Web API for previous track');
                    await makeSpotifyRequest('https://api.spotify.com/v1/me/player/previous', { method: 'POST' });
                    setTimeout(getCurrentlyPlaying, 1000);
                    awardXP(5, 'Previous track! üéµ');
                    showFloatingNotification('‚èÆÔ∏è Previous Track', 'Went to previous track');
                }
            } catch (error) {
                console.error('Error going to previous track:', error);
                showFloatingNotification('‚ö†Ô∏è Previous Error', 'Unable to go to previous track');
            }
        }

        function getMusicForActivity(activity) {
            if (!spotifyState.isConnected) {
                showFloatingNotification('üéµ Not Connected', 'Connect Spotify to get music recommendations');
                return;
            }
            
            generateActivityPlaylist(activity);
        }

        async function generateActivityPlaylist(activity) {
            console.log('üéµ Starting playlist generation for:', activity);
            
            // Show loading state
            showFloatingNotification('üîÑ Generating Playlist...', 'AI is analyzing your music preferences');
            
            try {
                let recommendations = [];
                let insight = '';
                
                console.log('üéµ Spotify state check:', {
                    isConnected: spotifyState.isConnected,
                    hasTopTracks: spotifyState.topTracks?.items?.length || 0,
                    hasTopArtists: spotifyState.topArtists?.items?.length || 0
                });
                
                switch (activity) {
                    case 'workout':
                        console.log('üéµ Generating workout recommendations...');
                        recommendations = await getWorkoutRecommendations();
                        insight = 'High-energy tracks selected based on your listening history to boost your workout performance!';
                        break;
                    case 'focus':
                        console.log('üéµ Generating focus recommendations...');
                        recommendations = await getFocusRecommendations();
                        insight = 'Concentration-enhancing music chosen to help you maintain focus and productivity!';
                        break;
                    case 'relaxation':
                        console.log('üéµ Generating relaxation recommendations...');
                        recommendations = await getRelaxationRecommendations();
                        insight = 'Calming tracks selected to help you unwind and reduce stress based on your preferences!';
                        break;
                    default:
                        throw new Error(`Unknown activity: ${activity}`);
                }
                
                console.log('üéµ Recommendations received:', recommendations?.tracks?.length || 0);
                
                if (!recommendations || !recommendations.tracks || recommendations.tracks.length === 0) {
                    throw new Error('No recommendations returned');
                }
                
                showActivityPlaylistModal(activity, recommendations, insight);
                
                // Award XP for successful playlist generation
                awardXP(25, `AI ${activity} playlist generated! üéµ`);
                
            } catch (error) {
                console.error('‚ùå Error generating playlist:', error);
                
                let errorMessage = 'Unable to generate recommendations';
                if (error.message.includes('Token')) {
                    errorMessage = 'Please reconnect your Spotify account';
                } else if (error.message.includes('No recommendations')) {
                    errorMessage = 'No suitable tracks found. Try listening to more music on Spotify first.';
                } else if (error.message.includes('401')) {
                    errorMessage = 'Spotify authentication expired. Please reconnect.';
                } else if (error.message.includes('403')) {
                    errorMessage = 'Spotify Premium required for this feature';
                } else if (error.message.includes('429')) {
                    errorMessage = 'Too many requests. Please wait a moment and try again.';
                }
                
                showFloatingNotification('‚ö†Ô∏è Playlist Error', errorMessage);
                
                // Show a basic fallback playlist
                showFallbackPlaylist(activity);
            }
        }

        function showFallbackPlaylist(activity) {
            const fallbackPlaylists = {
                workout: [
                    { name: 'Thunder', artist: 'Imagine Dragons', emoji: '‚ö°' },
                    { name: 'Stronger', artist: 'Kanye West', emoji: 'üí™' },
                    { name: 'Eye of the Tiger', artist: 'Survivor', emoji: 'üêÖ' },
                    { name: 'Can\'t Hold Us', artist: 'Macklemore', emoji: 'üî•' },
                    { name: 'Till I Collapse', artist: 'Eminem', emoji: 'üéØ' }
                ],
                focus: [
                    { name: 'Weightless', artist: 'Marconi Union', emoji: 'üåä' },
                    { name: 'Clair de Lune', artist: 'Debussy', emoji: 'üåô' },
                    { name: 'Max Richter - Sleep', artist: 'Max Richter', emoji: '‚òÅÔ∏è' },
                    { name: 'Brain Food', artist: 'Various Artists', emoji: 'üß†' },
                    { name: 'Study Music', artist: 'ChilledCow', emoji: 'üìö' }
                ],
                relaxation: [
                    { name: 'Spa Relaxation', artist: 'Nature Sounds', emoji: 'üßò‚Äç‚ôÄÔ∏è' },
                    { name: 'Ocean Waves', artist: 'Nature Collection', emoji: 'üåä' },
                    { name: 'Forest Sounds', artist: 'Meditation Music', emoji: 'üå≤' },
                    { name: 'Rain Sounds', artist: 'Sleep Stories', emoji: 'üåßÔ∏è' },
                    { name: 'Meditation Music', artist: 'Zen Garden', emoji: 'üïØÔ∏è' }
                ]
            };

            const activityEmojis = {
                workout: 'üèÉ‚Äç‚ôÇÔ∏è',
                focus: 'üß†',
                relaxation: 'üòå'
            };

            const playlist = fallbackPlaylists[activity] || fallbackPlaylists.workout;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-center">${activityEmojis[activity]} ${activity.charAt(0).toUpperCase() + activity.slice(1)} Music Ideas</h3>
                    
                    <div class="bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded-lg mb-6">
                        <h4 class="font-bold mb-2 text-yellow-700 dark:text-yellow-300">üí° Music Suggestions</h4>
                        <div class="text-sm text-yellow-600 dark:text-yellow-400">
                            Here are some popular ${activity} tracks to search for on your music platform:
                        </div>
                    </div>
                    
                    <div class="space-y-3 mb-6">
                        ${playlist.map(track => `
                            <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="text-2xl">${track.emoji}</div>
                                <div class="flex-1">
                                    <div class="font-medium">${track.name}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">${track.artist}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg mb-4">
                        <div class="text-sm text-blue-600 dark:text-blue-400">
                            üí° Tip: Connect your Spotify account to get personalized AI recommendations based on your actual listening history!
                        </div>
                    </div>
                    
                    <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                        Close
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function getWorkoutRecommendations() {
            console.log('üéµ Getting workout recommendations...');
            
            // Check if we have enough top tracks
            if (!spotifyState.topTracks?.items || spotifyState.topTracks.items.length === 0) {
                console.log('‚ö†Ô∏è No top tracks available, using genre seeds');
                return await getGenreBasedRecommendations('workout');
            }
            
            try {
                const seedTracks = spotifyState.topTracks.items
                    .slice(0, Math.min(5, spotifyState.topTracks.items.length))
                    .map(track => track.id)
                    .join(',');
                
                console.log('üéµ Using seed tracks:', seedTracks);
                
                const recommendations = await makeSpotifyRequest(
                    `https://api.spotify.com/v1/recommendations?seed_tracks=${seedTracks}&target_energy=0.8&target_danceability=0.7&min_tempo=120&limit=20`
                );
                
                console.log('‚úÖ Workout recommendations received:', recommendations.tracks?.length || 0);
                return recommendations;
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Track-based recommendations failed, trying genre-based:', error);
                return await getGenreBasedRecommendations('workout');
            }
        }

        async function getFocusRecommendations() {
            console.log('üéµ Getting focus recommendations...');
            
            if (!spotifyState.topTracks?.items || spotifyState.topTracks.items.length === 0) {
                console.log('‚ö†Ô∏è No top tracks available, using genre seeds');
                return await getGenreBasedRecommendations('focus');
            }
            
            try {
                const seedTracks = spotifyState.topTracks.items
                    .slice(0, Math.min(5, spotifyState.topTracks.items.length))
                    .map(track => track.id)
                    .join(',');
                
                console.log('üéµ Using seed tracks:', seedTracks);
                
                const recommendations = await makeSpotifyRequest(
                    `https://api.spotify.com/v1/recommendations?seed_tracks=${seedTracks}&target_energy=0.3&target_valence=0.5&max_tempo=100&target_instrumentalness=0.7&limit=20`
                );
                
                console.log('‚úÖ Focus recommendations received:', recommendations.tracks?.length || 0);
                return recommendations;
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Track-based recommendations failed, trying genre-based:', error);
                return await getGenreBasedRecommendations('focus');
            }
        }

        async function getRelaxationRecommendations() {
            console.log('üéµ Getting relaxation recommendations...');
            
            if (!spotifyState.topTracks?.items || spotifyState.topTracks.items.length === 0) {
                console.log('‚ö†Ô∏è No top tracks available, using genre seeds');
                return await getGenreBasedRecommendations('relaxation');
            }
            
            try {
                const seedTracks = spotifyState.topTracks.items
                    .slice(0, Math.min(5, spotifyState.topTracks.items.length))
                    .map(track => track.id)
                    .join(',');
                
                console.log('üéµ Using seed tracks:', seedTracks);
                
                const recommendations = await makeSpotifyRequest(
                    `https://api.spotify.com/v1/recommendations?seed_tracks=${seedTracks}&target_energy=0.2&target_valence=0.6&max_tempo=80&target_acousticness=0.8&limit=20`
                );
                
                console.log('‚úÖ Relaxation recommendations received:', recommendations.tracks?.length || 0);
                return recommendations;
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Track-based recommendations failed, trying genre-based:', error);
                return await getGenreBasedRecommendations('relaxation');
            }
        }

        async function getGenreBasedRecommendations(activity) {
            console.log('üéµ Getting genre-based recommendations for:', activity);
            
            const genreSeeds = {
                workout: ['pop', 'hip-hop', 'electronic', 'rock', 'dance'],
                focus: ['ambient', 'classical', 'chill', 'instrumental', 'jazz'],
                relaxation: ['ambient', 'new-age', 'acoustic', 'folk', 'classical']
            };
            
            const targetAttributes = {
                workout: { target_energy: 0.8, target_danceability: 0.7, min_tempo: 120 },
                focus: { target_energy: 0.3, target_valence: 0.5, max_tempo: 100, target_instrumentalness: 0.7 },
                relaxation: { target_energy: 0.2, target_valence: 0.6, max_tempo: 80, target_acousticness: 0.8 }
            };
            
            try {
                const genres = genreSeeds[activity] || genreSeeds.workout;
                const seedGenres = genres.slice(0, 5).join(',');
                const attributes = targetAttributes[activity] || targetAttributes.workout;
                
                const params = new URLSearchParams({
                    seed_genres: seedGenres,
                    limit: '20',
                    ...attributes
                });
                
                console.log('üéµ Using genre seeds:', seedGenres);
                const recommendations = await makeSpotifyRequest(
                    `https://api.spotify.com/v1/recommendations?${params.toString()}`
                );
                
                console.log('‚úÖ Genre-based recommendations received:', recommendations.tracks?.length || 0);
                return recommendations;
                
            } catch (error) {
                console.error('‚ùå Genre-based recommendations also failed:', error);
                return { tracks: [] };
            }
        }

        function showActivityPlaylistModal(activity, recommendations, insight) {
            const activityEmojis = {
                workout: 'üèÉ‚Äç‚ôÇÔ∏è',
                focus: 'üß†',
                relaxation: 'üòå'
            };
            
            const activityNames = {
                workout: 'Workout',
                focus: 'Focus',
                relaxation: 'Relaxation'
            };
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4 text-center">${activityEmojis[activity]} AI ${activityNames[activity]} Playlist</h3>
                    
                    <div class="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg mb-6">
                        <h4 class="font-bold mb-2 text-purple-700 dark:text-purple-300">üß† AI Insight</h4>
                        <div class="text-sm text-purple-600 dark:text-purple-400">${insight}</div>
                    </div>
                    
                    <div class="space-y-3 mb-6 max-h-64 overflow-y-auto">
                        ${recommendations.tracks?.map(track => `
                            <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600">
                                <div class="w-12 h-12 bg-gray-300 dark:bg-gray-600 rounded flex items-center justify-center">
                                    ${track.album.images.length > 0 ? `<img src="${track.album.images[2]?.url || track.album.images[0].url}" alt="Album" class="w-full h-full object-cover rounded">` : 'üéµ'}
                                </div>
                                <div class="flex-1">
                                    <div class="font-medium">${track.name}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">${track.artists.map(a => a.name).join(', ')}</div>
                                </div>
                                <button onclick="playTrack('${track.uri}')" class="text-green-500 hover:text-green-600">
                                    ‚ñ∂Ô∏è
                                </button>
                            </div>
                        `).join('') || '<div class="text-center text-gray-500">No recommendations available</div>'}
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="createSpotifyPlaylist('${activity}', ${JSON.stringify(recommendations.tracks?.map(t => t.uri) || []).replace(/"/g, '&quot;')})" class="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600">
                            üéµ Create Playlist
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function playTrack(uri) {
            if (!spotifyState.isConnected) {
                showFloatingNotification('üéµ Not Connected', 'Connect Spotify to play tracks');
                return;
            }
            
            try {
                await makeSpotifyRequest('https://api.spotify.com/v1/me/player/play', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uris: [uri] })
                });
                
                showFloatingNotification('üéµ Playing Track', 'Track started playing on your Spotify device');
                awardXP(10, 'AI music recommendation played! üéµ');
                
                setTimeout(getCurrentlyPlaying, 1000);
                
            } catch (error) {
                console.error('Error playing track:', error);
                showFloatingNotification('‚ö†Ô∏è Play Error', 'Unable to play track. Make sure Spotify is open on a device.');
            }
        }

        async function createSpotifyPlaylist(activity, trackUris) {
            if (!spotifyState.isConnected || !spotifyState.userProfile) {
                showFloatingNotification('üéµ Not Connected', 'Connect Spotify to create playlists');
                return;
            }
            
            try {
                const playlistName = `Life Quest ${activity.charAt(0).toUpperCase() + activity.slice(1)} - ${new Date().toLocaleDateString()}`;
                
                // Create playlist
                const playlist = await makeSpotifyRequest(`https://api.spotify.com/v1/users/${spotifyState.userProfile.id}/playlists`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: playlistName,
                        description: `AI-generated ${activity} playlist from Life Quest RPG`,
                        public: false
                    })
                });
                
                // Add tracks
                if (trackUris.length > 0) {
                    await makeSpotifyRequest(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ uris: trackUris })
                    });
                }
                
                showFloatingNotification('üéµ Playlist Created!', `"${playlistName}" saved to your Spotify`);
                awardXP(50, 'AI playlist created! üéµ');
                
                addAchievement('üéµ Playlist Creator', 'Created your first AI-generated playlist!', 75);
                
                document.querySelector('.fixed')?.remove();
                
            } catch (error) {
                console.error('Error creating playlist:', error);
                showFloatingNotification('‚ö†Ô∏è Playlist Error', 'Unable to create playlist');
            }
        }

        function updateMusicAnalytics() {
            const analyticsContainer = document.getElementById('musicAnalytics');
            if (!analyticsContainer) {
                console.log('‚ö†Ô∏è Music analytics container not found');
                return;
            }
            
            console.log('üéµ Updating music analytics...', {
                isConnected: spotifyState.isConnected,
                topTracks: spotifyState.topTracks?.items?.length || 0,
                topArtists: spotifyState.topArtists?.items?.length || 0
            });
            
            if (!spotifyState.isConnected) {
                analyticsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">üéµ</div>
                        <div>Connect Spotify to analyze your music preferences</div>
                    </div>
                `;
                return;
            }
            
            // Check if we have data
            if (!spotifyState.topArtists?.items || !spotifyState.topTracks?.items) {
                analyticsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">üîÑ</div>
                        <div>Loading your music data...</div>
                        <div class="text-xs mt-2">This may take a moment</div>
                    </div>
                `;
                return;
            }
            
            const topGenres = {};
            if (spotifyState.topArtists.items && spotifyState.topArtists.items.length > 0) {
                spotifyState.topArtists.items.forEach(artist => {
                    if (artist.genres && artist.genres.length > 0) {
                        artist.genres.forEach(genre => {
                            topGenres[genre] = (topGenres[genre] || 0) + 1;
                        });
                    }
                });
            }
            
            const sortedGenres = Object.entries(topGenres)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            console.log('üéµ Top genres found:', sortedGenres);
            
            analyticsContainer.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg">
                        <h4 class="font-bold mb-2 text-green-700 dark:text-green-300">üéµ Your Music Profile</h4>
                        <div class="text-sm text-green-600 dark:text-green-400">
                            ${sortedGenres.length > 0 ? 
                                `Top Genres: ${sortedGenres.map(([genre]) => genre).slice(0, 3).join(', ')}${sortedGenres.length > 3 ? ' +more' : ''}` : 
                                'No genre data available yet - keep listening!'
                            }
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">${spotifyState.topTracks?.items?.length || 0}</div>
                            <div class="text-sm text-blue-500">Top Tracks</div>
                        </div>
                        <div class="bg-purple-50 dark:bg-purple-900/30 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600">${spotifyState.topArtists?.items?.length || 0}</div>
                            <div class="text-sm text-purple-500">Top Artists</div>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 dark:bg-orange-900/30 p-4 rounded-lg">
                        <h4 class="font-bold mb-2 text-orange-700 dark:text-orange-300">ü§ñ AI Analysis</h4>
                        <div class="text-sm text-orange-600 dark:text-orange-400">
                            ${spotifyState.musicPreferences && (spotifyState.musicPreferences.workoutGenres.length > 0 || spotifyState.musicPreferences.focusGenres.length > 0) ? 
                                `Your music taste shows preferences for ${spotifyState.musicPreferences.workoutGenres.length > 0 ? 'high-energy workout music' : 'diverse genres'}. 
                                Perfect for ${spotifyState.musicPreferences.focusGenres.length > 0 ? 'focus sessions and ' : ''}
                                ${spotifyState.musicPreferences.relaxationGenres.length > 0 ? 'relaxation' : 'various activities'}.` :
                                spotifyState.topTracks?.items?.length > 0 ? 
                                'Your music preferences have been analyzed! Try generating an AI playlist for specific activities.' :
                                'Keep listening to build your music profile for better AI recommendations!'
                            }
                        </div>
                    </div>
                    
                    ${spotifyState.topTracks?.items?.length === 0 ? `
                        <div class="bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-2 text-yellow-700 dark:text-yellow-300">üí° Tip</h4>
                            <div class="text-sm text-yellow-600 dark:text-yellow-400">
                                No listening history found. Listen to music on Spotify for a few days, then refresh your data to get AI recommendations!
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            console.log('‚úÖ Music analytics updated successfully');
        }

        function updateMusicRecommendations() {
            const recommendationElement = document.getElementById('musicRecommendation');
            if (!recommendationElement || !spotifyState.isConnected) return;
            
            const hour = new Date().getHours();
            let recommendation = '';
            
            if (hour < 10) {
                recommendation = 'Start your day with energizing music! Try our AI workout playlist to boost your morning energy.';
            } else if (hour < 14) {
                recommendation = 'Perfect time for productive focus! Our AI focus playlist can enhance your concentration.';
            } else if (hour < 18) {
                recommendation = 'Afternoon energy boost time! High-energy tracks can help power through your tasks.';
            } else if (hour < 22) {
                recommendation = 'Evening workout or relaxation? We have AI playlists for both activities based on your preferences.';
            } else {
                recommendation = 'Wind down with our AI relaxation playlist - specially curated for your taste in calming music.';
            }
            
            recommendationElement.textContent = recommendation;
        }

        function checkMusicAchievements() {
            if (!spotifyState.isConnected) return;
            
            // Connection achievement
            if (!gameState.achievements.find(a => a.title.includes('Music Connected'))) {
                addAchievement('üéµ Music Connected', 'Successfully connected your Spotify account!', 50);
            }
            
            // Data analysis achievement
            if (spotifyState.topTracks.items?.length > 0 && !gameState.achievements.find(a => a.title.includes('Music Analyzed'))) {
                addAchievement('üìä Music Analyzed', 'AI has analyzed your music preferences!', 30);
            }
        }

        function checkMusicListeningAchievements(track) {
            if (!track) return;
            
            // Listening achievements could be added here
            // For example, achievements for listening to recommended tracks, different genres, etc.
        }

        async function generateWorkoutPlaylist() {
            if (!spotifyState.isConnected) {
                showFloatingNotification('üéµ Not Connected', 'Connect Spotify to generate playlists');
                return;
            }
            
            generateActivityPlaylist('workout');
        }

        function refreshSpotifyData() {
            if (!spotifyState.isConnected) {
                showFloatingNotification('üéµ Not Connected', 'Connect Spotify first');
                return;
            }
            
            initializeSpotifyData();
            showFloatingNotification('üîÑ Refreshing...', 'Updating your Spotify data');
        }

        function disconnectSpotify() {
            // Clear all Spotify data
            spotifyState = {
                accessToken: null,
                refreshToken: null,
                expiresAt: null,
                clientId: null,
                isConnected: false,
                currentTrack: null,
                userProfile: null,
                topTracks: [],
                topArtists: [],
                recentlyPlayed: [],
                musicPreferences: {
                    workoutGenres: [],
                    focusGenres: [],
                    relaxationGenres: [],
                    tempo: { min: 60, max: 180 },
                    energy: { min: 0.3, max: 1.0 }
                }
            };
            
            // Clear localStorage
            localStorage.removeItem('spotify_access_token');
            localStorage.removeItem('spotify_refresh_token');
            localStorage.removeItem('spotify_expires_at');
            localStorage.removeItem('spotify_client_id');
            localStorage.removeItem('spotify_music_preferences');
            
            updateSpotifyUI();
            showFloatingNotification('üö´ Spotify Disconnected', 'Your Spotify account has been disconnected');
        }

        // üì±‚û°Ô∏èüíª WEB PLAYBACK TRANSFER SYSTEM
        let webPlayerInstance = null;
        let deviceId = null;
        let webPlayerReady = false;
        let webPlayerActive = false;

        window.onSpotifyWebPlaybackSDKReady = () => {
            console.log('üéµ Spotify Web Playback SDK Ready');
            if (spotifyState.isConnected) {
                initializeWebPlayer();
            }
        };

        function initializeWebPlayer() {
            if (!spotifyState.accessToken || webPlayerInstance) {
                console.log('üéµ Cannot initialize web player:', !spotifyState.accessToken ? 'No access token' : 'Already initialized');
                return;
            }
            
            console.log('üéµ Initializing Spotify Web Player...');
            
            webPlayerInstance = new Spotify.Player({
                name: 'Life Quest RPG Web Player',
                getOAuthToken: cb => { 
                    console.log('üéµ Web Player requesting token...');
                    cb(spotifyState.accessToken); 
                },
                volume: 0.5
            });

            // Error handling with better feedback
            webPlayerInstance.addListener('initialization_error', ({ message }) => {
                console.error('üö´ Web Player initialization error:', message);
                showFloatingNotification('‚ùå Web Player Error', `Initialization failed: ${message}`);
            });

            webPlayerInstance.addListener('authentication_error', ({ message }) => {
                console.error('üö´ Web Player authentication error:', message);
                showFloatingNotification('‚ùå Auth Error', 'Web player authentication failed. Try reconnecting Spotify.');
                // Try to refresh token
                refreshSpotifyToken().then(() => {
                    console.log('üîÑ Token refreshed, retrying web player...');
                    initializeWebPlayer();
                }).catch(err => {
                    console.error('Failed to refresh token:', err);
                });
            });

            webPlayerInstance.addListener('account_error', ({ message }) => {
                console.error('üö´ Web Player account error:', message);
                showFloatingNotification('‚ùå Account Error', 'Spotify Premium required for web playback');
            });

            webPlayerInstance.addListener('playback_error', ({ message }) => {
                console.error('üö´ Web Player playback error:', message);
                showFloatingNotification('‚ö†Ô∏è Playback Error', `Playback failed: ${message}`);
            });

            // Playback status updates
            webPlayerInstance.addListener('player_state_changed', (state) => {
                console.log('üéµ Player state changed:', state);
                if (!state) {
                    console.log('üéµ No playback state');
                    return;
                }
                
                webPlayerActive = true;
                updatePlayerUI({
                    item: state.track_window.current_track,
                    is_playing: !state.paused,
                    progress_ms: state.position,
                    duration_ms: state.track_window.current_track.duration_ms
                });
            });

            // Ready
            webPlayerInstance.addListener('ready', ({ device_id }) => {
                console.log('‚úÖ Web Player ready with Device ID:', device_id);
                deviceId = device_id;
                webPlayerReady = true;
                showTransferButton();
                showFloatingNotification('üéµ Web Player Ready!', 'You can now transfer playback to the app');
            });

            // Not Ready
            webPlayerInstance.addListener('not_ready', ({ device_id }) => {
                console.log('üö´ Web Player device offline:', device_id);
                webPlayerReady = false;
                webPlayerActive = false;
                hideTransferButton();
            });

            // Connect to the player
            webPlayerInstance.connect().then(success => {
                if (success) {
                    console.log('‚úÖ Web Player connected successfully');
                } else {
                    console.error('üö´ Web Player connection failed');
                    showFloatingNotification('‚ùå Connection Failed', 'Could not connect to Spotify Web Player');
                }
            });
        }

        function showTransferButton() {
            const transferButton = document.getElementById('transferButton');
            
            if (transferButton && webPlayerReady) {
                transferButton.style.display = 'block';
                transferButton.textContent = 'üì±‚û°Ô∏èüíª Transfer to Web Player';
                console.log('üéµ Transfer button shown');
            }
        }

        function hideTransferButton() {
            const transferButton = document.getElementById('transferButton');
            const webPlayerStatus = document.getElementById('webPlayerStatus');
            
            if (transferButton) {
                transferButton.style.display = 'none';
            }
            if (webPlayerStatus) {
                webPlayerStatus.style.display = 'none';
            }
        }

        async function transferToWebPlayer() {
            if (!webPlayerReady || !deviceId) {
                showFloatingNotification('‚ùå Web Player Error', 'Web player not ready. Please wait a moment and try again.');
                return;
            }

            const transferButton = document.getElementById('transferButton');
            if (transferButton) {
                transferButton.textContent = 'üîÑ Transferring...';
                transferButton.disabled = true;
            }

            try {
                console.log('üéµ Attempting to transfer playback to device:', deviceId);
                
                // First, try to get available devices to verify our device exists
                const devices = await makeSpotifyRequest('https://api.spotify.com/v1/me/player/devices');
                console.log('üéµ Available devices:', devices);
                
                const ourDevice = devices.devices.find(d => d.id === deviceId);
                if (!ourDevice) {
                    throw new Error('Web player device not found in devices list');
                }

                // Transfer playback to our device
                const transferResponse = await fetch('https://api.spotify.com/v1/me/player', {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${spotifyState.accessToken}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        device_ids: [deviceId],
                        play: false
                    })
                });

                if (!transferResponse.ok) {
                    if (transferResponse.status === 404) {
                        throw new Error('No active playback session found. Start playing music on Spotify first.');
                    } else if (transferResponse.status === 403) {
                        throw new Error('Spotify Premium required for device transfer');
                    } else {
                        throw new Error(`Transfer failed with status: ${transferResponse.status}`);
                    }
                }

                console.log('‚úÖ Transfer successful');

                const webPlayerStatus = document.getElementById('webPlayerStatus');
                
                if (webPlayerStatus) {
                    webPlayerStatus.style.display = 'block';
                    webPlayerStatus.textContent = 'Web player active - control music directly in the app!';
                    webPlayerStatus.className = 'text-xs text-green-600';
                }
                
                if (transferButton) {
                    transferButton.style.display = 'none';
                }

                webPlayerActive = true;
                showFloatingNotification('üì±‚û°Ô∏èüíª Transfer Complete!', 'Spotify playback transferred to web player');
                awardXP(25, 'Spotify web player activated! üéµ');
                
                // Refresh current track info after a short delay
                setTimeout(() => {
                    getCurrentlyPlaying();
                    // Also try to get state from web player directly
                    if (webPlayerInstance) {
                        webPlayerInstance.getCurrentState().then(state => {
                            if (state) {
                                console.log('üéµ Web player state:', state);
                                updatePlayerUI({
                                    item: state.track_window.current_track,
                                    is_playing: !state.paused,
                                    progress_ms: state.position,
                                    duration_ms: state.track_window.current_track.duration_ms
                                });
                            }
                        });
                    }
                }, 2000);

            } catch (error) {
                console.error('üö´ Transfer error:', error);
                showFloatingNotification('‚ùå Transfer Failed', error.message || 'Unable to transfer playback to web player');
                
                // Reset button
                if (transferButton) {
                    transferButton.textContent = 'üì±‚û°Ô∏èüíª Transfer to Web Player';
                    transferButton.disabled = false;
                    transferButton.style.display = 'block';
                }
            }
        }

        // ü•ó NUTRITION SYSTEM EXPANSIONS
        function quickLogMeal() {
            logMeal(); // Use existing function
        }

        function quickAddMeal(mealType) {
            const mealSuggestions = {
                breakfast: [
                    { name: 'Oatmeal with berries', calories: 300, protein: 8, carbs: 45, fat: 8 },
                    { name: 'Greek yogurt parfait', calories: 250, protein: 15, carbs: 30, fat: 6 },
                    { name: 'Avocado toast', calories: 350, protein: 10, carbs: 35, fat: 18 },
                    { name: 'Protein smoothie', calories: 280, protein: 25, carbs: 20, fat: 8 }
                ],
                lunch: [
                    { name: 'Grilled chicken salad', calories: 400, protein: 30, carbs: 15, fat: 20 },
                    { name: 'Quinoa bowl', calories: 450, protein: 18, carbs: 55, fat: 15 },
                    { name: 'Turkey sandwich', calories: 380, protein: 25, carbs: 40, fat: 12 },
                    { name: 'Soup and salad', calories: 320, protein: 12, carbs: 35, fat: 10 }
                ],
                dinner: [
                    { name: 'Salmon with vegetables', calories: 420, protein: 35, carbs: 20, fat: 22 },
                    { name: 'Chicken stir-fry', calories: 380, protein: 28, carbs: 35, fat: 15 },
                    { name: 'Lean beef with sweet potato', calories: 450, protein: 32, carbs: 40, fat: 18 },
                    { name: 'Vegetarian curry', calories: 350, protein: 15, carbs: 45, fat: 12 }
                ]
            };

            const suggestions = mealSuggestions[mealType] || [];
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 capitalize">üçΩÔ∏è ${mealType} Options</h3>
                    <div class="space-y-3 mb-6">
                        ${suggestions.map((meal, index) => `
                            <button onclick="addQuickMeal('${mealType}', ${index})" class="w-full text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                                <div class="font-medium">${meal.name}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">
                                    ${meal.calories} cal ‚Ä¢ ${meal.protein}g protein ‚Ä¢ ${meal.carbs}g carbs ‚Ä¢ ${meal.fat}g fat
                                </div>
                            </button>
                        `).join('')}
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="this.closest('.fixed').remove(); quickLogMeal()" class="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700">
                            Custom Entry
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function addQuickMeal(mealType, mealIndex) {
            const mealSuggestions = {
                breakfast: [
                    { name: 'Oatmeal with berries', calories: 300, protein: 8, carbs: 45, fat: 8 },
                    { name: 'Greek yogurt parfait', calories: 250, protein: 15, carbs: 30, fat: 6 },
                    { name: 'Avocado toast', calories: 350, protein: 10, carbs: 35, fat: 18 },
                    { name: 'Protein smoothie', calories: 280, protein: 25, carbs: 20, fat: 8 }
                ],
                lunch: [
                    { name: 'Grilled chicken salad', calories: 400, protein: 30, carbs: 15, fat: 20 },
                    { name: 'Quinoa bowl', calories: 450, protein: 18, carbs: 55, fat: 15 },
                    { name: 'Turkey sandwich', calories: 380, protein: 25, carbs: 40, fat: 12 },
                    { name: 'Soup and salad', calories: 320, protein: 12, carbs: 35, fat: 10 }
                ],
                dinner: [
                    { name: 'Salmon with vegetables', calories: 420, protein: 35, carbs: 20, fat: 22 },
                    { name: 'Chicken stir-fry', calories: 380, protein: 28, carbs: 35, fat: 15 },
                    { name: 'Lean beef with sweet potato', calories: 450, protein: 32, carbs: 40, fat: 18 },
                    { name: 'Vegetarian curry', calories: 350, protein: 15, carbs: 45, fat: 12 }
                ]
            };

            const meal = mealSuggestions[mealType][mealIndex];
            if (meal) {
                gameState.dailyStats.calories += meal.calories;
                gameState.dailyStats.protein = (gameState.dailyStats.protein || 0) + meal.protein;
                gameState.dailyStats.carbs = (gameState.dailyStats.carbs || 0) + meal.carbs;
                gameState.dailyStats.fat = (gameState.dailyStats.fat || 0) + meal.fat;
                gameState.dailyStats.meals++;

                updateAllUI();
                updateNutritionDisplay();
                saveGameState();
                awardXP(20, `${meal.name} logged! ü•ó`);

                document.querySelector('.fixed').remove();
                showFloatingNotification('üçΩÔ∏è Meal Added!', `${meal.name} - ${meal.calories} calories`);
            }
        }

        function adjustNutritionGoals() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üéØ Nutrition Goals</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Daily Calorie Target</label>
                            <input type="number" id="calorieGoal" value="${gameState.profile.calorieTarget || 2000}" min="1200" max="4000" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-2">Protein %</label>
                                <input type="number" id="proteinPercent" value="${gameState.profile.proteinPercent || 25}" min="10" max="40" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Carbs %</label>
                                <input type="number" id="carbsPercent" value="${gameState.profile.carbsPercent || 50}" min="20" max="70" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Fat %</label>
                                <input type="number" id="fatPercent" value="${gameState.profile.fatPercent || 25}" min="15" max="40" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="saveNutritionGoals()" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700">
                                Save Goals
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveNutritionGoals() {
            const calorieTarget = parseInt(document.getElementById('calorieGoal').value) || 2000;
            const proteinPercent = parseInt(document.getElementById('proteinPercent').value) || 25;
            const carbsPercent = parseInt(document.getElementById('carbsPercent').value) || 50;
            const fatPercent = parseInt(document.getElementById('fatPercent').value) || 25;

            gameState.profile.calorieTarget = calorieTarget;
            gameState.profile.proteinPercent = proteinPercent;
            gameState.profile.carbsPercent = carbsPercent;
            gameState.profile.fatPercent = fatPercent;

            updateNutritionDisplay();
            saveGameState();
            
            document.querySelector('.fixed').remove();
            showFloatingNotification('üéØ Goals Updated!', 'Nutrition targets have been set');
            awardXP(15, 'Nutrition goals customized!');
        }

        function updateNutritionDisplay() {
            const calories = gameState.dailyStats.calories || 0;
            const protein = gameState.dailyStats.protein || 0;
            const carbs = gameState.dailyStats.carbs || 0;
            const fat = gameState.dailyStats.fat || 0;
            const meals = gameState.dailyStats.meals || 0;
            const water = gameState.dailyStats.waterGlasses || 0;
            
            const target = gameState.profile.calorieTarget || 2000;
            const progress = Math.min(100, (calories / target) * 100);

            // Update nutrition elements
            const nutritionElements = {
                'nutritionCalories': calories,
                'calorieTarget': target,
                'proteinCount': `${protein}g`,
                'carbsCount': `${carbs}g`,
                'fatCount': `${fat}g`,
                'mealsCount': meals,
                'waterDaily': water,
                'snacksCount': 0, // Placeholder
                'mealStreak': 0, // Placeholder
                'hydrationProgress': `${water}/8`,
                'weeklyAverage': Math.round(calories) // Simplified
            };

            Object.entries(nutritionElements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });

            // Update progress bar
            const progressElement = document.getElementById('caloriesProgress');
            if (progressElement) {
                progressElement.style.width = `${progress}%`;
            }

            // Update status
            const statusElement = document.getElementById('caloriesStatus');
            if (statusElement) {
                if (progress >= 100) {
                    statusElement.textContent = `üéâ Daily goal achieved! ${calories - target} calories over target.`;
                } else if (progress >= 75) {
                    statusElement.textContent = `üî• Almost there! ${target - calories} calories to go.`;
                } else if (calories > 0) {
                    statusElement.textContent = `üí™ Good progress! ${target - calories} calories remaining.`;
                } else {
                    statusElement.textContent = 'Start tracking meals to reach your goal!';
                }
            }
        }

        function showFoodCategory(category) {
            const foods = {
                proteins: [
                    { name: 'Chicken Breast', calories: 165, protein: 31, carbs: 0, fat: 3.6 },
                    { name: 'Salmon Fillet', calories: 208, protein: 22, carbs: 0, fat: 12 },
                    { name: 'Greek Yogurt', calories: 100, protein: 17, carbs: 6, fat: 0 },
                    { name: 'Eggs (2 large)', calories: 140, protein: 12, carbs: 1, fat: 10 }
                ],
                grains: [
                    { name: 'Brown Rice (1 cup)', calories: 216, protein: 5, carbs: 45, fat: 1.8 },
                    { name: 'Quinoa (1 cup)', calories: 222, protein: 8, carbs: 39, fat: 3.6 },
                    { name: 'Oatmeal (1 cup)', calories: 154, protein: 6, carbs: 28, fat: 3 },
                    { name: 'Whole Wheat Bread (2 slices)', calories: 160, protein: 8, carbs: 28, fat: 2 }
                ],
                vegetables: [
                    { name: 'Broccoli (1 cup)', calories: 25, protein: 3, carbs: 5, fat: 0.3 },
                    { name: 'Spinach (2 cups)', calories: 14, protein: 2, carbs: 2, fat: 0.2 },
                    { name: 'Sweet Potato (medium)', calories: 112, protein: 2, carbs: 26, fat: 0.1 },
                    { name: 'Bell Peppers (1 cup)', calories: 30, protein: 1, carbs: 7, fat: 0.3 }
                ],
                fruits: [
                    { name: 'Apple (medium)', calories: 95, protein: 0.5, carbs: 25, fat: 0.3 },
                    { name: 'Banana (medium)', calories: 105, protein: 1.3, carbs: 27, fat: 0.4 },
                    { name: 'Berries (1 cup)', calories: 84, protein: 1, carbs: 21, fat: 0.5 },
                    { name: 'Orange (medium)', calories: 62, protein: 1.2, carbs: 15, fat: 0.2 }
                ]
            };

            const categoryEmojis = {
                proteins: 'üçñ',
                grains: 'üåæ',
                vegetables: 'ü•¨',
                fruits: 'üçé'
            };

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center">${categoryEmojis[category]} ${category.charAt(0).toUpperCase() + category.slice(1)}</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${foods[category].map((food, index) => `
                            <div class="border rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700">
                                <div class="font-bold mb-2">${food.name}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                    ${food.calories} cal ‚Ä¢ ${food.protein}g protein ‚Ä¢ ${food.carbs}g carbs ‚Ä¢ ${food.fat}g fat
                                </div>
                                <button onclick="addFoodToMeal('${category}', ${index})" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 text-sm">
                                    Add to Today's Meals
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="flex justify-center mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function addFoodToMeal(category, foodIndex) {
            const foods = {
                proteins: [
                    { name: 'Chicken Breast', calories: 165, protein: 31, carbs: 0, fat: 3.6 },
                    { name: 'Salmon Fillet', calories: 208, protein: 22, carbs: 0, fat: 12 },
                    { name: 'Greek Yogurt', calories: 100, protein: 17, carbs: 6, fat: 0 },
                    { name: 'Eggs (2 large)', calories: 140, protein: 12, carbs: 1, fat: 10 }
                ],
                grains: [
                    { name: 'Brown Rice (1 cup)', calories: 216, protein: 5, carbs: 45, fat: 1.8 },
                    { name: 'Quinoa (1 cup)', calories: 222, protein: 8, carbs: 39, fat: 3.6 },
                    { name: 'Oatmeal (1 cup)', calories: 154, protein: 6, carbs: 28, fat: 3 },
                    { name: 'Whole Wheat Bread (2 slices)', calories: 160, protein: 8, carbs: 28, fat: 2 }
                ],
                vegetables: [
                    { name: 'Broccoli (1 cup)', calories: 25, protein: 3, carbs: 5, fat: 0.3 },
                    { name: 'Spinach (2 cups)', calories: 14, protein: 2, carbs: 2, fat: 0.2 },
                    { name: 'Sweet Potato (medium)', calories: 112, protein: 2, carbs: 26, fat: 0.1 },
                    { name: 'Bell Peppers (1 cup)', calories: 30, protein: 1, carbs: 7, fat: 0.3 }
                ],
                fruits: [
                    { name: 'Apple (medium)', calories: 95, protein: 0.5, carbs: 25, fat: 0.3 },
                    { name: 'Banana (medium)', calories: 105, protein: 1.3, carbs: 27, fat: 0.4 },
                    { name: 'Berries (1 cup)', calories: 84, protein: 1, carbs: 21, fat: 0.5 },
                    { name: 'Orange (medium)', calories: 62, protein: 1.2, carbs: 15, fat: 0.2 }
                ]
            };

            const food = foods[category][foodIndex];
            if (food) {
                gameState.dailyStats.calories += food.calories;
                gameState.dailyStats.protein = (gameState.dailyStats.protein || 0) + food.protein;
                gameState.dailyStats.carbs = (gameState.dailyStats.carbs || 0) + food.carbs;
                gameState.dailyStats.fat = (gameState.dailyStats.fat || 0) + food.fat;

                updateAllUI();
                updateNutritionDisplay();
                saveGameState();
                awardXP(10, `${food.name} added! ü•ó`);

                document.querySelector('.fixed').remove();
                showFloatingNotification('üçΩÔ∏è Food Added!', `${food.name} - ${food.calories} calories`);
            }
        }

        function generateWeeklyMealPlan() {
            const mealPlan = [
                { day: 'Monday', breakfast: 'Protein oats with berries', lunch: 'Grilled chicken salad', dinner: 'Salmon with quinoa' },
                { day: 'Tuesday', breakfast: 'Greek yogurt parfait', lunch: 'Turkey wrap', dinner: 'Chicken stir-fry' },
                { day: 'Wednesday', breakfast: 'Smoothie bowl', lunch: 'Quinoa Buddha bowl', dinner: 'Lean beef with sweet potato' },
                { day: 'Thursday', breakfast: 'Avocado toast', lunch: 'Chicken soup', dinner: 'Fish tacos' },
                { day: 'Friday', breakfast: 'Protein pancakes', lunch: 'Mediterranean salad', dinner: 'Vegetarian curry' },
                { day: 'Saturday', breakfast: 'Egg scramble', lunch: 'Grain bowl', dinner: 'Grilled chicken with vegetables' },
                { day: 'Sunday', breakfast: 'Chia pudding', lunch: 'Soup and sandwich', dinner: 'Sunday roast with vegetables' }
            ];

            const container = document.getElementById('weeklyMealPlan');
            if (!container) return;

            container.innerHTML = mealPlan.map(day => `
                <div class="border rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <div class="font-bold mb-2">${day.day}</div>
                    <div class="text-sm space-y-1">
                        <div>üåÖ Breakfast: ${day.breakfast}</div>
                        <div>ü•ô Lunch: ${day.lunch}</div>
                        <div>üçΩÔ∏è Dinner: ${day.dinner}</div>
                    </div>
                </div>
            `).join('');

            showFloatingNotification('üìÖ Meal Plan Generated!', 'Your weekly meal plan is ready');
            awardXP(30, 'Weekly meal plan generated! üìÖ');
        }

        // üöÄ START THE APPLICATION
        window.addEventListener('load', () => {
            initializeApp();
            loadSpotifyState();
            handleSpotifyCallback();
            
            // Initialize Spotify Web Player when SDK is ready
            if (window.Spotify) {
                window.onSpotifyWebPlaybackSDKReady();
            }
        });
        
        // Listen for health data from iOS shortcuts
        window.addEventListener('focus', () => {
            checkForHealthData();
        });
        
        window.addEventListener('popstate', () => {
            checkForHealthData();
        });
    </script>
</body>
</html>
