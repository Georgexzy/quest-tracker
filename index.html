<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Quest RPG - Ultimate AI Edition with Spotify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        fitness: '#ef4444',
                        nutrition: '#16a34a',
                        hydration: '#3b82f6',
                        wellness: '#a855f7',
                        focus: '#f59e0b',
                        personal: '#6366f1',
                        spotify: '#1DB954'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-primary to-purple-600 text-white">
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold">üéÆ Life Quest RPG</h1>
                        <p class="opacity-90">Ultimate AI Edition with Spotify Integration</p>
                    </div>
                    <div class="text-right">
                        <div id="levelDisplay" class="text-2xl font-bold">Level 1</div>
                        <div id="xpDisplay" class="text-sm opacity-90">0 / 100 XP</div>
                    </div>
                </div>
                
                <!-- XP Progress Bar -->
                <div class="mt-4 bg-white/20 rounded-full h-3 overflow-hidden">
                    <div id="xpProgress" class="bg-white h-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </header>

        <!-- AI Insights -->
        <div class="container mx-auto px-4 py-4">
            <div id="aiInsights"></div>
        </div>

        <!-- Navigation -->
        <nav class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-10">
            <div class="container mx-auto px-4">
                <div class="flex space-x-1 overflow-x-auto">
                    <button onclick="switchTab('tasks')" class="tab-button active px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üéØ Quests
                    </button>
                    <button onclick="switchTab('health')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üí™ Health
                    </button>
                    <button onclick="switchTab('music')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        üéµ Music
                    </button>
                    <button onclick="switchTab('settings')" class="tab-button px-4 py-3 text-white/80 hover:text-white font-medium whitespace-nowrap">
                        ‚öôÔ∏è Settings
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-6">
            <!-- Tasks Tab -->
            <div id="tasks-tab" class="tab-content active">
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <div class="xl:col-span-2 space-y-6">
                        <!-- Task Management -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold">üéØ Today's Quests</h3>
                                <div class="flex space-x-2">
                                    <button onclick="showAddTaskModal()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors text-sm">
                                        ‚ûï Add Quest
                                    </button>
                                    <button onclick="generateAITasks()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm">
                                        üß† AI Generate
                                    </button>
                                </div>
                            </div>
                            <div id="tasksListDetailed" class="space-y-3">
                                <!-- Tasks will be populated here -->
                            </div>
                        </div>

                        <!-- Achievements -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üèÜ Recent Achievements</h3>
                            <div id="achievementsListDetailed" class="space-y-3">
                                <!-- Achievements will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Quick Actions -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">‚ö° Quick Actions</h3>
                            <div class="grid grid-cols-1 gap-3">
                                <button onclick="completeTask('workout')" class="w-full text-left px-4 py-3 bg-fitness/10 dark:bg-fitness/20 rounded-lg hover:bg-fitness/20 dark:hover:bg-fitness/30">
                                    <div class="font-medium text-fitness">üí™ Log Workout</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">+25 XP</div>
                                </button>
                                <button onclick="completeTask('water')" class="w-full text-left px-4 py-3 bg-hydration/10 dark:bg-hydration/20 rounded-lg hover:bg-hydration/20 dark:hover:bg-hydration/30">
                                    <div class="font-medium text-hydration">üíß Drink Water</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">+5 XP</div>
                                </button>
                                <button onclick="startPomodoro()" class="w-full text-left px-4 py-3 bg-focus/10 dark:bg-focus/20 rounded-lg hover:bg-focus/20 dark:hover:bg-focus/30">
                                    <div class="font-medium text-focus">üçÖ Start Pomodoro</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">+15 XP per session</div>
                                </button>
                                <button onclick="completeTask('meal')" class="w-full text-left px-4 py-3 bg-nutrition/10 dark:bg-nutrition/20 rounded-lg hover:bg-nutrition/20 dark:hover:bg-nutrition/30">
                                    <div class="font-medium text-nutrition">üçé Log Healthy Meal</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">+10 XP</div>
                                </button>
                            </div>
                        </div>

                        <!-- Stats Overview -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üìä Today's Stats</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 dark:text-gray-400">üíß Water</span>
                                    <span id="waterCount" class="font-bold">0 glasses</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 dark:text-gray-400">üí™ Workouts</span>
                                    <span id="workoutCount" class="font-bold">0 sessions</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 dark:text-gray-400">üß† Focus</span>
                                    <span id="focusCount" class="font-bold">0 minutes</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 dark:text-gray-400">üçé Meals</span>
                                    <span id="mealCount" class="font-bold">0 logged</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health Tab -->
            <div id="health-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <!-- Health Dashboard -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üí™ Health Dashboard</h3>
                            <div id="healthProgressContainer" class="space-y-4">
                                <!-- Health progress will be populated here -->
                            </div>
                        </div>

                        <!-- Nutrition Tracking -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üçé Nutrition Tracker</h3>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="text-center p-3 bg-nutrition/10 dark:bg-nutrition/20 rounded-lg">
                                    <div id="caloriesDisplay" class="text-xl font-bold text-nutrition">0</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Calories</div>
                                </div>
                                <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                    <div id="proteinDisplay" class="text-xl font-bold text-blue-600">0g</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Protein</div>
                                </div>
                            </div>
                            <button onclick="showNutritionModal()" class="w-full bg-nutrition text-white py-2 rounded-lg hover:bg-green-600">
                                üìù Log Food
                            </button>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Sleep & Recovery -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üò¥ Sleep & Recovery</h3>
                            <div class="space-y-4">
                                <div class="text-center p-4 bg-wellness/10 dark:bg-wellness/20 rounded-lg">
                                    <div id="sleepDisplay" class="text-2xl font-bold text-wellness">0h</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Last Night's Sleep</div>
                                </div>
                                <button onclick="showSleepModal()" class="w-full bg-wellness text-white py-2 rounded-lg hover:bg-purple-600">
                                    üìù Log Sleep
                                </button>
                            </div>
                        </div>

                        <!-- Pomodoro Timer -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üçÖ Focus Timer</h3>
                            <div id="pomodoroDisplay" class="text-center">
                                <div id="pomodoroTime" class="text-4xl font-bold text-focus mb-4">25:00</div>
                                <div class="space-y-2">
                                    <button id="pomodoroBtn" onclick="startPomodoro()" class="w-full bg-focus text-white py-3 rounded-lg hover:bg-yellow-600 font-bold">
                                        üöÄ Start Focus Session
                                    </button>
                                    <div id="pomodoroStatus" class="text-sm text-gray-600 dark:text-gray-400"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Music Tab -->
            <div id="music-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <!-- Spotify Connection -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-3xl text-spotify">üéµ</span>
                                <div>
                                    <h3 class="text-xl font-bold">Spotify Integration</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Connect your Spotify for AI-powered music recommendations</p>
                                </div>
                            </div>
                            <div id="spotifyConnectionStatus" class="mb-4">
                                <!-- Connection status will be populated here -->
                            </div>
                            <div class="grid grid-cols-1 gap-3">
                                <button onclick="showSpotifySetup()" class="w-full text-left px-4 py-3 bg-spotify/10 dark:bg-spotify/20 rounded-lg hover:bg-spotify/20 dark:hover:bg-spotify/30">
                                    <div class="font-medium text-spotify">‚öôÔ∏è Setup Spotify</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Configure client ID and connect</div>
                                </button>
                                <button onclick="showCurrentlyPlaying()" class="w-full text-left px-4 py-3 bg-green-50 dark:bg-green-900/30 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/50">
                                    <div class="font-medium">üéµ Now Playing</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">View current track and controls</div>
                                </button>
                                <button onclick="showWorkoutMusic()" class="w-full text-left px-4 py-3 bg-red-50 dark:bg-red-900/30 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/50">
                                    <div class="font-medium">üí™ Workout Music</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">AI-curated workout playlists</div>
                                </button>
                                <button onclick="showFocusMusic()" class="w-full text-left px-4 py-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg hover:bg-yellow-100 dark:hover:bg-yellow-900/50">
                                    <div class="font-medium">üß† Focus Music</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Music for productivity sessions</div>
                                </button>
                            </div>
                        </div>

                        <!-- Music Controls -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üéõÔ∏è Music Controls</h3>
                            <div id="musicControlsContainer">
                                <!-- Music controls will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- AI Music Recommendations -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üß† AI Music Coach</h3>
                            <div id="aiMusicRecommendations" class="space-y-4">
                                <!-- AI recommendations will be populated here -->
                            </div>
                            <button onclick="generateAIMusicRecommendations()" class="w-full mt-4 bg-spotify text-white py-3 rounded-lg hover:bg-green-600">
                                Generate Smart Playlist
                            </button>
                        </div>

                        <!-- Music Stats -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üìä Music Stats</h3>
                            <div id="musicStatsContainer" class="space-y-3">
                                <!-- Music stats will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <!-- Comprehensive Profile Settings -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold">üë§ Personal Profile</h3>
                                <button onclick="showFullProfileSetup()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                    üîß Complete Setup
                                </button>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Name</label>
                                        <input type="text" id="profileName" placeholder="Enter your name" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Age</label>
                                        <input type="number" id="profileAge" min="13" max="100" placeholder="30" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Gender</label>
                                        <select id="profileGender" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                            <option value="male">Male</option>
                                            <option value="female">Female</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Height (cm)</label>
                                        <input type="number" id="profileHeight" min="100" max="250" placeholder="170" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Weight (kg)</label>
                                        <input type="number" id="profileWeight" min="30" max="200" step="0.1" placeholder="70" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Fitness Goal</label>
                                        <select id="fitnessGoal" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                            <option value="general">General Fitness</option>
                                            <option value="lose_weight">Lose Weight</option>
                                            <option value="build_muscle">Build Muscle</option>
                                            <option value="endurance">Improve Endurance</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Activity Level</label>
                                        <select id="activityLevel" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                            <option value="sedentary">Sedentary (office job)</option>
                                            <option value="light">Light (1-3 workouts/week)</option>
                                            <option value="moderate">Moderate (3-5 workouts/week)</option>
                                            <option value="active">Active (6-7 workouts/week)</option>
                                            <option value="very_active">Very Active (2x/day)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                                    <h4 class="font-bold mb-2 text-sm">üßÆ AI Calculations (Auto-Updated)</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-xs">
                                        <div class="text-center">
                                            <div id="calculatedBMR" class="font-bold text-lg text-blue-600">-</div>
                                            <div class="text-gray-600 dark:text-gray-400">BMR (cal/day)</div>
                                        </div>
                                        <div class="text-center">
                                            <div id="calculatedTDEE" class="font-bold text-lg text-green-600">-</div>
                                            <div class="text-gray-600 dark:text-gray-400">TDEE (cal/day)</div>
                                        </div>
                                        <div class="text-center">
                                            <div id="calculatedBMI" class="font-bold text-lg text-purple-600">-</div>
                                            <div class="text-gray-600 dark:text-gray-400">BMI</div>
                                        </div>
                                        <div class="text-center">
                                            <div id="calculatedProtein" class="font-bold text-lg text-orange-600">-</div>
                                            <div class="text-gray-600 dark:text-gray-400">Protein (g/day)</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button onclick="saveBasicProfile()" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-purple-600 font-bold">
                                    üíæ Save Basic Profile
                                </button>
                            </div>
                        </div>

                        <!-- Data Management -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üíæ Data Management</h3>
                            <div class="space-y-3">
                                <button onclick="exportData()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                                    üì§ Export Data
                                </button>
                                <button onclick="importData()" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">
                                    üì• Import Data
                                </button>
                                <button onclick="resetData()" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                                    üóëÔ∏è Reset All Data
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Statistics -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">üìà Statistics</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center p-3 bg-primary/10 dark:bg-primary/20 rounded-lg">
                                    <div id="settingsLevel" class="text-xl font-bold text-primary">1</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Level</div>
                                </div>
                                <div class="text-center p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg">
                                    <div id="settingsTotalXP" class="text-xl font-bold text-yellow-600">0</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Total XP</div>
                                </div>
                                <div class="text-center p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                    <div id="settingsAchievements" class="text-xl font-bold text-green-600">0</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Achievements</div>
                                </div>
                                <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                    <div id="settingsTasks" class="text-xl font-bold text-blue-600">0</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Total Tasks</div>
                                </div>
                            </div>
                        </div>

                        <!-- About -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">‚ÑπÔ∏è About</h3>
                            <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                                <p><strong>Life Quest RPG</strong> - Ultimate AI Edition with Spotify Integration</p>
                                <p>Transform your daily routine into an epic adventure with gamification, AI insights, and personalized music recommendations.</p>
                                <p class="text-xs mt-4">Version 3.0 - Enhanced AI & Spotify Integration</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Persistent Music Player -->
    <div id="persistentMusicPlayer" class="fixed bottom-4 right-4 bg-white dark:bg-gray-800 shadow-xl rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300 z-40" style="display: none;">
        <div class="p-4">
            <!-- Player Header -->
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-spotify rounded-full animate-pulse"></div>
                    <span class="text-sm font-medium text-spotify">Now Playing</span>
                </div>
                <div class="flex items-center space-x-1">
                    <button onclick="minimizeMusicPlayer()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 p-1 rounded">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 10h10a1 1 0 010 2H5a1 1 0 010-2z"/>
                        </svg>
                    </button>
                    <button onclick="closeMusicPlayer()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 p-1 rounded">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Track Info -->
            <div id="persistentTrackInfo" class="mb-3">
                <div class="flex items-center space-x-3">
                    <div id="persistentAlbumArt" class="w-12 h-12 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center text-xl">
                        üéµ
                    </div>
                    <div class="flex-1 min-w-0">
                        <div id="persistentTrackName" class="font-medium text-sm truncate">No track playing</div>
                        <div id="persistentArtistName" class="text-xs text-gray-500 dark:text-gray-400 truncate">Connect Spotify to start</div>
                    </div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="flex items-center justify-center space-x-3 mb-3">
                <button onclick="previousTrack()" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 p-1">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M8.445 14.832A1 1 0 0010 14v-2.798l5.445 3.63A1 1 0 0017 14V6a1 1 0 00-1.555-.832L10 8.798V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z"/>
                    </svg>
                </button>
                <button onclick="togglePlayPause()" id="persistentPlayBtn" class="bg-spotify text-white p-2 rounded-full hover:bg-green-600 transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                    </svg>
                </button>
                <button onclick="nextTrack()" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 p-1">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M4.555 5.168A1 1 0 003 6v8a1 1 0 001.555.832L10 11.202V14a1 1 0 001.555.832l6-4a1 1 0 000-1.664l-6-4A1 1 0 0010 6v2.798l-5.445-3.63z"/>
                    </svg>
                </button>
            </div>
            
            <!-- Progress Bar -->
            <div id="persistentProgressContainer" class="mb-2" style="display: none;">
                <div class="flex items-center space-x-2 text-xs text-gray-500">
                    <span id="persistentCurrentTime">0:00</span>
                    <div class="flex-1 bg-gray-200 dark:bg-gray-600 rounded-full h-1">
                        <div id="persistentProgressBar" class="bg-spotify h-1 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="persistentTotalTime">0:00</span>
                </div>
            </div>
            
            <!-- Mini Controls -->
            <div class="flex items-center justify-between text-xs">
                <button onclick="showCurrentlyPlaying()" class="text-spotify hover:text-green-600 font-medium">
                    View Details
                </button>
                <div class="flex items-center space-x-2">
                    <button onclick="toggleShuffle()" id="persistentShuffleBtn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        üîÄ
                    </button>
                    <button onclick="toggleRepeat()" id="persistentRepeatBtn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        üîÅ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Minimized Music Player -->
    <div id="minimizedMusicPlayer" class="fixed bottom-4 right-4 bg-spotify text-white shadow-xl rounded-full p-3 cursor-pointer hover:bg-green-600 transition-all duration-300 z-40" style="display: none;" onclick="expandMusicPlayer()">
        <div class="flex items-center space-x-2">
            <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div class="hidden sm:block">
                <div id="minimizedTrackName" class="text-xs font-medium truncate max-w-24">No track</div>
            </div>
        </div>
    </div>

    <!-- Floating Notifications -->
    <div id="notificationContainer" class="fixed top-4 right-4 space-y-2 z-50" style="pointer-events: none;">
        <!-- Notifications will be dynamically added here -->
    </div>

    <!-- Toast Notification Template -->
    <template id="notificationTemplate">
        <div class="notification-toast bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4 max-w-sm transform translate-x-full transition-transform duration-300 border-l-4" style="pointer-events: auto;">
            <div class="flex items-start space-x-3">
                <div class="notification-icon text-2xl flex-shrink-0"></div>
                <div class="flex-1 min-w-0">
                    <div class="notification-title font-bold text-sm"></div>
                    <div class="notification-message text-xs text-gray-600 dark:text-gray-400 mt-1"></div>
                    <div class="notification-progress h-1 bg-gray-200 dark:bg-gray-600 rounded-full mt-2 overflow-hidden">
                        <div class="notification-progress-bar h-full bg-current transition-all duration-100 ease-linear"></div>
                    </div>
                </div>
                <button class="notification-close text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 flex-shrink-0">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
        </div>
    </template>

    <!-- Achievement Popup -->
    <div id="achievementPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-gradient-to-br from-yellow-400 via-yellow-500 to-orange-500 p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 text-center transform scale-95 transition-transform duration-300">
            <div class="text-6xl mb-4">üèÜ</div>
            <h2 class="text-2xl font-bold text-white mb-2">Achievement Unlocked!</h2>
            <div id="achievementTitle" class="text-xl font-semibold text-yellow-100 mb-2"></div>
            <div id="achievementDescription" class="text-yellow-200 mb-4"></div>
            <div id="achievementXP" class="text-3xl font-bold text-white mb-6"></div>
            <button onclick="closeAchievementPopup()" class="bg-white text-yellow-600 px-6 py-3 rounded-lg font-bold hover:bg-yellow-50 transition-colors">
                Awesome! üéâ
            </button>
        </div>
    </div>

    <!-- Level Up Popup -->
    <div id="levelUpPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-gradient-to-br from-purple-500 via-blue-500 to-green-500 p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 text-center transform scale-95 transition-transform duration-300">
            <div class="text-6xl mb-4">üéä</div>
            <h2 class="text-3xl font-bold text-white mb-2">LEVEL UP!</h2>
            <div id="levelUpNumber" class="text-5xl font-bold text-white mb-4"></div>
            <div class="text-xl text-purple-100 mb-6">You're getting stronger!</div>
            <div class="bg-white/20 rounded-lg p-4 mb-6">
                <div class="text-sm text-purple-100 mb-2">Next Level Progress</div>
                <div class="bg-white/30 rounded-full h-3 overflow-hidden">
                    <div id="levelUpProgress" class="bg-white h-full rounded-full transition-all duration-500"></div>
                </div>
            </div>
            <button onclick="closeLevelUpPopup()" class="bg-white text-purple-600 px-6 py-3 rounded-lg font-bold hover:bg-purple-50 transition-colors">
                Keep Going! üöÄ
            </button>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="fixed bg-white dark:bg-gray-800 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 py-2 z-50" style="display: none;">
        <div class="context-menu-items"></div>
    </div>

    <!-- AI Insights Popup -->
    <div id="aiInsightsPopup" class="fixed bottom-20 right-4 bg-gradient-to-br from-purple-600 to-blue-600 text-white p-4 rounded-xl shadow-xl max-w-sm transform translate-x-full transition-transform duration-300 z-45">
        <div class="flex items-start space-x-3">
            <div class="text-2xl">üß†</div>
            <div class="flex-1">
                <div class="font-bold text-sm mb-1">AI Insight</div>
                <div id="aiInsightText" class="text-xs opacity-90"></div>
            </div>
            <button onclick="closeAIInsightPopup()" class="text-white/60 hover:text-white">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
    </div>

    <style>
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-button {
            @apply text-gray-600 dark:text-gray-400 border-b-2 border-transparent hover:text-gray-900 dark:hover:text-gray-100 hover:border-gray-300 dark:hover:border-gray-600;
        }
        
        .tab-button.active {
            @apply text-primary border-primary;
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring__circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 0.35s;
        }
    </style>

    <script>
        // üéÆ GAME STATE MANAGEMENT
        let gameState = {
            level: 1,
            totalXP: 0,
            currentXP: 0,
            xpToNextLevel: 100,
            tasks: [],
            achievements: [],
            dailyStats: {
                workouts: 0,
                waterGlasses: 0,
                focusMinutes: 0,
                meals: 0,
                sleepHours: 0,
                calories: 0,
                protein: 0,
                steps: 0
            },
            profile: {
                // Basic Information
                name: '',
                age: 30,
                gender: 'male',
                height: 170, // cm
                weight: 70, // kg
                
                // Fitness & Health
                fitnessGoal: 'general',
                activityLevel: 'moderate',
                bodyFatPercentage: 15,
                fitnessExperience: 'intermediate',
                workoutFrequency: 3,
                preferredWorkoutTime: 'morning',
                
                // Lifestyle
                sleepSchedule: 'normal', // early, normal, late
                workSchedule: 'standard', // standard, shift, flexible
                stressLevel: 'moderate',
                dietaryRestrictions: [],
                
                // Productivity
                focusStyle: 'deep_work', // deep_work, pomodoro, flexible
                peakProductivityTime: 'morning',
                workType: 'knowledge', // physical, knowledge, creative, mixed
                attentionSpan: 45,
                
                // Goals & Targets
                targetWeight: 70,
                targetBodyFat: 12,
                weeklyWorkoutGoal: 4,
                dailyWaterGoal: 8,
                dailyCalorieGoal: 2000,
                dailyProteinGoal: 140,
                
                // Advanced Metrics
                restingHeartRate: 65,
                maxHeartRate: 185,
                vo2Max: 45,
                
                // Preferences
                musicPreferences: ['rock', 'electronic'],
                preferredExercises: [],
                dislikedExercises: [],
                
                // Progress Tracking
                startingWeight: 70,
                startingBodyFat: 15,
                measurementHistory: [],
                strengthProgress: {},
                
                // Calculated Fields (updated dynamically)
                BMR: 0,
                TDEE: 0,
                leanMass: 0,
                metabolicAge: 0,
                fitnessAge: 0
            },
            streaks: {
                workout: 0,
                water: 0,
                focus: 0
            },
            progressHistory: {
                weight: [],
                bodyFat: [],
                measurements: [],
                strength: [],
                endurance: [],
                flexibility: [],
                cognitive: []
            }
        };

        // üéµ SPOTIFY INTEGRATION WITH PKCE
        let spotifyState = {
            clientId: null,
            accessToken: null,
            refreshToken: null,
            tokenExpiry: null,
            isConnected: false,
            currentTrack: null,
            deviceId: null,
            playlists: [],
            userProfile: null
        };

        // ü§ñ ENHANCED AI SYSTEM
        let aiState = {
            userPatterns: {
                bestWorkoutTimes: [],
                preferredTaskTypes: {},
                energyLevels: {},
                musicPreferences: {},
                nutritionTiming: {},
                sleepPatterns: []
            },
            recommendations: [],
            learningData: [],
            insights: [],
            crossSystemConnections: {}
        };

        // üçÖ POMODORO STATE
        let pomodoroState = {
            isRunning: false,
            timeRemaining: 25 * 60,
            sessionType: 'work',
            interval: null
        };

        // PKCE helpers
        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const values = crypto.getRandomValues(new Uint8Array(length));
            return values.reduce((acc, x) => acc + possible[x % possible.length], "");
        }

        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return window.crypto.subtle.digest('SHA-256', data);
        }

        function base64encode(input) {
            return btoa(String.fromCharCode(...new Uint8Array(input)))
                .replace(/=/g, '')
                .replace(/\+/g, '-')
                .replace(/\//g, '_');
        }

        async function generateCodeChallenge(verifier) {
            const hashed = await sha256(verifier);
            return base64encode(hashed);
        }

        // Spotify Functions
        function showSpotifySetup() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-spotify">üéµ Spotify Setup</h3>
                    
                    <div class="space-y-4">
                        <div class="bg-spotify/10 dark:bg-spotify/20 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">üîë Client ID Required</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                You need a Spotify Client ID to connect. Get one from the Spotify Developer Dashboard.
                            </p>
                            <a href="https://developer.spotify.com/dashboard" target="_blank" class="text-spotify text-sm hover:underline">
                                üîó Get Client ID from Spotify
                            </a>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Spotify Client ID</label>
                            <input type="text" id="spotifyClientId" value="${spotifyState.clientId || ''}" placeholder="Enter your Spotify Client ID" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">üõ°Ô∏è PKCE Authentication</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                This app uses secure PKCE flow for authentication. No client secret required!
                            </p>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="connectSpotify()" class="flex-1 bg-spotify text-white py-3 rounded-lg hover:bg-green-600">
                                üîó Connect Spotify
                            </button>
                            <button onclick="saveSpotifyClientId()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600">
                                üíæ Save Client ID
                            </button>
                        </div>
                        
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveSpotifyClientId() {
            const clientId = document.getElementById('spotifyClientId').value.trim();
            if (clientId) {
                spotifyState.clientId = clientId;
                localStorage.setItem('spotify_client_id', clientId);
                showFloatingNotification('üíæ Client ID Saved', 'Spotify Client ID saved successfully');
                updateSpotifyConnectionStatus();
            } else {
                showFloatingNotification('‚ùå Error', 'Please enter a valid Client ID');
            }
        }

        async function connectSpotify() {
            if (!spotifyState.clientId) {
                showFloatingNotification('‚ùå Error', 'Please enter your Spotify Client ID first');
                return;
            }

            try {
                const codeVerifier = generateRandomString(64);
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                
                localStorage.setItem('spotify_code_verifier', codeVerifier);
                
                const redirectUri = window.location.origin + window.location.pathname;
                const scope = 'user-read-private user-read-email user-read-playback-state user-modify-playback-state user-read-currently-playing playlist-read-private playlist-read-collaborative streaming user-read-recently-played user-top-read';
                
                const authUrl = new URL('https://accounts.spotify.com/authorize');
                authUrl.searchParams.append('client_id', spotifyState.clientId);
                authUrl.searchParams.append('response_type', 'code');
                authUrl.searchParams.append('redirect_uri', redirectUri);
                authUrl.searchParams.append('scope', scope);
                authUrl.searchParams.append('code_challenge_method', 'S256');
                authUrl.searchParams.append('code_challenge', codeChallenge);
                authUrl.searchParams.append('state', 'spotify_auth');
                
                window.location.href = authUrl.toString();
            } catch (error) {
                console.error('Spotify connection error:', error);
                showFloatingNotification('‚ùå Connection Error', 'Failed to initiate Spotify connection');
            }
        }

        async function handleSpotifyCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            
            if (error) {
                showFloatingNotification('‚ùå Spotify Error', `Authentication failed: ${error}`);
                return;
            }
            
            if (code && state === 'spotify_auth') {
                try {
                    await exchangeCodeForToken(code);
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                } catch (error) {
                    console.error('Token exchange error:', error);
                    showFloatingNotification('‚ùå Auth Error', 'Failed to complete Spotify authentication');
                }
            }
        }

        async function exchangeCodeForToken(code) {
            const codeVerifier = localStorage.getItem('spotify_code_verifier');
            if (!codeVerifier) {
                throw new Error('Code verifier not found');
            }
            
            const redirectUri = window.location.origin + window.location.pathname;
            
            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: redirectUri,
                    client_id: spotifyState.clientId,
                    code_verifier: codeVerifier,
                }),
            });

            if (!response.ok) {
                throw new Error(`Token exchange failed: ${response.status}`);
            }

            const data = await response.json();
            
            spotifyState.accessToken = data.access_token;
            spotifyState.refreshToken = data.refresh_token;
            spotifyState.tokenExpiry = Date.now() + (data.expires_in * 1000);
            spotifyState.isConnected = true;
            
            localStorage.setItem('spotify_access_token', data.access_token);
            localStorage.setItem('spotify_refresh_token', data.refresh_token);
            localStorage.setItem('spotify_token_expiry', spotifyState.tokenExpiry.toString());
            
            localStorage.removeItem('spotify_code_verifier');
            
            await fetchSpotifyUserProfile();
            
            updateSpotifyConnectionStatus();
            showFloatingNotification('üéµ Connected!', 'Successfully connected to Spotify');
            
            initializeSpotifyFeatures();
        }

        async function fetchSpotifyUserProfile() {
            try {
                const response = await spotifyApiCall('/me');
                spotifyState.userProfile = response;
                localStorage.setItem('spotify_user_profile', JSON.stringify(response));
            } catch (error) {
                console.error('Failed to fetch user profile:', error);
            }
        }

        async function spotifyApiCall(endpoint, options = {}) {
            if (!spotifyState.accessToken) {
                throw new Error('No access token available');
            }
            
            if (Date.now() >= spotifyState.tokenExpiry - 60000) {
                await refreshSpotifyToken();
            }
            
            const response = await fetch(`https://api.spotify.com/v1${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${spotifyState.accessToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers,
                },
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    await refreshSpotifyToken();
                    return spotifyApiCall(endpoint, options);
                }
                throw new Error(`Spotify API error: ${response.status}`);
            }
            
            return response.json();
        }

        async function refreshSpotifyToken() {
            if (!spotifyState.refreshToken) {
                throw new Error('No refresh token available');
            }
            
            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    grant_type: 'refresh_token',
                    refresh_token: spotifyState.refreshToken,
                    client_id: spotifyState.clientId,
                }),
            });

            if (!response.ok) {
                throw new Error(`Token refresh failed: ${response.status}`);
            }

            const data = await response.json();
            
            spotifyState.accessToken = data.access_token;
            if (data.refresh_token) {
                spotifyState.refreshToken = data.refresh_token;
            }
            spotifyState.tokenExpiry = Date.now() + (data.expires_in * 1000);
            
            localStorage.setItem('spotify_access_token', data.access_token);
            if (data.refresh_token) {
                localStorage.setItem('spotify_refresh_token', data.refresh_token);
            }
            localStorage.setItem('spotify_token_expiry', spotifyState.tokenExpiry.toString());
        }

        function loadSpotifyState() {
            try {
                spotifyState.clientId = localStorage.getItem('spotify_client_id');
                spotifyState.accessToken = localStorage.getItem('spotify_access_token');
                spotifyState.refreshToken = localStorage.getItem('spotify_refresh_token');
                const expiry = localStorage.getItem('spotify_token_expiry');
                if (expiry) {
                    spotifyState.tokenExpiry = parseInt(expiry);
                }
                
                const profile = localStorage.getItem('spotify_user_profile');
                if (profile) {
                    spotifyState.userProfile = JSON.parse(profile);
                }
                
                spotifyState.isConnected = !!(spotifyState.accessToken && spotifyState.tokenExpiry > Date.now());
                
                if (spotifyState.isConnected) {
                    initializeSpotifyFeatures();
                }
            } catch (error) {
                console.error('Error loading Spotify state:', error);
                spotifyState.isConnected = false;
            }
        }

        function updateSpotifyConnectionStatus() {
            const container = document.getElementById('spotifyConnectionStatus');
            if (!container) return;
            
            if (spotifyState.isConnected && spotifyState.userProfile) {
                container.innerHTML = `
                    <div class="bg-green-50 dark:bg-green-900/30 p-3 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-spotify rounded-full flex items-center justify-center text-white font-bold">
                                ${spotifyState.userProfile.display_name ? spotifyState.userProfile.display_name[0] : 'üéµ'}
                            </div>
                            <div>
                                <div class="font-bold text-green-700 dark:text-green-300">Connected to Spotify</div>
                                <div class="text-sm text-green-600 dark:text-green-400">${spotifyState.userProfile.display_name || 'Spotify User'}</div>
                            </div>
                        </div>
                        <button onclick="disconnectSpotify()" class="mt-2 text-sm text-red-600 hover:text-red-700">
                            Disconnect
                        </button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                        <div class="text-center text-gray-600 dark:text-gray-400">
                            <div class="text-2xl mb-2">üéµ</div>
                            <div class="font-medium">Not Connected</div>
                            <div class="text-sm">Connect your Spotify account for AI music features</div>
                        </div>
                    </div>
                `;
            }
        }

        function disconnectSpotify() {
            spotifyState = {
                clientId: spotifyState.clientId,
                accessToken: null,
                refreshToken: null,
                tokenExpiry: null,
                isConnected: false,
                currentTrack: null,
                deviceId: null,
                playlists: [],
                userProfile: null
            };
            
            localStorage.removeItem('spotify_access_token');
            localStorage.removeItem('spotify_refresh_token');
            localStorage.removeItem('spotify_token_expiry');
            localStorage.removeItem('spotify_user_profile');
            
            updateSpotifyConnectionStatus();
            updateMusicControls();
            showFloatingNotification('üîå Disconnected', 'Spotify account disconnected');
        }

        async function initializeSpotifyFeatures() {
            try {
                await fetchCurrentTrack();
                await fetchUserPlaylists();
                updateMusicControls();
                updateSpotifyConnectionStatus();
                
                setInterval(fetchCurrentTrack, 10000);
            } catch (error) {
                console.error('Error initializing Spotify features:', error);
            }
        }

        async function fetchCurrentTrack() {
            try {
                const response = await spotifyApiCall('/me/player/currently-playing');
                spotifyState.currentTrack = response;
                updateNowPlaying();
                updatePersistentPlayer();
                updateMinimizedPlayer();
                
                // Auto-show persistent player when music starts playing
                if (response && response.is_playing) {
                    const player = document.getElementById('persistentMusicPlayer');
                    const minimized = document.getElementById('minimizedMusicPlayer');
                    
                    if (player.style.display === 'none' && minimized.style.display === 'none') {
                        showPersistentMusicPlayer();
                    }
                }
            } catch (error) {
                if (error.message.includes('204')) {
                    spotifyState.currentTrack = null;
                    updateNowPlaying();
                    updatePersistentPlayer();
                    updateMinimizedPlayer();
                } else {
                    console.error('Error fetching current track:', error);
                }
            }
        }

        async function fetchUserPlaylists() {
            try {
                const response = await spotifyApiCall('/me/playlists?limit=50');
                spotifyState.playlists = response.items;
            } catch (error) {
                console.error('Error fetching playlists:', error);
            }
        }

        function updateMusicControls() {
            const container = document.getElementById('musicControlsContainer');
            if (!container) return;
            
            if (!spotifyState.isConnected) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">üéµ</div>
                        <div>Connect Spotify to control your music</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="previousTrack()" class="bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                            ‚èÆÔ∏è Previous
                        </button>
                        <button onclick="togglePlayPause()" class="bg-spotify text-white p-3 rounded-lg hover:bg-green-600" id="playPauseBtn">
                            ${spotifyState.currentTrack?.is_playing ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Play'}
                        </button>
                        <button onclick="nextTrack()" class="bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                            ‚è≠Ô∏è Next
                        </button>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Volume</label>
                        <input type="range" id="volumeSlider" min="0" max="100" value="50" class="w-full" onchange="setVolume(this.value)">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="toggleShuffle()" class="bg-blue-500 text-white p-2 rounded text-sm hover:bg-blue-600">
                            üîÄ Shuffle
                        </button>
                        <button onclick="toggleRepeat()" class="bg-purple-500 text-white p-2 rounded text-sm hover:bg-purple-600">
                            üîÅ Repeat
                        </button>
                    </div>
                </div>
            `;
        }

        function updateNowPlaying() {
            const playPauseBtn = document.getElementById('playPauseBtn');
            if (playPauseBtn) {
                playPauseBtn.innerHTML = spotifyState.currentTrack?.is_playing ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Play';
            }
        }

        async function togglePlayPause() {
            try {
                if (spotifyState.currentTrack?.is_playing) {
                    await spotifyApiCall('/me/player/pause', { method: 'PUT' });
                } else {
                    await spotifyApiCall('/me/player/play', { method: 'PUT' });
                }
                
                setTimeout(fetchCurrentTrack, 500);
                showFloatingNotification('üéµ Music Control', spotifyState.currentTrack?.is_playing ? 'Paused' : 'Playing');
            } catch (error) {
                console.error('Error toggling play/pause:', error);
                showFloatingNotification('‚ùå Error', 'Failed to control playback');
            }
        }

        async function previousTrack() {
            try {
                await spotifyApiCall('/me/player/previous', { method: 'POST' });
                setTimeout(fetchCurrentTrack, 1000);
                showFloatingNotification('‚èÆÔ∏è Previous', 'Skipped to previous track');
            } catch (error) {
                console.error('Error skipping to previous track:', error);
            }
        }

        async function nextTrack() {
            try {
                await spotifyApiCall('/me/player/next', { method: 'POST' });
                setTimeout(fetchCurrentTrack, 1000);
                showFloatingNotification('‚è≠Ô∏è Next', 'Skipped to next track');
            } catch (error) {
                console.error('Error skipping to next track:', error);
            }
        }

        async function setVolume(volume) {
            try {
                await spotifyApiCall(`/me/player/volume?volume_percent=${volume}`, { method: 'PUT' });
                showFloatingNotification('üîä Volume', `Set to ${volume}%`);
            } catch (error) {
                console.error('Error setting volume:', error);
            }
        }

        async function toggleShuffle() {
            try {
                const state = await spotifyApiCall('/me/player');
                const newShuffleState = !state.shuffle_state;
                
                await spotifyApiCall(`/me/player/shuffle?state=${newShuffleState}`, { method: 'PUT' });
                showFloatingNotification('üîÄ Shuffle', newShuffleState ? 'Enabled' : 'Disabled');
            } catch (error) {
                console.error('Error toggling shuffle:', error);
            }
        }

        async function toggleRepeat() {
            try {
                const state = await spotifyApiCall('/me/player');
                const currentRepeat = state.repeat_state;
                const newRepeat = currentRepeat === 'off' ? 'context' : currentRepeat === 'context' ? 'track' : 'off';
                
                await spotifyApiCall(`/me/player/repeat?state=${newRepeat}`, { method: 'PUT' });
                showFloatingNotification('üîÅ Repeat', `Set to ${newRepeat}`);
            } catch (error) {
                console.error('Error toggling repeat:', error);
            }
        }

        function showCurrentlyPlaying() {
            if (!spotifyState.isConnected) {
                showFloatingNotification('‚ùå Error', 'Please connect to Spotify first');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-center">üéµ Now Playing</h3>
                    
                    <div id="currentTrackDisplay" class="space-y-4">
                        <!-- Current track info will be populated here -->
                    </div>
                    
                    <div class="flex justify-center mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            updateCurrentTrackDisplay();
        }

        function updateCurrentTrackDisplay() {
            const container = document.getElementById('currentTrackDisplay');
            if (!container) return;
            
            if (!spotifyState.currentTrack || !spotifyState.currentTrack.item) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">üéµ</div>
                        <div>No track currently playing</div>
                        <button onclick="fetchCurrentTrack(); updateCurrentTrackDisplay();" class="mt-4 bg-spotify text-white px-4 py-2 rounded hover:bg-green-600">
                            üîÑ Refresh
                        </button>
                    </div>
                `;
                return;
            }
            
            const track = spotifyState.currentTrack.item;
            const isPlaying = spotifyState.currentTrack.is_playing;
            
            container.innerHTML = `
                <div class="text-center">
                    ${track.album?.images?.[0]?.url ? `
                        <img src="${track.album.images[0].url}" alt="Album Art" class="w-32 h-32 mx-auto rounded-lg mb-4">
                    ` : '<div class="w-32 h-32 mx-auto bg-gray-200 dark:bg-gray-700 rounded-lg mb-4 flex items-center justify-center text-4xl">üéµ</div>'}
                    
                    <div class="font-bold text-lg mb-2">${track.name}</div>
                    <div class="text-gray-600 dark:text-gray-400 mb-2">${track.artists?.map(a => a.name).join(', ') || 'Unknown Artist'}</div>
                    <div class="text-sm text-gray-500 mb-4">${track.album?.name || 'Unknown Album'}</div>
                    
                    <div class="flex items-center justify-center space-x-2 mb-4">
                        <span class="${isPlaying ? 'text-green-500' : 'text-gray-500'}">${isPlaying ? '‚ñ∂Ô∏è Playing' : '‚è∏Ô∏è Paused'}</span>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="previousTrack()" class="bg-gray-200 dark:bg-gray-700 p-2 rounded hover:bg-gray-300 dark:hover:bg-gray-600">
                            ‚èÆÔ∏è
                        </button>
                        <button onclick="togglePlayPause()" class="bg-spotify text-white p-2 rounded hover:bg-green-600">
                            ${isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                        </button>
                        <button onclick="nextTrack()" class="bg-gray-200 dark:bg-gray-700 p-2 rounded hover:bg-gray-300 dark:hover:bg-gray-600">
                            ‚è≠Ô∏è
                        </button>
                    </div>
                </div>
            `;
        }

        function showWorkoutMusic() {
            if (!spotifyState.isConnected) {
                showFloatingNotification('‚ùå Error', 'Please connect to Spotify first');
                return;
            }
            
            const workoutPlaylists = [
                { name: 'üí™ High Intensity', query: 'workout high energy', description: 'Perfect for HIIT and strength training' },
                { name: 'üèÉ‚Äç‚ôÇÔ∏è Cardio Beats', query: 'running cardio', description: 'Steady rhythm for cardio sessions' },
                { name: 'üî• Pump Up', query: 'gym motivation', description: 'Get hyped for your workout' },
                { name: 'üíØ Beast Mode', query: 'workout beast mode', description: 'Push your limits with intense beats' }
            ];
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center text-fitness">üí™ Workout Music</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        ${workoutPlaylists.map(playlist => `
                            <div class="border rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" onclick="searchAndPlayWorkoutMusic('${playlist.query}')">
                                <div class="font-bold mb-2">${playlist.name}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${playlist.description}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg mb-4">
                        <h4 class="font-bold mb-2">üß† AI Workout Music</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                            Get AI-curated music based on your current workout and energy level.
                        </p>
                        <button onclick="generateAIWorkoutPlaylist()" class="w-full bg-fitness text-white py-2 rounded hover:bg-red-600">
                            üéµ Generate AI Workout Playlist
                        </button>
                    </div>
                    
                    <div class="flex justify-center">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showFocusMusic() {
            if (!spotifyState.isConnected) {
                showFloatingNotification('‚ùå Error', 'Please connect to Spotify first');
                return;
            }
            
            const focusPlaylists = [
                { name: 'üß† Deep Focus', query: 'deep focus instrumental', description: 'Minimal distractions, maximum concentration' },
                { name: 'üéµ Lo-Fi Study', query: 'lofi hip hop study', description: 'Chill beats for sustained focus' },
                { name: 'üåä Ambient Flow', query: 'ambient focus music', description: 'Atmospheric sounds for deep work' },
                { name: 'üéπ Classical Focus', query: 'classical music focus', description: 'Timeless classical pieces for concentration' }
            ];
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6 text-center text-focus">üß† Focus Music</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        ${focusPlaylists.map(playlist => `
                            <div class="border rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" onclick="searchAndPlayFocusMusic('${playlist.query}')">
                                <div class="font-bold mb-2">${playlist.name}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${playlist.description}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded-lg mb-4">
                        <h4 class="font-bold mb-2">üçÖ Pomodoro Music</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                            Start a Pomodoro session with perfectly timed focus music.
                        </p>
                        <button onclick="startPomodoroWithMusic()" class="w-full bg-focus text-white py-2 rounded hover:bg-yellow-600">
                            üçÖ Start Pomodoro + Music
                        </button>
                    </div>
                    
                    <div class="flex justify-center">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function searchAndPlayWorkoutMusic(query) {
            try {
                const searchResponse = await spotifyApiCall(`/search?q=${encodeURIComponent(query)}&type=playlist&limit=1`);
                
                if (searchResponse.playlists.items.length > 0) {
                    const playlist = searchResponse.playlists.items[0];
                    await spotifyApiCall('/me/player/play', {
                        method: 'PUT',
                        body: JSON.stringify({
                            context_uri: playlist.uri
                        })
                    });
                    
                    showFloatingNotification('üéµ Playing Workout Music', playlist.name);
                    awardXP(10, 'Using AI workout music! üéµ');
                } else {
                    showFloatingNotification('‚ùå No Results', 'No workout playlists found');
                }
            } catch (error) {
                console.error('Error playing workout music:', error);
                showFloatingNotification('‚ùå Error', 'Failed to play workout music');
            }
        }

        async function searchAndPlayFocusMusic(query) {
            try {
                const searchResponse = await spotifyApiCall(`/search?q=${encodeURIComponent(query)}&type=playlist&limit=1`);
                
                if (searchResponse.playlists.items.length > 0) {
                    const playlist = searchResponse.playlists.items[0];
                    await spotifyApiCall('/me/player/play', {
                        method: 'PUT',
                        body: JSON.stringify({
                            context_uri: playlist.uri
                        })
                    });
                    
                    showFloatingNotification('üéµ Playing Focus Music', playlist.name);
                    awardXP(10, 'Using AI focus music! üß†');
                } else {
                    showFloatingNotification('‚ùå No Results', 'No focus playlists found');
                }
            } catch (error) {
                console.error('Error playing focus music:', error);
                showFloatingNotification('‚ùå Error', 'Failed to play focus music');
            }
        }

        function generateAIMusicRecommendations() {
            if (!spotifyState.isConnected) {
                showFloatingNotification('‚ùå Error', 'Please connect to Spotify first');
                return;
            }
            
            const stats = gameState.dailyStats;
            const hour = new Date().getHours();
            const profile = gameState.profile;
            
            let recommendations = [];
            
            if (stats.workouts > 0 || stats.steps > 5000) {
                recommendations.push({
                    title: 'üí™ Post-Workout Recovery',
                    description: 'Chill music to help you cool down and recover',
                    query: 'chill recovery music',
                    reasoning: 'You\'ve been active today - time for some recovery music'
                });
            }
            
            if (stats.focusMinutes < 60 && hour >= 9 && hour <= 17) {
                recommendations.push({
                    title: 'üß† Focus Boost',
                    description: 'Concentration-enhancing instrumental music',
                    query: 'focus instrumental productivity',
                    reasoning: 'Low focus time detected - boost your productivity with the right music'
                });
            }
            
            if (hour >= 18 || stats.sleepHours > 0) {
                recommendations.push({
                    title: 'üò¥ Evening Wind-Down',
                    description: 'Relaxing music for better sleep',
                    query: 'relaxing sleep music',
                    reasoning: 'Perfect time to start winding down for better sleep quality'
                });
            }
            
            if (hour >= 6 && hour <= 10) {
                recommendations.push({
                    title: 'üåÖ Morning Energy',
                    description: 'Upbeat music to start your day right',
                    query: 'morning energy upbeat',
                    reasoning: 'Kickstart your morning with energizing music'
                });
            }
            
            const container = document.getElementById('aiMusicRecommendations');
            if (container) {
                container.innerHTML = recommendations.map(rec => `
                    <div class="border rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700">
                        <div class="font-bold mb-2">${rec.title}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">${rec.description}</div>
                        <div class="text-xs text-purple-600 dark:text-purple-400 mb-3">
                            üß† ${rec.reasoning}
                        </div>
                        <button onclick="searchAndPlayAIMusic('${rec.query}', '${rec.title}')" class="w-full bg-spotify text-white py-2 rounded hover:bg-green-600 text-sm">
                            üéµ Play Now
                        </button>
                    </div>
                `).join('');
            }
            
            showFloatingNotification('üß† AI Recommendations', 'Generated personalized music suggestions');
        }

        async function searchAndPlayAIMusic(query, title) {
            try {
                const searchResponse = await spotifyApiCall(`/search?q=${encodeURIComponent(query)}&type=playlist&limit=1`);
                
                if (searchResponse.playlists.items.length > 0) {
                    const playlist = searchResponse.playlists.items[0];
                    await spotifyApiCall('/me/player/play', {
                        method: 'PUT',
                        body: JSON.stringify({
                            context_uri: playlist.uri
                        })
                    });
                    
                    showFloatingNotification('üß† AI Music Playing', title);
                    awardXP(15, 'Using AI music recommendations! üéµ');
                    
                    if (!gameState.achievements.find(a => a.title.includes('AI DJ'))) {
                        addAchievement('üéµ AI DJ', 'Used AI music recommendations for the first time!', 50);
                    }
                } else {
                    showFloatingNotification('‚ùå No Results', 'No matching playlists found');
                }
            } catch (error) {
                console.error('Error playing AI music:', error);
                showFloatingNotification('‚ùå Error', 'Failed to play music');
            }
        }

        function generateAIWorkoutPlaylist() {
            const stats = gameState.dailyStats;
            const profile = gameState.profile;
            
            let musicQuery = 'high energy workout';
            let intensity = 'medium';
            
            if (stats.workouts >= 2) {
                intensity = 'high';
                musicQuery = 'beast mode extreme workout';
            } else if (stats.steps > 10000) {
                intensity = 'medium-high';
                musicQuery = 'cardio running music';
            }
            
            if (profile.fitnessGoal === 'build_muscle') {
                musicQuery += ' strength training';
            } else if (profile.fitnessGoal === 'lose_weight') {
                musicQuery += ' cardio fat burn';
            }
            
            showFloatingNotification('üß† AI Generating...', 'Creating your personalized workout playlist');
            
            setTimeout(() => {
                searchAndPlayAIMusic(musicQuery, `üéµ AI ${intensity.charAt(0).toUpperCase() + intensity.slice(1)} Intensity Workout`);
            }, 1000);
        }

        function startPomodoroWithMusic() {
            searchAndPlayFocusMusic('deep focus instrumental');
            document.querySelector('.fixed')?.remove();
            
            setTimeout(() => {
                startPomodoro();
            }, 500);
        }

        function updateMusicStats() {
            const container = document.getElementById('musicStatsContainer');
            if (!container) return;
            
            if (!spotifyState.isConnected) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <div class="text-2xl mb-2">üéµ</div>
                        <div>Connect Spotify to see music stats</div>
                    </div>
                `;
                return;
            }
            
            const musicXP = gameState.achievements
                .filter(a => a.title.includes('Music') || a.title.includes('AI DJ'))
                .reduce((total, a) => total + a.xp, 0);
            
            const musicTasks = gameState.tasks
                .filter(t => t.completed && (t.text.includes('music') || t.aiGenerated))
                .length;
            
            container.innerHTML = `
                <div class="space-y-3">
                    <div class="bg-spotify/10 dark:bg-spotify/20 p-3 rounded-lg">
                        <div class="text-lg font-bold text-spotify">${musicXP}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Music XP Earned</div>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg">
                        <div class="text-lg font-bold text-blue-600">${musicTasks}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Music-Enhanced Tasks</div>
                    </div>
                    
                    <div class="bg-green-50 dark:bg-green-900/30 p-3 rounded-lg">
                        <div class="text-lg font-bold text-green-600">${spotifyState.userProfile?.display_name ? '‚úì' : '‚ùå'}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Spotify Connected</div>
                    </div>
                </div>
            `;
        }

        // ü§ñ ENHANCED AI SYSTEM
        function enhancedAIAnalysis() {
            const stats = gameState.dailyStats;
            const profile = gameState.profile;
            const tasks = gameState.tasks;
            const achievements = gameState.achievements;
            const hour = new Date().getHours();
            const dayOfWeek = new Date().getDay();
            
            updateUserPatterns();
            generateCrossSystemInsights();
            generatePredictiveRecommendations();
            updateLearningData();
        }
        
        function updateUserPatterns() {
            const hour = new Date().getHours();
            
            if (gameState.dailyStats.workouts > 0) {
                aiState.userPatterns.bestWorkoutTimes.push(hour);
                if (aiState.userPatterns.bestWorkoutTimes.length > 50) {
                    aiState.userPatterns.bestWorkoutTimes = aiState.userPatterns.bestWorkoutTimes.slice(-30);
                }
            }
            
            gameState.tasks.filter(t => t.completed).forEach(task => {
                const completionHour = new Date(task.completedAt).getHours();
                if (!aiState.userPatterns.preferredTaskTypes[task.category]) {
                    aiState.userPatterns.preferredTaskTypes[task.category] = [];
                }
                aiState.userPatterns.preferredTaskTypes[task.category].push(completionHour);
            });
            
            const energyScore = calculateCurrentEnergyScore();
            aiState.userPatterns.energyLevels[hour] = energyScore;
            
            localStorage.setItem('ai_user_patterns', JSON.stringify(aiState.userPatterns));
        }
        
        function calculateCurrentEnergyScore() {
            const stats = gameState.dailyStats;
            let energy = 50;
            
            if (stats.sleepHours >= 7) energy += 20;
            if (stats.waterGlasses >= 6) energy += 15;
            if (stats.workouts > 0) energy += 10;
            if (stats.meals >= 2) energy += 10;
            
            if (stats.sleepHours < 6) energy -= 20;
            if (stats.waterGlasses < 3) energy -= 15;
            if (stats.focusMinutes > 120) energy -= 10;
            
            return Math.max(0, Math.min(100, energy));
        }
        
        function generateCrossSystemInsights() {
            const insights = [];
            const stats = gameState.dailyStats;
            
            if (spotifyState.isConnected && stats.workouts > 0) {
                insights.push({
                    type: 'cross-system',
                    systems: ['music', 'fitness'],
                    insight: 'Music during workouts increases performance by 15% on average',
                    action: 'Try starting your next workout with high-energy music',
                    confidence: 85
                });
            }
            
            if (stats.protein > 30 && stats.focusMinutes > 60) {
                insights.push({
                    type: 'cross-system',
                    systems: ['nutrition', 'focus'],
                    insight: 'High protein intake correlates with sustained focus sessions',
                    action: 'Continue prioritizing protein for cognitive performance',
                    confidence: 78
                });
            }
            
            if (stats.sleepHours >= 8) {
                insights.push({
                    type: 'cross-system',
                    systems: ['sleep', 'all'],
                    insight: 'Quality sleep amplifies all other health metrics by 25%',
                    action: 'Your sleep optimization is the foundation of today\'s success',
                    confidence: 92
                });
            }
            
            if (stats.waterGlasses < 4 && stats.focusMinutes < 30) {
                insights.push({
                    type: 'cross-system',
                    systems: ['hydration', 'energy'],
                    insight: 'Dehydration reduces cognitive performance by up to 12%',
                    action: 'Drink 2 glasses of water before your next focus session',
                    confidence: 89
                });
            }
            
            aiState.insights = insights;
        }
        
        function generatePredictiveRecommendations() {
            const recommendations = [];
            const hour = new Date().getHours();
            const patterns = aiState.userPatterns;
            
            if (patterns.bestWorkoutTimes.length > 5) {
                const avgWorkoutTime = patterns.bestWorkoutTimes.reduce((a, b) => a + b, 0) / patterns.bestWorkoutTimes.length;
                if (Math.abs(hour - avgWorkoutTime) <= 1) {
                    recommendations.push({
                        type: 'predictive',
                        category: 'fitness',
                        text: 'AI predicts this is your optimal workout time',
                        action: 'Start a workout now for maximum performance',
                        confidence: 87,
                        reasoning: `Based on ${patterns.bestWorkoutTimes.length} previous workouts`
                    });
                }
            }
            
            Object.entries(patterns.preferredTaskTypes).forEach(([category, times]) => {
                if (times.length > 3) {
                    const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                    if (Math.abs(hour - avgTime) <= 1) {
                        recommendations.push({
                            type: 'predictive',
                            category: category,
                            text: `AI suggests focusing on ${category} tasks now`,
                            action: 'You have a 78% higher completion rate for these tasks at this time',
                            confidence: 78,
                            reasoning: `Pattern recognition from ${times.length} completed tasks`
                        });
                    }
                }
            });
            
            const currentEnergy = calculateCurrentEnergyScore();
            if (currentEnergy > 80) {
                recommendations.push({
                    type: 'energy-based',
                    category: 'optimization',
                    text: 'High energy detected - perfect for challenging tasks',
                    action: 'Consider starting your most difficult task or an intensive workout',
                    confidence: 85,
                    reasoning: `Current energy score: ${currentEnergy}/100`
                });
            } else if (currentEnergy < 40) {
                recommendations.push({
                    type: 'energy-based',
                    category: 'recovery',
                    text: 'Low energy detected - focus on recovery',
                    action: 'Try hydration, light movement, or relaxing music',
                    confidence: 82,
                    reasoning: `Energy deficit detected: ${currentEnergy}/100`
                });
            }
            
            aiState.recommendations = recommendations;
        }
        
        function updateLearningData() {
            const dataPoint = {
                timestamp: new Date().toISOString(),
                stats: { ...gameState.dailyStats },
                hour: new Date().getHours(),
                day: new Date().getDay(),
                energyScore: calculateCurrentEnergyScore(),
                spotifyConnected: spotifyState.isConnected,
                completedTasks: gameState.tasks.filter(t => t.completed).length,
                totalXP: gameState.totalXP
            };
            
            aiState.learningData.push(dataPoint);
            
            if (aiState.learningData.length > 100) {
                aiState.learningData = aiState.learningData.slice(-100);
            }
            
            localStorage.setItem('ai_learning_data', JSON.stringify(aiState.learningData));
        }
        
        function loadAIState() {
            try {
                const patterns = localStorage.getItem('ai_user_patterns');
                if (patterns) {
                    aiState.userPatterns = JSON.parse(patterns);
                }
                
                const learningData = localStorage.getItem('ai_learning_data');
                if (learningData) {
                    aiState.learningData = JSON.parse(learningData);
                }
            } catch (error) {
                console.error('Error loading AI state:', error);
            }
        }
        
        function showEnhancedAIInsights() {
            enhancedAIAnalysis();
            
            const container = document.getElementById('aiInsights');
            if (!container) return;
            
            const topInsight = aiState.insights
                .sort((a, b) => b.confidence - a.confidence)[0];
            
            const topRecommendation = aiState.recommendations
                .sort((a, b) => b.confidence - a.confidence)[0];
            
            if (topInsight || topRecommendation) {
                const insight = topInsight || topRecommendation;
                const isInsight = !!topInsight;
                
                container.innerHTML = `
                    <div class="rounded-xl p-4 border bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/30 dark:to-blue-900/30 border-purple-200 dark:border-purple-800">
                        <div class="flex items-start space-x-3">
                            <div class="text-2xl">üß†</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-purple-900 dark:text-purple-100 mb-1">
                                    ${isInsight ? 'AI Cross-System Insight' : 'AI Predictive Recommendation'} 
                                    <span class="text-xs bg-purple-200 dark:bg-purple-800 text-purple-700 dark:text-purple-300 px-2 py-1 rounded ml-2">
                                        ${insight.confidence}% confidence
                                    </span>
                                </h4>
                                <p class="text-sm text-purple-800 dark:text-purple-200 mb-2">${insight.insight || insight.text}</p>
                                <p class="text-xs text-purple-700 dark:text-purple-300 italic">${insight.action}</p>
                                ${insight.reasoning ? `<p class="text-xs text-purple-600 dark:text-purple-400 mt-1">üîç ${insight.reasoning}</p>` : ''}
                                ${insight.systems ? `<div class="text-xs text-purple-500 mt-2">Systems: ${insight.systems.join(' + ')}</div>` : ''}
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="text-purple-400 hover:text-purple-600">√ó</button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = '';
            }
        }
        
        function initializeEnhancedAI() {
            loadAIState();
            
            setInterval(() => {
                enhancedAIAnalysis();
                showEnhancedAIInsights();
            }, 30000);
            
            if (spotifyState.isConnected) {
                updateMusicStats();
            }
        }

        // üéØ CORE FUNCTIONS
        function loadGameState() {
            const saved = localStorage.getItem('lifeQuestRPG');
            if (saved) {
                gameState = { ...gameState, ...JSON.parse(saved) };
            }
            
            const profile = localStorage.getItem('lifeQuestProfile');
            if (profile) {
                gameState.profile = { ...gameState.profile, ...JSON.parse(profile) };
            }
        }

        function saveGameState() {
            localStorage.setItem('lifeQuestRPG', JSON.stringify(gameState));
            localStorage.setItem('lifeQuestProfile', JSON.stringify(gameState.profile));
        }

        function awardXP(amount, reason) {
            gameState.totalXP += amount;
            gameState.currentXP += amount;
            
            while (gameState.currentXP >= gameState.xpToNextLevel) {
                levelUp();
            }
            
            updateXPDisplay();
            sendGameEventNotification('xp_gained', 'üéâ XP Gained!', `+${amount} XP - ${reason}`, '‚ú®');
            saveGameState();
        }

        function levelUp() {
            gameState.currentXP -= gameState.xpToNextLevel;
            gameState.level++;
            gameState.xpToNextLevel = Math.floor(gameState.xpToNextLevel * 1.2);
            
            sendGameEventNotification('level_up', 'üéä LEVEL UP!', `Congratulations! You reached Level ${gameState.level}!`, 'üéä');
            addAchievement(`üèÜ Level ${gameState.level}`, `Reached Level ${gameState.level}!`, 100);
            
            // Show level up popup
            showLevelUpPopup(gameState.level);
        }

        function addAchievement(title, description, xp) {
            const achievement = {
                id: Date.now().toString(),
                title,
                description,
                xp,
                unlockedAt: new Date().toISOString()
            };
            
            gameState.achievements.unshift(achievement);
            awardXP(xp, `Achievement: ${title}`);
            
            sendGameEventNotification('achievement', 'üèÜ Achievement Unlocked!', title, 'üèÜ');
            
            // Show achievement popup
            showAchievementPopup(achievement);
        }

        function addTask(text, category, xp, icon) {
            const task = {
                id: Date.now().toString(),
                text,
                category,
                xp,
                icon,
                completed: false,
                createdAt: new Date().toISOString(),
                aiGenerated: false
            };
            
            gameState.tasks.unshift(task);
            updateTasksListDetailed();
            saveGameState();
        }

        function toggleTask(taskId) {
            const task = gameState.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.completed = !task.completed;
            task.completedAt = task.completed ? new Date().toISOString() : null;
            
            if (task.completed) {
                awardXP(task.xp, task.text);
                checkAchievements();
            }
            
            updateTasksListDetailed();
            updateAllUI();
            saveGameState();
        }

        function completeTask(type) {
            const taskData = {
                workout: { text: 'Complete a workout', xp: 25, icon: 'üí™', category: 'fitness' },
                water: { text: 'Drink a glass of water', xp: 5, icon: 'üíß', category: 'health' },
                meal: { text: 'Log a healthy meal', xp: 10, icon: 'üçé', category: 'nutrition' },
                focus: { text: 'Complete focus session', xp: 15, icon: 'üß†', category: 'productivity' }
            };
            
            if (taskData[type]) {
                const data = taskData[type];
                addTask(data.text, data.category, data.xp, data.icon);
                
                const newTask = gameState.tasks[0];
                toggleTask(newTask.id);
                
                updateDailyStats(type);
            }
        }

        function updateDailyStats(type) {
            switch(type) {
                case 'workout':
                    gameState.dailyStats.workouts++;
                    break;
                case 'water':
                    gameState.dailyStats.waterGlasses++;
                    break;
                case 'meal':
                    gameState.dailyStats.meals++;
                    break;
                case 'focus':
                    gameState.dailyStats.focusMinutes += 25;
                    break;
            }
            
            updateAllUI();
        }

        function checkAchievements() {
            const stats = gameState.dailyStats;
            
            if (stats.workouts >= 1 && !gameState.achievements.find(a => a.title === 'üí™ First Workout')) {
                addAchievement('üí™ First Workout', 'Completed your first workout!', 25);
            }
            
            if (stats.waterGlasses >= 8 && !gameState.achievements.find(a => a.title === 'üíß Hydration Hero')) {
                addAchievement('üíß Hydration Hero', 'Drank 8 glasses of water in a day!', 30);
            }
            
            if (stats.focusMinutes >= 120 && !gameState.achievements.find(a => a.title === 'üß† Focus Master')) {
                addAchievement('üß† Focus Master', 'Focused for 2 hours in a day!', 50);
            }
            
            if (gameState.tasks.filter(t => t.completed).length >= 10 && !gameState.achievements.find(a => a.title === 'üéØ Task Crusher')) {
                addAchievement('üéØ Task Crusher', 'Completed 10 tasks!', 40);
            }
        }

        // üçÖ POMODORO TIMER
        function startPomodoro() {
            if (pomodoroState.isRunning) {
                stopPomodoro();
                return;
            }
            
            pomodoroState.isRunning = true;
            pomodoroState.interval = setInterval(updatePomodoro, 1000);
            
            document.getElementById('pomodoroBtn').innerHTML = '‚è∏Ô∏è Pause Session';
            document.getElementById('pomodoroStatus').textContent = 'üî• Focus time! Stay concentrated.';
            
            showFloatingNotification('üçÖ Pomodoro Started', 'Focus session begun. Stay concentrated!');
        }

        function stopPomodoro() {
            pomodoroState.isRunning = false;
            clearInterval(pomodoroState.interval);
            
            document.getElementById('pomodoroBtn').innerHTML = 'üöÄ Start Focus Session';
            document.getElementById('pomodoroStatus').textContent = '';
        }

        function updatePomodoro() {
            pomodoroState.timeRemaining--;
            
            const minutes = Math.floor(pomodoroState.timeRemaining / 60);
            const seconds = pomodoroState.timeRemaining % 60;
            
            document.getElementById('pomodoroTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (pomodoroState.timeRemaining <= 0) {
                completePomodoroSession();
            }
        }

        function completePomodoroSession() {
            stopPomodoro();
            
            pomodoroState.timeRemaining = 25 * 60;
            document.getElementById('pomodoroTime').textContent = '25:00';
            
            awardXP(15, 'Completed Pomodoro session');
            updateDailyStats('focus');
            
            sendGameEventNotification(
                'pomodoro_complete',
                'üçÖ Pomodoro Complete!',
                'Excellent focus session! Take a well-deserved 5-minute break.',
                'üçÖ'
            );
            
            // Achievement for first Pomodoro of the day
            if (gameState.dailyStats.focusMinutes === 25 && !gameState.achievements.find(a => a.title.includes('Focus Starter'))) {
                setTimeout(() => {
                    addAchievement('üß† Focus Starter', 'Completed your first Pomodoro session today!', 20);
                }, 2000);
            }
        }

        // üß≠ TAB NAVIGATION
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            event.target.classList.add('active');
            
            switch(tabName) {
                case 'tasks':
                    updateTasksListDetailed();
                    updateAchievementsListDetailed();
                    break;
                case 'health':
                    updateHealthProgress();
                    break;
                case 'music':
                    updateSpotifyConnectionStatus();
                    updateMusicControls();
                    updateMusicStats();
                    generateAIMusicRecommendations();
                    break;
                case 'settings':
                    updateSettingsStats();
                    break;
            }
        }

        function updateTasksListDetailed() {
            const container = document.getElementById('tasksListDetailed');
            if (!container) return;
            
            const todayTasks = gameState.tasks.filter(task => {
                const taskDate = new Date(task.createdAt).toDateString();
                const today = new Date().toDateString();
                return taskDate === today;
            }).sort((a, b) => a.completed - b.completed);

            container.innerHTML = todayTasks.map(task => `
                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg ${task.completed ? 'opacity-60' : ''}">
                    <div class="flex items-center space-x-3">
                        <button onclick="toggleTask('${task.id}')" class="text-3xl hover:scale-110 transition-transform">
                            ${task.completed ? '‚úÖ' : '‚¨ú'}
                        </button>
                        <div>
                            <div class="font-medium ${task.completed ? 'line-through' : ''}">${task.text}</div>
                            <div class="text-sm text-gray-500 capitalize flex items-center space-x-2">
                                <span>${task.icon} ${task.category}</span>
                                ${task.aiGenerated ? '<span class="bg-purple-100 dark:bg-purple-800 text-purple-600 dark:text-purple-300 px-2 py-0.5 rounded text-xs">üß† AI</span>' : ''}
                                ${task.completed ? `<span class="text-xs text-green-600">Completed ${new Date(task.completedAt).toLocaleTimeString()}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-primary">+${task.xp} XP</div>
                        ${task.completed ? '<div class="text-xs text-green-600">‚úì Earned</div>' : ''}
                    </div>
                </div>
            `).join('');

            if (todayTasks.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12">No quests yet! Add some tasks to get started.</div>';
            }
        }

        function updateAchievementsListDetailed() {
            const container = document.getElementById('achievementsListDetailed');
            if (!container) return;
            
            const allAchievements = gameState.achievements
                .sort((a, b) => new Date(b.unlockedAt) - new Date(a.unlockedAt));

            container.innerHTML = allAchievements.map(achievement => `
                <div class="flex items-center space-x-4 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/30 dark:to-orange-900/30 rounded-lg border border-yellow-200 dark:border-yellow-800">
                    <div class="text-3xl">üèÜ</div>
                    <div class="flex-1">
                        <div class="font-bold text-yellow-800 dark:text-yellow-200">${achievement.title}</div>
                        <div class="text-sm text-yellow-700 dark:text-yellow-300">${achievement.description}</div>
                        <div class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">
                            Unlocked ${new Date(achievement.unlockedAt).toLocaleDateString()} at ${new Date(achievement.unlockedAt).toLocaleTimeString()}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold text-yellow-600">+${achievement.xp}</div>
                        <div class="text-xs text-yellow-500">XP</div>
                    </div>
                </div>
            `).join('');

            if (allAchievements.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12">Complete tasks to unlock achievements!</div>';
            }
        }

        function updateHealthProgress() {
            const container = document.getElementById('healthProgressContainer');
            if (!container) return;
            
            const habits = getHabitProgress();
            
            container.innerHTML = habits.map(habit => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="text-xl">${habit.icon}</div>
                        <div>
                            <div class="font-medium">${habit.name}</div>
                            <div class="text-xs text-gray-500">${habit.current}/${habit.goal} ${habit.unit}</div>
                        </div>
                    </div>
                    <div class="w-24 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                        <div class="bg-${habit.color} h-full rounded-full" style="width: ${Math.min(100, (habit.current/habit.goal)*100)}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function getHabitProgress() {
            const stats = gameState.dailyStats;
            return [
                { name: 'Water Intake', icon: 'üíß', current: stats.waterGlasses, goal: 8, unit: 'glasses', color: 'hydration' },
                { name: 'Workouts', icon: 'üí™', current: stats.workouts, goal: 1, unit: 'sessions', color: 'fitness' },
                { name: 'Focus Time', icon: 'üß†', current: stats.focusMinutes, goal: 120, unit: 'minutes', color: 'focus' },
                { name: 'Meals Logged', icon: 'üçé', current: stats.meals, goal: 3, unit: 'meals', color: 'nutrition' },
                { name: 'Sleep Hours', icon: 'üò¥', current: stats.sleepHours, goal: 8, unit: 'hours', color: 'wellness' }
            ];
        }

        function updateSettingsStats() {
            const elements = {
                'settingsLevel': gameState.level,
                'settingsTotalXP': gameState.totalXP.toLocaleString(),
                'settingsAchievements': gameState.achievements.length,
                'settingsTasks': gameState.tasks.length
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
        }

        // üì± UI UPDATES
        function updateAllUI() {
            updateXPDisplay();
            updateStatsDisplay();
            updateTasksListDetailed();
            updateAchievementsListDetailed();
            showEnhancedAIInsights();
        }

        function updateXPDisplay() {
            document.getElementById('levelDisplay').textContent = `Level ${gameState.level}`;
            document.getElementById('xpDisplay').textContent = `${gameState.currentXP} / ${gameState.xpToNextLevel} XP`;
            
            const progressPercent = (gameState.currentXP / gameState.xpToNextLevel) * 100;
            document.getElementById('xpProgress').style.width = `${progressPercent}%`;
        }

        function updateStatsDisplay() {
            const stats = gameState.dailyStats;
            
            document.getElementById('waterCount').textContent = `${stats.waterGlasses} glasses`;
            document.getElementById('workoutCount').textContent = `${stats.workouts} sessions`;
            document.getElementById('focusCount').textContent = `${stats.focusMinutes} minutes`;
            document.getElementById('mealCount').textContent = `${stats.meals} logged`;
            document.getElementById('caloriesDisplay').textContent = stats.calories;
            document.getElementById('proteinDisplay').textContent = `${stats.protein}g`;
            document.getElementById('sleepDisplay').textContent = `${stats.sleepHours}h`;
        }

        // üîî ENHANCED NOTIFICATION SYSTEM
        let notificationQueue = [];
        let notificationId = 0;
        let browserNotificationsEnabled = false;

        // Browser notification system
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showFloatingNotification('‚ùå Not Supported', 'Browser notifications not supported');
                return false;
            }

            if (Notification.permission === 'granted') {
                browserNotificationsEnabled = true;
                return true;
            }

            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    browserNotificationsEnabled = true;
                    localStorage.setItem('browser_notifications_enabled', 'true');
                    showFloatingNotification('üîî Enabled!', 'Browser notifications are now active');
                    return true;
                }
            }
            
            browserNotificationsEnabled = false;
            localStorage.setItem('browser_notifications_enabled', 'false');
            return false;
        }

        function sendBrowserNotification(title, body, icon = 'üéÆ', tag = null, actions = []) {
            if (!browserNotificationsEnabled || Notification.permission !== 'granted') {
                return;
            }

            const options = {
                body: body,
                icon: '/favicon.ico', // You can use a proper icon URL
                badge: '/badge-icon.png',
                tag: tag,
                requireInteraction: false,
                silent: false,
                actions: actions,
                data: {
                    timestamp: Date.now(),
                    app: 'Life Quest RPG'
                }
            };

            try {
                const notification = new Notification(`${icon} ${title}`, options);
                
                notification.onclick = function(event) {
                    event.preventDefault();
                    window.focus(); // Focus the app window
                    notification.close();
                };

                // Auto close after 8 seconds
                setTimeout(() => {
                    notification.close();
                }, 8000);

                return notification;
            } catch (error) {
                console.error('Failed to send notification:', error);
            }
        }

        function initializeBrowserNotifications() {
            // Check if previously enabled
            const wasEnabled = localStorage.getItem('browser_notifications_enabled');
            if (wasEnabled === 'true' && Notification.permission === 'granted') {
                browserNotificationsEnabled = true;
            }

            // Add notification settings button to settings tab
            addNotificationSettings();
        }

        function addNotificationSettings() {
            // Find the data management card and add notification settings after it
            const settingsTab = document.getElementById('settings-tab');
            if (!settingsTab) return;

            const dataManagementCard = settingsTab.querySelector('.bg-white:nth-child(2)');
            if (!dataManagementCard) return;

            const notificationCard = document.createElement('div');
            notificationCard.className = 'bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg';
            notificationCard.innerHTML = `
                <h3 class="text-xl font-bold mb-4">üîî Browser Notifications</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">Push Notifications</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Get notifications sent to your device</div>
                        </div>
                        <div id="notificationStatus" class="text-sm font-medium">
                            ${browserNotificationsEnabled ? '‚úÖ Enabled' : '‚ùå Disabled'}
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="toggleBrowserNotifications()" id="notificationToggleBtn" class="w-full ${browserNotificationsEnabled ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-white py-2 rounded-lg">
                            ${browserNotificationsEnabled ? 'üîï Disable Notifications' : 'üîî Enable Notifications'}
                        </button>
                        <button onclick="testBrowserNotification()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600" ${!browserNotificationsEnabled ? 'disabled' : ''}>
                            üì± Test Notification
                        </button>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg">
                        <h4 class="font-bold mb-2 text-sm">üí° What you'll get notified about:</h4>
                        <ul class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                            <li>‚Ä¢ üèÜ Achievement unlocks</li>
                            <li>‚Ä¢ üéä Level ups</li>
                            <li>‚Ä¢ üçÖ Pomodoro timer completion</li>
                            <li>‚Ä¢ üíß Hydration reminders</li>
                            <li>‚Ä¢ üß† AI insights and recommendations</li>
                            <li>‚Ä¢ üéµ Music session updates</li>
                        </ul>
                    </div>
                </div>
            `;

            // Insert after data management card
            dataManagementCard.parentNode.insertBefore(notificationCard, dataManagementCard.nextSibling);
        }

        async function toggleBrowserNotifications() {
            if (browserNotificationsEnabled) {
                // Disable notifications
                browserNotificationsEnabled = false;
                localStorage.setItem('browser_notifications_enabled', 'false');
                updateNotificationSettings();
                showFloatingNotification('üîï Disabled', 'Browser notifications turned off');
            } else {
                // Enable notifications
                const granted = await requestNotificationPermission();
                updateNotificationSettings();
                if (granted) {
                    sendBrowserNotification('üéÆ Life Quest RPG', 'Browser notifications are now enabled!', 'üîî');
                }
            }
        }

        function updateNotificationSettings() {
            const statusEl = document.getElementById('notificationStatus');
            const toggleBtn = document.getElementById('notificationToggleBtn');
            
            if (statusEl) {
                statusEl.textContent = browserNotificationsEnabled ? '‚úÖ Enabled' : '‚ùå Disabled';
            }
            
            if (toggleBtn) {
                toggleBtn.textContent = browserNotificationsEnabled ? 'üîï Disable Notifications' : 'üîî Enable Notifications';
                toggleBtn.className = `w-full ${browserNotificationsEnabled ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-white py-2 rounded-lg`;
            }
        }

        function testBrowserNotification() {
            if (browserNotificationsEnabled) {
                sendBrowserNotification(
                    'üéÆ Life Quest RPG Test',
                    'This is a test notification from your Life Quest RPG app!',
                    'üì±'
                );
                showFloatingNotification('üì± Test Sent', 'Check your device for the notification');
            }
        }

        // Enhanced notification sending for key events
        function sendGameEventNotification(type, title, body, icon) {
            // Send both in-app and browser notifications
            showFloatingNotification(title, body, icon);
            
            if (browserNotificationsEnabled) {
                sendBrowserNotification(title, body, icon, type);
            }
        }

        function showFloatingNotification(title, message, icon = 'üéâ', duration = 4000, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const template = document.getElementById('notificationTemplate');
            const notification = template.content.cloneNode(true);
            
            const notificationEl = notification.querySelector('.notification-toast');
            const iconEl = notification.querySelector('.notification-icon');
            const titleEl = notification.querySelector('.notification-title');
            const messageEl = notification.querySelector('.notification-message');
            const progressEl = notification.querySelector('.notification-progress');
            const progressBarEl = notification.querySelector('.notification-progress-bar');
            const closeBtn = notification.querySelector('.notification-close');
            
            const currentId = notificationId++;
            notificationEl.setAttribute('data-id', currentId);
            
            // Set content
            iconEl.textContent = icon;
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // Set colors based on type
            const colorClasses = {
                info: 'border-blue-500 text-blue-600',
                success: 'border-green-500 text-green-600',
                warning: 'border-yellow-500 text-yellow-600',
                error: 'border-red-500 text-red-600',
                achievement: 'border-yellow-500 text-yellow-600',
                music: 'border-spotify text-spotify'
            };
            
            notificationEl.classList.add(colorClasses[type] || colorClasses.info);
            progressBarEl.style.color = type === 'music' ? '#1DB954' : undefined;
            
            // Add to container
            container.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notificationEl.style.transform = 'translateX(0)';
            }, 100);
            
            // Progress bar animation
            progressBarEl.style.width = '100%';
            progressBarEl.style.transition = `width ${duration}ms linear`;
            setTimeout(() => {
                progressBarEl.style.width = '0%';
            }, 100);
            
            // Close button handler
            closeBtn.addEventListener('click', () => {
                removeNotification(notificationEl);
            });
            
            // Auto remove
            setTimeout(() => {
                removeNotification(notificationEl);
            }, duration);
            
            // Add to queue for management
            notificationQueue.push({
                id: currentId,
                element: notificationEl,
                timestamp: Date.now()
            });
            
            // Limit notifications
            if (notificationQueue.length > 5) {
                const oldestNotification = notificationQueue.shift();
                removeNotification(oldestNotification.element);
            }
        }

        function removeNotification(notificationEl) {
            if (!notificationEl || !notificationEl.parentNode) return;
            
            notificationEl.style.transform = 'translateX(100%)';
            notificationEl.style.opacity = '0';
            
            setTimeout(() => {
                if (notificationEl.parentNode) {
                    notificationEl.parentNode.removeChild(notificationEl);
                }
                
                // Remove from queue
                const id = parseInt(notificationEl.getAttribute('data-id'));
                notificationQueue = notificationQueue.filter(n => n.id !== id);
            }, 300);
        }

        // Enhanced notification types
        function showSuccessNotification(title, message) {
            showFloatingNotification(title, message, '‚úÖ', 3000, 'success');
        }

        function showErrorNotification(title, message) {
            showFloatingNotification(title, message, '‚ùå', 5000, 'error');
        }

        function showWarningNotification(title, message) {
            showFloatingNotification(title, message, '‚ö†Ô∏è', 4000, 'warning');
        }

        function showMusicNotification(title, message) {
            showFloatingNotification(title, message, 'üéµ', 3000, 'music');
        }

        function showAchievementNotification(title, message) {
            showFloatingNotification(title, message, 'üèÜ', 6000, 'achievement');
        }

        // üéµ PERSISTENT MUSIC PLAYER FUNCTIONS
        function showPersistentMusicPlayer() {
            if (!spotifyState.isConnected) return;
            
            const player = document.getElementById('persistentMusicPlayer');
            const minimized = document.getElementById('minimizedMusicPlayer');
            
            player.style.display = 'block';
            minimized.style.display = 'none';
            
            updatePersistentPlayer();
        }

        function minimizeMusicPlayer() {
            const player = document.getElementById('persistentMusicPlayer');
            const minimized = document.getElementById('minimizedMusicPlayer');
            
            player.style.display = 'none';
            minimized.style.display = 'block';
            
            updateMinimizedPlayer();
        }

        function expandMusicPlayer() {
            showPersistentMusicPlayer();
        }

        function closeMusicPlayer() {
            const player = document.getElementById('persistentMusicPlayer');
            const minimized = document.getElementById('minimizedMusicPlayer');
            
            player.style.display = 'none';
            minimized.style.display = 'none';
        }

        function updatePersistentPlayer() {
            const albumArt = document.getElementById('persistentAlbumArt');
            const trackName = document.getElementById('persistentTrackName');
            const artistName = document.getElementById('persistentArtistName');
            const playBtn = document.getElementById('persistentPlayBtn');
            const progressContainer = document.getElementById('persistentProgressContainer');
            
            if (!spotifyState.currentTrack || !spotifyState.currentTrack.item) {
                trackName.textContent = 'No track playing';
                artistName.textContent = 'Connect Spotify to start';
                albumArt.innerHTML = 'üéµ';
                progressContainer.style.display = 'none';
                return;
            }
            
            const track = spotifyState.currentTrack.item;
            const isPlaying = spotifyState.currentTrack.is_playing;
            
            // Update track info
            trackName.textContent = track.name;
            artistName.textContent = track.artists?.map(a => a.name).join(', ') || 'Unknown Artist';
            
            // Update album art
            if (track.album?.images?.[0]?.url) {
                albumArt.innerHTML = `<img src="${track.album.images[0].url}" alt="Album Art" class="w-full h-full object-cover rounded-lg">`;
            } else {
                albumArt.innerHTML = 'üéµ';
            }
            
            // Update play button
            playBtn.innerHTML = isPlaying ? 
                '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>' :
                '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>';
            
            // Update progress if available
            if (spotifyState.currentTrack.progress_ms && track.duration_ms) {
                const progress = (spotifyState.currentTrack.progress_ms / track.duration_ms) * 100;
                const progressBar = document.getElementById('persistentProgressBar');
                const currentTime = document.getElementById('persistentCurrentTime');
                const totalTime = document.getElementById('persistentTotalTime');
                
                if (progressBar) progressBar.style.width = `${progress}%`;
                if (currentTime) currentTime.textContent = formatTime(spotifyState.currentTrack.progress_ms);
                if (totalTime) totalTime.textContent = formatTime(track.duration_ms);
                progressContainer.style.display = 'block';
            } else {
                progressContainer.style.display = 'none';
            }
        }

        function updateMinimizedPlayer() {
            const trackName = document.getElementById('minimizedTrackName');
            
            if (!spotifyState.currentTrack || !spotifyState.currentTrack.item) {
                trackName.textContent = 'No track';
                return;
            }
            
            trackName.textContent = spotifyState.currentTrack.item.name;
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // üéä POPUP SYSTEMS
        function showAchievementPopup(achievement) {
            const popup = document.getElementById('achievementPopup');
            const title = document.getElementById('achievementTitle');
            const description = document.getElementById('achievementDescription');
            const xp = document.getElementById('achievementXP');
            
            title.textContent = achievement.title;
            description.textContent = achievement.description;
            xp.textContent = `+${achievement.xp} XP`;
            
            popup.style.display = 'flex';
            popup.querySelector('.bg-gradient-to-br').style.transform = 'scale(1)';
            
            // Auto close after 6 seconds
            setTimeout(() => {
                closeAchievementPopup();
            }, 6000);
        }

        function closeAchievementPopup() {
            const popup = document.getElementById('achievementPopup');
            popup.querySelector('.bg-gradient-to-br').style.transform = 'scale(0.95)';
            
            setTimeout(() => {
                popup.style.display = 'none';
            }, 300);
        }

        function showLevelUpPopup(level) {
            const popup = document.getElementById('levelUpPopup');
            const levelNumber = document.getElementById('levelUpNumber');
            const progress = document.getElementById('levelUpProgress');
            
            levelNumber.textContent = `Level ${level}`;
            
            const progressPercent = (gameState.currentXP / gameState.xpToNextLevel) * 100;
            progress.style.width = `${progressPercent}%`;
            
            popup.style.display = 'flex';
            popup.querySelector('.bg-gradient-to-br').style.transform = 'scale(1)';
            
            // Auto close after 8 seconds
            setTimeout(() => {
                closeLevelUpPopup();
            }, 8000);
        }

        function closeLevelUpPopup() {
            const popup = document.getElementById('levelUpPopup');
            popup.querySelector('.bg-gradient-to-br').style.transform = 'scale(0.95)';
            
            setTimeout(() => {
                popup.style.display = 'none';
            }, 300);
        }

        // üß† AI INSIGHTS POPUP
        function showAIInsightPopup(insight) {
            const popup = document.getElementById('aiInsightsPopup');
            const text = document.getElementById('aiInsightText');
            
            text.textContent = insight;
            popup.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                closeAIInsightPopup();
            }, 8000);
        }

        function closeAIInsightPopup() {
            const popup = document.getElementById('aiInsightsPopup');
            popup.style.transform = 'translateX(100%)';
        }

        // üì± CONTEXT MENU SYSTEM
        function showContextMenu(x, y, items) {
            const menu = document.getElementById('contextMenu');
            const container = menu.querySelector('.context-menu-items');
            
            container.innerHTML = items.map(item => `
                <button onclick="${item.action}; hideContextMenu();" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm">
                    ${item.icon} ${item.label}
                </button>
            `).join('');
            
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.style.display = 'block';
            
            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', hideContextMenu, { once: true });
            }, 100);
        }

        function hideContextMenu() {
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'none';
        }

        // üìù MODALS AND FORMS
        function showAddTaskModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">‚ûï Add New Quest</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Quest Description</label>
                            <input type="text" id="taskText" placeholder="What do you want to accomplish?" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Category</label>
                            <select id="taskCategory" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <option value="fitness">üí™ Fitness</option>
                                <option value="nutrition">üçé Nutrition</option>
                                <option value="wellness">üíÜ Wellness</option>
                                <option value="productivity">üß† Productivity</option>
                                <option value="personal">üë§ Personal</option>
                                <option value="learning">üìö Learning</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">XP Reward</label>
                            <select id="taskXP" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                <option value="5">5 XP - Quick task</option>
                                <option value="10">10 XP - Small task</option>
                                <option value="15" selected>15 XP - Medium task</option>
                                <option value="25">25 XP - Large task</option>
                                <option value="50">50 XP - Major achievement</option>
                            </select>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="createTask()" class="flex-1 bg-primary text-white py-3 rounded-lg hover:bg-purple-600 font-bold">
                                üöÄ Create Quest
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function createTask() {
            const text = document.getElementById('taskText').value.trim();
            const category = document.getElementById('taskCategory').value;
            const xp = parseInt(document.getElementById('taskXP').value);
            
            if (!text) {
                showFloatingNotification('‚ùå Error', 'Please enter a task description');
                return;
            }
            
            const categoryIcons = {
                fitness: 'üí™',
                nutrition: 'üçé',
                wellness: 'üíÜ',
                productivity: 'üß†',
                personal: 'üë§',
                learning: 'üìö'
            };
            
            addTask(text, category, xp, categoryIcons[category]);
            document.querySelector('.fixed').remove();
            
            showFloatingNotification('‚úÖ Quest Added', `"${text}" added to your quest log!`);
        }

        function showNutritionModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üçé Log Nutrition</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Calories</label>
                            <input type="number" id="caloriesInput" placeholder="Enter calories" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Protein (grams)</label>
                            <input type="number" id="proteinInput" placeholder="Enter protein" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="logNutrition()" class="flex-1 bg-nutrition text-white py-3 rounded-lg hover:bg-green-600 font-bold">
                                üìù Log Food
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function logNutrition() {
            const calories = parseInt(document.getElementById('caloriesInput').value) || 0;
            const protein = parseInt(document.getElementById('proteinInput').value) || 0;
            
            gameState.dailyStats.calories += calories;
            gameState.dailyStats.protein += protein;
            gameState.dailyStats.meals++;
            
            updateAllUI();
            saveGameState();
            
            document.querySelector('.fixed').remove();
            awardXP(10, 'Logged nutrition data');
            
            showFloatingNotification('üìù Nutrition Logged', `+${calories} calories, +${protein}g protein`);
        }

        function showSleepModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">üò¥ Log Sleep</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Hours of Sleep</label>
                            <input type="number" id="sleepInput" min="0" max="12" step="0.5" placeholder="7.5" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="logSleep()" class="flex-1 bg-wellness text-white py-3 rounded-lg hover:bg-purple-600 font-bold">
                                üí§ Log Sleep
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function logSleep() {
            const hours = parseFloat(document.getElementById('sleepInput').value) || 0;
            
            gameState.dailyStats.sleepHours = hours;
            
            updateAllUI();
            saveGameState();
            
            document.querySelector('.fixed').remove();
            
            let xp = 10;
            if (hours >= 8) xp = 25;
            else if (hours >= 7) xp = 20;
            
            awardXP(xp, `Logged ${hours} hours of sleep`);
            
            showFloatingNotification('üí§ Sleep Logged', `${hours} hours of rest recorded`);
        }

        // üß† ADVANCED AI NUTRITION SYSTEM
        let nutritionAI = {
            macroTargets: { protein: 0, carbs: 0, fat: 0, calories: 0 },
            microNutrients: {
                vitamins: { A: 0, C: 0, D: 0, E: 0, K: 0, B1: 0, B2: 0, B3: 0, B6: 0, B12: 0, folate: 0 },
                minerals: { calcium: 0, iron: 0, magnesium: 0, potassium: 0, zinc: 0, selenium: 0 }
            },
            mealTiming: { breakfast: null, lunch: null, dinner: null, snacks: [] },
            metabolicProfile: { BMR: 0, TDEE: 0, metabolicAge: 0 },
            nutritionScore: 0,
            deficiencies: [],
            recommendations: []
        };

        // üí™ ADVANCED AI WORKOUT SYSTEM
        let workoutAI = {
            muscleGroups: {
                chest: { fatigue: 0, lastWorked: null, volume: 0, strength: 100 },
                back: { fatigue: 0, lastWorked: null, volume: 0, strength: 100 },
                shoulders: { fatigue: 0, lastWorked: null, volume: 0, strength: 100 },
                arms: { fatigue: 0, lastWorked: null, volume: 0, strength: 100 },
                legs: { fatigue: 0, lastWorked: null, volume: 0, strength: 100 },
                core: { fatigue: 0, lastWorked: null, volume: 0, strength: 100 }
            },
            workoutProgression: { week: 1, phase: 'strength', intensity: 75, volume: 100 },
            recoveryMetrics: { sleepQuality: 80, soreness: 0, energy: 80, motivation: 80 },
            workoutHistory: [],
            adaptations: { strength: 0, endurance: 0, powerOutput: 0 },
            injuryRisk: 0
        };

        // üìã ADVANCED AI TASK SYSTEM
        let taskAI = {
            cognitiveLoad: 0,
            attentionSpan: 25,
            energyProfile: { morning: 80, afternoon: 60, evening: 40 },
            taskComplexity: {},
            dependencies: {},
            contextSwitchCost: 0,
            flowState: { current: 0, peak: 0, triggers: [] },
            procrastinationFactors: [],
            timeBlocks: [],
            urgencyMatrix: { urgent_important: [], not_urgent_important: [], urgent_not_important: [], not_urgent_not_important: [] }
        };

        function calculateNutritionTargets() {
            const profile = gameState.profile;
            const stats = gameState.dailyStats;
            
            // Use actual profile data or fallback to defaults
            const age = profile.age || 30;
            const weight = profile.weight || 70; // kg
            const height = profile.height || 170; // cm
            const gender = profile.gender || 'male';
            const activityLevel = profile.activityLevel || 'moderate';
            
            let BMR;
            if (gender === 'male') {
                BMR = 10 * weight + 6.25 * height - 5 * age + 5;
            } else if (gender === 'female') {
                BMR = 10 * weight + 6.25 * height - 5 * age - 161;
            } else {
                // Non-binary/other - use average of male/female formulas
                const maleBMR = 10 * weight + 6.25 * height - 5 * age + 5;
                const femaleBMR = 10 * weight + 6.25 * height - 5 * age - 161;
                BMR = (maleBMR + femaleBMR) / 2;
            }
            
            // Activity multipliers based on detailed activity level
            const activityMultipliers = {
                sedentary: 1.2,
                light: 1.375,
                moderate: 1.55,
                active: 1.725,
                very_active: 1.9
            };
            
            const TDEE = BMR * activityMultipliers[activityLevel];
            
            nutritionAI.metabolicProfile.BMR = BMR;
            nutritionAI.metabolicProfile.TDEE = TDEE;
            
            // Macro targets based on goals
            const goalMultipliers = {
                lose_weight: { calories: 0.8, protein: 2.2, carbs: 0.4, fat: 0.25 },
                build_muscle: { calories: 1.1, protein: 2.5, carbs: 0.45, fat: 0.25 },
                endurance: { calories: 1.2, protein: 1.8, carbs: 0.6, fat: 0.2 },
                general: { calories: 1.0, protein: 2.0, carbs: 0.5, fat: 0.25 }
            };
            
            const goal = profile.fitnessGoal || 'general';
            const multipliers = goalMultipliers[goal];
            
            nutritionAI.macroTargets.calories = Math.round(TDEE * multipliers.calories);
            nutritionAI.macroTargets.protein = Math.round(weight * multipliers.protein);
            nutritionAI.macroTargets.carbs = Math.round((TDEE * multipliers.calories * multipliers.carbs) / 4);
            nutritionAI.macroTargets.fat = Math.round((TDEE * multipliers.calories * multipliers.fat) / 9);
            
            return nutritionAI.macroTargets;
        }

        function analyzeNutritionalGaps() {
            const current = gameState.dailyStats;
            const targets = nutritionAI.macroTargets;
            const gaps = [];
            
            // Protein analysis
            const proteinRatio = current.protein / targets.protein;
            if (proteinRatio < 0.7) {
                gaps.push({
                    nutrient: 'protein',
                    severity: 'high',
                    deficit: targets.protein - current.protein,
                    impact: 'muscle recovery and growth',
                    recommendations: ['Add lean meat to next meal', 'Consider protein shake', 'Include eggs or dairy']
                });
            }
            
            // Calorie analysis
            const calorieRatio = current.calories / targets.calories;
            if (calorieRatio < 0.6) {
                gaps.push({
                    nutrient: 'calories',
                    severity: 'moderate',
                    deficit: targets.calories - current.calories,
                    impact: 'energy levels and metabolism',
                    recommendations: ['Add healthy fats', 'Include complex carbs', 'Increase meal frequency']
                });
            }
            
            // Time-based analysis
            const hour = new Date().getHours();
            if (hour > 14 && current.meals < 2) {
                gaps.push({
                    nutrient: 'meal_timing',
                    severity: 'moderate',
                    deficit: 'missed meals',
                    impact: 'blood sugar stability',
                    recommendations: ['Plan balanced lunch', 'Prepare healthy snacks', 'Set meal reminders']
                });
            }
            
            nutritionAI.deficiencies = gaps;
            return gaps;
        }

        function generateNutritionPlan() {
            const targets = calculateNutritionTargets();
            const gaps = analyzeNutritionalGaps();
            const hour = new Date().getHours();
            const recommendations = [];
            
            // Meal timing optimization
            const optimalMealTimes = {
                breakfast: { start: 6, end: 9, importance: 0.9 },
                lunch: { start: 11, end: 14, importance: 0.8 },
                preworkout: { start: 15, end: 17, importance: 0.7 },
                dinner: { start: 18, end: 20, importance: 0.8 },
                postworkout: { start: 16, end: 19, importance: 0.9 }
            };
            
            // Pre-workout nutrition
            if (hour >= 14 && hour <= 17 && gameState.dailyStats.workouts === 0) {
                recommendations.push({
                    type: 'pre_workout',
                    priority: 0.9,
                    meal: 'Pre-workout fuel',
                    components: ['Complex carbs (banana, oats)', 'Small amount of protein', 'Light on fats'],
                    timing: '30-60 minutes before workout',
                    rationale: 'Optimize energy and performance'
                });
            }
            
            // Post-workout nutrition
            if (gameState.dailyStats.workouts > 0) {
                const lastWorkout = workoutAI.workoutHistory[0];
                if (lastWorkout && Date.now() - new Date(lastWorkout.timestamp).getTime() < 2 * 60 * 60 * 1000) {
                    recommendations.push({
                        type: 'post_workout',
                        priority: 0.95,
                        meal: 'Recovery nutrition',
                        components: ['Fast protein (whey/casein)', 'Simple carbs for glycogen', 'Anti-inflammatory foods'],
                        timing: 'Within 30 minutes',
                        rationale: 'Maximize recovery and muscle protein synthesis'
                    });
                }
            }
            
            // Micronutrient optimization
            if (gaps.length > 0) {
                gaps.forEach(gap => {
                    if (gap.nutrient === 'protein') {
                        recommendations.push({
                            type: 'protein_boost',
                            priority: 0.85,
                            meal: 'Protein-rich snack',
                            components: ['Greek yogurt', 'Nuts/seeds', 'Lean meat'],
                            timing: 'Next meal or snack',
                            rationale: gap.impact
                        });
                    }
                });
            }
            
            nutritionAI.recommendations = recommendations;
            return recommendations;
        }

        function calculateWorkoutReadiness() {
            const recovery = workoutAI.recoveryMetrics;
            const muscles = workoutAI.muscleGroups;
            
            // Sleep quality impact (0-100 scale)
            const sleepFactor = gameState.dailyStats.sleepHours >= 7 ? 1.0 : gameState.dailyStats.sleepHours / 7;
            
            // Nutrition impact
            const nutritionFactor = Math.min(1.0, gameState.dailyStats.protein / 100); // Simplified
            
            // Hydration impact
            const hydrationFactor = Math.min(1.0, gameState.dailyStats.waterGlasses / 8);
            
            // Muscle recovery analysis
            const muscleReadiness = Object.values(muscles).reduce((avg, muscle) => {
                const daysSinceWork = muscle.lastWorked ? (Date.now() - new Date(muscle.lastWorked).getTime()) / (24 * 60 * 60 * 1000) : 7;
                const recoveryScore = Math.min(1.0, daysSinceWork / 2); // 48-hour recovery window
                return avg + (recoveryScore * (1 - muscle.fatigue));
            }, 0) / Object.keys(muscles).length;
            
            const overallReadiness = (sleepFactor * 0.3 + nutritionFactor * 0.2 + hydrationFactor * 0.2 + muscleReadiness * 0.3) * 100;
            
            return {
                overall: Math.round(overallReadiness),
                factors: {
                    sleep: Math.round(sleepFactor * 100),
                    nutrition: Math.round(nutritionFactor * 100),
                    hydration: Math.round(hydrationFactor * 100),
                    recovery: Math.round(muscleReadiness * 100)
                }
            };
        }

        function generateOptimalWorkout() {
            const readiness = calculateWorkoutReadiness();
            const muscles = workoutAI.muscleGroups;
            const progression = workoutAI.workoutProgression;
            
            // Find most recovered muscle groups
            const muscleScores = Object.entries(muscles).map(([name, data]) => {
                const daysSinceWork = data.lastWorked ? (Date.now() - new Date(data.lastWorked).getTime()) / (24 * 60 * 60 * 1000) : 7;
                const recoveryScore = Math.min(1.0, daysSinceWork / 2);
                const fatigueScore = 1 - data.fatigue;
                return { name, score: recoveryScore * fatigueScore, data };
            }).sort((a, b) => b.score - a.score);
            
            const targetMuscles = muscleScores.slice(0, 3).map(m => m.name);
            
            // Workout templates based on muscle groups and goals
            const workoutTemplates = {
                strength: {
                    chest: ['Bench Press 4x6', 'Incline Dumbbell Press 3x8', 'Dips 3x8-12'],
                    back: ['Deadlifts 4x5', 'Pull-ups 3x8', 'Rows 3x8'],
                    legs: ['Squats 4x6', 'Romanian Deadlifts 3x8', 'Bulgarian Split Squats 3x10'],
                    shoulders: ['Overhead Press 4x6', 'Lateral Raises 3x12', 'Face Pulls 3x15'],
                    arms: ['Close-Grip Bench 3x8', 'Barbell Curls 3x10', 'Tricep Dips 3x12']
                },
                hypertrophy: {
                    chest: ['Incline Press 4x8-10', 'Dumbbell Flyes 3x12', 'Push-ups 3xAMRAP'],
                    back: ['Lat Pulldowns 4x10', 'Cable Rows 3x12', 'Face Pulls 3x15'],
                    legs: ['Leg Press 4x12', 'Leg Curls 3x12', 'Calf Raises 4x15'],
                    shoulders: ['Dumbbell Press 4x10', 'Lateral Raises 4x12', 'Rear Delt Flyes 3x15'],
                    arms: ['Hammer Curls 3x12', 'Tricep Extensions 3x12', 'Cable Curls 3x15']
                },
                endurance: {
                    full_body: ['Circuit: Push-ups, Squats, Burpees, Mountain Climbers', 'HIIT: 30s work, 15s rest x 20 rounds', 'Steady State Cardio 30-45 minutes']
                }
            };
            
            // Adjust intensity based on readiness
            let intensity = progression.intensity;
            if (readiness.overall < 70) {
                intensity *= 0.8; // Reduce intensity if not well recovered
            } else if (readiness.overall > 90) {
                intensity *= 1.1; // Increase intensity if fully recovered
            }
            
            const workoutType = readiness.overall > 80 ? 'strength' : 'hypertrophy';
            const exercises = [];
            
            targetMuscles.forEach(muscle => {
                if (workoutTemplates[workoutType][muscle]) {
                    exercises.push(...workoutTemplates[workoutType][muscle]);
                }
            });
            
            return {
                type: workoutType,
                targetMuscles,
                exercises: exercises.slice(0, 6), // Limit to 6 exercises
                intensity: Math.round(intensity),
                duration: readiness.overall > 80 ? 60 : 45,
                restPeriods: workoutType === 'strength' ? '2-3 minutes' : '1-2 minutes',
                readinessScore: readiness.overall,
                notes: generateWorkoutNotes(readiness, targetMuscles)
            };
        }

        function generateWorkoutNotes(readiness, muscles) {
            const notes = [];
            
            if (readiness.factors.sleep < 70) {
                notes.push('üõå Prioritize sleep for better recovery');
            }
            if (readiness.factors.hydration < 80) {
                notes.push('üíß Increase water intake before and during workout');
            }
            if (readiness.factors.nutrition < 70) {
                notes.push('üçé Consider pre-workout nutrition');
            }
            if (readiness.overall > 90) {
                notes.push('üî• Perfect day for a challenging workout!');
            }
            
            notes.push(`üéØ Focus areas: ${muscles.join(', ')}`);
            
            return notes;
        }

        function calculateTaskComplexity(taskText) {
            const complexityFactors = {
                keywords: {
                    high: ['design', 'create', 'write', 'analyze', 'research', 'plan', 'strategy', 'complex'],
                    medium: ['organize', 'review', 'update', 'prepare', 'schedule', 'call', 'meeting'],
                    low: ['check', 'reply', 'quick', 'simple', 'easy', 'routine', 'daily']
                },
                length: taskText.length,
                timeIndicators: /(\d+)\s*(hour|minute|day)/gi.test(taskText)
            };
            
            let complexity = 50; // Base complexity
            
            // Keyword analysis
            const text = taskText.toLowerCase();
            complexityFactors.keywords.high.forEach(keyword => {
                if (text.includes(keyword)) complexity += 20;
            });
            complexityFactors.keywords.medium.forEach(keyword => {
                if (text.includes(keyword)) complexity += 10;
            });
            complexityFactors.keywords.low.forEach(keyword => {
                if (text.includes(keyword)) complexity -= 10;
            });
            
            // Length factor
            if (complexityFactors.length > 50) complexity += 15;
            if (complexityFactors.length < 20) complexity -= 10;
            
            return Math.max(10, Math.min(100, complexity));
        }

        function optimizeTaskScheduling() {
            const tasks = gameState.tasks.filter(t => !t.completed);
            const hour = new Date().getHours();
            const currentEnergy = calculateCurrentEnergyScore();
            
            // Analyze task complexities
            tasks.forEach(task => {
                taskAI.taskComplexity[task.id] = calculateTaskComplexity(task.text);
            });
            
            // Energy-complexity matching
            const highEnergyTasks = tasks.filter(t => taskAI.taskComplexity[t.id] > 70);
            const mediumEnergyTasks = tasks.filter(t => taskAI.taskComplexity[t.id] >= 40 && taskAI.taskComplexity[t.id] <= 70);
            const lowEnergyTasks = tasks.filter(t => taskAI.taskComplexity[t.id] < 40);
            
            const recommendations = [];
            
            // Time block optimization
            if (hour >= 9 && hour <= 11 && currentEnergy > 70) {
                recommendations.push({
                    timeBlock: 'Morning Peak (9-11 AM)',
                    recommendedTasks: highEnergyTasks.slice(0, 2),
                    rationale: 'Highest cognitive performance window',
                    technique: 'Deep Work - 90 minute blocks'
                });
            }
            
            if (hour >= 14 && hour <= 16 && currentEnergy > 50) {
                recommendations.push({
                    timeBlock: 'Afternoon Focus (2-4 PM)',
                    recommendedTasks: mediumEnergyTasks.slice(0, 3),
                    rationale: 'Good for collaborative and routine tasks',
                    technique: 'Pomodoro - 25 minute sessions'
                });
            }
            
            if (hour >= 16 && hour <= 18) {
                recommendations.push({
                    timeBlock: 'Administrative Hours (4-6 PM)',
                    recommendedTasks: lowEnergyTasks,
                    rationale: 'Handle emails, planning, and simple tasks',
                    technique: 'Batch processing'
                });
            }
            
            // Context switching analysis
            const categories = [...new Set(tasks.map(t => t.category))];
            if (categories.length > 3) {
                recommendations.push({
                    optimization: 'Context Switching',
                    suggestion: 'Group similar tasks together',
                    rationale: `${categories.length} different contexts detected - high switching cost`,
                    technique: 'Theme days or time blocks by category'
                });
            }
            
            // Procrastination factors
            const overdueTasks = tasks.filter(t => {
                const daysSinceCreated = (Date.now() - new Date(t.createdAt).getTime()) / (24 * 60 * 60 * 1000);
                return daysSinceCreated > 2;
            });
            
            if (overdueTasks.length > 0) {
                recommendations.push({
                    issue: 'Procrastination Pattern',
                    tasks: overdueTasks.slice(0, 2),
                    suggestion: 'Break down into smaller, 15-minute tasks',
                    technique: '2-minute rule: if it takes less than 2 minutes, do it now'
                });
            }
            
            taskAI.timeBlocks = recommendations;
            return recommendations;
        }

        function generateAITasks() {
            // Get advanced AI recommendations from all systems
            const nutritionPlan = generateNutritionPlan();
            const workoutPlan = generateOptimalWorkout();
            const taskOptimization = optimizeTaskScheduling();
            
            const aiTasks = [];
            const hour = new Date().getHours();
            const currentEnergy = calculateCurrentEnergyScore();
            
            // Nutrition-based tasks
            nutritionPlan.forEach(rec => {
                aiTasks.push({
                    text: `${rec.meal}: ${rec.components.slice(0, 2).join(', ')}`,
                    category: 'nutrition',
                    xp: rec.priority * 25,
                    icon: 'üçé',
                    priority: rec.priority,
                    aiReasoning: rec.rationale,
                    timing: rec.timing,
                    complexity: 40
                });
            });
            
            // Workout-based tasks
            if (workoutPlan.readinessScore > 60) {
                aiTasks.push({
                    text: `${workoutPlan.type.charAt(0).toUpperCase() + workoutPlan.type.slice(1)} workout: ${workoutPlan.targetMuscles.join(', ')}`,
                    category: 'fitness',
                    xp: Math.round(workoutPlan.intensity / 2),
                    icon: 'üí™',
                    priority: workoutPlan.readinessScore / 100,
                    aiReasoning: `Readiness: ${workoutPlan.readinessScore}% - ${workoutPlan.notes[0]}`,
                    duration: workoutPlan.duration,
                    complexity: workoutPlan.intensity
                });
            }
            
            // Productivity optimization tasks
            if (taskOptimization.length > 0) {
                const topRecommendation = taskOptimization[0];
                if (topRecommendation.recommendedTasks) {
                    aiTasks.push({
                        text: `Focus block: ${topRecommendation.technique} for high-priority tasks`,
                        category: 'productivity',
                        xp: 30,
                        icon: 'üß†',
                        priority: 0.85,
                        aiReasoning: topRecommendation.rationale,
                        technique: topRecommendation.technique,
                        complexity: 70
                    });
                }
            }
            
            // Energy-based wellness tasks
            if (currentEnergy < 60) {
                aiTasks.push({
                    text: 'Energy restoration: 10-minute breathing + hydration break',
                    category: 'wellness',
                    xp: 15,
                    icon: '‚ö°',
                    priority: 0.8,
                    aiReasoning: `Low energy detected (${currentEnergy}/100)`,
                    technique: 'Box breathing + movement',
                    complexity: 20
                });
            }
            
            // Circadian rhythm optimization
            if (hour >= 6 && hour <= 8) {
                aiTasks.push({
                    text: 'Morning activation: Sunlight exposure + movement routine',
                    category: 'wellness',
                    xp: 20,
                    icon: 'üåÖ',
                    priority: 0.9,
                    aiReasoning: 'Optimize circadian rhythm and cortisol awakening response',
                    timing: 'First 30 minutes awake',
                    complexity: 30
                });
            }
            
            // Sort by priority and complexity matching
            aiTasks.sort((a, b) => {
                const energyMatch = Math.abs(currentEnergy - a.complexity) - Math.abs(currentEnergy - b.complexity);
                return b.priority - a.priority + (energyMatch * 0.01);
            });
            
            // Add to game state
            aiTasks.slice(0, 4).forEach(task => {
                const newTask = {
                    id: Date.now().toString() + Math.random(),
                    text: task.text,
                    category: task.category,
                    xp: Math.round(task.xp),
                    icon: task.icon,
                    completed: false,
                    createdAt: new Date().toISOString(),
                    aiGenerated: true,
                    priority: task.priority,
                    aiReasoning: task.aiReasoning,
                    complexity: task.complexity
                };
                gameState.tasks.unshift(newTask);
            });
            
            updateTasksListDetailed();
            saveGameState();
            
            showFloatingNotification('üß† Advanced AI Analysis', `Generated ${aiTasks.slice(0, 4).length} optimized tasks based on nutrition, workout readiness, and cognitive performance!`);
        }

        function calculateCategoryPriorities(stats, patterns, learningData, hour) {
            const priorities = {
                fitness: 0,
                nutrition: 0,
                productivity: 0,
                wellness: 0,
                learning: 0
            };
            
            // Base priority calculation
            if (stats.workouts === 0) priorities.fitness += 0.8;
            if (stats.meals < 2) priorities.nutrition += 0.7;
            if (stats.focusMinutes < 30) priorities.productivity += 0.6;
            if (stats.sleepHours < 7) priorities.wellness += 0.5;
            
            // Time-based adjustments
            if (hour >= 6 && hour <= 10) {
                priorities.fitness += 0.3;
                priorities.wellness += 0.2;
            } else if (hour >= 11 && hour <= 17) {
                priorities.productivity += 0.4;
                priorities.learning += 0.3;
            } else if (hour >= 18 && hour <= 22) {
                priorities.nutrition += 0.3;
                priorities.wellness += 0.4;
            }
            
            // Pattern-based adjustments
            if (patterns.bestWorkoutTimes.length > 0) {
                const avgWorkoutTime = patterns.bestWorkoutTimes.reduce((a, b) => a + b, 0) / patterns.bestWorkoutTimes.length;
                if (Math.abs(hour - avgWorkoutTime) <= 2) {
                    priorities.fitness += 0.5;
                }
            }
            
            // Learning data adjustments
            if (learningData.length > 5) {
                const recentData = learningData.slice(-7); // Last 7 data points
                const avgProductivity = recentData.reduce((sum, data) => sum + (data.stats.focusMinutes || 0), 0) / recentData.length;
                if (avgProductivity < 60) {
                    priorities.productivity += 0.3;
                }
            }
            
            return priorities;
        }

        function generateTaskFromTemplate(template, category, priority) {
            const categoryIcons = {
                fitness: 'üí™',
                nutrition: 'üçé',
                productivity: 'üß†',
                wellness: 'üíÜ',
                learning: 'üìö'
            };
            
            let text = template.base;
            
            // Replace placeholders with random variations
            Object.entries(template).forEach(([key, values]) => {
                if (Array.isArray(values) && key !== 'base') {
                    const placeholder = `{${key.slice(0, -1)}}`;
                    if (text.includes(placeholder)) {
                        const randomValue = values[Math.floor(Math.random() * values.length)];
                        text = text.replace(placeholder, randomValue);
                    }
                }
            });
            
            // Calculate XP based on priority and complexity
            const baseXP = { fitness: 25, nutrition: 15, productivity: 20, wellness: 15, learning: 18 }[category];
            const xp = Math.floor(baseXP * (0.8 + priority * 0.4));
            
            return {
                text,
                category,
                xp,
                icon: categoryIcons[category],
                priority
            };
        }

        function addContextualTasks(aiTasks, hour, stats, patterns) {
            // Hydration tasks
            if (stats.waterGlasses < 4) {
                aiTasks.push({
                    text: `Drink ${8 - stats.waterGlasses} more glasses of water today`,
                    category: 'wellness',
                    xp: 5 + (8 - stats.waterGlasses) * 2,
                    icon: 'üíß',
                    priority: 0.9
                });
            }
            
            // Energy-based tasks
            const energyScore = calculateCurrentEnergyScore();
            if (energyScore < 40) {
                aiTasks.push({
                    text: 'Take a 10-minute energy-boosting break',
                    category: 'wellness',
                    xp: 10,
                    icon: '‚ö°',
                    priority: 0.8
                });
            } else if (energyScore > 80) {
                aiTasks.push({
                    text: 'Tackle your most challenging task while energy is high',
                    category: 'productivity',
                    xp: 30,
                    icon: 'üöÄ',
                    priority: 0.9
                });
            }
            
            // Streak maintenance tasks
            Object.entries(gameState.streaks).forEach(([type, streak]) => {
                if (streak > 0 && streak < 7) {
                    const streakTasks = {
                        workout: { text: `Maintain your ${streak}-day workout streak!`, category: 'fitness', xp: 20 + streak * 3, icon: 'üî•' },
                        water: { text: `Keep up your ${streak}-day hydration streak!`, category: 'wellness', xp: 10 + streak * 2, icon: 'üíß' },
                        focus: { text: `Continue your ${streak}-day focus streak!`, category: 'productivity', xp: 15 + streak * 3, icon: 'üß†' }
                    };
                    
                    if (streakTasks[type]) {
                        aiTasks.push({
                            ...streakTasks[type],
                            priority: 0.7 + (streak * 0.05)
                        });
                    }
                }
            });
        }

        function checkForHealthData() {
            if (navigator.geolocation && 'permissions' in navigator) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    if (result.state === 'granted') {
                        // Could potentially use for step tracking or location-based tasks
                    }
                });
            }
        }

        // üß† PERSONALIZATION SYSTEM
        function calculatePersonalizedMetrics() {
            const profile = gameState.profile;
            
            // BMR calculation using Mifflin-St Jeor equation
            let BMR;
            if (profile.gender === 'male') {
                BMR = 10 * profile.weight + 6.25 * profile.height - 5 * profile.age + 5;
            } else if (profile.gender === 'female') {
                BMR = 10 * profile.weight + 6.25 * profile.height - 5 * profile.age - 161;
            } else {
                // Non-binary/other - use average of male/female formulas
                const maleBMR = 10 * profile.weight + 6.25 * profile.height - 5 * profile.age + 5;
                const femaleBMR = 10 * profile.weight + 6.25 * profile.height - 5 * profile.age - 161;
                BMR = (maleBMR + femaleBMR) / 2;
            }
            
            // Activity multipliers based on detailed activity level
            const activityMultipliers = {
                sedentary: 1.2,
                light: 1.375,
                moderate: 1.55,
                active: 1.725,
                very_active: 1.9
            };
            
            const TDEE = BMR * activityMultipliers[profile.activityLevel];
            
            // Calculate lean body mass
            const leanMass = profile.weight * (1 - profile.bodyFatPercentage / 100);
            
            // Calculate BMI
            const BMI = profile.weight / Math.pow(profile.height / 100, 2);
            
            // Estimate metabolic age based on BMR, BMI, and actual age
            const avgBMRForAge = profile.gender === 'male' ? (66.5 + 13.75 * 70 + 5.003 * 175 - 6.755 * profile.age) : (655.1 + 9.563 * 60 + 1.850 * 165 - 4.676 * profile.age);
            const metabolicAge = profile.age + (avgBMRForAge - BMR) / 10;
            
            // Calculate fitness age based on workout frequency and VO2 max
            const baseVO2 = profile.gender === 'male' ? 45 : 35;
            const vo2Adjustment = (profile.vo2Max - baseVO2) / 2;
            const workoutAdjustment = (profile.workoutFrequency - 2) * 2;
            const fitnessAge = Math.max(18, profile.age - vo2Adjustment - workoutAdjustment);
            
            // Update profile with calculated values
            profile.BMR = Math.round(BMR);
            profile.TDEE = Math.round(TDEE);
            profile.leanMass = Math.round(leanMass);
            profile.metabolicAge = Math.round(metabolicAge);
            profile.fitnessAge = Math.round(fitnessAge);
            
            // Calculate personalized daily goals
            calculatePersonalizedGoals();
            
            return {
                BMR: profile.BMR,
                TDEE: profile.TDEE,
                BMI: Math.round(BMI * 10) / 10,
                leanMass: profile.leanMass,
                metabolicAge: profile.metabolicAge,
                fitnessAge: profile.fitnessAge
            };
        }
        
        function calculatePersonalizedGoals() {
            const profile = gameState.profile;
            
            // Personalized calorie goals based on fitness goal
            const goalAdjustments = {
                lose_weight: -500, // 500 calorie deficit
                build_muscle: +300, // 300 calorie surplus
                endurance: +200, // Slight surplus for endurance training
                general: 0 // Maintenance
            };
            
            profile.dailyCalorieGoal = profile.TDEE + goalAdjustments[profile.fitnessGoal];
            
            // Personalized protein goals (g per kg body weight)
            const proteinMultipliers = {
                lose_weight: 2.2, // Higher protein for muscle preservation
                build_muscle: 2.5, // Maximum protein for muscle building
                endurance: 1.8, // Moderate protein for endurance
                general: 2.0 // Standard recommendation
            };
            
            profile.dailyProteinGoal = Math.round(profile.weight * proteinMultipliers[profile.fitnessGoal]);
            
            // Personalized water goals based on body weight and activity
            const baseWater = Math.round(profile.weight * 0.035); // 35ml per kg
            const activityBonus = profile.activityLevel === 'very_active' ? 2 : profile.activityLevel === 'active' ? 1 : 0;
            profile.dailyWaterGoal = Math.min(12, Math.max(6, baseWater + activityBonus));
        }
        
        function updateProgressTracking() {
            const profile = gameState.profile;
            const today = new Date().toISOString().split('T')[0];
            
            // Track weight progress
            const lastWeightEntry = profile.measurementHistory[profile.measurementHistory.length - 1];
            if (!lastWeightEntry || lastWeightEntry.date !== today) {
                // Only log if weight has changed significantly or it's been a week
                const daysSinceLastEntry = lastWeightEntry ? 
                    (new Date() - new Date(lastWeightEntry.date)) / (1000 * 60 * 60 * 24) : 7;
                
                if (daysSinceLastEntry >= 7) {
                    profile.measurementHistory.push({
                        date: today,
                        weight: profile.weight,
                        bodyFat: profile.bodyFatPercentage,
                        measurements: {}
                    });
                }
            }
            
            // Analyze progress trends
            analyzeProgressTrends();
            
            // Update AI recommendations based on progress
            updatePersonalizedRecommendations();
        }
        
        function analyzeProgressTrends() {
            const profile = gameState.profile;
            const history = profile.measurementHistory;
            
            if (history.length < 2) return;
            
            const recent = history.slice(-4); // Last 4 entries
            const weightTrend = calculateTrend(recent.map(h => h.weight));
            const bodyFatTrend = calculateTrend(recent.map(h => h.bodyFat));
            
            // Analyze if user is progressing toward goals
            const progressAnalysis = {
                weightProgress: analyzeWeightProgress(weightTrend),
                bodyCompositionProgress: analyzeBodyCompositionProgress(bodyFatTrend),
                recommendedAdjustments: []
            };
            
            // Generate recommendations based on progress
            if (profile.fitnessGoal === 'lose_weight' && weightTrend > 0) {
                progressAnalysis.recommendedAdjustments.push({
                    type: 'calorie_deficit',
                    suggestion: 'Increase calorie deficit by 100-200 calories',
                    reasoning: 'Weight trend is upward despite weight loss goal'
                });
            }
            
            if (profile.fitnessGoal === 'build_muscle' && bodyFatTrend > 0) {
                progressAnalysis.recommendedAdjustments.push({
                    type: 'training_intensity',
                    suggestion: 'Increase workout intensity and protein intake',
                    reasoning: 'Body fat increasing without proportional muscle gain'
                });
            }
            
            profile.progressAnalysis = progressAnalysis;
        }
        
        function calculateTrend(values) {
            if (values.length < 2) return 0;
            
            const firstHalf = values.slice(0, Math.floor(values.length / 2));
            const secondHalf = values.slice(Math.floor(values.length / 2));
            
            const firstAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
            const secondAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;
            
            return secondAvg - firstAvg;
        }
        
        function analyzeWeightProgress(trend) {
            const profile = gameState.profile;
            const target = profile.targetWeight;
            const current = profile.weight;
            
            if (Math.abs(current - target) < 1) {
                return { status: 'at_goal', message: 'Weight goal achieved!' };
            }
            
            const needsToLose = current > target;
            const trendInRightDirection = needsToLose ? trend < 0 : trend > 0;
            
            if (trendInRightDirection) {
                return { status: 'on_track', message: 'Weight progressing toward goal' };
            } else {
                return { status: 'needs_adjustment', message: 'Weight trending away from goal' };
            }
        }
        
        function analyzeBodyCompositionProgress(bodyFatTrend) {
            const profile = gameState.profile;
            const target = profile.targetBodyFat;
            const current = profile.bodyFatPercentage;
            
            if (Math.abs(current - target) < 1) {
                return { status: 'at_goal', message: 'Body composition goal achieved!' };
            }
            
            const needsToLose = current > target;
            const trendInRightDirection = needsToLose ? bodyFatTrend < 0 : bodyFatTrend > 0;
            
            if (trendInRightDirection) {
                return { status: 'on_track', message: 'Body composition improving' };
            } else {
                return { status: 'needs_adjustment', message: 'Body composition needs attention' };
            }
        }
        
        function updatePersonalizedRecommendations() {
            const profile = gameState.profile;
            const stats = gameState.dailyStats;
            
            // Adjust workout recommendations based on progress
            if (profile.progressAnalysis) {
                profile.progressAnalysis.recommendedAdjustments.forEach(adjustment => {
                    if (adjustment.type === 'calorie_deficit') {
                        profile.dailyCalorieGoal = Math.max(profile.BMR, profile.dailyCalorieGoal - 150);
                    } else if (adjustment.type === 'training_intensity') {
                        workoutAI.workoutProgression.intensity = Math.min(100, workoutAI.workoutProgression.intensity + 5);
                    }
                });
            }
            
            // Adjust based on adherence patterns
            const adherenceRate = calculateAdherenceRate();
            if (adherenceRate.nutrition < 0.7) {
                // Make nutrition goals more achievable
                profile.dailyCalorieGoal = Math.round(profile.dailyCalorieGoal * 0.95);
                profile.dailyProteinGoal = Math.round(profile.dailyProteinGoal * 0.9);
            }
            
            if (adherenceRate.fitness < 0.6) {
                // Suggest easier workout frequency
                profile.weeklyWorkoutGoal = Math.max(2, profile.weeklyWorkoutGoal - 1);
            }
        }
        
        function calculateAdherenceRate() {
            const recentDays = 7;
            const tasks = gameState.tasks.filter(task => {
                const daysSince = (Date.now() - new Date(task.createdAt).getTime()) / (1000 * 60 * 60 * 24);
                return daysSince <= recentDays;
            });
            
            const nutritionTasks = tasks.filter(t => t.category === 'nutrition');
            const fitnessTasks = tasks.filter(t => t.category === 'fitness');
            
            const nutritionAdherence = nutritionTasks.length > 0 ? 
                nutritionTasks.filter(t => t.completed).length / nutritionTasks.length : 1;
            const fitnessAdherence = fitnessTasks.length > 0 ? 
                fitnessTasks.filter(t => t.completed).length / fitnessTasks.length : 1;
            
            return {
                nutrition: nutritionAdherence,
                fitness: fitnessAdherence,
                overall: (nutritionAdherence + fitnessAdherence) / 2
            };
        }
        
        function showFullProfileSetup() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-4xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-2xl font-bold mb-6 text-center">üîß Complete Profile Setup</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Basic Information -->
                        <div class="space-y-4">
                            <h4 class="text-lg font-bold border-b pb-2">üìã Basic Information</h4>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Age</label>
                                    <input type="number" id="setupAge" min="13" max="100" value="${gameState.profile.age}" class="w-full p-2 border rounded-lg text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Gender</label>
                                    <select id="setupGender" class="w-full p-2 border rounded-lg text-base">
                                        <option value="male" ${gameState.profile.gender === 'male' ? 'selected' : ''}>Male</option>
                                        <option value="female" ${gameState.profile.gender === 'female' ? 'selected' : ''}>Female</option>
                                        <option value="other" ${gameState.profile.gender === 'other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Height (cm)</label>
                                    <input type="number" id="setupHeight" min="100" max="250" value="${gameState.profile.height}" class="w-full p-2 border rounded-lg text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Weight (kg)</label>
                                    <input type="number" id="setupWeight" min="30" max="200" step="0.1" value="${gameState.profile.weight}" class="w-full p-2 border rounded-lg text-base">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Body Fat %</label>
                                    <input type="number" id="setupBodyFat" min="5" max="50" step="0.1" value="${gameState.profile.bodyFatPercentage}" class="w-full p-2 border rounded-lg text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Resting HR</label>
                                    <input type="number" id="setupRHR" min="40" max="100" value="${gameState.profile.restingHeartRate}" class="w-full p-2 border rounded-lg text-base">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fitness & Health -->
                        <div class="space-y-4">
                            <h4 class="text-lg font-bold border-b pb-2">üí™ Fitness & Health</h4>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Primary Fitness Goal</label>
                                <select id="setupFitnessGoal" class="w-full p-2 border rounded-lg text-base">
                                    <option value="general" ${gameState.profile.fitnessGoal === 'general' ? 'selected' : ''}>General Fitness</option>
                                    <option value="lose_weight" ${gameState.profile.fitnessGoal === 'lose_weight' ? 'selected' : ''}>Lose Weight</option>
                                    <option value="build_muscle" ${gameState.profile.fitnessGoal === 'build_muscle' ? 'selected' : ''}>Build Muscle</option>
                                    <option value="endurance" ${gameState.profile.fitnessGoal === 'endurance' ? 'selected' : ''}>Improve Endurance</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Activity Level</label>
                                <select id="setupActivityLevel" class="w-full p-2 border rounded-lg text-base">
                                    <option value="sedentary" ${gameState.profile.activityLevel === 'sedentary' ? 'selected' : ''}>Sedentary (desk job, no exercise)</option>
                                    <option value="light" ${gameState.profile.activityLevel === 'light' ? 'selected' : ''}>Light (1-3 workouts/week)</option>
                                    <option value="moderate" ${gameState.profile.activityLevel === 'moderate' ? 'selected' : ''}>Moderate (3-5 workouts/week)</option>
                                    <option value="active" ${gameState.profile.activityLevel === 'active' ? 'selected' : ''}>Active (6-7 workouts/week)</option>
                                    <option value="very_active" ${gameState.profile.activityLevel === 'very_active' ? 'selected' : ''}>Very Active (2x/day + physical job)</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Fitness Experience</label>
                                    <select id="setupFitnessExperience" class="w-full p-2 border rounded-lg text-base">
                                        <option value="beginner" ${gameState.profile.fitnessExperience === 'beginner' ? 'selected' : ''}>Beginner</option>
                                        <option value="intermediate" ${gameState.profile.fitnessExperience === 'intermediate' ? 'selected' : ''}>Intermediate</option>
                                        <option value="advanced" ${gameState.profile.fitnessExperience === 'advanced' ? 'selected' : ''}>Advanced</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Preferred Workout Time</label>
                                    <select id="setupWorkoutTime" class="w-full p-2 border rounded-lg text-base">
                                        <option value="morning" ${gameState.profile.preferredWorkoutTime === 'morning' ? 'selected' : ''}>Morning (6-10 AM)</option>
                                        <option value="afternoon" ${gameState.profile.preferredWorkoutTime === 'afternoon' ? 'selected' : ''}>Afternoon (12-4 PM)</option>
                                        <option value="evening" ${gameState.profile.preferredWorkoutTime === 'evening' ? 'selected' : ''}>Evening (5-8 PM)</option>
                                        <option value="night" ${gameState.profile.preferredWorkoutTime === 'night' ? 'selected' : ''}>Night (8+ PM)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lifestyle & Productivity -->
                        <div class="space-y-4">
                            <h4 class="text-lg font-bold border-b pb-2">üè† Lifestyle</h4>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Sleep Schedule</label>
                                    <select id="setupSleepSchedule" class="w-full p-2 border rounded-lg text-base">
                                        <option value="early" ${gameState.profile.sleepSchedule === 'early' ? 'selected' : ''}>Early (9-10 PM to 5-6 AM)</option>
                                        <option value="normal" ${gameState.profile.sleepSchedule === 'normal' ? 'selected' : ''}>Normal (10-11 PM to 6-7 AM)</option>
                                        <option value="late" ${gameState.profile.sleepSchedule === 'late' ? 'selected' : ''}>Late (11+ PM to 7+ AM)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Work Schedule</label>
                                    <select id="setupWorkSchedule" class="w-full p-2 border rounded-lg text-base">
                                        <option value="standard" ${gameState.profile.workSchedule === 'standard' ? 'selected' : ''}>Standard (9-5)</option>
                                        <option value="shift" ${gameState.profile.workSchedule === 'shift' ? 'selected' : ''}>Shift Work</option>
                                        <option value="flexible" ${gameState.profile.workSchedule === 'flexible' ? 'selected' : ''}>Flexible</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Stress Level</label>
                                    <select id="setupStressLevel" class="w-full p-2 border rounded-lg text-base">
                                        <option value="low" ${gameState.profile.stressLevel === 'low' ? 'selected' : ''}>Low</option>
                                        <option value="moderate" ${gameState.profile.stressLevel === 'moderate' ? 'selected' : ''}>Moderate</option>
                                        <option value="high" ${gameState.profile.stressLevel === 'high' ? 'selected' : ''}>High</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Work Type</label>
                                    <select id="setupWorkType" class="w-full p-2 border rounded-lg text-base">
                                        <option value="physical" ${gameState.profile.workType === 'physical' ? 'selected' : ''}>Physical</option>
                                        <option value="knowledge" ${gameState.profile.workType === 'knowledge' ? 'selected' : ''}>Knowledge Work</option>
                                        <option value="creative" ${gameState.profile.workType === 'creative' ? 'selected' : ''}>Creative</option>
                                        <option value="mixed" ${gameState.profile.workType === 'mixed' ? 'selected' : ''}>Mixed</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Goals & Targets -->
                        <div class="space-y-4">
                            <h4 class="text-lg font-bold border-b pb-2">üéØ Goals & Targets</h4>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Target Weight (kg)</label>
                                    <input type="number" id="setupTargetWeight" min="30" max="200" step="0.1" value="${gameState.profile.targetWeight}" class="w-full p-2 border rounded-lg text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Target Body Fat %</label>
                                    <input type="number" id="setupTargetBodyFat" min="5" max="30" step="0.1" value="${gameState.profile.targetBodyFat}" class="w-full p-2 border rounded-lg text-base">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Weekly Workout Goal</label>
                                    <input type="number" id="setupWeeklyWorkouts" min="1" max="7" value="${gameState.profile.weeklyWorkoutGoal}" class="w-full p-2 border rounded-lg text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Focus Style</label>
                                    <select id="setupFocusStyle" class="w-full p-2 border rounded-lg text-base">
                                        <option value="deep_work" ${gameState.profile.focusStyle === 'deep_work' ? 'selected' : ''}>Deep Work (90+ min blocks)</option>
                                        <option value="pomodoro" ${gameState.profile.focusStyle === 'pomodoro' ? 'selected' : ''}>Pomodoro (25 min blocks)</option>
                                        <option value="flexible" ${gameState.profile.focusStyle === 'flexible' ? 'selected' : ''}>Flexible</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-center space-x-4">
                        <button onclick="saveCompleteProfile()" class="bg-primary text-white px-8 py-3 rounded-lg hover:bg-purple-600 font-bold">
                            üíæ Save Complete Profile
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function saveCompleteProfile() {
            const profile = gameState.profile;
            
            // Basic Information
            profile.age = parseInt(document.getElementById('setupAge').value) || 30;
            profile.gender = document.getElementById('setupGender').value;
            profile.height = parseInt(document.getElementById('setupHeight').value) || 170;
            profile.weight = parseFloat(document.getElementById('setupWeight').value) || 70;
            profile.bodyFatPercentage = parseFloat(document.getElementById('setupBodyFat').value) || 15;
            profile.restingHeartRate = parseInt(document.getElementById('setupRHR').value) || 65;
            
            // Fitness & Health
            profile.fitnessGoal = document.getElementById('setupFitnessGoal').value;
            profile.activityLevel = document.getElementById('setupActivityLevel').value;
            profile.fitnessExperience = document.getElementById('setupFitnessExperience').value;
            profile.preferredWorkoutTime = document.getElementById('setupWorkoutTime').value;
            
            // Lifestyle
            profile.sleepSchedule = document.getElementById('setupSleepSchedule').value;
            profile.workSchedule = document.getElementById('setupWorkSchedule').value;
            profile.stressLevel = document.getElementById('setupStressLevel').value;
            profile.workType = document.getElementById('setupWorkType').value;
            
            // Goals & Targets
            profile.targetWeight = parseFloat(document.getElementById('setupTargetWeight').value) || profile.weight;
            profile.targetBodyFat = parseFloat(document.getElementById('setupTargetBodyFat').value) || 12;
            profile.weeklyWorkoutGoal = parseInt(document.getElementById('setupWeeklyWorkouts').value) || 4;
            profile.focusStyle = document.getElementById('setupFocusStyle').value;
            
            // Calculate all personalized metrics
            const metrics = calculatePersonalizedMetrics();
            
            // Update progress tracking
            updateProgressTracking();
            
            // Close modal
            document.querySelector('.fixed').remove();
            
            // Update UI with new calculations
            updatePersonalizedUI();
            saveGameState();
            
            showFloatingNotification('üéâ Profile Complete!', 'All systems personalized to your data. AI recommendations updated!');
            
            // Award achievement for completing profile
            if (!gameState.achievements.find(a => a.title.includes('Profile Master'))) {
                addAchievement('üë§ Profile Master', 'Completed comprehensive profile setup!', 100);
            }
        }
        
        function saveBasicProfile() {
            const profile = gameState.profile;
            
            profile.name = document.getElementById('profileName').value.trim();
            profile.age = parseInt(document.getElementById('profileAge').value) || 30;
            profile.gender = document.getElementById('profileGender').value;
            profile.height = parseInt(document.getElementById('profileHeight').value) || 170;
            profile.weight = parseFloat(document.getElementById('profileWeight').value) || 70;
            profile.fitnessGoal = document.getElementById('fitnessGoal').value;
            profile.activityLevel = document.getElementById('activityLevel').value;
            
            // Calculate metrics with available data
            const metrics = calculatePersonalizedMetrics();
            updatePersonalizedUI();
            
            saveGameState();
            showFloatingNotification('üíæ Basic Profile Saved', 'Your profile has been updated! Complete full setup for better AI recommendations.');
        }
        
        function updatePersonalizedUI() {
            const metrics = calculatePersonalizedMetrics();
            
            // Update calculated fields in UI
            const bmrEl = document.getElementById('calculatedBMR');
            const tdeeEl = document.getElementById('calculatedTDEE');
            const bmiEl = document.getElementById('calculatedBMI');
            const proteinEl = document.getElementById('calculatedProtein');
            
            if (bmrEl) bmrEl.textContent = metrics.BMR;
            if (tdeeEl) tdeeEl.textContent = metrics.TDEE;
            if (bmiEl) bmiEl.textContent = metrics.BMI;
            if (proteinEl) proteinEl.textContent = gameState.profile.dailyProteinGoal;
            
            // Update form fields with current values
            const profileInputs = {
                'profileName': gameState.profile.name,
                'profileAge': gameState.profile.age,
                'profileGender': gameState.profile.gender,
                'profileHeight': gameState.profile.height,
                'profileWeight': gameState.profile.weight,
                'fitnessGoal': gameState.profile.fitnessGoal,
                'activityLevel': gameState.profile.activityLevel
            };
            
            Object.entries(profileInputs).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value;
                }
            });
        }
        
        // Add event listeners for real-time calculation updates
        function initializeProfileCalculations() {
            const calcFields = ['profileAge', 'profileGender', 'profileHeight', 'profileWeight', 'activityLevel'];
            
            calcFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => {
                        // Update profile with current values
                        if (fieldId === 'profileAge') gameState.profile.age = parseInt(field.value) || 30;
                        if (fieldId === 'profileGender') gameState.profile.gender = field.value;
                        if (fieldId === 'profileHeight') gameState.profile.height = parseInt(field.value) || 170;
                        if (fieldId === 'profileWeight') gameState.profile.weight = parseFloat(field.value) || 70;
                        if (fieldId === 'activityLevel') gameState.profile.activityLevel = field.value;
                        
                        // Recalculate and update display
                        const metrics = calculatePersonalizedMetrics();
                        updatePersonalizedUI();
                    });
                }
            });
        }

        // üíæ DATA MANAGEMENT
        function saveProfile() {
            saveBasicProfile();
        }

        function exportData() {
            const dataToExport = {
                gameState: gameState,
                spotifyState: {
                    clientId: spotifyState.clientId,
                    userProfile: spotifyState.userProfile
                },
                aiState: aiState,
                exportDate: new Date().toISOString(),
                version: '3.0'
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `life-quest-rpg-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showFloatingNotification('üì§ Data Exported', 'Your data has been downloaded!');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (importedData.gameState) {
                            gameState = importedData.gameState;
                        }
                        if (importedData.spotifyState?.clientId) {
                            spotifyState.clientId = importedData.spotifyState.clientId;
                        }
                        if (importedData.aiState) {
                            aiState = importedData.aiState;
                        }
                        
                        saveGameState();
                        updateAllUI();
                        showFloatingNotification('üì• Data Imported', 'Your data has been restored!');
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        showFloatingNotification('‚ùå Import Failed', 'Invalid file format');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function resetData() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-red-600">‚ö†Ô∏è Reset All Data</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">
                        This will permanently delete ALL your progress, tasks, achievements, and settings. 
                        This action cannot be undone!
                    </p>
                    <div class="flex space-x-3">
                        <button onclick="confirmReset()" class="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 font-bold">
                            üóëÔ∏è Yes, Reset Everything
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmReset() {
            localStorage.clear();
            location.reload();
        }

        // üéØ INITIALIZATION
        function initializeApp() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });

            loadGameState();
            loadSpotifyState();
            loadAIState();
            
            updateAllUI();
            generateAIMusicRecommendations();
            showEnhancedAIInsights();
            updateSpotifyConnectionStatus();
            updateMusicControls();
            updateMusicStats();
            checkForHealthData();
            
            handleSpotifyCallback();
            initializeEnhancedAI();
            initializeBrowserNotifications();
            
            setInterval(saveGameState, 30000);
            
            // Set up automatic reminders
            setupAutomaticReminders();
            
            const profileName = document.getElementById('profileName');
            const fitnessGoal = document.getElementById('fitnessGoal');
            if (profileName) profileName.value = gameState.profile.name || '';
            if (fitnessGoal) fitnessGoal.value = gameState.profile.fitnessGoal || 'general';
            
            // Initialize real-time profile calculations
            initializeProfileCalculations();
            updatePersonalizedUI();
            
            console.log('üéÆ Life Quest RPG - Ultimate AI Edition with Spotify Integration Initialized!');
        }

        // üîî AUTOMATIC REMINDERS SYSTEM
        function setupAutomaticReminders() {
            // Water reminder every 30 minutes during the day
            setInterval(() => {
                const hour = new Date().getHours();
                if (hour >= 8 && hour <= 20 && gameState.dailyStats.waterGlasses < 8) {
                    sendGameEventNotification(
                        'water_reminder',
                        'üíß Hydration Reminder',
                        `You've had ${gameState.dailyStats.waterGlasses} glasses today. Time for another!`,
                        'üíß'
                    );
                }
            }, 30 * 60 * 1000); // 30 minutes

            // Focus session reminder every 2 hours during work hours
            setInterval(() => {
                const hour = new Date().getHours();
                if (hour >= 9 && hour <= 17 && gameState.dailyStats.focusMinutes < 60) {
                    sendGameEventNotification(
                        'focus_reminder',
                        'üß† Focus Reminder',
                        'Ready for a productive Pomodoro session? Your brain will thank you!',
                        'üß†'
                    );
                }
            }, 2 * 60 * 60 * 1000); // 2 hours

            // Daily review reminder in the evening
            setInterval(() => {
                const hour = new Date().getHours();
                if (hour === 19) { // 7 PM
                    const completedTasks = gameState.tasks.filter(t => {
                        const taskDate = new Date(t.createdAt).toDateString();
                        const today = new Date().toDateString();
                        return taskDate === today && t.completed;
                    }).length;
                    
                    sendGameEventNotification(
                        'daily_review',
                        'üìä Daily Review',
                        `You completed ${completedTasks} tasks today! Ready to plan tomorrow's quests?`,
                        'üìä'
                    );
                }
            }, 60 * 60 * 1000); // Check every hour

            // Workout reminder if no exercise today
            setInterval(() => {
                const hour = new Date().getHours();
                if ((hour === 10 || hour === 14 || hour === 18) && gameState.dailyStats.workouts === 0) {
                    sendGameEventNotification(
                        'workout_reminder',
                        'üí™ Workout Reminder',
                        'Your body is ready for some movement! Even a 10-minute walk counts.',
                        'üí™'
                    );
                }
            }, 60 * 60 * 1000); // Check every hour

            // AI insight notifications every 45 minutes
            setInterval(() => {
                if (aiState.insights.length > 0 && Math.random() < 0.3) { // 30% chance
                    const insight = aiState.insights[Math.floor(Math.random() * aiState.insights.length)];
                    sendGameEventNotification(
                        'ai_insight',
                        'üß† AI Insight',
                        insight.action,
                        'üí°'
                    );
                }
            }, 45 * 60 * 1000);

            // Daily streak motivation at 8 AM
            setInterval(() => {
                const hour = new Date().getHours();
                const minute = new Date().getMinutes();
                
                if (hour === 8 && minute === 0) {
                    const waterStreak = gameState.streaks.water || 0;
                    const workoutStreak = gameState.streaks.workout || 0;
                    
                    if (waterStreak > 0 || workoutStreak > 0) {
                        sendGameEventNotification(
                            'streak_motivation',
                            'üî• Streak Power!',
                            `Water: ${waterStreak} days, Workouts: ${workoutStreak} days. Keep it going!`,
                            'üî•'
                        );
                    }
                }
            }, 60 * 1000); // Check every minute for precise timing
        }

        // üöÄ START THE APPLICATION
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
